### 批量任务

效果：

![image-20210119115245724](7%E6%89%B9%E9%87%8F%E4%BB%BB%E5%8A%A1.assets/image-20210119115245724.png)



命令管理效果

![image-20210119115303409](7%E6%89%B9%E9%87%8F%E4%BB%BB%E5%8A%A1.assets/image-20210119115303409.png)

关于批量任务，我们是一个单独的模块，所以我们也创建一个单独的应用来完成。

```python
python ../../manage.py startapp mtask
```

配置应用

```python
INSTALLED_APPS = [
    'simpleui',  # 必须写在django.contrib.admin之前
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'corsheaders',
    'channels',

    'home',
    'users',
    'host',
    'consumer',
    'mtask',
]
```

mtask/urls.py

```python
from django.urls import path
from . import views

urlpatterns = [
    
]
```

总路由，`hippo_api.urls`，代码：

```python
from django.contrib import admin
from django.urls import path,include

urlpatterns = [
    path('admin/', admin.site.urls),
    path("", include("home.urls")),
    path("users/", include("users.urls")),
    path('host/', include('host.urls')),
    path('mtask/', include('mtask.urls')),
]
```



#### 获取所有主机信息

点击从主机列表中选择的效果图

![image-20210119115020398](7%E6%89%B9%E9%87%8F%E4%BB%BB%E5%8A%A1.assets/image-20210119115020398.png)



服务端提供主机列表数据

在原来的主机管理的视图集的基础上，增加一个按分类显示数据即可。

host/views.py

```python
class HostModelViewSet(ModelViewSet):
    serializer_class = HostModelSerializers
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        # 重写qureyset方法，补充过滤主机列表参数，获取主机列表
        category_id = self.request.query_params.get("category",None)
        queryset = Host.objects
        if category_id is not None:
            queryset = queryset.filter(category_id=category_id)

        return queryset.all()
```

客户端展示界面效果。

创建src/components/MultiExec.vue组件，代码：

```vue
<template>
<div class="multi_exec">
    <div>
      <h3>执行主机：</h3>
      <div>
        <a-tag closable @close="log(info_index)" v-for="(info,info_index) in show_host_info" :key="info.id">
          {{`${info.name}(${info.ip_addr}:${info.port})`}}
        </a-tag>
      </div>
    </div>
    <div style="margin-top: 10px;">
      <a-button @click="showModal" icon="plus">从主机列表中选择</a-button>
      <a-modal v-model="visible" title="选择执行主机" @ok="handleOk" width="960px">
        <div>
          <a-row>
            <a-col :span="8">
              <a-form-item label="主机类别：" :label-col="formItemLayout.labelCol" :wrapper-col="formItemLayout.wrapperCol">
                <a-select style="width: 160px;" placeholder="请选择" v-model="host_form.form.category">
                  <a-select-option :value="value.id" v-for="(value, index) in categorys" :key="value.id">
                    {{value.name}}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="8">
              <a-form-item :label-col="formItemLayout.labelCol" :wrapper-col="formItemLayout.wrapperCol" label="主机别名：">
                <a-input placeholder="请输入"/>
              </a-form-item>
            </a-col>
            <a-col :span="4">
              <a-form-item :label-col="formItemLayout.labelCol" :wrapper-col="formItemLayout.wrapperCol" label="已选：">
                <span style="margin-left: 8px">
                  <template v-if="hasSelected">
                    {{ `${selectedRowKeys.length}` }}
                  </template>
                </span>
              </a-form-item>
            </a-col>
            <a-col :span="4">
              <a-button type="primary" icon="sync" style="margin-top: 3px;">刷新</a-button>
            </a-col>
          </a-row>
        </div>
        <div>
          <a-table
            :columns="columns"
            :data-source="data"
            :pagination="false"
            :rowKey="record => record.id"
            :row-selection="{ selectedRowKeys: selectedRowKeys, onChange: onSelectChange }"
          ></a-table>
        </div>
      </a-modal>
    </div>
  </div>
</template>

<script>
  const formItemLayout = {
      labelCol: {span: 8},
      wrapperCol: {span: 14},
  };
  const columns = [
    {
      slots: {title: 'customTitle'},
      scopedSlots: {customRender: 'action'},
    }, {
      title: '类别',
      dataIndex: 'category_name',
      key: 'category_name',
    }, {
      title: '主机名称',
      dataIndex: 'name',
      key: 'name',
    }, {
      title: '连接地址',
      dataIndex: 'ip_addr',
      key: 'ip_addr',
      width: 200,
    }, {
      title: '端口',
      dataIndex: 'port',
      key: 'port',
    }, {
      title: '备注信息',
      dataIndex: 'description',
      key: 'description',
    },
  ];

export default {
  name: "MultiExec",
  data(){
    return {
      formItemLayout,        // 弹窗的首行表单配置信息
      columns,               // 弹窗的表格的每一列数据的配置信息
      show_host_info: [],    // 显示选中的所有主机内容
      visible: false,        // 是否显示主机列表的弹窗
      host_form:{
        form:{
          category: undefined,// 当前选择的主机分类ID
        }
      },
      data: [],              // 当前显示咋表格中的主机列表数据
      categorys: [],         // 主机分类列表
      selectedRowKeys: [],   // 已经勾选的主机ID列表
    }
  },
  // 计算属性
  computed: {
      hasSelected() {
        return this.selectedRowKeys.length > 0;
      },
  },
  methods:{
    showModal(){
      this.visible = true;
    },
    // 选中主机时触发的，selectedRowKeys被选中的主机id列表
    onSelectChange(selectedRowKeys) {
      this.selectedRowKeys = selectedRowKeys;
    },
    handleOk(){

    },
  }
}
</script>
```

路由代码，`src/router/index.js`，代码：

```javascript
// ....代码省略
import MultiExec from '@/components/MultiExec'

const router = new Router({
  mode: "history",
  routes: [
    // ....代码省略
    {
      path: '/hippo',
      name: 'Base',
      component: Base,
      children: [
        // ....代码省略
        {
          path: 'multi_exec',
          name: 'MultiExec',
          component: MultiExec,
        }
      ]
    },

  ]
})

// 路由守卫[导航守卫]
// ....代码省略

export default router
```



获取主机分类和主机列表数据并展示，`src/components/MultiExec.vue`

```html
<template>
<div class="multi_exec">
    <div>
      <h3>执行主机：</h3>
      <div>
        <a-tag closable @close="close_host(info_index)" v-for="(info,info_index) in show_host_info" :key="info.id">
          {{`${info.name}(${info.ip_addr}:${info.port})`}}
        </a-tag>
      </div>
    </div>
    <div style="margin-top: 10px;">
      <a-button @click="showModal" icon="plus">从主机列表中选择</a-button>
      <a-modal v-model="visible" title="选择执行主机" @ok="handleOk" width="960px">
        <div>
          <a-row>
            <a-col :span="8">
              <a-form-item label="主机类别：" :label-col="formItemLayout.labelCol" :wrapper-col="formItemLayout.wrapperCol">
                <a-select style="width: 160px;" placeholder="请选择" v-model="host_form.form.category" @change="has_change_category">
                  <a-select-option :value="value.id" v-for="(value, index) in categorys" :key="value.id">
                    {{value.name}}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="8">
              <a-form-item :label-col="formItemLayout.labelCol" :wrapper-col="formItemLayout.wrapperCol" label="主机别名：">
                <a-input placeholder="请输入"/>
              </a-form-item>
            </a-col>
            <a-col :span="4">
              <a-form-item :label-col="formItemLayout.labelCol" :wrapper-col="formItemLayout.wrapperCol" label="已选：">
                <span style="margin-left: 8px">
                  <template v-if="hasSelected">
                    {{ `${selectedRowKeys.length}` }}
                  </template>
                </span>
              </a-form-item>
            </a-col>
            <a-col :span="4">
              <a-button type="primary" icon="sync" style="margin-top: 3px;" @click="refresh_data">刷新</a-button>
            </a-col>
          </a-row>
        </div>
        <div>
          <a-table
            :columns="columns"
            :data-source="data"
            :pagination="false"
            :rowKey="record => record.id"
            :row-selection="{ selectedRowKeys: selectedRowKeys, onChange: onSelectChange }"
          ></a-table>
        </div>
      </a-modal>
    </div>
  </div>
</template>

<script>
  const formItemLayout = {
      labelCol: {span: 8},
      wrapperCol: {span: 14},
  };
  const columns = [
    {
      slots: {title: 'customTitle'},
      scopedSlots: {customRender: 'action'},
    }, {
      title: '类别',
      dataIndex: 'category_name',
      key: 'category_name',
    }, {
      title: '主机名称',
      dataIndex: 'name',
      key: 'name',
    }, {
      title: '连接地址',
      dataIndex: 'ip_addr',
      key: 'ip_addr',
      width: 200,
    }, {
      title: '端口',
      dataIndex: 'port',
      key: 'port',
    }, {
      title: '备注信息',
      dataIndex: 'description',
      key: 'description',
    },
  ];

export default {
  name: "MultiExec",
  data(){
    return {
      formItemLayout,        // 弹窗的首行表单配置信息
      columns,               // 弹窗的表格的每一列数据的配置信息
      show_host_info: [],    // 显示选中的所有主机内容
      visible: false,        // 是否显示主机列表的弹窗
      host_form:{
        form:{
          category: undefined,// 当前选择的主机分类ID
        }
      },
      data: [],              // 当前显示表格中的主机列表数据
      categorys: [],         // 主机分类列表
      selectedRowKeys: [],   // 已经勾选的主机ID列表
      selected_host_ids: [], // 选中的主机id列表
    }
  },
  // 计算属性
  computed: {
    hasSelected() {
      return this.selectedRowKeys.length > 0;
    },
  },
  created(){
      this.get_host_category_list()
      this.get_host_list()
  },
  methods:{
    showModal(){
      this.visible = true;
    },
    // 选中主机时触发的，selectedRowKeys被选中的主机id列表
    onSelectChange(selectedRowKeys) {
      this.selectedRowKeys = selectedRowKeys;
    },
    handleOk(){
      this.data.forEach((v, k) => {
        if (this.selectedRowKeys.includes(v.id)) { // 判断某元素是否在数组中用includes比较合适，不能用in
          this.show_host_info.push({
            id: v.id,
            name: v.name,
            ip_addr: v.ip_addr,
            port: v.port,
          })
          this.selected_host_ids.push(v.id);
        }
      })
      // 关闭弹窗
      this.visible = false;
    },
    get_host_category_list() {
      // 获取主机类别
      let token = sessionStorage.token || localStorage.token;
      this.$axios.get(`${this.$settings.host}/host/category`,{
        headers:{
          Authorization: "jwt " + token,
        }
      }).then((response) => {
          this.categorys = response.data;
      })
    },
    get_host_list(category=null){
      // 获取主机列表
      let params = {}
      if(category !== null){
        params.category = category
      }
      let token = sessionStorage.token || localStorage.token;
      this.$axios.get(`${this.$settings.host}/host/host`,{
        params: params,
        headers:{
          Authorization: "jwt " + token,
        }
      }).then((response) => {
          this.data = response.data;
      })
    },
    has_change_category(category){
      // 切换主机分类时，重新获取主机列表
      this.get_host_list(category)
    },
    refresh_data(){
      // 刷新数据
      this.host_form.form.category = undefined
      this.get_host_list();
    },
    close_host(info_index){
      // 移除已经勾选的主机信息
      this.show_host_info.splice(info_index,1);
      let ids_list = this.selected_host_ids.splice(info_index,1);
      let id_index = this.selectedRowKeys.indexOf(ids_list[0]);
      this.selectedRowKeys.splice(id_index,1);
    }
  }
}
</script>
```



#### 指令输入框

##### Ace-editor编辑器

文档地址： https://github.com/chairuosen/vue2-ace-editor

客户端根目录下，下载安装

```shell
npm install --save-dev vue2-ace-editor
```

在需要引入编辑器插件的组件中先挂载插件，然后再使用，那么我们现在就需要在MultiExec.vue中注册插件。

`src/components/MultiExec.vue`，代码：

```js
{
    data,
    methods,
    ...
    components: {
        editor: require('vue2-ace-editor'),
    },
}
```

在methods中，创建编辑器插件的初始化方法editorInit，`src/components/MultiExec.vue`，代码：

```js
{
    data,
    methods: {
        editorInit: function () {
            require('brace/ext/language_tools') //language extension prerequsite...
            require('brace/mode/html')                
            require('brace/mode/javascript')    //language
            require('brace/mode/less')
            require('brace/theme/chrome')
            require('brace/snippets/javascript') //snippet
        }
    },
}
```

vue视图中使用

```html
    <div class="cmd">
        <div>执行指令： </div>
        <editor v-model="content" @init="editorInit" lang="html" theme="chrome" width="500" height="100" style="font-size: 20px;margin-bottom: 1rem;"></editor>
    </div>
    <div>
      <a-button type="primary" icon="thunderbolt">开始执行</a-button>
    </div>
```

#### 执行指令操作

后端实现执行指令的api接口

mtask/urls.py

```python
path('cmd_exec', views.CmdExecView.as_view()),
```

mtask/views.py

```python
from rest_framework.views import APIView
from host.models import Host
from hippo_api.utils.key import AppSetting
from django.conf import settings
from rest_framework.response import Response

class CmdExecView(APIView):
    def post(self, request):
        host_ids = request.data.get('host_ids')
        cmd = request.data.get('cmd')
        if host_ids and cmd:
            exec_host_list = Host.objects.filter(id__in=host_ids)
            pkey, _ = AppSetting.get(settings.DEFAULT_KEY_NAME)  # 获取ssh秘钥
            response_list = []
            for host in exec_host_list:
                cli = host.get_ssh(pkey)
                # ssh 远程执行指令
                res_code, res_data = cli.exec_command(cmd)
                # res_code为0表示ok，不为0说明指令执行有问题
                response_list.append({
                    'host_info': {
                        'id': host.id,
                        'name': host.name,
                        'ip_addr': host.ip_addr,
                        'port': host.port,
                    },
                    'res_code': res_code,
                    'res_data': res_data,
                })
            return Response(response_list)

        else:
            return Response({'error': '没有该主机或者没有输入指令'}, status=400)
```

客户端发送执行指令请求。

`src/components/MultiExec.vue`，代码：

```vue
<a-button type="primary" icon="thunderbolt" @click="execute_cmd">开始执行</a-button>
```

```vue
<template>
<div class="multi_exec">
    <div>
      <h3>执行主机：</h3>
      <div>
        <a-tag closable @close="close_host(info_index)" v-for="(info,info_index) in show_host_info" :key="info.id">
          {{`${info.name}(${info.ip_addr}:${info.port})`}}
        </a-tag>
      </div>
    </div>
    <div style="margin-top: 10px;">
      <a-button @click="showModal" icon="plus">从主机列表中选择</a-button>
      <a-modal v-model="visible" title="选择执行主机" @ok="handleOk" width="960px">
        <div>
          <a-row>
            <a-col :span="8">
              <a-form-item label="主机类别：" :label-col="formItemLayout.labelCol" :wrapper-col="formItemLayout.wrapperCol">
                <a-select style="width: 160px;" placeholder="请选择" v-model="host_form.form.category" @change="has_change_category">
                  <a-select-option :value="value.id" v-for="(value, index) in categorys" :key="value.id">
                    {{value.name}}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="8">
              <a-form-item :label-col="formItemLayout.labelCol" :wrapper-col="formItemLayout.wrapperCol" label="主机别名：">
                <a-input placeholder="请输入"/>
              </a-form-item>
            </a-col>
            <a-col :span="4">
              <a-form-item :label-col="formItemLayout.labelCol" :wrapper-col="formItemLayout.wrapperCol" label="已选：">
                <span style="margin-left: 8px">
                  <template v-if="hasSelected">
                    {{ `${selectedRowKeys.length}` }}
                  </template>
                </span>
              </a-form-item>
            </a-col>
            <a-col :span="4">
              <a-button type="primary" icon="sync" style="margin-top: 3px;" @click="refresh_data">刷新</a-button>
            </a-col>
          </a-row>
        </div>
        <div>
          <a-table
            :columns="columns"
            :data-source="data"
            :pagination="false"
            :rowKey="record => record.id"
            :row-selection="{ selectedRowKeys: selectedRowKeys, onChange: onSelectChange }"
          ></a-table>
        </div>
      </a-modal>
    </div>
    <div class="cmd">
        <div>执行指令： </div>
        <editor v-model="content" @init="editorInit" lang="html" theme="chrome" width="600" height="200" style="font-size: 22px;line-height: 24px; margin-bottom: 1rem;"></editor>
    </div>
    <div>
      <a-button type="primary" icon="thunderbolt" @click="execute_cmd">开始执行</a-button>
    </div>
  </div>
</template>

<script>
  const formItemLayout = {
      labelCol: {span: 8},
      wrapperCol: {span: 14},
  };
  const columns = [
    {
      slots: {title: 'customTitle'},
      scopedSlots: {customRender: 'action'},
    }, {
      title: '类别',
      dataIndex: 'category_name',
      key: 'category_name',
    }, {
      title: '主机名称',
      dataIndex: 'name',
      key: 'name',
    }, {
      title: '连接地址',
      dataIndex: 'ip_addr',
      key: 'ip_addr',
      width: 200,
    }, {
      title: '端口',
      dataIndex: 'port',
      key: 'port',
    }, {
      title: '备注信息',
      dataIndex: 'description',
      key: 'description',
    },
  ];

export default {
  name: "MultiExec",
  data(){
    return {
      formItemLayout,        // 弹窗的首行表单配置信息
      columns,               // 弹窗的表格的每一列数据的配置信息
      show_host_info: [],    // 显示选中的所有主机内容
      visible: false,        // 是否显示主机列表的弹窗
      host_form:{
        form:{
          category: undefined,// 当前选择的主机分类ID
        }
      },
      data: [],              // 当前显示表格中的主机列表数据
      categorys: [],         // 主机分类列表
      selectedRowKeys: [],   // 已经勾选的主机ID列表
      selected_host_ids: [], // 选中的主机id列表
    }
  },
  // 计算属性
  computed: {
    hasSelected() {
      return this.selectedRowKeys.length > 0;
    },
  },
  created(){
      this.get_host_category_list()
      this.get_host_list()
  },
  methods:{
    editorInit: function () {
        require('brace/ext/language_tools') //language extension prerequsite...
        require('brace/mode/html')
        require('brace/mode/javascript')    //language
        require('brace/mode/less')
        require('brace/theme/chrome')
        require('brace/snippets/javascript') //snippet
    },
    showModal(){
      this.visible = true;
    },
    // 选中主机时触发的，selectedRowKeys被选中的主机id列表
    onSelectChange(selectedRowKeys) {
      this.selectedRowKeys = selectedRowKeys;
    },
    handleOk(){
      this.data.forEach((v, k) => {
        if (this.selectedRowKeys.includes(v.id)) { // 判断某元素是否在数组中用includes比较合适，不能用in
          this.show_host_info.push({
            id: v.id,
            name: v.name,
            ip_addr: v.ip_addr,
            port: v.port,
          })
          this.selected_host_ids.push(v.id);
        }
      })
      // 关闭弹窗
      this.visible = false;
    },
    get_host_category_list() {
      // 获取主机类别
      let token = sessionStorage.token || localStorage.token;
      this.$axios.get(`${this.$settings.host}/host/category`,{
        headers:{
          Authorization: "jwt " + token,
        }
      }).then((response) => {
          this.categorys = response.data;
      })
    },
    get_host_list(category=null){
      // 获取主机列表
      let params = {}
      if(category !== null){
        params.category = category
      }
      let token = sessionStorage.token || localStorage.token;
      this.$axios.get(`${this.$settings.host}/host/host`,{
        params: params,
        headers:{
          Authorization: "jwt " + token,
        }
      }).then((response) => {
          this.data = response.data;
      })
    },
    has_change_category(category){
      // 切换主机分类时，重新获取主机列表
      this.get_host_list(category)
    },
    refresh_data(){
      // 刷新数据
      this.host_form.form.category = undefined
      this.get_host_list();
    },
    close_host(info_index){
      // 移除已经勾选的主机信息
      this.show_host_info.splice(info_index,1);
      let ids_list = this.selected_host_ids.splice(info_index,1);
      let id_index = this.selectedRowKeys.indexOf(ids_list[0]);
      this.selectedRowKeys.splice(id_index,1);
    },
    execute_cmd(){
      let token = sessionStorage.token || localStorage.token;
      this.$axios.post(`${this.$settings.host}/mtask/cmd_exec`,{
          host_ids: this.selected_host_ids,
          cmd: this.content,
        },{
          headers:{
            Authorization: "jwt "+token
          }
        }).then((res) => {
          console.log(res);
        })
    }
  },
  components: {
    editor: require('vue2-ace-editor'),
  },
}
</script>
```



在日常运维过程中，有些指令会经常重复被调用，所以前端还可以通过创建指令模板，然后执行指令模板的方式来执行模板中提前写好的指令。

#### 指令模板

后端

mtask/models.py

```python
from hippo_api.utils.models import BaseModel,models
from host.models import Host

class CmdTemplateCategory(BaseModel):
    class Meta:
        db_table = "hp_cmd_template_category"
        verbose_name = "模板分类"
        verbose_name_plural = verbose_name

    def __str__(self):
        return self.name

class CmdTemplate(BaseModel):
    category = models.ForeignKey('CmdTemplateCategory', on_delete=models.CASCADE,verbose_name='模板类别')
    cmd = models.TextField(verbose_name='模板内容')

    class Meta:
        db_table = "hp_cmd_template"
        verbose_name = "指令模板"
        verbose_name_plural = verbose_name
```

数据迁移，终端下在服务端项目根目录下执行

```bash
python manage.py makemigrations
python manage.py migrate
```

添加测试数据，mysql中执行以下SQL语句。

```sql
INSERT INTO hippo.hp_cmd_template_category (id, name, is_show, orders, is_delete, created_time, updated_time, description) VALUES (1, '文件操作', 1, 1, 0, '2021-08-07 20:52:55', '2021-08-07 20:52:55', null);
INSERT INTO hippo.hp_cmd_template_category (id, name, is_show, orders, is_delete, created_time, updated_time, description) VALUES (2, '文件夹操作', 1, 1, 0, '2021-08-07 20:52:55', '2021-08-07 20:52:55', null);

INSERT INTO hippo.hp_cmd_template (id, name, is_show, orders, is_delete, created_time, updated_time, description, cmd, category_id) VALUES (1, '列出当前目录下所有文件', 1, 1, 0, '2021-08-07 20:55:45', '2021-08-07 20:55:45', null, 'ls', 2);
INSERT INTO hippo.hp_cmd_template (id, name, is_show, orders, is_delete, created_time, updated_time, description, cmd, category_id) VALUES (2, '创建文件', 1, 1, 0, '2021-08-07 20:55:45', '2021-08-07 20:55:45', null, 'touch index.html', 1);
INSERT INTO hippo.hp_cmd_template (id, name, is_show, orders, is_delete, created_time, updated_time, description, cmd, category_id) VALUES (3, '家目录下创建文件夹', 1, 1, 0, '2021-08-07 20:55:45', '2021-08-07 20:55:45', null, 'cd /home
mkdir hippo', 2);
```



mtask/urls.py

```python
from django.urls import path
from . import views

urlpatterns = [
    path('cmd_exec', views.CmdExecView.as_view()),
    path('templates', views.TemplateView.as_view()),
    path('templates/categorys', views.TemplateCategoryView.as_view()),
]
```

mtask/views.py

```python
from rest_framework.generics import ListAPIView,CreateAPIView
from .models import CmdTemplate,CmdTemplateCategory
from .serializers import CmdTemplateModelSerialzer,CmdTemplateCategoryModelSerialzer
from rest_framework.permissions import IsAuthenticated
class TemplateView(ListAPIView,CreateAPIView):
    # 获取所有执行模板
    permission_classes = [IsAuthenticated]
    queryset = CmdTemplate.objects.all()
    serializer_class = CmdTemplateModelSerialzer


class TemplateCategoryView(ListAPIView,CreateAPIView):
    # 获取执行模板类别
    permission_classes = [IsAuthenticated]
    queryset = CmdTemplateCategory.objects.all()
    serializer_class = CmdTemplateCategoryModelSerialzer
```

mtask.serializers，代码：

```python
from rest_framework import serializers
from .models import CmdTemplateCategory,CmdTemplate

class CmdTemplateModelSerialzer(serializers.ModelSerializer):
    category_name = serializers.CharField(source="category.name", read_only=True)
    class Meta:
        model = CmdTemplate
        fields = ["id","name","cmd","description","category_name", "category"]

class CmdTemplateCategoryModelSerialzer(serializers.ModelSerializer):
    class Meta:
        model = CmdTemplateCategory
        fields = "__all__"
```



前端部分，`src/components/TemplateManage.vue`，代码：

```html
<template>
  <div class="template_manager">
    <div>
      <a-row>
        <a-col :span="10">
          <a-form-item
            label="模板类别："
            :label-col="formItemLayout.labelCol"
            :wrapper-col="formItemLayout.wrapperCol"
          >
            <a-select style="width: 160px;"
                      placeholder="请选择"
                      @change="handleSelectChange"
                      v-model="template_category.form.category_id"
            >
              <a-select-option :value="value.id" v-for="(value, index) in tem_categorys" :key="value.id">
                {{value.name}}
              </a-select-option>
            </a-select>
          </a-form-item>
        </a-col>
        <a-col :span="10">
          <a-form-item
            :label-col="formItemLayout.labelCol"
            :wrapper-col="formItemLayout.wrapperCol"
            label="模板名称："
          >
            <a-input placeholder="请输入" />
          </a-form-item>
        </a-col>
        <a-col :span="4">
          <!-- <router-link> -->
          <a-button type="primary" icon="sync" style="margin-top: 3px;" @click="refresh_data">刷新</a-button>
          <!-- </router-link> -->
        </a-col>
      </a-row>
    </div>
    <div style="margin-top: 20px;">
      <a-button type="primary" @click="showModal" icon="plus"> 新建 </a-button>
      <a-modal v-model="visible" title="新建模板" @ok="handleSubmit" width="960px">
        <div>
          <div>
            <a-form :form="form" :label-col="{ span: 5 }" :wrapper-col="{ span: 12 }" @submit="handleSubmit">
              <a-row>
                <a-form-item label="模板类别">
                  <a-col :span="18">
                    <a-select
                      v-decorator="[ 'category',
              { rules: [{ required: true, message: 'Please select your gender!' }] }, ]"
                      placeholder=""
                      @change="handleSelectChange" >
                      <a-select-option :value="value.id" v-for="(value, index) in tem_categorys" :key="value.id">
                        {{value.name}}
                      </a-select-option>
                    </a-select>
                  </a-col>
                  <a-col :span="6"><a-button type="link">添加类别</a-button></a-col>
                </a-form-item>
              </a-row>
              <a-form-item label="模板名称">
                <a-input
                  v-decorator="['name', { rules: [{ required: true, message: 'Please input your note!' }] }]"
                />
              </a-form-item>
              <a-form-item label="模板内容">
                <div>
                  <editor v-model="cmd" @init="editorInit" lang="html" theme="chrome" width="500" height="300">
                  </editor>
                </div>
              </a-form-item>

              <a-form-item label="备注信息">
                <a-textarea v-decorator="['desc', { rules: [{ required: false, message: 'Please input your note!' }] }]"
                            placeholder="Basic usage" :rows="4"/>
              </a-form-item>


            </a-form>

          </div>

        </div>


      </a-modal>

    </div>

    <div style="margin-top: 10px;">
      <a-table :columns="columns" :data-source="data" :rowKey="record => record.id">

      <span slot="action" slot-scope="record">
        <a href="javascript:;">编辑</a> |
        <a href="javascript:;">删除</a>

      </span>
      </a-table>
    </div>
  </div>
</template>

<script>
  const formItemLayout = {
    labelCol: {span: 6},
    wrapperCol: {span: 14},
  };

  const columns = [
    {
      title: '模板名称',
      dataIndex: 'name',
      key: 'name',

    },
    {
      title: '模板类型',
      dataIndex: 'category_name',
      key: 'category_name',

    },
    {
      title: '模板内容',
      dataIndex: 'cmd',
      key: 'cmd',
      width: 200,
    },
    {
      title: '描述信息',
      dataIndex: 'description',
      key: 'description',

    },
    {
      title: '操作',
      key: 'action',
      width: 200,
      scopedSlots: {customRender: 'action'},
    },
  ];
  export default {
    name: "TemplateManage",
    data() {
      return {
        formItemLayout,
        visible: false,
        formLayout: 'horizontal',
        form: this.$form.createForm(this, {name: 'coordinated'}),
        tem_categorys: [],
        data: [],
        columns,
        cmd: '',  // 添加指令模板时的cmd指令
        template_category: {
          form: {
            category_id: 1,
            name: '',
            cmd: '',
            desc: '',
          }
        }
      }
    },
    components: {
      editor: require('vue2-ace-editor'),
    },
    created() {
      this.get_templates_list();
      this.get_templates_category_list();
    },

    methods: {
      editorInit: function () {
        require('brace/ext/language_tools') //language extension prerequsite...
        require('brace/mode/html')
        require('brace/mode/javascript')    //language
        require('brace/mode/less')
        require('brace/theme/chrome')
        require('brace/snippets/javascript') //snippet
      },
      handleSubmit(e) {  // handleSubmit必须声明并使用这个方法，名字不能改
        e.preventDefault();
        this.form.validateFields((err, values) => {
          let token = sessionStorage.token || localStorage.token;
          if (!err) {
            values.cmd = this.cmd;
            // 拿到验证成功之后的数据
            console.log('Received values of form: ', values);
            // 发送添加模板的请求
            this.$axios.post(`${this.$settings.host}/mtask/templates`, values,{
              headers:{
                Authorization: "jwt " + token
              }
            })
              .then(response => {
                console.log(response);
                this.visible = false;
                this.get_templates_list();
              })

          }

        });
        // this.visible = false;
      },
      showModal() {
        this.visible = true;
      },
      // handleOk(e) {
      //
      //   this.visible = false;
      // },

      handleSelectChange(value) {
        // 切换模板分类
        this.get_templates_list(value)
      },
      refresh_data() {
        this.get_templates_list();
      },
      get_templates_list(category = null) {
        let token = sessionStorage.token || localStorage.token;
        let params = {}
        if(category !== null){
          params.category = category
        }
        this.$axios.get(`${this.$settings.host}/mtask/templates`,{
          params:params,
          headers:{
            Authorization: "jwt " + token
          }
        }).then(response => {
            this.data = response.data;
        })
      },
      get_templates_category_list() {
        let token = sessionStorage.token || localStorage.token;
        this.$axios.get(`${this.$settings.host}/mtask/templates/categorys`,{
          headers:{
            Authorization: "jwt " + token
          }
        })
          .then(response => {
            this.tem_categorys = response.data;
          })
      }
    }

  }
</script>

<style scoped>

</style>

```

路由，代码：

```javascript
import Vue from 'vue'
import Router from 'vue-router'

Vue.use(Router)
import Base from "../components/Base";
import Login from "../components/Login";
import ShowCenter from "../components/ShowCenter";
import Host from '@/components/Host'
import Console from '@/components/Console'
import MultiExec from '@/components/MultiExec'
import TemplateManage from '@/components/TemplateManage'

const router = new Router({
  mode: "history",
  routes: [
    {
      path: '/',
      name: 'Login',
      component: Login,
    },
    {
      path: '/hippo',
      name: 'Base',
      component: Base,
      children: [
        {
          path: 'workbench',  // 访问路径： 父级路由 + 当前路由
          name: 'ShowCenter',
          component: ShowCenter,
        }, {
          path: 'host',
          name: 'Host',
          component: Host,
        }, {
          path: 'console/:id',
          name: 'Console',
          component: Console,
        }, {
          path: 'multi_exec',
          name: 'MultiExec',
          component: MultiExec,
        },{
          path: 'template_manage',
          name: 'TemplateManage',
          component: TemplateManage,
        },
      ]
    },

  ]
})

// 路由守卫[导航守卫]
import axios from "axios"
import settings from "../settings.js"
router.beforeEach((to, from, next) => {
  if(to.name === 'Login'){
    next()
    return
  }
  let token = sessionStorage.token || localStorage.token;
  // 验证jwt token
  axios.post(`${settings.host}/users/refresh`,{
    token, // token: token,
  }).then(response=>{
      // 保存返回的新token
      sessionStorage.token = response.data.token;
      next()
  }).catch(error=>{
      // alert("对不起，您尚未登录或登录已超时，请重新登录！")
      next("/")
  })

})


export default router
```

好了，指令模板可以创建了，那么我们可以在批量执行指令的功能上，添加上选择模板执行指令的功能，并点击执行。

```html
<template>
<div class="multi_exec">
    <div>
      <h3>执行主机：</h3>
      <div>
        <a-tag closable @close="close_host(info_index)" v-for="(info,info_index) in show_host_info" :key="info.id">
          {{`${info.name}(${info.ip_addr}:${info.port})`}}
        </a-tag>
      </div>
    </div>
    <div style="margin-top: 10px;">
      <a-button @click="showModal" icon="plus">从主机列表中选择</a-button>
      <a-modal v-model="visible" title="选择执行主机" @ok="handleOk" width="960px">
        <div>
          <a-row>
            <a-col :span="8">
              <a-form-item label="主机类别：" :label-col="formItemLayout.labelCol" :wrapper-col="formItemLayout.wrapperCol">
                <a-select style="width: 160px;" placeholder="请选择" v-model="host_form.form.category" @change="has_change_category">
                  <a-select-option :value="value.id" v-for="(value, index) in categorys" :key="value.id">
                    {{value.name}}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="8">
              <a-form-item :label-col="formItemLayout.labelCol" :wrapper-col="formItemLayout.wrapperCol" label="主机别名：">
                <a-input placeholder="请输入"/>
              </a-form-item>
            </a-col>
            <a-col :span="4">
              <a-form-item :label-col="formItemLayout.labelCol" :wrapper-col="formItemLayout.wrapperCol" label="已选：">
                <span style="margin-left: 8px">
                  <template v-if="hasSelected">
                    {{ `${selectedRowKeys.length}` }}
                  </template>
                </span>
              </a-form-item>
            </a-col>
            <a-col :span="4">
              <a-button type="primary" icon="sync" style="margin-top: 3px;" @click="refresh_data">刷新</a-button>
            </a-col>
          </a-row>
        </div>
        <div>
          <a-table
            :columns="columns"
            :data-source="data"
            :pagination="false"
            :rowKey="record => record.id"
            :row-selection="{ selectedRowKeys: selectedRowKeys, onChange: onSelectChange }"
          ></a-table>
        </div>
      </a-modal>
    </div>
    <div class="cmd">
        <div>执行指令： </div>
        <editor v-model="content" @init="editorInit" lang="html" theme="chrome" width="600" height="200" style="font-size: 22px;line-height: 24px; margin-bottom: 1rem;"></editor>
    </div>

<div style="margin-top: 20px;">
      <a-button @click="showModal2" icon="plus">从执行模板中选择</a-button>
      <a-modal v-model="visible2" title="选择执行模板" @ok="handleOk2" width="960px">
        <div>
          <a-row>
            <a-col :span="10">
              <a-form-item label="模板类别：" :label-col="formItemLayout.labelCol" :wrapper-col="formItemLayout.wrapperCol">
                <a-select style="width: 160px;" placeholder="请选择" @change="handleSelectChange2" v-model="template_form.form.category">
                  <a-select-option :value="value.id" v-for="(value, index) in tem_categorys" :key="value.id">
                    {{value.name}}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="10">
              <a-form-item :label-col="formItemLayout.labelCol" :wrapper-col="formItemLayout.wrapperCol" label="模板名称：">
                <a-input placeholder="请输入"/>
              </a-form-item>
            </a-col>
            <a-col :span="4">
              <a-button type="primary" icon="sync" style="margin-top: 3px;" @click="refresh_data2">刷新</a-button>
            </a-col>
          </a-row>

        </div>
        <div>
          <a-table :columns="tem_columns" :data-source="tem_data" :rowKey="record => record.id"
                   :row-selection="{ radioselectedRow: radioselectedRow, onChange: onSelectChange2,type: 'radio' }">
          </a-table>
        </div>
      </a-modal>
    </div>

    <div style="margin-top: 15px;">
      <a-button type="primary" icon="thunderbolt" @click="execute_cmd">开始执行</a-button>
    </div>
  </div>
</template>

<script>
  const formItemLayout = {
      labelCol: {span: 8},
      wrapperCol: {span: 14},
  };
  const columns = [
    {
      slots: {title: 'customTitle'},
      scopedSlots: {customRender: 'action'},
    }, {
      title: '类别',
      dataIndex: 'category_name',
      key: 'category_name',
    }, {
      title: '主机名称',
      dataIndex: 'name',
      key: 'name',
    }, {
      title: '连接地址',
      dataIndex: 'ip_addr',
      key: 'ip_addr',
      width: 200,
    }, {
      title: '端口',
      dataIndex: 'port',
      key: 'port',
    }, {
      title: '备注信息',
      dataIndex: 'description',
      key: 'description',
    },
  ];

  const tem_columns = [
    {
      title: '模板名称',
      dataIndex: 'name',
      key: 'name',

    },
    {
      title: '模板类型',
      dataIndex: 'category_name',
      key: 'category_name',

    },
    {
      title: '模板内容',
      dataIndex: 'cmd',
      key: 'cmd',
      width: 200,
    },
    {
      title: '描述信息',
      dataIndex: 'description',
      key: 'description',

    },


  ];

export default {
  name: "MultiExec",
  data(){
    return {
      formItemLayout,        // 弹窗的首行表单配置信息
      columns,               // 弹窗的表格的每一列数据的配置信息
      show_host_info: [],    // 显示选中的所有主机内容
      visible: false,        // 是否显示主机列表的弹窗
      host_form:{
        form:{
          category: undefined,// 当前选择的主机分类ID
        }
      },
      data: [],              // 当前显示表格中的主机列表数据
      categorys: [],         // 主机分类列表
      selectedRowKeys: [],   // 已经勾选的主机ID列表
      selected_host_ids: [], // 选中的主机id列表
      visible2: false,       // 选择指令模板的弹窗
      template_form:{
        form:{
          category: undefined,
        }
      },
      tem_categorys: [],    // 指令模板分类列表
      tem_columns,
      tem_data: [],         // 指令模板列表
      radioselectedRow: [], //
      content: "",
    }
  },
  // 计算属性
  computed: {
    hasSelected() {
      return this.selectedRowKeys.length > 0;
    },
  },
  created(){
      this.get_host_category_list()
      this.get_host_list()
      this.get_templates_list();
      this.get_templates_category_list();
  },
  methods:{
    editorInit: function () {
        require('brace/ext/language_tools') //language extension prerequsite...
        require('brace/mode/html')
        require('brace/mode/javascript')    //language
        require('brace/mode/less')
        require('brace/theme/chrome')
        require('brace/snippets/javascript') //snippet
    },
    showModal(){
      this.visible = true;
    },
    // 选中主机时触发的，selectedRowKeys被选中的主机id列表
    onSelectChange(selectedRowKeys) {
      this.selectedRowKeys = selectedRowKeys;
    },
    handleOk(){
      this.data.forEach((v, k) => {
        if (this.selectedRowKeys.includes(v.id)) { // 判断某元素是否在数组中用includes比较合适，不能用in
          this.show_host_info.push({
            id: v.id,
            name: v.name,
            ip_addr: v.ip_addr,
            port: v.port,
          })
          this.selected_host_ids.push(v.id);
        }
      })
      // 关闭弹窗
      this.visible = false;
    },
    get_host_category_list() {
      // 获取主机类别
      let token = sessionStorage.token || localStorage.token;
      this.$axios.get(`${this.$settings.host}/host/category`,{
        headers:{
          Authorization: "jwt " + token,
        }
      }).then((response) => {
          this.categorys = response.data;
      })
    },
    get_host_list(category=null){
      // 获取主机列表
      let params = {}
      if(category !== null){
        params.category = category
      }
      let token = sessionStorage.token || localStorage.token;
      this.$axios.get(`${this.$settings.host}/host/host`,{
        params: params,
        headers:{
          Authorization: "jwt " + token,
        }
      }).then((response) => {
          this.data = response.data;
      })
    },
    has_change_category(category){
      // 切换主机分类时，重新获取主机列表
      this.get_host_list(category)
    },
    refresh_data(){
      // 刷新数据
      this.host_form.form.category = undefined
      this.get_host_list();
    },
    close_host(info_index){
      // 移除已经勾选的主机信息
      this.show_host_info.splice(info_index,1);
      let ids_list = this.selected_host_ids.splice(info_index,1);
      let id_index = this.selectedRowKeys.indexOf(ids_list[0]);
      this.selectedRowKeys.splice(id_index,1);
    },
    execute_cmd(){
      let token = sessionStorage.token || localStorage.token;
      this.$axios.post(`${this.$settings.host}/mtask/cmd_exec`,{
          host_ids: this.selected_host_ids,
          cmd: this.content,
        },{
          headers:{
            Authorization: "jwt "+token
          }
        }).then((res) => {
          console.log(res);
        })
    },
    showModal2(){
      this.visible2 = true;
    },
    handleOk2(e) {
      let tid = this.radioselectedRow[0]; //选中的模板id值
        // 通过模板id值，找到该模板记录中的cmd值，并赋值给content属性
        this.tem_data.forEach((v, k) => {
        if (v.id === tid) {
          this.content = v.cmd;
        }
      })
      this.visible2 = false;
    },
    onSelectChange2(radioselectedRow) {
        // [6, 7, 8, 9]
        console.log('>>>>> ', radioselectedRow);
        this.radioselectedRow = radioselectedRow;
    },
    handleSelectChange2(value) {
      // 切换模板分类
      this.get_templates_list(value)
    },
    refresh_data2() {
      this.get_templates_list();
    },
    get_templates_list(category = null) {
      let token = sessionStorage.token || localStorage.token;
      let params = {}
      if(category !== null){
        params.category = category
      }
      this.$axios.get(`${this.$settings.host}/mtask/templates`,{
        params:params,
        headers:{
          Authorization: "jwt " + token
        }
      }).then(response => {
          this.tem_data = response.data;
      })
    },
    get_templates_category_list() {
      let token = sessionStorage.token || localStorage.token;
      this.$axios.get(`${this.$settings.host}/mtask/templates/categorys`,{
        headers:{
          Authorization: "jwt " + token
        }
      })
        .then(response => {
          this.tem_categorys = response.data;
        })
    }
  },
  components: {
    editor: require('vue2-ace-editor'),
  },
}
</script>
```

