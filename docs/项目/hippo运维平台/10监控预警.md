## 监控和报警

基于echarts图表结合我们之前使用的websocket来完成。

效果：

![image-20210312194813533](9%E7%9B%91%E6%8E%A7%E9%A2%84%E8%AD%A6.assets/image-20210312194813533.png)

客户端，`Monitor.vue`，代码：

```vue
<template>
  <div class="monitor">
    <div ref="container" style="height: 300px;"></div>
  </div>
</template>

<script>
export default {
  name: "Monitor",
  data(){
    return {
      host: 2,
      cpu_echart: null,
      cpu_data: [],
    }
  },
  mounted(){
    this.init_cpu_echart();
    setInterval(()=>{
        this.get_cpu_data();
    }, 1000);
  },
  methods:{
    init_cpu_echart(){
      this.cpu_echart = this.$echarts.init(this.$refs.container);
      var option = {
          title: {
              text: 'CPU使用率'
          },
          tooltip: {
              trigger: 'axis',
              formatter: function (params) {
                  params = params[0];
                  return params.value[0] + ' : ' + params.value[1];
              },
              axisPointer: {
                  animation: true
              }
          },
          xAxis: {
              type: 'time',
              splitLine: {
                  show: true
              }
          },
          yAxis: {
              type: 'value',
              boundaryGap: [0, '100%'],
              splitLine: {
                  show: true
              }
          },
          series: [{
              name: '数据',
              type: 'line',
              showSymbol: true,
              hoverAnimation: true,
              data: this.cpu_data
          }]
      };

      if (option && typeof option === 'object') {
          this.cpu_echart.setOption(option);
      }
    },
    get_cpu_data(){
        this.$axios.get(`${this.$settings.host}/monitor/cpu/`,{
          params: {host: this.host},
        }).then((res)=>{
          let row = res.data;
          for (var i = 0; i < 5; i++) {
              this.cpu_data.shift();
              this.cpu_data.push(row);
          }
          this.cpu_echart.setOption({
              series: [{
                  data: this.cpu_data
              }]
          });
        }).catch((error)=>{

        })
    }
  }
}
</script>

<style scoped>

</style>

```

Base.vue中补充地址，代码：

```vue
{id: 7,icon:'mail', title: '监控', tube: '', 'menu_url': '/hippo/monitor', children: []},
```

路由，代码：

```javascript
import Monitor from '@/components/Monitor'

const router = new Router({
  mode: "history",
  routes: [
    //....
    {
      path: '/hippo',
      name: 'Base',
      component: Base,
      children: [
        // ....
        {
          path: 'monitor',
          name: 'Monitor',
          component: Monitor,
        },
      ]
    },

  ]
})


```



创建应用

```shell
cd hippo_api/apps
python ../../manage.py startapp monitor
```

settings.py配置应用

```python
INSTALLED_APPS = [
    ...
    'monitor',
]
```

总路由

```python
path('monitor/', include('monitor.urls')),
```



monitor/urls.py

```python
from django.urls import path,re_path
from . import views

urlpatterns = [
    path('data/', views.MonitorView.as_view()),
]
```

### 短信发送

使用容联云第三方进行短信发送

![1615705610571](9%E7%9B%91%E6%8E%A7%E9%A2%84%E8%AD%A6.assets/1615705610571.png)

在登录后的平台上面获取一下信息:[https://www.yuntongxun.com/]

```
ACCOUNT SID：8aaf07086f17620f016f308d0d2c0fa9
AUTH TOKEN : be8d96030fca44ffaf958062e6c658e8
AppID(默认)：8aaf07086f17620f016f308d0d850faf
```



https://www.yuntongxun.com/doc.html

![1615705656076](9%E7%9B%91%E6%8E%A7%E9%A2%84%E8%AD%A6.assets/1615705656076.png)

流程

http://doc.yuntongxun.com/space/5a5098313b8496dd00dcdd7f

![1615705685200](9%E7%9B%91%E6%8E%A7%E9%A2%84%E8%AD%A6.assets/1615705685200.png)



找到sdkdemo进行下载

![1615705698493](9%E7%9B%91%E6%8E%A7%E9%A2%84%E8%AD%A6.assets/1615705698493.png)



文档和sdk下载地址：https://doc.yuntongxun.com/p/5f029ae7a80948a1006e776e

安装短信的sdk，python模块

```bash
pip install ronglian_sms_sdk
pip install -U django-redis
```

视图代码：

```python
from django.shortcuts import render
from rest_framework.viewsets import ViewSet
from rest_framework.response import Response
from django.utils import timezone as datetime
from host.models import Host
from django.conf import settings
from hippo_api.utils.key import AppSetting
from ronglian_sms_sdk import SmsSDK
from django_redis import get_redis_connection

class MonitorViewSet(ViewSet):
    def cpu(self,request):
        # 根据当前host_id获取主机地址
        host_id = request.query_params.get("host")
        try:
            host = Host.objects.get(pk=host_id)
        except Host.DoesNotExist:
            return Response({"errmsg": "主机错误！"})

        private_key,_ = AppSetting.get(settings.DEFAULT_KEY_NAME)
        cli = host.get_ssh(private_key)
        code,result = cli.exec_command("iostat -c")
        if code == 0:
            value = result.split("\n")[-5].split()[0]
        else:
            print("远程无法查询！")
            return Response({"errmsg": "主机错误！"})

        now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        # 从数据库中查找出预警通知的管理员手机号，多个使用英文逗号拼接成字符串
        mobile = "13928835901"
        redis = get_redis_connection("monitor")
        if float(value)>90:
            """一级预警"""
            has_time = redis.ttl(f"1NF_{mobile}")
            if has_time < 0:
                self.sms("13928835901", host.ip_addr, value)
                redis.setex(f"1NF_{mobile}", settings.NF1, "90%")
        elif float(value)>75:
            """二级预警"""
            has_time = redis.ttl(f"2NF_{mobile}")
            if has_time < 0:
                self.sms("13928835901", host.ip_addr, value)
                redis.setex(f"2NF_{mobile}", settings.NF2, "75%")
        elif float(value)>65:
            """三级预警"""
            has_time = redis.ttl(f"3NF_{mobile}")
            if has_time < 0:
                self.sms("13928835901", host.ip_addr, value)
                redis.setex(f"3NF_{mobile}", settings.NF3, "65%")

        return Response({
            "name": now,
            "value": [now, float(value)]
        })

    def sms(self, mobile,host_ip, cpu_num):

        sdk = SmsSDK(settings.ACCID, settings.ACCTOKEN, settings.APPID)
        tid = settings.TEMID
        # 短信一定要基于redis实现冷却控制 expire设置一个键 控制手机号接受短信的间隔时间
        # 1NF_13928835901 90%   600
        # 2NF_13928835901 75%   3600
        # 3NF_13928835901 65%   18000

        datas = (host_ip, cpu_num)
        resp = sdk.sendMessage(tid, mobile, datas)
        print(resp)
        """
        from monitor.views import sms
        sms("13928835901")
        """

```

settings.dev，代码：

```python
# 短信发送配置
ACCID = '8a216da863f8e6c20164139687e80c1b'
ACCTOKEN = '6dd01b2b60104b3dbc88b2b74158bac6'
APPID = '8a216da863f8e6c20164139688400c21'
TEMID = 1


# 预警间隔时间
NF_1 = 600
NF_2 = 3600
NF_3 = 86400
```

