

## 代码发布功能

流程图

![image-20210106153814329](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210106153814329.png)

一般都是结合码云和gitlab、github来完成目标集群服务器的代码发布、历史版本保留、版本回滚、发布前置和后置任务配置和执行等操作，不需要借助jenkins。

效果图：

第一步：创建应用

![image-20210119141646641](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210119141646641.png)

![image-20210119141754024](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210119141754024.png)

第二步，新建发布

![image-20210119141825259](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210119141825259.png)

第三步： 点击常规发布

基础配置

![image-20210119141846952](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210119141846952.png)



发布主机

![image-20210119141921697](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210119141921697.png)



任务配置

![image-20210119141947529](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210119141947529.png)



### 配置管理之环境管理

由于我们进行代码发布的时候，需要选择环境(测试环境、线上环境等等)，来区分我们本次将代码发布到什么环境的主机。

![image-20210120142752339](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210120142752339.png)



所以我们先完成左侧菜单栏中环境管理

![image-20210120142832689](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210120142832689.png)



#### 后端实现

创建应用

```python
cd hippo_api/apps
python ../../manage.py startapp conf_center
```

配置应用，`settings.dev`，代码：

```python
INSTALLED_APPS = [
		...,
    'conf_center',
]
```

创建子应用路由文件，`conf_center.urls`，代码：

```python
from django.urls import path
from . import views

urlpatterns = [
    # path('cmd_exec', views.CmdExecView.as_view()),
]
```

总路由，`hippo_api.urls`，代码：

```python
from django.contrib import admin
from django.urls import path,include

urlpatterns = [
    path('admin/', admin.site.urls),
    path("", include("home.urls")),
    path("users/", include("users.urls")),
    path('host/', include('host.urls')),
    path('mtask/', include('mtask.urls')),
    path('conf_center/', include('conf_center.urls')),
]
```



创建环境模型类

Conf_center/models.py

```python
from hippo_api.utils.models import BaseModel,models
# Create your models here.
class Environment(BaseModel):
    tag = models.CharField(max_length=32,verbose_name='标识符')
    class Meta:
        db_table = "hp_environment"  # Ctrl+Shift+U 把选中的内容进行大小写切换
        verbose_name = "环境配置"
        verbose_name_plural = verbose_name
```

终端下在项目根目录下执行数据迁移。

```sql
python manage.py makemigrations
python manage.py migrate
```

在mysql中，执行SQL语句， 添加测试数据。

```sql
INSERT INTO hippo.hp_environment (id, name, is_show, orders, is_delete, created_time, updated_time, description, tag) VALUES (1, '测试环境', 1, 1, 0, '2021-08-08 00:43:09', '2021-08-08 00:43:09', null, 'dev');
INSERT INTO hippo.hp_environment (id, name, is_show, orders, is_delete, created_time, updated_time, description, tag) VALUES (2, '运营环境', 1, 1, 0, '2021-08-08 00:43:09', '2021-08-08 00:43:09', null, 'prod');
```

拓展host子应用的主机模型的字段，添加上主机和环境的关系

host/models.py

```python
from conf_center.models import Environment
class Host(BaseModel):
    # 真正在数据库中的字段实际上叫 category_id，而category则代表了关联的哪个分类模型对象
    category = models.ForeignKey('HostCategory', on_delete=models.DO_NOTHING, verbose_name='主机类别', related_name='hc', null=True, blank=True)
    ip_addr = models.CharField(blank=True, null=True, max_length=255, verbose_name='连接地址')
    port = models.IntegerField(verbose_name='端口')
    # pkey = models.TextField(null=True, blank=True, default="", verbose_name="独立公私钥, PKeyModel的name值")
    username = models.CharField(max_length=50, verbose_name='登录用户')
    users = models.ManyToManyField(User)
    environment = models.ForeignKey(Environment, on_delete=models.DO_NOTHING, default=1, verbose_name='从属环境')

    class Meta:
        db_table = "hp_host"
        verbose_name = "主机信息"
        verbose_name_plural = verbose_name
    def __str__(self):
        return self.name + ':' + self.ip_addr

    def get_ssh(self, pkey=None):
        # 获取ssh连接对象
        # pkey = pkey or self.pkey
        return SSH(self.ip_addr, self.port, self.username, pkey)
```

执行数据库同步指令

```python
python manage.py makemigrations
python manage.py migrate
```

conf_center.urls，路由代码：

```python
from django.urls import path, re_path
from conf_center import views

urlpatterns = [
    path('environments/', views.EnvironmentView.as_view({'post': 'create', 'get': 'list'})),

]
```

conf_center.views，视图代码：

```python
from rest_framework.generics import CreateAPIView,ListAPIView
from rest_framework.permissions import IsAuthenticated
from .models import Environment
from .serializers import EnvironmentModelSerializer
# Create your views here.
class EnvironmentAPIView(ListAPIView, CreateAPIView):
    permission_classes = [IsAuthenticated]
    queryset = Environment.objects.all()
    serializer_class = EnvironmentModelSerializer
```

conf_center.serializers，序列化器代码：

```python
from rest_framework import serializers
from .models import Environment
class EnvironmentModelSerializer(serializers.ModelSerializer):
    class Meta:
        model = Environment
        fields = ["id","name","tag","description"]
        # fields = "__all__"
```



#### 前端实现

src/components/Environment.vue

```html
<template>

  <div class="release">
    <div class="search">
      <a-row>
        <a-col :span="8">
          <a-form-item :label-col="formItemLayout.labelCol" :wrapper-col="formItemLayout.wrapperCol" label="环境名称：">
            <a-input placeholder="请输入"/>
          </a-form-item>
        </a-col>

        <a-col :span="8">
          <router-link to="/release">
            <a-button type="primary" icon="sync" style="margin-top: 3px;">刷新</a-button>
          </router-link>
        </a-col>
      </a-row>
    </div>
    <div>
      <a-button type="primary" @click="showModal"><a-icon type="plus"/>新建</a-button>
    </div>
    <div class="app_list">
      <a-table :columns="columns" :data-source="data" rowKey="id">
        <a slot="action" slot-scope="text" href="javascript:;">
          <router-link to="/">编辑</router-link>
          <span style="color: lightgray"> | </span>
          <router-link to="/">删除</router-link>
        </a>
      </a-table>
    </div>
    <div>
      <a-modal width="720px" v-model="visible" title="新建环境" @ok="handleOk">
        <a-form :form="form" :label-col="{ span: 5 }" :wrapper-col="{ span: 12 }" @submit="handleSubmit">
          <a-form-item label="环境名称">
            <a-input v-decorator="['name', { rules: [{ required: true, message: '请输入环境名称' }] }]"/>
          </a-form-item>
          <a-form-item label="唯一标识符">
            <a-input v-decorator="['tag', { rules: [{ required: true, message: '请输入唯一标识符' }] }]"/>
          </a-form-item>
          <a-form-item label="备注信息">
            <a-input type="textarea"/>
          </a-form-item>
        </a-form>
      </a-modal>
    </div>
  </div>
</template>
<script>

  const columns = [
    {title: '序号', dataIndex: 'id', key: 'id'},
    {title: '环境名称', dataIndex: 'name', key: 'name'},
    {title: '标识符', dataIndex: 'tag', key: 'tag'},
    {title: '描述信息', dataIndex: 'description', key: 'description'},
    {title: '操作', dataIndex: '', key: 'x', scopedSlots: {customRender: 'action'}},
  ];
  const formItemLayout = {
    labelCol: {span: 8},
    wrapperCol: {span: 12},
  };

  export default {
    name: "Release",
    data() {
      return {
        name:'',
        tag:'',
        desc:'',
        formLayout: 'horizontal',
        form: this.$form.createForm(this, { name: 'coordinated' }),
        formItemLayout,
        columns,
        data:[],
        visible: false,
        visible1: false,
        current: 0,
        steps: [
          {
            title: 'First',
            content: '基本配置',
          },
          {
            title: 'Second',
            content: '发布主机',
          },
          {
            title: 'Last',
            content: '任务配置',
          },
        ],
      }
    },
    created() {
      this.get_envrionments_data();
    },
    methods: {
      get_envrionments_data(){
        let token = sessionStorage.token || localStorage.token;
        this.$axios.get(`${this.$settings.host}/conf_center/environment`,{
          headers:{
            Authorization: "jwt " + token,
          }
        })
        .then((res)=>{
          this.data = res.data;
        }).catch((error)=>{

        })
      },
      handleSubmit(e) {
        e.preventDefault();
          this.form.validateFields((err, values) => {
            if (!err) {
              let token = sessionStorage.token || localStorage.token;
              console.log('Received values of form: ', values);
              this.$axios.post(`${this.$settings.host}/conf_center/environment`,values,{
                headers:{
                  Authorization: "jwt " + token,
                }
              })
              .then((res)=>{
                this.$message.success('添加成功！')
                // console.log(res.data);
                this.data.push(res.data);
              }).catch((error)=>{

              })
              this.visible = false;

            }
          });
      },

      next() {
        this.current++;
      },

      prev() {
        this.current--;
      },

      showModal() {
        this.visible = true;
      },

      handleOk(e) {
        // console.log(e);
        this.handleSubmit(e);
      },
    },
  }
</script>
<style scoped>
  .xx_title:after {
    border: none;
  }
</style>
```

### 代码发布

#### 添加应用和展示应用

release组件加载的时候需要用到环境信息、主机信息、和应用信息，以及添加应用，所以我们先把这几个简单的接口实现，并且注意一点，选择完环境之后，后续可以选择的主机应该是从属于该环境的主机，所以我们在切换选择环境的时候，进行主机信息的请求和筛选。

对主机列表的获取进行拓展

host/views.py，视图代码：

```python
class HostModelViewSet(ModelViewSet):
    # queryset = Host.objects.filter(category_id=3)
    serializer_class = HostModelSerializers
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        category_id = self.request.query_params.get("category", None)
        environment_id = self.request.query_params.get("env", None)
        queryset = Host.objects
        # 有分类的查询参数，则按分类来查询
        if category_id is not None:
            queryset = queryset.filter(category_id=category_id)
	   #  有环境的查询参数，则按环境来查询
        if environment_id is not None:
            queryset = queryset.filter(environment_id=environment_id)
        return queryset.all()
```

根据不同环境获取对应主机信息，这个api接口还是使用原来的主机列表的url地址。

```
http://api.hippo.cn:8000/host/host/                 # 表示查询全部的主机列表
http://api.hippo.cn:8000/host/host/?category=2      # 表示查询分类id为2的所有主机列表
http://api.hippo.cn:8000/host/host/?env=2           # 表示查询环境id为2的所有主机列表
```



##### 后端实现

创建代码发布功能的应用

```python
cd hippo_api/apps
python ../../manage.py startapp release
```

配置应用

```python
INSTALLED_APPS = [
		...,
    'release',
]
```

创建子应用release的路由文件，`release.urls`，代码：

```python
from django.urls import path
from . import views

urlpatterns = [
]
```

总路由，`hippo_api.urls`，代码：

```python
from django.contrib import admin
from django.urls import path,include

urlpatterns = [
    # ...省略
    path('release/', include('release.urls')),
]
```

创建应用模型类

release/models.py

```python
from hippo_api.utils.models import BaseModel,models
from users.models import User

# 发布应用表
class ReleaseApp(BaseModel):
    tag = models.CharField(max_length=32, unique=True, verbose_name='应用唯一标识号')
    user = models.ForeignKey(User, on_delete=models.CASCADE,verbose_name='用户')
    class Meta:
        db_table = "hp_release_app"
        verbose_name = "应用管理"
        verbose_name_plural = verbose_name
```

数据迁移，项目根目录下，执行

```bash
python manage.py makemigrations
python manage.py migrate
```



release.urls，路由，代码：

```python
from django.urls import path
from . import views

urlpatterns = [
    path('app', views.ReleaseAPIView.as_view()),
]
```

release.views，视图，代码：

```python
from rest_framework.generics import ListAPIView,CreateAPIView
from .models import ReleaseApp
from .serializers import ReleaseAppModelSerializer

class ReleaseAPIView(ListAPIView,CreateAPIView):
    queryset = ReleaseApp.objects.all()
    serializer_class = ReleaseAppModelSerializer
```

release.serailizers，代码：

```python
from rest_framework import serializers
from .models import ReleaseApp
class ReleaseAppModelSerializer(serializers.ModelSerializer):
    class Meta:
        model = ReleaseApp
        fields = ["id","name","tag","description"]
```

mysql执行SQL语句，添加测试数据。

```sql
INSERT INTO hippo.hp_release_app (id, name, is_show, orders, is_delete, created_time, updated_time, description, tag, user_id) VALUES (1, '购物车', 1, 1, 0, '2021-08-08 01:50:04', '2021-08-08 01:50:04', null, 'cart', 1);
INSERT INTO hippo.hp_release_app (id, name, is_show, orders, is_delete, created_time, updated_time, description, tag, user_id) VALUES (2, '支付模块', 1, 1, 0, '2021-08-08 01:50:04', '2021-08-08 01:50:04', null, 'pay', 1);
INSERT INTO hippo.hp_release_app (id, name, is_show, orders, is_delete, created_time, updated_time, description, tag, user_id) VALUES (3, '商品模块', 1, 1, 0, '2021-08-08 01:50:04', '2021-08-08 01:50:04', null, 'goods', 1);
```

客户端新建发布组件，`src/components/Release.vue`，代码：

```vue
<template>
  <div class="release">
    <div class="search">
      <a-row>
        <a-col :span="8">
          <a-form-item
            :label-col="formItemLayout.labelCol"
            :wrapper-col="formItemLayout.wrapperCol"
            label="应用名称："
          >
            <a-input
              placeholder="请输入"
            />
          </a-form-item>
        </a-col>
        <a-col :span="8">
          <a-form-item
            :label-col="formItemLayout.labelCol"
            :wrapper-col="formItemLayout.wrapperCol"
            label="描述信息："
          >
            <a-input
              v-decorator="[
          'nickname',
          { rules: [{ required: true, message: 'Please input your nickname' }] },
        ]"
              placeholder="请输入"
            />
          </a-form-item>
        </a-col>
        <a-col :span="8">
          <router-link to="/release">
            <a-button type="primary" icon="sync" style="margin-top: 3px;">
              刷新
            </a-button>
          </router-link>
        </a-col>
      </a-row>
    </div>
    <div class="add_app">
      <a-button @click="showaddModal" icon="plus">新建应用</a-button>
      <a-modal v-model="addmodelvisible" title="新建应用" @ok="handleaddappOk">
        <a-form-model ref="addappruleForm" :model="app_form" :rules="add_app_rules" :label-col="labelCol" :wrapper-col="wrapperCol">
          <a-form-model-item ref="app_name" label="应用名称" prop="app_name">
            <a-input v-model="app_form.app_name" @blur=" () => { $refs.app_name.onFieldBlur(); }"/>
          </a-form-model-item>
          <a-form-model-item ref="tag" label="唯一标识符" prop="tag"><a-input v-model="app_form.tag" @blur=" () => { $refs.tag.onFieldBlur(); }"/>
          </a-form-model-item>
          <a-form-model-item label="备注信息" prop="app_desc">
            <a-input v-model="app_form.desc" type="textarea"/>
          </a-form-model-item>
        </a-form-model>
      </a-modal>
    </div>
    <div class="app_list">
      <a-table :columns="columns" :data-source="app_data" :rowKey="record => record.id">
        <span class="release_btn" slot="action" slot-scope="record">
          <span @click="showModal(record.id)">新建发布</span>
          <span style="color: lightgray"> | </span>
          <span>克隆发布</span>
          <span style="color: lightgray"> | </span>
          <span>编辑</span>
          <span style="color: lightgray"> | </span>
          <span>删除</span>
        </span>
        <p slot="expandedRowRender" slot-scope="record, index, indent, expanded" style="margin: 0">
          {{ record.name }} {{expanded}}
        </p>
      </a-table>

    </div>
  </div>
</template>

<script>
const columns = [
  {title: '应用名称', dataIndex: 'name', key: 'name'},
  {title: '标识符', dataIndex: 'tag', key: 'tag'},
  {title: '描述信息', dataIndex: 'description', key: 'description'},
  {title: '操作', dataIndex: '', key: 'x', scopedSlots: {customRender: 'action'}},
];
const formItemLayout = {
  labelCol: {span: 8},
  wrapperCol: {span: 12},
};
export default {
  name: "Release",
  data(){
    return {
      columns,
      formItemLayout,
      labelCol: {span: 6},
      wrapperCol: {span: 16},
      app_data:[],      // 应用列表
      env_datas:[],     // 发布环境数据
      addmodelvisible: false,   // 是否显示新建发布应用的弹窗
      app_form: {               // 新建发布应用的表单数据
        app_name: '',
        tag: '',
        app_desc: '',
      },
      add_app_rules: {  // 添加发布应用的表单数据验证规则
        app_name: [
          {required: true, message: '请输入应用名称', trigger: 'blur'},
          {min: 1, max: 30, message: '应用名称的长度必须在1~30个字符之间', trigger: 'blur'},
        ],
        tag: [
          {required: true, message: '请输入应用唯一标识符', trigger: 'blur'},
          {min: 1, max: 50, message: '应用名称的长度必须在1~50个字符之间', trigger: 'blur'},
        ],
      },
    }
  },
  created(){
    this.get_release_app_data();
  },
  methods:{
    get_release_app_data(){
      let token = sessionStorage.token || localStorage.token;
      this.$axios.get(`${this.$settings.host}/release/app`,{
        headers: {
          Authorization: "jwt " + token,
        }
      })
      .then(response=>{
        this.app_data = response.data;
      }).catch((error)=>{
        console.log(error.response.data)
      })
    },
    // 添加应用
    showaddModal() {
      this.addmodelvisible = true;
    },
    handleaddappOk(e) {
      this.$refs.addappruleForm.validate(valid => {
        if (valid) {
          let data = {
            name:this.app_form.app_name,
            tag:this.app_form.tag,
            description:this.app_form.desc,
          }
          let token = sessionStorage.token || localStorage.token;
          this.$axios.post(`${this.$settings.host}/release/app`,data,{
            headers: {
              Authorization: "jwt " + token,
            }
          })
          .then((res)=>{
            this.app_data.push(res.data);
            this.$message.success('添加成功');
            this.addmodelvisible = false;
          }).catch((error)=>{

          })
        } else {
          console.log('error submit!!');
          return false;
        }
      });
    },
    showModal(record_id){
      console.log(record_id)
    }
  },
  components: {
    editor: require('vue2-ace-editor')
  },
}
</script>

<style scoped>
.release_btn span{
  color: #1890ff;
  cursor: pointer;
}
</style>
```

路由，代码：

```javascript
// ....代码省略
import Release from '@/components/Release'

const router = new Router({
  mode: "history",
  routes: [
    // ....代码省略
    {
      path: '/hippo',
      name: 'Base',
      component: Base,
      children: [
        // ....代码省略
        {
          path: 'release',
          name: 'Release',
          component: Release,
        }
      ]
    },

  ]
})

// ....代码省略
```



#### 新建发布

我们新建发布的功能是为了保存一条发布记录，在代码发布的另外一个发布申请功能模块中，我们再进行发布申请、审批通过之后在进行真正的发布过程。

任务配置简单说明：

![image-20210120162619569](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210120162619569.png)



##### 后端实现

需要统计和保存用户的发布流程信息，所以我们进行表结构设计

release/models.py

```python
from conf_center.models import Environment
from host.models import Host
class ReleaseRecord(BaseModel):
    msg_type_choices = (
        (0, '关闭'),
        (1, '钉钉'),
        (2, '短信'),
        (3, '邮件'),
    )

    file_filter_choices = (
        (0, '包含'),
        (1, '排除'),

    )

    release_app = models.ForeignKey(ReleaseApp, on_delete=models.CASCADE, related_name='release_appliction', verbose_name='发布从属应用')
    envs = models.ForeignKey(Environment, on_delete=models.CASCADE, related_name='release_envs', verbose_name='发布环境')
    code_git_addr = models.CharField(max_length=128, verbose_name='Git仓库地址,注意我们使用的是ssh地址')
    # 应该加一个项目名称字段，因为我们将来可能要存储多个项目，通过项目名称进行区分和作为将来存放该项目的目录名称
    git_project_name = models.CharField(max_length=128,verbose_name='项目名称/目录名称')
    # 有了项目名称字段，那么保存数据的时候别忘了添加该字段的数据，其实就通过git仓库地址就能分离出名称
    msg_notice_status = models.BooleanField(default=False, verbose_name='发布审核开启')  # 默认是没有开启审核通知的
    msg_type = models.IntegerField(choices=msg_type_choices, default=0, verbose_name='审核通知方式')
    msg_content = models.CharField(max_length=128, verbose_name='审核通知内容')
    target_host_pub_path = models.CharField(max_length=128, verbose_name="远程主机的发布路径")
    target_host_repository_path = models.CharField(max_length=128, verbose_name="远程主机的git仓库地址")
    keep_history_count = models.IntegerField(default=5, verbose_name="远程主机中代码的历史版本数量")
    filefilterway = models.IntegerField(choices=file_filter_choices, verbose_name='文件过滤方式', help_text='默认是包含')
    # 往下的几个数据，都是客户端代码发布的第三步时填写的数据，全部都是通过换行符进行分割取值。
    file_filter_cmd_content = models.TextField(verbose_name='需要过滤的文件或者目录, 通过换行符分隔', null=True, blank=True)
    before_code_check_out_value = models.TextField(verbose_name='代码检出前的执行动作')
    before_release_content = models.TextField(verbose_name='代码发布前的执行动作', null=True, blank=True, help_text='在管理的目标主机执行')
    custom_global_variable = models.TextField(verbose_name='全局变量', null=True, blank=True, help_text='全局变量设置')
    after_code_check_out_value = models.TextField(verbose_name='代码检出后的动作', help_text='在Hippo项目所在服务器执行的', null=True,  blank=True)
    after_release_value = models.TextField(verbose_name='代码发布后执行', help_text='在目标主机执行的', null=True, blank=True)

    class Meta:
        db_table = "hp_release_record"
        verbose_name = "发布记录"
        verbose_name_plural = verbose_name

class ReleaseRecordDetail(BaseModel):
    record = models.ForeignKey(ReleaseRecord, related_name='release_record', on_delete=models.CASCADE, verbose_name='发布记录')
    hosts = models.ForeignKey(Host, on_delete=models.CASCADE, related_name='release_host', verbose_name='发布的主机')

    class Meta:
        db_table = "hp_release_record_detail"
        verbose_name = "发布记录详情"
        verbose_name_plural = verbose_name
```

项目根目录下，进行数据迁移。

```bash
python manage.py makemigrations
python manage.py migrate
```



release.urls，代码：

```python
from django.urls import path
from . import views

urlpatterns = [
    path('app', views.ReleaseAPIView.as_view()),
    path('new', views.NewReleaseAPIView.as_view()),
]
```

release.views，代码：

```python
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from django.db import transaction
from .models import ReleaseRecord,ReleaseRecordDetail
import logging
logger = logging.getLogger("django")

class NewReleaseAPIView(APIView):
    def post(self,request):
        print('新建发布的数据： ', request.data)
        # 按理来讲，应该对数据进行校验，我这里就不做了，直接保存
        # 默认发布状态为待审核
        data = request.data
        # 发布应用的主机列表
        host_ids = data.pop('pub_target_host_choose')

        # 事务，在数据库中，为了保证多条SQL在同一个函数或功能中，要么一起操作成功，要么一起操作失败而提供的。
        # 关于事务在MySQL等关系型数据库中一个比较重要的概念，所以大家去看下 事务的特性：
        # 4个特性(ACID)：原子性，一致性，隔离性和持久性
        # 5个级别：指代的就是项目运行过程中，遇到多个事务一并执行的情况下，事务操作的数据之间的存在的隔离性问题,从低到高：
        # 没有隔离级别
        # 未提交读[read-uncommitted]
        # 不可重复读[read-committed]
        # 已提交读[repeatable-read]
        # 串行化[serializable]

        # 由于有两张表的数据要同时保存，所以我们要开启事务[transaction]
        with transaction.atomic():
            sid = transaction.savepoint() #创建事务回滚点
            try:
                re_record_obj = ReleaseRecord.objects.create(**data)
                for host_id in host_ids:
                    ReleaseRecordDetail.objects.create(
                        record_id=re_record_obj.id,
                        hosts_id=host_id
                    )
            except Exception as e:
                transaction.savepoint_rollback(sid)
                # 记录日志
                error_msg = f'新建发布失败，请联系管理员,错误信息为{str(e)}'
                logger.error(error_msg)
                # 回复错误信息提示客户端
                return Response({'error': error_msg}, status=status.HTTP_507_INSUFFICIENT_STORAGE)

        return Response({'msg': 'ok'})


'''
新建发布的数据：
{
	'release_app_id': 1, 发布从属的应用id
	'envs_id': 1, 发布环境
	'code_git_addr': 'git@gitee.com:s32-private-club/spa.git', git仓库的ssh地址
	'msg_notice_status': True,#消息通知状态是否开启，True表示开启
	'msg_type': 1,#消息通知类型（钉钉、短信等）
	'msg_content': 消息通知内容
	#  'release_status': 1, #发布状态  这个放到发布申请的表中了
	'target_host_pub_path': '/var/www/html', 代码发布到目标主机的路径
	'target_host_repository_path': '/data/hippo/repos', 代码版本管理目录
	'keep_history_count': '10', 代码版本存储个数
	'pub_target_host_choose': [11, 10], 目标主机的id列表
	'filefilterway': 1,  # 文件过滤方式 1表示包含，2表示过滤
	'file_filter_cmd_content': 'readme.txt\nreadme.md', 代码文件过滤的指令
	'before_code_check_out_value': 'mkdir xxx', 代码检出前的执行指令
	'before_release_content': 'mkdir kkk', 代码发布前的执行指令
	'custom_global_variable': "user='root'\npassword='123'", 代码所需的全局变量
	'after_code_check_out_value': 'mkdir ooo', 代码检出后执行的指令
	'after_release_value': 'mkdir vvv' 代码发布后执行的指令
}
'''
```

##### 前端实现

显示选择发布方式的窗口

src/components/Release.vue，代码：

```vue
<template>
  <div class="release">
    <div class="search">
      <a-row>
        <a-col :span="8">
          <a-form-item
            :label-col="formItemLayout.labelCol"
            :wrapper-col="formItemLayout.wrapperCol"
            label="应用名称："
          >
            <a-input
              placeholder="请输入"
            />
          </a-form-item>
        </a-col>
        <a-col :span="8">
          <a-form-item
            :label-col="formItemLayout.labelCol"
            :wrapper-col="formItemLayout.wrapperCol"
            label="描述信息："
          >
            <a-input
              v-decorator="[
          'nickname',
          { rules: [{ required: true, message: 'Please input your nickname' }] },
        ]"
              placeholder="请输入"
            />
          </a-form-item>
        </a-col>
        <a-col :span="8">
          <router-link to="/release">
            <a-button type="primary" icon="sync" style="margin-top: 3px;">
              刷新
            </a-button>
          </router-link>
        </a-col>
      </a-row>
    </div>
    <div class="add_app">
      <a-button @click="showaddModal" icon="plus">新建应用</a-button>
      <a-modal v-model="addmodelvisible" title="新建应用" @ok="handleaddappOk">
        <a-form-model ref="addappruleForm" :model="app_form" :rules="add_app_rules" :label-col="labelCol" :wrapper-col="wrapperCol">
          <a-form-model-item ref="app_name" label="应用名称" prop="app_name">
            <a-input v-model="app_form.app_name" @blur=" () => { $refs.app_name.onFieldBlur(); }"/>
          </a-form-model-item>
          <a-form-model-item ref="tag" label="唯一标识符" prop="tag"><a-input v-model="app_form.tag" @blur=" () => { $refs.tag.onFieldBlur(); }"/>
          </a-form-model-item>
          <a-form-model-item label="备注信息" prop="app_desc">
            <a-input v-model="app_form.desc" type="textarea"/>
          </a-form-model-item>
        </a-form-model>
      </a-modal>
    </div>
    <div class="app_list">
      <a-table :columns="columns" :data-source="app_data" :rowKey="record => record.id">
        <span class="release_btn" slot="action" slot-scope="record">
          <span @click="showModal(record.id)">新建发布</span>
          <span style="color: lightgray"> | </span>
          <span>克隆发布</span>
          <span style="color: lightgray"> | </span>
          <span>编辑</span>
          <span style="color: lightgray"> | </span>
          <span>删除</span>
        </span>
        <p slot="expandedRowRender" slot-scope="record, index, indent, expanded" style="margin: 0">
          {{ record.name }} {{expanded}}
        </p>
      </a-table>
    </div>
    <div class="create_new_release">

      <a-modal width="800px" v-model="visible" title="选择发布方式" @ok="handleOk" :footer="null">
        <div style="background-color: #ececec; padding: 20px;">
          <a-row :gutter="10">
            <a-col :span="10" :offset="1" @click="showModal1">
              <a-card :bordered="false" style="cursor: pointer;">
                <div style="display: flex;">
                  <div style="margin-right: 16px;">
                    <a-icon type="ordered-list" style="font-size: 36px; color: rgb(24, 144, 255);"/>
                  </div>
                  <div>
                    <div style="margin-bottom: 12px;font-weight: 500;font-size: 16px; color: rgba(0,0,0,.85);"><span>常规发布</span></div>
                    <div>由 Hippo 来控制发布的主流程，你可以通过添加钩子脚本来执行额外的自定义操作。</div>
                  </div>
                </div>
              </a-card>
            </a-col>
            <a-col :span="10" :offset="1">
              <a-card :bordered="false" style="cursor: pointer;">
                <div style="display: flex;">
                  <div style="margin-right: 16px;">
                    <a-icon type="build" style="font-size: 36px; color: rgb(24, 144, 255);"/>
                  </div>
                  <div>
                    <div style="margin-bottom: 12px;font-weight: 500;font-size: 16px; color: rgba(0,0,0,.85);"><span>自定义发布</span></div>
                    <div>你可以完全自己定义发布的所有流程和操作，Hippo 负责按顺序依次执行你记录的动作。</div>
                  </div>
                </div>
              </a-card>
            </a-col>
          </a-row>
        </div>
      </a-modal>
    </div>
  </div>
</template>

<script>
const columns = [
  {title: '应用名称', dataIndex: 'name', key: 'name'},
  {title: '标识符', dataIndex: 'tag', key: 'tag'},
  {title: '描述信息', dataIndex: 'description', key: 'description'},
  {title: '操作', dataIndex: '', key: 'x', scopedSlots: {customRender: 'action'}},
];
const formItemLayout = {
  labelCol: {span: 8},
  wrapperCol: {span: 12},
};
export default {
  name: "Release",
  data(){
    return {
      columns,
      formItemLayout,
      labelCol: {span: 6},
      wrapperCol: {span: 16},
      app_data:[],      // 应用列表
      env_datas:[],     // 发布环境数据
      addmodelvisible: false,   // 是否显示新建发布应用的弹窗
      app_form: {               // 新建发布应用的表单数据
        app_name: '',
        tag: '',
        app_desc: '',
      },
      add_app_rules: {  // 添加发布应用的表单数据验证规则
        app_name: [
          {required: true, message: '请输入应用名称', trigger: 'blur'},
          {min: 1, max: 30, message: '应用名称的长度必须在1~30个字符之间', trigger: 'blur'},
        ],
        tag: [
          {required: true, message: '请输入应用唯一标识符', trigger: 'blur'},
          {min: 1, max: 50, message: '应用名称的长度必须在1~50个字符之间', trigger: 'blur'},
        ],
      },
      visible: false, // 显示新建发布弹窗
    }
  },
  created(){
    this.get_release_app_data();
  },
  methods:{
    get_release_app_data(){
      let token = sessionStorage.token || localStorage.token;
      this.$axios.get(`${this.$settings.host}/release/app`,{
        headers: {
          Authorization: "jwt " + token,
        }
      })
      .then(response=>{
        this.app_data = response.data;
      }).catch((error)=>{
        console.log(error.response.data)
      })
    },
    // 添加应用
    showaddModal() {
      this.addmodelvisible = true;
    },
    handleaddappOk(e) {
      this.$refs.addappruleForm.validate(valid => {
        if (valid) {
          let data = {
            name:this.app_form.app_name,
            tag:this.app_form.tag,
            description:this.app_form.desc,
          }
          let token = sessionStorage.token || localStorage.token;
          this.$axios.post(`${this.$settings.host}/release/app`,data,{
            headers: {
              Authorization: "jwt " + token,
            }
          })
          .then((res)=>{
            this.app_data.push(res.data);
            this.$message.success('添加成功');
            this.addmodelvisible = false;
          }).catch((error)=>{

          })
        } else {
          console.log('error submit!!');
          return false;
        }
      });
    },
    showModal(record_id){
      this.release_app_id = record_id;  // 将点击的应用的id保存下来
      this.visible = true;
    },
    handleOk(e) {
      console.log(e);
      this.visible = false;
    },
    showModal1() {

    }
  },
  components: {
    editor: require('vue2-ace-editor')
  },
}
</script>

<style scoped>
.release_btn span{
  color: #1890ff;
  cursor: pointer;
}
</style>
```

编辑发布流程的窗口

src/components/Release.vue，代码：

```html
<template>
  <div class="release">
    <div class="search">
      <a-row>
        <a-col :span="8">
          <a-form-item
            :label-col="formItemLayout.labelCol"
            :wrapper-col="formItemLayout.wrapperCol"
            label="应用名称："
          >
            <a-input
              placeholder="请输入"
            />
          </a-form-item>
        </a-col>
        <a-col :span="8">
          <a-form-item
            :label-col="formItemLayout.labelCol"
            :wrapper-col="formItemLayout.wrapperCol"
            label="描述信息："
          >
            <a-input
              v-decorator="[
          'nickname',
          { rules: [{ required: true, message: 'Please input your nickname' }] },
        ]"
              placeholder="请输入"
            />
          </a-form-item>
        </a-col>
        <a-col :span="8">
          <router-link to="/release">
            <a-button type="primary" icon="sync" style="margin-top: 3px;">
              刷新
            </a-button>
          </router-link>
        </a-col>
      </a-row>
    </div>
    <div class="add_app">
      <a-button @click="showaddModal" icon="plus">新建应用</a-button>
      <a-modal v-model="addmodelvisible" title="新建应用" @ok="handleaddappOk">
        <a-form-model ref="addappruleForm" :model="app_form" :rules="add_app_rules" :label-col="labelCol" :wrapper-col="wrapperCol">
          <a-form-model-item ref="app_name" label="应用名称" prop="app_name">
            <a-input v-model="app_form.app_name" @blur=" () => { $refs.app_name.onFieldBlur(); }"/>
          </a-form-model-item>
          <a-form-model-item ref="tag" label="唯一标识符" prop="tag"><a-input v-model="app_form.tag" @blur=" () => { $refs.tag.onFieldBlur(); }"/>
          </a-form-model-item>
          <a-form-model-item label="备注信息" prop="app_desc">
            <a-input v-model="app_form.desc" type="textarea"/>
          </a-form-model-item>
        </a-form-model>
      </a-modal>
    </div>
    <div class="app_list">
      <a-table :columns="columns" :data-source="app_data" :rowKey="record => record.id">
        <span class="release_btn" slot="action" slot-scope="record">
          <span @click="showModal(record)">新建发布</span>
          <span style="color: lightgray"> | </span>
          <span>克隆发布</span>
          <span style="color: lightgray"> | </span>
          <span>编辑</span>
          <span style="color: lightgray"> | </span>
          <span>删除</span>
        </span>
        <p slot="expandedRowRender" slot-scope="record, index, indent, expanded" style="margin: 0">
          {{ record.name }} {{expanded}}
        </p>
      </a-table>
    </div>
    <div class="create_new_release">

      <a-modal width="800px" v-model="visible" title="选择发布方式" @ok="handleOk" :footer="null">
        <div style="background-color: #ececec; padding: 20px;">
          <a-row :gutter="10">
            <a-col :span="10" :offset="1" @click="showModal1">
              <a-card :bordered="false" style="cursor: pointer;">
                <div style="display: flex;">
                  <div style="margin-right: 16px;">
                    <a-icon type="ordered-list" style="font-size: 36px; color: rgb(24, 144, 255);"/>
                  </div>
                  <div>
                    <div style="margin-bottom: 12px;font-weight: 500;font-size: 16px; color: rgba(0,0,0,.85);"><span>常规发布</span></div>
                    <div>由 Hippo 来控制发布的主流程，你可以通过添加钩子脚本来执行额外的自定义操作。</div>
                  </div>
                </div>
              </a-card>
            </a-col>
            <a-col :span="10" :offset="1">
              <a-card :bordered="false" style="cursor: pointer;">
                <div style="display: flex;">
                  <div style="margin-right: 16px;">
                    <a-icon type="build" style="font-size: 36px; color: rgb(24, 144, 255);"/>
                  </div>
                  <div>
                    <div style="margin-bottom: 12px;font-weight: 500;font-size: 16px; color: rgba(0,0,0,.85);"><span>自定义发布</span></div>
                    <div>你可以完全自己定义发布的所有流程和操作，Hippo 负责按顺序依次执行你记录的动作。</div>
                  </div>
                </div>
              </a-card>
            </a-col>
          </a-row>
        </div>
      </a-modal>
    </div>


    <!--    发布流程对话框 -->
    <div>
      <a-modal width="900px" v-model="visible1" :title="`新建常规发布 - ${release_app_name}`" @ok="handleOk" :footer="null">
        <div>
          <a-steps :current="current">
            <a-step v-for="item in steps" :key="item.title" :title="item.title"/>
          </a-steps>
          <div class="steps-content" style="margin-top: 20px;">
            <a-form-model ref="ruleForm" :model="form" :rules="rules" :label-col="labelCol" :wrapper-col="wrapperCol">
              <div class="basic_config" v-show="current===0">
                <a-form-model-item label="发布环境" prop="envrionment">
                  <a-select v-model="form.envrionment" placeholder="请选择发布环境">
                    <a-select-option :value="env_value.id" v-for="(env_value,env_index) in env_datas" :key="env_index">
                      {{env_value.name}}
                    </a-select-option>
                  </a-select>
                </a-form-model-item>
                <a-form-model-item ref="git_addr" label="Git仓库地址" prop="git_addr">
                  <a-input v-model="form.git_addr" @blur=" () => { $refs.git_addr.onFieldBlur(); }"/>
                </a-form-model-item>
                <a-form-model-item label="发布审核" prop="delivery">
                  <a-switch @change="msg_notice" checked-children="开" un-checked-children="关"/>
                </a-form-model-item>
                <a-form-model-item label="发布审核" prop="delivery">
                  <a-input-group compact>
                    <a-select v-model="form.msg_type" :disabled="!msg_notice_status">
                      <a-select-option value="0">关闭</a-select-option>
                      <a-select-option value="1">钉钉</a-select-option>
                      <a-select-option value="2">短信</a-select-option>
                      <a-select-option value="3">邮件</a-select-option>
                    </a-select>
                    <a-auto-complete :disabled="!msg_notice_status" style="width: auto" @change="handleChange"/>
                  </a-input-group>
                  <span>应用审核及发布成功或失败结果通知</span>
                </a-form-model-item>
              </div>
              <div class="pub_host" v-show="current===1">
                <a-form-model-item ref="target_host_pub_path" label="目标主机部署路径:" prop="target_host_pub_path">
                  <a-input v-model="form.target_host_pub_path" @blur=" () => { $refs.target_host_pub_path.onFieldBlur(); }"/>
                  <span style="color:darkgrey">目标主机的应用根目录，例如：/var/www/html</span>
                </a-form-model-item>
                <a-form-model-item ref="target_host_repository_path" label="目标主机仓库路径" prop="target_host_repository_path">
                  <a-input v-model="form.target_host_repository_path" @blur=" () => { $refs.target_host_repository_path.onFieldBlur(); }"/>
                  <span style="color:darkgrey">此目录用于存储应用的历史版本，例如：/data/hippo/repos</span>
                </a-form-model-item>
                <a-form-model-item ref="keep_history_count" label="保留历史版本数量" prop="keep_history_count">
                  <a-input v-model="form.keep_history_count" @blur=" () => { $refs.keep_history_count.onFieldBlur(); }"/>
                  <span style="color:darkgrey">早于指定数量的历史版本会被删除，以释放空间</span>
                </a-form-model-item>
                <a-form-model-item label="发布目标主机选择" prop="pub_target_host_choose">
                  <a-select @change="handleselectChange" mode="multiple" v-model="form.pub_target_host_choose" placeholder="please select your zone">
                    <a-select-option :value="host_value.id" v-for="(host_value,host_index) in hosts_data" :key="host_index">
                      {{host_value.name}}:{{host_value.ip_addr}}
                    </a-select-option>
                  </a-select>
                </a-form-model-item>
              </div>
              <div class="task_config" v-show="current===2">
                <a-row>
                  <a-col :span="11">
                    <div class="file_filter" style="margin-bottom: 20px;">
                      <div class="file_filter_head">
                        <span>文件过滤：</span>
                        <span>
                          <a-radio-group v-model="filefilterway" @change="filterfilteronChange">
                          <a-radio :value="1">
                            包含
                            <a-tooltip>
                              <template slot="title">仅将匹配文件放到目标主机</template>
                              <a-icon type="info-circle"/>
                            </a-tooltip>
                          </a-radio>
                          <a-radio :value="2">
                            排除
                            <a-tooltip>
                              <template slot="title">匹配文件将不会放到目标主机</template>
                              <a-icon type="info-circle"/>
                            </a-tooltip>
                          </a-radio>
                        </a-radio-group>
                        </span>
                      </div>
                      <div>
                        <editor v-model="file_filter_cmd_content" @init="editorInit" lang="html" theme="chrome" width="100%" height="100"></editor>
                      </div>
                    </div>
                    <div class="before_code_check_out" style="margin-bottom: 20px;">
                      <div class="before_code_check_out_head">
                        <span>代码检出前执行：</span>
                        <span>
                          <a-tooltip>
                              <template slot="title">在部署了hippo项目的服务器上执行，拉去代码之前可以执行任意指令</template>
                              <a-icon type="info-circle"/>
                            </a-tooltip>
                        </span>
                      </div>
                      <div>
                        <editor v-model="before_code_check_out_value" @init="editorInit" lang="html" theme="chrome" width="100%" height="100"></editor>
                      </div>
                    </div>
                    <div class="before_release" style="margin-bottom: 20px;">
                      <div class="before_release_head">
                        <span>应用发布前执行：</span>
                        <span>
                          <a-tooltip>
                            <template slot="title">在发布的目标主机上运行，当前目录为目标主机上待发布的源代码目录，可执行任意自定义命令。</template>
                            <a-icon type="info-circle"/>
                          </a-tooltip>
                        </span>
                      </div>
                      <div>
                        <editor v-model="before_release_content" @init="editorInit" lang="html" theme="chrome" width="100%" height="100"></editor>
                      </div>
                    </div>
                  </a-col>
                  <a-col :span="2">
                    <div style="margin-top: 37px;vertical-align: center;text-align: center;height: 100px;">
                      <a-icon style="font-size: 32px" type="setting"/><br><span>基础设置</span>
                    </div>
                    <div style="margin-top: 37px;vertical-align: center;text-align: center;height: 100px;">
                      <a-icon style="font-size: 32px" type="gitlab"/><br><span>代码检出</span>
                    </div>
                    <div style="margin-top: 37px;vertical-align: center;text-align: center;height: 100px;">
                      <a-icon style="font-size: 32px" type="swap"/><br><span>版本切换</span>
                    </div>
                  </a-col>
                  <a-col :span="11">
                    <div class="custom_global_variable" style="margin-bottom: 20px;">
                      <div class="custom_global_variable_head">
                        <span>自定义全局变量:</span>
                        <span>
                          <a-tooltip>
                              <template slot="title">hippo 内置了一些全局变量，这些变量可以直接使用，请参考官方文档：<a href="#">全局变量</a></template>
                              <a-icon type="info-circle"/>
                            </a-tooltip>
                        </span>
                      </div>
                      <div>
                        <editor v-model="custom_global_variable" @init="editorInit" lang="html" theme="chrome" width="100%" height="100"></editor>
                      </div>
                    </div>
                    <div class="after_code_check_out" style="margin-bottom: 20px;">
                      <div class="after_code_check_out_head">
                        <span>代码检出后执行:</span>
                        <span>
                          <a-tooltip>
                            <template slot="title">在部署 Hippo 的服务器上运行，当前目录为检出后待发布的源代码目录，可执行任意自定义命令。</template>
                            <a-icon type="info-circle"/>
                          </a-tooltip>
                        </span>
                      </div>
                      <div>
                        <editor v-model="after_code_check_out_value" @init="editorInit" lang="html" theme="chrome" width="100%" height="100"></editor>
                      </div>
                    </div>
                    <div class="after_release" style="margin-bottom: 20px;">
                      <div class="after_release_head">
                        <span>应用发布后执行：</span>
                        <span>
                          <a-tooltip>
                            <template slot="title">在发布的目标主机上运行，当前目录为已发布的应用目录，可执行任意自定义命令。</template>
                            <a-icon type="info-circle"/>
                          </a-tooltip>
                        </span>
                      </div>
                      <div>
                        <editor v-model="after_release_value" @init="editorInit" lang="html" theme="chrome" width="100%" height="100"></editor>
                      </div>
                    </div>
                  </a-col>
                </a-row>
              </div>
              <div class="steps-action">
                <a-button :disabled="next_status_control()" v-if="current < steps.length - 1" type="primary" @click="next">下一步</a-button>
                <a-button v-if="current == steps.length - 1" type="primary" @click="onSubmit">提交</a-button>
                <a-button v-if="current > 0" style="margin-left: 8px" @click="prev">上一步</a-button>
              </div>
            </a-form-model>
          </div>
        </div>
      </a-modal>
    </div>
  </div>
</template>

<script>
const columns = [
  {title: '应用名称', dataIndex: 'name', key: 'name'},
  {title: '标识符', dataIndex: 'tag', key: 'tag'},
  {title: '描述信息', dataIndex: 'description', key: 'description'},
  {title: '操作', dataIndex: '', key: 'x', scopedSlots: {customRender: 'action'}},
];
const formItemLayout = {
  labelCol: {span: 8},
  wrapperCol: {span: 12},
};
export default {
  name: "Release",
  data(){
    return {
      columns,
      formItemLayout,
      labelCol: {span: 6},
      wrapperCol: {span: 16},
      app_data:[],      // 应用列表
      env_datas:[],     // 发布环境数据
      addmodelvisible: false,   // 是否显示新建发布应用的弹窗
      app_form: {               // 新建发布应用的表单数据
        app_name: '',
        tag: '',
        app_desc: '',
      },
      add_app_rules: {  // 添加发布应用的表单数据验证规则
        app_name: [
          {required: true, message: '请输入应用名称', trigger: 'blur'},
          {min: 1, max: 30, message: '应用名称的长度必须在1~30个字符之间', trigger: 'blur'},
        ],
        tag: [
          {required: true, message: '请输入应用唯一标识符', trigger: 'blur'},
          {min: 1, max: 50, message: '应用名称的长度必须在1~50个字符之间', trigger: 'blur'},
        ],
      },
      release_app_id: 0,    // 新建发布时从属的应用id
      release_app_name: "", // 新建发布时从属的应用名称
      hosts_data:[],      // 主机数据
      msg_notice_status: false,
      filefilterway: 1,
      file_filter_cmd_content: '',
      before_code_check_out_value: '',
      before_release_content: '',
      custom_global_variable: '',
      after_code_check_out_value: '',
      after_release_value: '',
      visible: false,  // 显示新建发布弹窗
      visible1: false, // 显示发布流程配置弹窗
      current: 0,      // 当前发布流程配置的步骤下标
      steps: [         // 发布流程步骤提示
          {
            title: '基本配置',
            content: '基本配置',
          },
          {
            title: '发布主机',
            content: '发布主机',
          },
          {
            title: '任务配置',
            content: '任务配置',
          },
      ],
      form: { // 新建发布流程的表单数据
          git_addr: '',
          envrionment: undefined,
          msg_type: '0',
          msg_content: '',
          target_host_pub_path: '',
          target_host_repository_path: '',
          keep_history_count: '',
          // pub_target_host_choose:[],
          pub_target_host_choose: undefined,

      },
      rules: {  // 新建发布流程的表单验证规则
          git_addr: [
            {required: true, message: '请输入git地址', trigger: 'blur'},
            {min: 1, max: 64, message: 'Length should be 1 to 64', trigger: 'blur'},
          ],
          target_host_pub_path: [
            {required: true, message: 'Please input Activity name', trigger: 'blur'},
            {min: 3, max: 32, message: 'Length should be 3 to 5', trigger: 'blur'},
          ],
          target_host_repository_path: [
            {required: true, message: 'Please input Activity name', trigger: 'blur'},
            {min: 3, max: 32, message: 'Length should be 3 to 5', trigger: 'blur'},
          ],
          keep_history_count: [
            {required: true, message: 'Please input Activity name', trigger: 'blur'},
            {min: 1, max: 5, message: 'Length should be 3 to 5', trigger: 'blur'},
          ],
          envrionment: [{required: true, message: '请选择环境', trigger: 'change'}],
          pub_target_host_choose: [{required: true, message: '请选择主机', trigger: 'change'}],
        },
    }
  },
  created(){
    this.get_envrionments_data()
    this.get_release_app_data();
  },
  watch:{
    // 切换环境时，触发主机数据的筛选
    'form.envrionment': function(){
      this.get_host_list(this.form.envrionment);
    }
  },
  methods:{
    get_host_list(env) {
      // 获取所选环境对应的主机列表
      let token = sessionStorage.token || localStorage.token;
      this.$axios.get(`${this.$settings.host}/host/host`,{
        params: {
          env: env,
        },
        headers: {
          Authorization: "jwt " + token,
        }
      }).then((res) => {
          this.hosts_data = res.data;
        })

    },
    // 获取所有环境数据
    get_envrionments_data(){
      let token = sessionStorage.token || localStorage.token;
      this.$axios.get(`${this.$settings.host}/conf_center/environment`,{
        headers: {
          Authorization: "jwt " + token,
        }
      })
      .then((res)=>{
        this.env_datas = res.data;
      }).catch((error)=>{

      })
    },
    get_release_app_data(){
      let token = sessionStorage.token || localStorage.token;
      this.$axios.get(`${this.$settings.host}/release/app`,{
        headers: {
          Authorization: "jwt " + token,
        }
      })
      .then(response=>{
        this.app_data = response.data;
      }).catch((error)=>{
        console.log(error.response.data)
      })
    },
    // 添加应用
    showaddModal() {
      this.addmodelvisible = true;
    },
    handleaddappOk(e) {
      this.$refs.addappruleForm.validate(valid => {
        if (valid) {
          let data = {
            name:this.app_form.app_name,
            tag:this.app_form.tag,
            description:this.app_form.desc,
          }
          let token = sessionStorage.token || localStorage.token;
          this.$axios.post(`${this.$settings.host}/release/app`,data,{
            headers: {
              Authorization: "jwt " + token,
            }
          })
          .then((res)=>{
            this.app_data.push(res.data);
            this.$message.success('添加成功');
            this.addmodelvisible = false;
          }).catch((error)=>{

          })
        } else {
          console.log('error submit!!');
          return false;
        }
      });
    },
    showModal(record){
      this.release_app_id = record.id;      // 记录本次发布的应用ID
      this.release_app_name = record.name;  // 记录本次发布的应用名称
      this.visible = true;
    },
    handleOk(e) {
      console.log(e);
      this.visible = false;
    },
    showModal1() {
      this.visible = false;
      this.visible1 = true;
    },
    // 消息通知开启和关闭切换
    msg_notice(value) {
      console.log('>>>>>', value);
      this.msg_notice_status = value;
    },
    // 控制下一步按钮的状态
    next_status_control() {
      if (this.current === 0 && (this.form.git_addr === '' || this.form.envrionment === undefined)) {
        return true
      } else if (this.current === 1 && (this.form.target_host_pub_path === '' || this.form.target_host_repository_path === '' || this.form.keep_history_count === '' || this.form.pub_target_host_choose === undefined)) {
        return true
      }
    },
    handleChange(value) {
      if (!value && this.msg_type !== 0) {
        this.$message.error('不能为空')
      } else {
        this.form.msg_content = value;
      }
    },
    onSubmit() {
      this.$refs.ruleForm.validate(valid => {
        if (valid) {
          let data = {
            release_app_id:this.release_app_id,
            // 基础配置
            envs_id: this.form.envrionment,
            code_git_addr: this.form.git_addr,
            msg_notice_status: this.msg_notice_status,
            msg_type: parseInt(this.form.msg_type),
            msg_content: this.form.msg_content,

            // 发布主机
            target_host_pub_path: this.form.target_host_pub_path,
            target_host_repository_path: this.form.target_host_repository_path,
            keep_history_count: this.form.keep_history_count,
            pub_target_host_choose: this.form.pub_target_host_choose,

            // 任务配置
            filefilterway:this.filefilterway, // 文件过滤方式 1表示包含 2表示过滤
            file_filter_cmd_content: this.file_filter_cmd_content,
            before_code_check_out_value: this.before_code_check_out_value,
            before_release_content: this.before_release_content,
            custom_global_variable: this.custom_global_variable,
            after_code_check_out_value: this.after_code_check_out_value,
            after_release_value: this.after_release_value,

          }
          console.log(data);
          this.$axios.post(`${this.$settings.host}/release/new`,data).then((res)=>{
            this.visible1 = false;
            this.$message.success('新建发布成功！');
          }).catch((error)=>{
            this.$message.error(`新建发布失败！原因：${error.response.data}`);
          })
        } else {
          console.log('error submit!!');
          return false;
        }
      });
    },
    editorInit: function () {
      require('brace/ext/language_tools') //language extension prerequsite...
      require('brace/mode/html')
      require('brace/mode/javascript')    //language
      require('brace/mode/less')
      require('brace/theme/chrome')
      require('brace/snippets/javascript') //snippet
    },
    filterfilteronChange(e) {
      console.log('radio checked', e.target.value);
    },

    handleselectChange(pub_target_host_choose) {
      this.pub_target_host_choose = pub_target_host_choose;
    },
    next() {
      this.current++;
    },
    prev() {
      this.current--;
    },

  },
  components: {
    editor: require('vue2-ace-editor')
  },
}
</script>

<style scoped>
.release_btn span{
  color: #1890ff;
  cursor: pointer;
}
</style>
```



#### 发布申请功能

效果：

![image-20210120195125623](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210120195125623.png)



点击新建发布按钮效果

![image-20210120195311965](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210120195311965.png)



点击其中某一个，比如点击订单服务

![image-20210120195338300](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210120195338300.png)



点击确定

![image-20210120195446677](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210120195446677.png)



待审核的发布，操作应该是有个审核按钮，点击审核

![image-20210120195718743](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210120195718743.png)



点击通过，待审核的发布就变为待发布的任务

待发布的列表中，每一项应该有个发布按钮，点击发布按钮，来到发布页面，点击右上角的发布按钮，才进行真正的部署流程的执行，执行的每个阶段我们都需要捕获是否存在问题，如果存在问题，将某个主机的某个阶段的错误都展示出来

![image-20210120200041270](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210120200041270.png)



发布成功之后，我们可以点击返回按钮，回到发布申请的列表出，我们的发布就尽到了发布成功的列表中

![image-20210120200218226](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210120200218226.png)



可以点击回滚，点击回滚我们弹出一个对话框，列出目前所有保存的版本，让用户可以自行选择回滚到哪一个版本，选择对应版本后，继续进入到待审核状态，然后按照一步一步的流程进行该版本的发布。



##### 前期准备

完成这个功能，我们需要的准备工作挺多的，首先说明一点，代码发布流程有很多的方案，目前我采用的方案没有迭代发布和灰度发布等，目前只是简单粗暴的将代码推送到目标主机，部署然后重启服务，后面我们再陆续的将多个方案更新进来，但是这个简单粗暴的方案肯定也能给你提供一定的开发思路。

我们先准备两个虚拟机作为我们的目标主机。

我给大家准备了两个东西

​	第一个：装好开发环境的虚拟机(通过vmware打开即可，但是要求vmware要在14及以上版本)：

```python
链接：https://pan.baidu.com/s/1_trF2CGBNNQxtC2IkX1YJA
提取码：22s7
复制这段内容后打开百度网盘手机App，操作更方便哦
```

​	第二个： 纯净的Ubuntu18.04镜像：需要自行安装系统

```python
链接:https://pan.baidu.com/s/19qZ2-vtMbz4amIJG3KNPcQ
提取码:40nl
复制这段内容后打开百度网盘手机App，操作更方便哦
```



我们使用vmware通过第二个ubuntu镜像，来创建两个虚拟机

我创建的两个虚拟机信息

```python
两个虚拟机都在本地安装，要相互组件网络被访问，需要在2个虚拟机中都安装一下：
sudo apt-get install net-tools  #网络工具
ssh服务是默认开启的，最好自己查询下是否开启了。如果没有开，请自行处理

u1:
  user: root
  password: 123456
  ip:  123.112.22.232
  hostname: iZbp1b1jw4l12ho53ivhkkZ

u2:
  user:root
  password: 123456
  ip:
  hostname:

```

给这两个系统安装nginx等项目运行软件。注意：安装之前别忘了保存快照。

我们的远程仓库使用的是码云，其他远程仓库请自行处理。

在运行我们项目的服务器上安装git

配置git操作码云时的免密登录(公私钥)

生成公私钥

```shell
执行系统指令

1. 输入ssh-keygen -t rsa -C "你的邮箱地址" 三次回车之后就可以生成密钥对
2. 上面的指令会自动在 ~/.ssh  目录中生成公私钥文件，mac的生成在 /Users/chao/.ssh/目录下面了
3. 这是这两个文件的名称id_rsa(私钥文件)		id_rsa.pub(公钥文件)
4. 将公钥文件中的内容复制一份放到码云的下面的位置
在使用git来操作码云远程仓库的时候，就是免密操作了。

但是当我们第一次配置完公私钥之后，我们要先在系统终端中执行一下git clone或者git pull指令，因为会提示如下内容
The authenticity of host 'gitee.com (212.64.62.183)' can't be established.
ECDSA key fingerprint is SHA256:FQGC9Kn/eye1W8icdBgrQp+KkGYoFgbVr17bmjey0Wc.
Are you sure you want to continue connecting (yes/no)?
我们需要进行指纹认证，其实就是在~/.ssh目录中的kown_hosts文件中添加一个记录，输入yes，以后就可以了。
```

如下图

![image-20210122134452074](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210122134452074.png)



保存即可。



##### 表结构设计

Release/models.py

```python
# 先进行发布，然后进行发布申请，在发布申请阶段进行真正的发布流程
# 发布申请记录表
class ReleaseApply(BaseModel):

    release_status_choices = (
        (1, '待审核'),
        (2, '待发布'),
        (3, '发布成功'),
        (4, '发布异常'),
        (5, '其他'),
    )

    branch_or_tag_choices = (
        (1, '分支'),
        (2, '标签'),
    )

    release_record = models.ForeignKey('ReleaseRecord', on_delete=models.CASCADE, verbose_name='发布记录', related_name='release_record_apply')
    # git_release_branch = models.CharField(max_length=128,verbose_name='分支',null=True, blank=True)
    # git_release_tag = models.CharField(max_length=128,verbose_name='git标签',null=True, blank=True)
    git_release_branch_or_tag = models.IntegerField(verbose_name='分支/标签', choices=branch_or_tag_choices, default=1)
    git_release_version = models.CharField(max_length=128, verbose_name='发布版本(其实是哪个分支或者哪个标签)')
    git_release_commit_id = models.CharField(max_length=256,verbose_name='git_commit_id',null=True,blank=True)

    release_status = models.IntegerField(choices=release_status_choices, default=1, verbose_name='状态')
    user = models.ForeignKey(User, verbose_name='申请人', on_delete=models.CASCADE, related_name='release_apply_user')

    class Meta:
        db_table = "hp_release_apply"
        verbose_name = "发布申请记录表"
        verbose_name_plural = verbose_name

    def git_release_branch_or_tag_name(self):
        # self.git_release_branch_or_tag # 获取choices对应的子成员的第一个信息，保存数据库中的数值
        return self.get_git_release_branch_or_tag_display() # 获取choices选项中对应的文本提示
```

数据迁移

```bash
python manage.py makemigrations
python manage.py migrate
```

添加测试数据，SQL语句：

```sql
INSERT INTO hippo.hp_release_apply (id, name, is_show, orders, is_delete, created_time, updated_time, description, git_release_branch_or_tag, git_release_version, git_release_commit_id, release_status, release_record_id, user_id) VALUES (1, '购物车代码发布', 1, 1, 0, '2021-08-15 07:14:43.544185', '2021-08-15 07:14:43.544563', null, 1, 'master', '6214836', 1, 1, 1);
INSERT INTO hippo.hp_release_apply (id, name, is_show, orders, is_delete, created_time, updated_time, description, git_release_branch_or_tag, git_release_version, git_release_commit_id, release_status, release_record_id, user_id) VALUES (2, '购物车v1', 1, 1, 0, '2021-08-15 07:15:07.577511', '2021-08-15 07:15:07.577727', null, 1, 'master', 'ca474c4', 1, 1, 1);
INSERT INTO hippo.hp_release_apply (id, name, is_show, orders, is_delete, created_time, updated_time, description, git_release_branch_or_tag, git_release_version, git_release_commit_id, release_status, release_record_id, user_id) VALUES (3, '支付功能', 1, 1, 0, '2021-08-15 07:15:28.132845', '2021-08-15 07:15:28.132897', null, 1, 'dev', 'f03c54b', 1, 2, 1);
```



##### 发布申请的界面基本效果

创建组件，ReleaseApply.vue，代码：

```html
<template>

  <div class="release_apply">
    <!--    <h1>发布申请</h1>-->
    <div class="release_apply_category" style="display: flex;justify-content: space-between;">
      <a-radio-group :value="apply_category" @change="handleCategoryChange">
        <a-radio-button value="0">
          全部
        </a-radio-button>
        <a-radio-button value="1">
          Default
        </a-radio-button>
        <a-radio-button value="2">
          Small
        </a-radio-button>
      </a-radio-group>
      <a-button type="primary" icon="plus" @click="new_release_apply">
        新建发布申请
      </a-button>

    </div>

    <div class="choose_app">

      <a-modal v-model="choose_app_visible" title="选择应用" width="800px">
        <a-row>
          <a-col :span="6">
            <div>
              <a-menu
                :default-selected-keys="['1']"
                mode="inline"
                :inline-collapsed="collapsed"
                @select="envs_menu_change"
              >
                <a-menu-item key="1">
                  <a-icon type="pie-chart"/>
                  <span>线上环境</span>
                </a-menu-item>
                <a-menu-item key="2">
                  <a-icon type="desktop"/>
                  <span>测试环境</span>
                </a-menu-item>
                <a-menu-item key="3">
                  <a-icon type="inbox"/>
                  <span>准生产环境</span>
                </a-menu-item>

              </a-menu>
            </div>
          </a-col>
          <a-col :span="18">
            <a-row type="flex" justify="space-around" align="middle">
              <a-col :span="8">
                <p style="height: 80px;line-height: 80px;text-align: center">

                  <a-button @click="show_new_release_apply" type="primary" style="height: 50px;width: 150px;">
                    Primary
                  </a-button>

                </p>
              </a-col>

            </a-row>
          </a-col>
        </a-row>


      </a-modal>
    </div>

    <div class="new_release_apply_modal">

      <a-modal v-model="new_release_visible" title="新建发布申请" width="800px" >
        <template slot="footer">
          <a-button key="back" @click="resetCreateApplyForm">
            取消
          </a-button>
          <a-button key="submit" type="primary" @click="onCreateApplySubmit">
            提交
          </a-button>
        </template>

        <div class="new_release_model_from">
          <a-form-model
            ref="ruleForm"
            :model="new_release_form_data.form"
            :rules="new_release_form_data.rules"
            :label-col="new_release_form_data.labelCol"
            :wrapper-col="new_release_form_data.wrapperCol"
          >
            <a-form-model-item ref="name" label="申请标题" prop="name">
              <a-input
                v-model="new_release_form_data.form.name"
                @blur="
          () => {
            $refs.name.onFieldBlur();
          }
        "
              />
            </a-form-model-item>
            <a-form-model-item label="选择分支/标签版本" prop="version">
              <a-input-group compact>

                <a-select style="width: 30%" v-model="new_release_form_data.form.git_release_branch_or_tag" default-value="1">

                  <a-select-option value="1">
                    branch
                  </a-select-option>
                  <a-select-option value="2">
                    Tag
                  </a-select-option>
                </a-select>
                <a-select style="width: 70%" v-model="new_release_form_data.form.git_release_version" default-value="1">
                  <a-select-option value="1">
                    v1版本
                  </a-select-option>
                  <a-select-option value="2">
                    v2版本
                  </a-select-option>
                </a-select>
              </a-input-group>
            </a-form-model-item>
            <a-form-model-item label="选择Commit ID" required prop="git_release_commit_id" v-if="new_release_form_data.form.git_release_branch_or_tag==='1'">
              <a-select v-model="new_release_form_data.form.git_release_commit_id" default-value="1">
                  <a-select-option value="1">
                    37c137 13833013278 吴超  更新订单功能成功
                  </a-select-option>
                  <a-select-option value="2">
                    2233x6 13833013278 吴超  生成购物车成功
                  </a-select-option>
                </a-select>

            </a-form-model-item>


            <a-form-model-item label="备注信息" prop="description">
              <a-input v-model="new_release_form_data.form.description" type="textarea"/>
            </a-form-model-item>

          </a-form-model>
        </div>


      </a-modal>
    </div>
    <div class="release_apply_list" style="margin-top: 20px;">
      <a-table :columns="columns" :data-source="data" rowKey="id">
        <a slot="action" slot-scope="text">action</a>
      </a-table>

    </div>
  </div>


</template>

<script>
  const columns = [
    {title: '申请标题', width: 100, dataIndex: 'name', key: 'name',},
    {title: '应用', width: 100, dataIndex: 'age', key: 'age',},
    {title: '发布环境', dataIndex: 'address', key: '1', width: 150},
    {title: '版本', dataIndex: 'address', key: '2', width: 150},
    {title: '状态', dataIndex: 'address', key: '3', width: 150},
    {title: '申请人', dataIndex: 'address', key: '4', width: 150},
    {title: '申请时间', dataIndex: 'address', key: '5', width: 150},

    {
      title: '操作',
      key: 'operation',
      width: 100,
      scopedSlots: {customRender: 'action'},
    },
  ];
  const data = [];
  for (let i = 0; i < 100; i++) {
    data.push({
      id: i,
      name: `Edrward ${i}`,
      age: 32,
      address: `London ${i}`,
    });
  }
  export default {
    name: "ReleaseApply",
    data() {
      return {
        columns,
        data,
        apply_category: 0,  // 发布申请分类，默认为全部
        choose_app_visible: false,
        new_release_visible: false,

        collapsed: false, // 环境分类菜单栏数据属性

        new_release_form_data: {
          labelCol: {span: 4},
          wrapperCol: {span: 14},
          other: '',
          form: {
            name: '', // 申请标题
            git_release_branch_or_tag:'1',  // 申请选择的是git分支还是标签
            git_release_version:'1', // 分支/标签 的版本
            git_release_commit_id: '', // git的commit id 数据

            description: '',  // 备注信息
          },
          rules: {
            name: [
              {required: true, message: '请输入申请标题', trigger: 'blur'},
              {min: 1, max: 10, message: 'Length should be 1 to 10', trigger: 'blur'},
            ],
            git_release_branch_or_tag: [{required: true, message: '请选择分支还是标签', trigger: 'change'}],
            git_release_version: [{required: true, message: '请选择版本', trigger: 'change'}],

            git_release_commit_id: [{required: true, message: '请选择commit ID', trigger: 'change'}],

          },
        }

      }
    },

    methods: {

      // 点击新建发布的弹框中的确认按钮的效果
      onCreateApplySubmit() {
        this.$refs.ruleForm.validate(valid => {
          if (valid) {
            alert('submit!');
          } else {
            console.log('error submit!!');
            return false;
          }
        });
      },
      // 点击新建发布的弹框中的取消按钮的效果
      resetCreateApplyForm() {
        this.$refs.ruleForm.resetFields();
        this.new_release_visible = false;
      },


      // 点击新建发布按钮的弹框效果
      new_release_apply() {
        this.choose_app_visible = true;
      },
      // 点击应用，弹出新建发布申请的弹框
      show_new_release_apply() {
        this.choose_app_visible = false;
        this.new_release_visible = true;
      },

      // // 点击新建发布的确认按钮效果
      // handle_new_release_apply(e) {
      //   console.log(e);
      //   this.new_release_visible = false;
      // },
      // 新建发布弹框中，选择不同环境的切换效果,antd官网中就有这个select事件如何使用
      envs_menu_change({item, key, selectedKeys}) {
        console.log(item, key, selectedKeys);
      },


      // 发布类型按钮点击切换效果
      handleCategoryChange(e) {

        this.apply_category = e.target.value;
        console.log(this.apply_category, typeof this.apply_category);
      }
    }

  }
</script>

<style scoped>

</style>

```

配置前端路由

```js
...
import ReleaseApply from '@/components/ReleaseApply'
...
	,
    {
      path: 'Release_apply',
      name: 'ReleaseApply',
      component: ReleaseApply,
    }


```

components/Base.vue，代码：

```javascript
{id: 13,  title: '发布申请', 'menu_url': '/hippo/release_apply'},
```



##### 新建发布申请记录

###### 展示和添加申请数据: 后端实现

release.urls，路由，代码：

```python
path('apply', views.ReleaseApplyViewSet.as_view({'get': 'list', 'post': 'create'})),

# 获取发布申请的状态数据 接口路径
path('release_apply/status/', views.ReleaseApplyStatus.as_view()),
```

release.views，视图，代码：

```python
from .serializers import ReleaseApplyModelSerializer
from rest_framework.permissions import IsAuthenticated
class ReleaseApplyViewSet(ModelViewSet):
    permission_classes = [IsAuthenticated]
    queryset = models.ReleaseApply.objects.filter(is_show=True, is_deleted=False)
    serializer_class = ReleaseApplyModelSerializer

# 获取发布申请的状态数据
class ReleaseApplyStatus(APIView):
    def get(self,request):
        status = models.ReleaseApply.release_status_choices
        return Response({'status_data': status})
```



Release/serializers.py

```python
from rest_framework import serializers
from release import models

# 新建发布的序列化器
class ReleaseModelSerializer(serializers.ModelSerializer):
    class Meta:
        model = models.ReleaseApp
        fields = '__all__'
        extra_kwargs = {
            'remark': {
                'required': False,
                # 'allow_blank': True,
                # 'allow_null': True,
            },
            'user': {
                'required': False,
                # 'allow_blank': True,
                # 'allow_null': True,
            }

        }
    def create(self, validated_data):
        user_obj = models.ReleaseApp.objects.create(**{
            'name': validated_data.get('name'),
            'app_id': validated_data.get('app_id'),
            # 'user':self.context['request'].user.id,
            'user_id': 1,
            'remark': validated_data.get('remark'),
        })
        return user_obj


# 新建发布申请的序列化器
class ReleaseApplyModelSerializer(serializers.ModelSerializer):
    app_name = serializers.CharField(source='release_record.release_app.name',read_only=True)
    envs_name = serializers.CharField(source='release_record.envs.name',read_only=True)
    username = serializers.CharField(source='user.username',read_only=True)

    # 关于git_release_commit_id只有现在选择的是git分支时才需要传递过来进行序列化器的校验，所有我们暂时不对他进行校验，回头再补充

    class Meta:
        model = models.ReleaseApply
        fields = ['id', 'name', 'app_name', 'envs_name', 'git_release_branch_or_tag','git_release_branch_or_tag_name', 'git_release_version', 'release_status', 'get_release_status_display', 'username', 'created_time', 'release_record', ]
        # branch_or_tag_choices为发布申请的状态数据
        extra_kwargs = {
            'release_status': {'read_only': True},
            'created_time': {'read_only': True},

        }

    # 对数据进行额外的校验
    # def validate(self, attrs):
    #     pass

    # 自定定制create，因为保存的数据不仅仅是用提交过来的数据，并且该方法的返回值是新创建的记录的模型类对象
    def create(self, validated_data):
        # self.context['request'].user  用户信息
        user_id = 1
        new_obj = models.ReleaseApply.objects.create(**{
            "git_release_branch_or_tag": validated_data.get('git_release_branch_or_tag'),
            "git_release_version": validated_data.get('git_release_version'),
            "name": validated_data.get('name'),
            "git_release_commit_id": validated_data.get('git_release_commit_id'),
            "description": validated_data.get('description'),
            "release_record": validated_data.get('release_record'),
            "user_id": user_id,
        })

        return new_obj


```

大家可以通过postman进行接口调试,在这里大家可以多添加几条数据，并且改一改每条记录的发布状态，争取每个发布状态下都有一些数据。

![image-20210121161932739](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210121161932739.png)



其实我们想完成前端效果的话，在前端发布申请页面，我们应该在页面加载的时候获取页面所需要的展示数据，比如：所有环境数据，所有应用数据，所有发布申请状态类型，所有的发布申请数据。

环境数据和应用数据的接口其实我们之前已经写好了，直接调用之前的接口就可以了

```python
http://api.hippo.cn:8000/conf_center/environment  #环境接口
http://api.hippo.cn:8000/release/app  # 应用接口
```



并且新建发布申请按钮的时候，我们应该获取我们新建发布的时候存储的那个git仓库地址的代码仓库中的所有分支和标签以及分支版本和标签的版本数据。

###### 展示申请数据: 前端实现

src/components/ReleaseApply.vue

```html
<template>

  <div class="release_apply">
    <!--    <h1>发布申请</h1>-->
    <div class="release_apply_category" style="display: flex;justify-content: space-between;">
      <a-radio-group :value="apply_category" @change="handleCategoryChange">
        <a-radio-button value="0">
          全部({{release_apply_data.length}})
        </a-radio-button>
        <a-radio-button :value="status_value[0]" v-for="(status_value,status_index) in release_apply_status_data" :key="status_index">
          {{status_value[1]}} ({{classify_release_apply_data[status_value[0]].length}})
        </a-radio-button>

      </a-radio-group>
      <a-button type="primary" icon="plus" @click="new_release_apply">
        新建发布申请
      </a-button>

    </div>

    <div class="choose_app">

      <a-modal v-model="choose_app_visible" title="选择应用" width="800px">
        <a-row>
          <a-col :span="6">
            <div>
              <a-menu
                :default-selected-keys="['1']"
                mode="inline"
                :inline-collapsed="collapsed"
                @select="envs_menu_change"
              >
                <a-menu-item :key="envs_value.id" v-for="(envs_value,envs_index) in envs_data">
                  <a-icon type="pie-chart"/>
                  <span>{{envs_value.name}}</span>
                </a-menu-item>


              </a-menu>
            </div>
          </a-col>
          <a-col :span="18">
            <a-row type="flex" justify="space-around" align="middle">
              <a-col :span="8" :key="app_index" v-for="(app_value,app_index) in app_data">
                <p style="height: 80px;line-height: 80px;text-align: center">

                  <a-button @click="show_new_release_apply(app_value.id)" type="primary" style="height: 50px;width: 150px;">
                    {{app_value.name}}
                  </a-button>

                </p>
              </a-col>

            </a-row>
          </a-col>
        </a-row>


      </a-modal>
    </div>

    <div class="new_release_apply_modal">

      <a-modal v-model="new_release_visible" title="新建发布申请" width="800px" >
        <template slot="footer">
          <a-button key="back" @click="resetCreateApplyForm">
            取消
          </a-button>
          <a-button key="submit" type="primary" @click="onCreateApplySubmit">
            提交
          </a-button>
        </template>

        <div class="new_release_model_from">
          <a-form-model
            ref="ruleForm"
            :model="new_release_form_data.form"
            :rules="new_release_form_data.rules"
            :label-col="new_release_form_data.labelCol"
            :wrapper-col="new_release_form_data.wrapperCol"
          >
            <a-form-model-item ref="name" label="申请标题" prop="name">
              <a-input
                v-model="new_release_form_data.form.name"
                @blur="
          () => {
            $refs.name.onFieldBlur();
          }
        "
              />
            </a-form-model-item>
            <a-form-model-item label="选择分支/标签版本" prop="version">
              <a-input-group compact>

                <a-select style="width: 30%" v-model="new_release_form_data.form.git_release_branch_or_tag" default-value="1">

                  <a-select-option value="1">
                    branch
                  </a-select-option>
                  <a-select-option value="2">
                    Tag
                  </a-select-option>
                </a-select>
                <a-select style="width: 70%" v-model="new_release_form_data.form.git_release_version" default-value="1">
                  <a-select-option value="1">
                    v1版本
                  </a-select-option>
                  <a-select-option value="2">
                    v2版本
                  </a-select-option>
                </a-select>
              </a-input-group>
            </a-form-model-item>
            <a-form-model-item label="选择Commit ID" required prop="git_release_commit_id" v-if="new_release_form_data.form.git_release_branch_or_tag==='1'">
              <a-select v-model="new_release_form_data.form.git_release_commit_id" default-value="1">
                  <a-select-option value="1">
                    37c137 13833013278 吴超  更新订单功能成功
                  </a-select-option>
                  <a-select-option value="2">
                    2233x6 13833013278 吴超  生成购物车成功
                  </a-select-option>
                </a-select>

            </a-form-model-item>


            <a-form-model-item label="备注信息" prop="description">
              <a-input v-model="new_release_form_data.form.description" type="textarea"/>
            </a-form-model-item>

          </a-form-model>
        </div>


      </a-modal>
    </div>
    <div class="release_apply_list" style="margin-top: 20px;">
      <a-table :columns="columns" :data-source="different_status_release_apply" rowKey="id">
        <a slot="action" slot-scope="text, record" v-if="record.release_status==='1'">
          <a-button size="small"  type="link">审核</a-button> |
          <a-button size="small"  type="link">编辑</a-button> |
          <a-button size="small"  type="link">删除</a-button>
        </a>
        <a slot="action" slot-scope="text, record" v-else-if="record.release_status==='2'">
          <a-button size="small"  type="link">发布</a-button> |
          <a-button size="small"  type="link">查看</a-button>

        </a>
        <a slot="action" slot-scope="text, record" v-else-if="record.release_status==='3'">
          <a-button size="small" type="link">查看</a-button> |
          <a-button size="small"  type="link">回滚</a-button>
        </a>

        <a slot="action" slot-scope="text, record" v-else-if="record.release_status==='4'">
          <a-button size="small" type="link" style="color:Red;">快查看吧</a-button>

        </a>
        <a slot="action" slot-scope="text, record" v-else>
          <a-button size="small"  type="link">查看</a-button>
        </a>




      </a-table>

    </div>
  </div>


</template>

<script>
  const columns = [
    {title: '申请标题', width: 50, dataIndex: 'name', key: 'name',},
    {title: '应用', width: 50, dataIndex: 'app_name', key: 'age',},
    {title: '发布环境', dataIndex: 'envs_name', key: '1', width: 80},
    {title: '版本', dataIndex: 'git_release_version', key: '2', width: 50},
    {title: '状态', dataIndex: 'get_release_status_display', key: '3', width: 50},
    {title: '申请人', dataIndex: 'username', key: '4', width: 50},
    {title: '申请时间', dataIndex: 'created_time', key: '5', width: 100},

    {
      title: '操作',
      key: 'operation',
      width: 100,
      scopedSlots: {customRender: 'action'},
    },
  ];
  // const data = [];
  // for (let i = 0; i < 100; i++) {
  //   data.push({
  //     id: i,
  //     name: `Edrward ${i}`,
  //     age: 32,
  //     address: `London ${i}`,
  //   });
  // }
  export default {
    name: "ReleaseApply",
    data() {
      return {
        envs_data:[],  // 环境数据
        app_data:[],  // 应用数据
        release_apply_data:[],  // 发布申请数据
        classify_release_apply_data:{},  // 所有分类归纳的发布申请数据
        different_status_release_apply:[], // 点击不能分类时的 发布申请数据

        release_apply_status_data:[],  // 发布申请状态数据

        // 根据分类划分出5个数据
        release_apply_data_1 : [], // 待审核数据
        release_apply_data_2 : [], // 待发布数据
        release_apply_data_3 : [], // 发布成功数据
        release_apply_data_4 : [], // 发布异常数据
        release_apply_data_5 : [], // 其他类型数据



        columns,
        // data,
        apply_category: '0',  // 发布申请分类，默认为全部
        choose_app_visible: false,
        new_release_visible: false,

        collapsed: false, // 环境分类菜单栏数据属性

        new_release_form_data: {
          labelCol: {span: 4},
          wrapperCol: {span: 14},
          other: '',
          form: {
            name: '', // 申请标题
            git_release_branch_or_tag:'1',  // 申请选择的是git分支还是标签
            git_release_version:'1', // 分支/标签 的版本
            git_release_commit_id: '', // git的commit id 数据

            description: '',  // 备注信息
          },
          rules: {
            name: [
              {required: true, message: '请输入申请标题', trigger: 'blur'},
              {min: 1, max: 10, message: 'Length should be 1 to 10', trigger: 'blur'},
            ],
            git_release_branch_or_tag: [{required: true, message: '请选择分支还是标签', trigger: 'change'}],
            git_release_version: [{required: true, message: '请选择版本', trigger: 'change'}],

            git_release_commit_id: [{required: true, message: '请选择commit ID', trigger: 'change'}],

          },
        }

      }
    },
    created() {
      this.get_envs_data();
      this.get_app_data();
      this.get_release_apply_data();
      this.get_release_apply_status_data();
    },

    methods: {

      // 根据发布申请的状态，将发布申请数据进行分类,请求数据回来之后，就执行该方法
       classify_release_data_by_status(){
         this.release_apply_data.forEach((k,v)=>{
           if (k.release_status === '1'){
             this.release_apply_data_1.push(k);
           }
           else if (k.release_status === '2'){
             this.release_apply_data_2.push(k);
           }
           else if (k.release_status === '3'){
             this.release_apply_data_3.push(k);
           }
           else if (k.release_status === '4'){
             this.release_apply_data_4.push(k);
           }
           else {
             this.release_apply_data_5.push(k);
           }

         });
        this.classify_release_apply_data['0'] = this.release_apply_data
        this.classify_release_apply_data['1'] = this.release_apply_data_1
        this.classify_release_apply_data['2'] = this.release_apply_data_2
        this.classify_release_apply_data['3'] = this.release_apply_data_3
        this.classify_release_apply_data['4'] = this.release_apply_data_4
        this.classify_release_apply_data['5'] = this.release_apply_data_5

       },

      // 点击新建发布的弹框中的确认按钮的效果
      onCreateApplySubmit() {
        this.$refs.ruleForm.validate(valid => {
          if (valid) {
            alert('submit!');
          } else {
            console.log('error submit!!');
            return false;
          }
        });
      },
      // 点击新建发布的弹框中的取消按钮的效果
      resetCreateApplyForm() {
        this.$refs.ruleForm.resetFields();
        this.new_release_visible = false;
      },


      // 点击新建发布按钮的弹框效果
      new_release_apply() {
        this.choose_app_visible = true;
      },
      // 点击应用，弹出新建发布申请的弹框
      show_new_release_apply() {
        this.choose_app_visible = false;
        this.new_release_visible = true;
      },

      // // 点击新建发布的确认按钮效果
      // handle_new_release_apply(e) {
      //   console.log(e);
      //   this.new_release_visible = false;
      // },
      // 新建发布弹框中，选择不同环境的切换效果,antd官网中就有这个select事件如何使用
      envs_menu_change({item, key, selectedKeys}) {
        console.log(item, key, selectedKeys);
      },


      // 发布类型按钮点击切换效果
      handleCategoryChange(e) {

        this.apply_category = e.target.value;
        this.different_status_release_apply = this.classify_release_apply_data[this.apply_category]
        // console.log(0)
        console.log(this.apply_category, typeof this.apply_category);
      },

      // 获取所有环境数据
      get_envs_data(){
        let token = sessionStorage.token || localStorage.token;
        this.$axios.get(`${this.$settings.host}/conf_center/environment`,{
          headers:{
            Authorization: "jwt "+ token
          }
        })
        .then((res)=>{
          this.envs_data = res.data;
        }).catch((error)=>{

        })
      },

      // 获取所有应用数据
      get_app_data(){
        let token = sessionStorage.token || localStorage.token;
        this.$axios.get(`${this.$settings.host}/release/app`, {
          headers:{
            Authorization: "jwt "+ token
          }
        })
        .then((res)=>{
          this.app_data = res.data;
        }).catch((error)=>{

        })
      },
      // 获取所有发布申请数据

      get_release_apply_data(){
        let token = sessionStorage.token || localStorage.token;
        this.$axios.get(`${this.$settings.host}/release/apply`, {
          headers:{
            Authorization: "jwt "+ token
          }
        })
        .then((res)=>{
          this.release_apply_data = res.data;
          this.classify_release_data_by_status();
          this.different_status_release_apply = this.release_apply_data;
        }).catch((error)=>{

        })
      },
      // 获取所有发布申请的状态数据

      get_release_apply_status_data(){
        let token = sessionStorage.token || localStorage.token;
        this.$axios.get(`${this.$settings.host}/release/apply/status`, {
          headers:{
            Authorization: "jwt "+ token
          }
        })
        .then((res)=>{
          this.release_apply_status_data = res.data;
        }).catch((error)=>{

        })
      },

    },

  }
</script>

<style scoped>

</style>
```



##### 切换环境得到不同环境下的应用

###### 前端实现

其实这个功能，我们点击切换环境时，将环境id发送给后台，后台筛选出该环境下所有的新建发布，通过新建发布数据反向查找对应的应用

当点击应用时，我们找到该应用对应的最新发布，拿到发布对应的git仓库地址，将git仓库clone下来，并获取仓库的所有分支和标签以及版本信息在页面上显示即可。



###### 切换环境得到不同环境的应用: 后端实现

Release/urls.py

```python
# 切换环境时获得不同的应用
path('envs/apps', views.EnvsAppsView.as_view()),
```

Release/views.py

```python
# 获取不同环境下的应用数据
class EnvsAppsView(APIView):

    def get(self,request):
        # 获取环境id
        envs_id = request.query_params.get('envs_id')
        envs_apps_data = list(models.ReleaseRecord.objects.filter(envs_id=envs_id).values(
            'release_app__id',
            'release_app__name',
        ).distinct())  # 别忘了去重
        return Response({'envs_apps_data': envs_apps_data})

```



###### 切换环境得到不同环境的应用: 前端实现

```vue
<template>

  <div class="release_apply">
    <!--    <h1>发布申请</h1>-->
    <div class="release_apply_category" style="display: flex;justify-content: space-between;">
      <a-radio-group :value="apply_category" @change="handleCategoryChange">
        <a-radio-button value="0">
          全部({{release_apply_data.length}})
        </a-radio-button>
        <a-radio-button :value="status_value[0]" v-for="(status_value,status_index) in release_apply_status_data" :key="status_index">
          {{status_value[1]}}({{classify_release_apply_data[status_value[0]].length}})
        </a-radio-button>

      </a-radio-group>
      <a-button type="primary" icon="plus" @click="new_release_apply">
        新建发布申请
      </a-button>

    </div>

    <div class="choose_app">

      <a-modal v-model="choose_app_visible" title="选择应用" width="800px">
        <a-row>
          <a-col :span="6">
            <div>
              <a-menu
                :default-selected-keys="['1']"
                mode="inline"
                :inline-collapsed="collapsed"
                @select="envs_menu_change"
              >
                <a-menu-item :key="envs_value.id" v-for="(envs_value,envs_index) in envs_data" @click="change_env_event(envs_value.id)">
                  <a-icon type="pie-chart"/>
                  <span>{{envs_value.name}}</span>
                </a-menu-item>


              </a-menu>
            </div>
          </a-col>
          <a-col :span="18">
            <a-row type="flex" justify="space-around" align="middle">
              <a-col :span="8" :key="app_index" v-for="(app_value,app_index) in app_data">
                <p style="height: 80px;line-height: 80px;text-align: center">

                  <a-button @click="show_new_release_apply(app_value.release_app__id)" type="primary" style="height: 50px;width: 150px;">
                    {{app_value.release_app__name}}
                  </a-button>

                </p>
              </a-col>

            </a-row>
          </a-col>
        </a-row>


      </a-modal>
    </div>

    <div class="new_release_apply_modal">

      <a-modal v-model="new_release_visible" title="新建发布申请" width="800px" >
        <template slot="footer">
          <a-button key="back" @click="resetCreateApplyForm">
            取消
          </a-button>
          <a-button key="submit" type="primary" @click="onCreateApplySubmit">
            提交
          </a-button>
        </template>

        <div class="new_release_model_from">
          <a-form-model
            ref="ruleForm"
            :model="new_release_form_data.form"
            :rules="new_release_form_data.rules"
            :label-col="new_release_form_data.labelCol"
            :wrapper-col="new_release_form_data.wrapperCol"
          >
            <a-form-model-item ref="name" label="申请标题" prop="name">
              <a-input
                v-model="new_release_form_data.form.name"
                @blur="
          () => {
            $refs.name.onFieldBlur();
          }
        "
              />
            </a-form-model-item>
            <a-form-model-item label="选择分支/标签版本" prop="version">
              <a-input-group compact>

                <a-select style="width: 30%" v-model="new_release_form_data.form.git_release_branch_or_tag" default-value="1">

                  <a-select-option value="1">
                    branch
                  </a-select-option>
                  <a-select-option value="2">
                    Tag
                  </a-select-option>
                </a-select>
                <a-select style="width: 70%" v-model="new_release_form_data.form.git_release_version" default-value="1">
                  <a-select-option value="1">
                    v1版本
                  </a-select-option>
                  <a-select-option value="2">
                    v2版本
                  </a-select-option>
                </a-select>
              </a-input-group>
            </a-form-model-item>
            <a-form-model-item label="选择Commit ID" required prop="git_release_commit_id" v-if="new_release_form_data.form.git_release_branch_or_tag==='1'">
              <a-select v-model="new_release_form_data.form.git_release_commit_id" default-value="1">
                  <a-select-option value="1">
                    37c137 13833013278 吴超  更新订单功能成功
                  </a-select-option>
                  <a-select-option value="2">
                    2233x6 13833013278 吴超  生成购物车成功
                  </a-select-option>
                </a-select>

            </a-form-model-item>


            <a-form-model-item label="备注信息" prop="description">
              <a-input v-model="new_release_form_data.form.description" type="textarea"/>
            </a-form-model-item>

          </a-form-model>
        </div>


      </a-modal>
    </div>
    <div class="release_apply_list" style="margin-top: 20px;">
      <a-table :columns="columns" :data-source="different_status_release_apply" rowKey="id">
        <a slot="action" slot-scope="text, record" v-if="record.release_status==='1'">
          <a-button size="small"  type="link">审核</a-button> |
          <a-button size="small"  type="link">编辑</a-button> |
          <a-button size="small"  type="link">删除</a-button>
        </a>
        <a slot="action" slot-scope="text, record" v-else-if="record.release_status==='2'">
          <a-button size="small"  type="link">发布</a-button> |
          <a-button size="small"  type="link">查看</a-button>

        </a>
        <a slot="action" slot-scope="text, record" v-else-if="record.release_status==='3'">
          <a-button size="small" type="link">查看</a-button> |
          <a-button size="small"  type="link">回滚</a-button>
        </a>

        <a slot="action" slot-scope="text, record" v-else-if="record.release_status==='4'">
          <a-button size="small" type="link" style="color:Red;">快查看吧</a-button>

        </a>
        <a slot="action" slot-scope="text, record" v-else>
          <a-button size="small"  type="link">查看</a-button>
        </a>




      </a-table>

    </div>
  </div>


</template>

<script>
  const columns = [
    {title: '申请标题', width: 50, dataIndex: 'name', key: 'name',},
    {title: '应用', width: 50, dataIndex: 'app_name', key: 'age',},
    {title: '发布环境', dataIndex: 'envs_name', key: '1', width: 80},
    {title: '版本', dataIndex: 'git_release_version', key: '2', width: 50},
    {title: '状态', dataIndex: 'get_release_status_display', key: '3', width: 50},
    {title: '申请人', dataIndex: 'username', key: '4', width: 50},
    {title: '申请时间', dataIndex: 'created_time', key: '5', width: 100},

    {
      title: '操作',
      key: 'operation',
      width: 100,
      scopedSlots: {customRender: 'action'},
    },
  ];
  // const data = [];
  // for (let i = 0; i < 100; i++) {
  //   data.push({
  //     id: i,
  //     name: `Edrward ${i}`,
  //     age: 32,
  //     address: `London ${i}`,
  //   });
  // }
  export default {
    name: "ReleaseApply",
    data() {
      return {
        envs_data:[],  // 环境数据
        envs_id:1, // 所选环境的id值
        app_data:[],  // 应用数据
        release_apply_data:[],  // 发布申请数据
        classify_release_apply_data:{},  // 所有分类归纳的发布申请数据
        different_status_release_apply:[], // 点击不能分类时的 发布申请数据

        release_apply_status_data:[],  // 发布申请状态数据

        // 根据分类划分出5个数据
        release_apply_data_1 : [], // 待审核数据
        release_apply_data_2 : [], // 待发布数据
        release_apply_data_3 : [], // 发布成功数据
        release_apply_data_4 : [], // 发布异常数据
        release_apply_data_5 : [], // 其他类型数据



        columns,
        // data,
        apply_category: '0',  // 发布申请分类，默认为全部
        choose_app_visible: false,
        new_release_visible: false,

        collapsed: false, // 环境分类菜单栏数据属性

        new_release_form_data: {
          labelCol: {span: 4},
          wrapperCol: {span: 14},
          other: '',
          form: {
            name: '', // 申请标题
            git_release_branch_or_tag:'1',  // 申请选择的是git分支还是标签
            git_release_version:'1', // 分支/标签 的版本
            git_release_commit_id: '', // git的commit id 数据

            description: '',  // 备注信息
          },
          rules: {
            name: [
              {required: true, message: '请输入申请标题', trigger: 'blur'},
              {min: 1, max: 10, message: 'Length should be 1 to 10', trigger: 'blur'},
            ],
            git_release_branch_or_tag: [{required: true, message: '请选择分支还是标签', trigger: 'change'}],
            git_release_version: [{required: true, message: '请选择版本', trigger: 'change'}],

            git_release_commit_id: [{required: true, message: '请选择commit ID', trigger: 'change'}],

          },
        }

      }
    },
    created() {
      this.get_envs_data();
      // this.get_app_data();
      this.change_env_event(); // 获取不同环境的应用，默认是测试环境，页面加载时触发一次，环境菜单切换时也触发
      this.get_release_apply_data();
      this.get_release_apply_status_data();
    },

    methods: {

      // 切换环境时，展示对应的环境的应用
      change_env_event(){
        let token = sessionStorage.token || localStorage.token;
        this.$axios.get(`${this.$settings.host}/release/envs/apps`,{
          params:{
            envs_id:this.envs_id,
          }
        }, {
          headers:{
            Authorization: "jwt "+ token
          }
        }).then((res)=>{
          this.app_data = res.data.envs_apps_data;


        }).catch((error)=>{

        })


      },


      // 根据发布申请的状态，将发布申请数据进行分类,请求数据回来之后，就执行该方法
       classify_release_data_by_status(){
         this.release_apply_data.forEach((k,v)=>{
           if (k.release_status === '1'){
             this.release_apply_data_1.push(k);
           }
           else if (k.release_status === '2'){
             this.release_apply_data_2.push(k);
           }
           else if (k.release_status === '3'){
             this.release_apply_data_3.push(k);
           }
           else if (k.release_status === '4'){
             this.release_apply_data_4.push(k);
           }
           else {
             this.release_apply_data_5.push(k);
           }

         });
        this.classify_release_apply_data['0'] = this.release_apply_data
        this.classify_release_apply_data['1'] = this.release_apply_data_1
        this.classify_release_apply_data['2'] = this.release_apply_data_2
        this.classify_release_apply_data['3'] = this.release_apply_data_3
        this.classify_release_apply_data['4'] = this.release_apply_data_4
        this.classify_release_apply_data['5'] = this.release_apply_data_5

       },

      // 点击新建发布的弹框中的确认按钮的效果
      onCreateApplySubmit() {
        this.$refs.ruleForm.validate(valid => {
          if (valid) {
            alert('submit!');
          } else {
            console.log('error submit!!');
            return false;
          }
        });
      },
      // 点击新建发布的弹框中的取消按钮的效果
      resetCreateApplyForm() {
        this.$refs.ruleForm.resetFields();
        this.new_release_visible = false;
      },


      // 点击新建发布按钮的弹框效果
      new_release_apply() {
        this.choose_app_visible = true;
      },
      // 点击应用，弹出新建发布申请的弹框
      show_new_release_apply(app_id) {
         console.log('app_id>> ',app_id);
        this.choose_app_visible = false;
        this.new_release_visible = true;
      },

      // // 点击新建发布的确认按钮效果
      // handle_new_release_apply(e) {
      //   console.log(e);
      //   this.new_release_visible = false;
      // },
      // 新建发布弹框中，选择不同环境的切换效果,antd官网中就有这个select事件如何使用
      envs_menu_change({item, key, selectedKeys}) {
        // console.log(item, key, selectedKeys);  key是环境id
        this.envs_id = key;
        this.change_env_event();
      },


      // 发布类型按钮点击切换效果
      handleCategoryChange(e) {

        this.apply_category = e.target.value;
        this.different_status_release_apply = this.classify_release_apply_data[this.apply_category]
        // console.log(0)
        console.log(this.apply_category, typeof this.apply_category);
      },

      // 获取所有环境数据
      get_envs_data(){
          let token = sessionStorage.token || localStorage.token;
        this.$axios.get(`${this.$settings.host}/conf_center/environment`, {
          headers:{
            Authorization: "jwt "+ token
          }
        })
        .then((res)=>{
          this.envs_data = res.data;
        }).catch((error)=>{

        })
      },

      // // 获取所有应用数据
      // get_app_data(){
      //   let token = sessionStorage.token || localStorage.token;
      //   this.$axios.get(`${this.$settings.host}/release/app`, {
      //     headers:{
      //       Authorization: "jwt "+ token
      //     }
      //   })
      //   .then((res)=>{
      //     this.app_data = res.data;
      //   }).catch((error)=>{
      //
      //   })
      // },
      // 获取所有发布申请数据

      get_release_apply_data(){
          let token = sessionStorage.token || localStorage.token;
        this.$axios.get(`${this.$settings.host}/release/apply`, {
          headers:{
            Authorization: "jwt "+ token
          }
        })
        .then((res)=>{
          this.release_apply_data = res.data;
          this.classify_release_data_by_status();
          this.different_status_release_apply = this.release_apply_data;
        }).catch((error)=>{

        })
      },
      // 获取所有发布申请的状态数据

      get_release_apply_status_data(){
          let token = sessionStorage.token || localStorage.token;
        this.$axios.get(`${this.$settings.host}/release/apply/status`, {
          headers:{
            Authorization: "jwt "+ token
          }
        })
        .then((res)=>{
          this.release_apply_status_data = res.data;
        }).catch((error)=>{

        })
      },
    },

  }
</script>

<style scoped>

</style>

```





##### 新建发布具体信息

点击应用弹框效果

![image-20210122104103184](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210122104103184.png)

点击应用

![image-20210122104121379](8%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83.assets/image-20210122104121379.png)



**后端实现**

配置一下git clone的代码存放目录

Hippo/settings.py

```python
# git clone的代码存放目录
GIT_CODE_DIR = BASE_DIR.parent / 'projects'
```



Release/urls.py

```python
# 获取git 仓库的分支数据
path('git/branchs/', views.GitBranchView.as_view()),
```

创建一个py文件，完成代码检出(git clone)，并获取代码的分支信息

utils/git_oprations.py

```python
import os

# 拉取git仓库并获得分支数据
def get_git_branchs(git_addr, git_code_dir):
    '''
    :param git_addr:  远程仓库的ssh地址
    :return:  该仓库的分支列表数据
    '''


    # 1 检出(git clone)前的动作

    # 2 检出代码

    # 3 检出后动作

    # 后面3步是在点击发布的时候进行的
    # 4 发布前，对目标主机执行的动作

    # 5 发布

    # 6 发布后，对目标主机执行的动作

    # git仓库地址：git_addr = 'git@gitee.com:mooluo_admin/hippo.git'
    # 本地仓库目录：git_pro_name = gitee.com/mooluo_admin
    git_path_name = "/".join(git_addr.split("@")[-1].replace(":","/")[:-4].split("/")[:-1])

    # 如果确定以后公司只会在某个git平台上存储git版本，则本地仓库目录采用项目名即可：hippo
    # 项目目录名：pro_name = 'hippo'
    pro_name = git_addr.rsplit('/')[-1].split('.')[0]

    # 指定git存储目录，目前的方式是在settings中配置的GIT_CODE_DIR的目录下根据项目名称创建一个目录，然后进入到这个目录里面再执行git clone
    # from django.conf import settings
    # git_code_dir = settings.GIT_CODE_DIR
    git_dir_path = f'{git_code_dir}/{git_path_name}' # '/home/moluo/Desktop/hippo/hippo_api/projects/gitee.com/mooluo_admin'
    git_pro_path = f'{git_code_dir}/{git_path_name}/{pro_name}' # '/home/moluo/Desktop/hippo/hippo_api/projects/gitee.com/mooluo_admin/hippo'
    # import os
    if os.path.exists(git_pro_path):
        git_branch_info = os.popen( f'cd {git_pro_path} && git pull {git_addr} && git branch -r').readlines()
        # git_branch_info = ['已经是最新的。\n', '  origin/HEAD -> origin/master\n', '  origin/dev\n', '  origin/master\n']
        git_branch_info_s = git_branch_info[2:]
    else:
        git_branch_info = os.popen( f'mkdir -p -m 777 {git_dir_path} && cd {git_dir_path} && git clone {git_addr} && cd {pro_name} && git branch -r').readlines()[1:]
        # git_branch_info = ['  origin/HEAD -> origin/master\n', '  origin/dev\n', '  origin/master\n']
        git_branch_info_s = git_branch_info[1:]

    # 查看提交版本的指令 git log --pretty="%h %an %s" --since="2020" --before="2021"  -10    #-10指的是最近的10次提交记录
    print('git_branch_info>>>', git_branch_info)
    print('git_branch_info_s>>>>', git_branch_info_s)
    # 将查看分支指令的返回结果进行加工，筛选出所有的分支名称
    branch_list = [i.split('/')[-1].replace('\n', '') for i in git_branch_info_s]
    print('>>>>>', branch_list)
    return branch_list


# 获取git 仓库中分支的commit版本信息
def get_git_commits(branchs_name, git_addr, git_code_dir):
    # git仓库代码的存储路径
    git_path_name = "/".join(git_addr.split("@")[-1].replace(":","/")[:-4].split("/")[:-1])
    # git仓库名称
    pro_name = git_addr.rsplit('/')[-1].split('.')[0]
    git_pro_path = f'{git_code_dir}/{git_path_name}'
    print(git_pro_path)
    print('branchs_name>>', branchs_name)
    result = os.popen(f'cd {git_pro_path}/{pro_name} && git checkout {branchs_name} && git log --pretty="%h %an %s"').readlines()[1:]
    print('result>>>>', result)
    res_dict = {}  #{'版本id号'，版本具体信息, }
    for i in result:
        i_list = i.split(' ')
        res_dict[i_list[0]] = i

    return res_dict

```

视图部分

Release/views.py

```python
from django.conf import settings
from hippo_api.utils.git_oprations import get_git_branchs,get_git_commits
class GitBranchAPIView(APIView):
    # 获取git仓库的分支记录获取tag标签
    def get(self,request):
        app_id = request.query_params.get('app_id')
        # 先找到该应用的新建的最新发布记录
        release_record_obj = ReleaseRecord.objects.filter(is_show=True, is_delete=False,release_app_id=app_id).order_by( '-id').first()
        git_code_dir = settings.GIT_CODE_DIR
        git_remote_attr = release_record_obj.code_git_addr
        # 获取git仓库的分支数据
        git_branch_list = get_git_branchs(git_remote_attr, git_code_dir)
        # 获得branch -- master等分支的所有提交版本
        branchs_name = request.query_params.get('branchs')  # master or dev

        commits = get_git_commits(branchs_name, git_remote_attr, git_code_dir)

        return Response({
            'branch_list': git_branch_list,
            'commits': commits,
            'release_record_id': release_record_obj.id
        })
```



前端实现

ReleaseApply.vue，代码：

```html
<template>

  <div class="release_apply">
    <!--    <h1>发布申请</h1>-->
    <div class="release_apply_category" style="display: flex;justify-content: space-between;">
      <a-radio-group :value="apply_category" @change="handleCategoryChange">
        <a-radio-button value="0">
          全部({{release_apply_data.length}})
        </a-radio-button>
        <a-radio-button :value="status_value[0]" v-for="(status_value,status_index) in release_apply_status_data" :key="status_index">
          {{status_value[1]}} ({{classify_release_apply_data[status_value[0]].length}})
        </a-radio-button>

      </a-radio-group>
      <a-button type="primary" icon="plus" @click="new_release_apply">
        新建发布申请
      </a-button>

    </div>

    <div class="choose_app">

      <a-modal v-model="choose_app_visible" title="选择应用" width="800px">
        <a-row>
          <a-col :span="6">
            <div>
              <a-menu
                :default-selected-keys="['1']"
                mode="inline"
                :inline-collapsed="collapsed"
                @select="envs_menu_change"
              >
                <a-menu-item :key="envs_value.id" v-for="(envs_value,envs_index) in envs_data" @click="change_env_event(envs_value.id)">
                  <a-icon type="pie-chart"/>
                  <span>{{envs_value.name}}</span>
                </a-menu-item>


              </a-menu>
            </div>
          </a-col>
          <a-col :span="18">
            <a-row type="flex" justify="space-around" align="middle">
              <a-col :span="8" :key="app_index" v-for="(app_value,app_index) in app_data">
                <p style="height: 80px;line-height: 80px;text-align: center">

                  <a-button @click="show_new_release_apply(app_value.release_app__id)" type="primary" style="height: 50px;width: 150px;">
                    {{app_value.release_app__name}}
                  </a-button>

                </p>
              </a-col>

            </a-row>
          </a-col>
        </a-row>


      </a-modal>
    </div>

    <div class="new_release_apply_modal">

      <a-modal v-model="new_release_visible" title="新建发布申请" width="800px" >
        <template slot="footer">
          <a-button key="back" @click="resetCreateApplyForm">
            取消
          </a-button>
          <a-button key="submit" type="primary" @click="onCreateApplySubmit">
            提交
          </a-button>
        </template>

        <div class="new_release_model_from">
          <a-form-model
            ref="ruleForm"
            :model="new_release_form_data.form"
            :rules="new_release_form_data.rules"
            :label-col="new_release_form_data.labelCol"
            :wrapper-col="new_release_form_data.wrapperCol"
          >
            <a-form-model-item ref="name" label="申请标题" prop="name">
              <a-input
                v-model="new_release_form_data.form.name"
                @blur="
          () => {
            $refs.name.onFieldBlur();
          }
        "
              />
            </a-form-model-item>
            <a-form-model-item label="选择分支/标签版本" prop="version">
              <a-input-group compact>

                <a-select style="width: 30%" v-model="new_release_form_data.form.git_release_branch_or_tag" default-value="1">

                  <a-select-option value="1">
                    branch
                  </a-select-option>
                  <a-select-option value="2">
                    Tag
                  </a-select-option>
                </a-select>
                <a-select style="width: 70%" v-model="new_release_form_data.form.git_release_version" default-value="1">
                  <a-select-option :value="branch_value" v-for="(branch_value, branch_index) in git_branchs" :key="branch_index">
                    {{branch_value}}
                  </a-select-option>

                </a-select>
              </a-input-group>
            </a-form-model-item>
            <a-form-model-item label="选择Commit ID" required prop="git_release_commit_id" v-if="new_release_form_data.form.git_release_branch_or_tag==='1'">
              <a-select v-model="new_release_form_data.form.git_release_commit_id" default-value="1">
                  <a-select-option :value="commit_info_index" v-for="(commit_info_value, commit_info_index) in git_branchs_commit_info" :key="commit_info_index">
                    {{commit_info_value}}>>>>{{commit_info_index}}
                  </a-select-option>

                </a-select>

            </a-form-model-item>


            <a-form-model-item label="备注信息" prop="description">
              <a-input v-model="new_release_form_data.form.description" type="textarea"/>
            </a-form-model-item>

          </a-form-model>
        </div>


      </a-modal>
    </div>
    <div class="release_apply_list" style="margin-top: 20px;">
      <a-table :columns="columns" :data-source="different_status_release_apply" rowKey="id">
        <a slot="action" slot-scope="text, record" v-if="record.release_status===1">
          <a-button size="small"  type="link">审核</a-button> |
          <a-button size="small"  type="link">编辑</a-button> |
          <a-button size="small"  type="link">删除</a-button>
        </a>
        <a slot="action" slot-scope="text, record" v-else-if="record.release_status===2">
          <a-button size="small"  type="link">发布</a-button> |
          <a-button size="small"  type="link">查看</a-button>

        </a>
        <a slot="action" slot-scope="text, record" v-else-if="record.release_status===3">
          <a-button size="small" type="link">查看</a-button> |
          <a-button size="small"  type="link">回滚</a-button>
        </a>

        <a slot="action" slot-scope="text, record" v-else-if="record.release_status===4">
          <a-button size="small" type="link" style="color:Red;">快查看吧</a-button>

        </a>
        <a slot="action" slot-scope="text, record" v-else>
          <a-button size="small"  type="link">查看</a-button>
        </a>




      </a-table>

    </div>
  </div>


</template>

<script>
  const columns = [
    {title: '申请标题', width: 50, dataIndex: 'name', key: 'name',},
    {title: '应用', width: 50, dataIndex: 'app_name', key: 'app_name',},
    {title: '发布环境', dataIndex: 'envs_name', key: 'envs_name', width: 80},
    {title: '版本', dataIndex: 'git_release_commit_id', key: 'git_release_commit_id', width: 50},
    {title: '状态', dataIndex: 'get_release_status_display', key: 'get_release_status_display', width: 50},
    {title: '申请人', dataIndex: 'username', key: 'username', width: 50},
    {title: '申请时间', dataIndex: 'created_time', key: 'created_time', width: 100},

    {
      title: '操作',
      key: 'operation',
      width: 100,
      scopedSlots: {customRender: 'action'},
    },
  ];
  // const data = [];
  // for (let i = 0; i < 100; i++) {
  //   data.push({
  //     id: i,
  //     name: `Edrward ${i}`,
  //     age: 32,
  //     address: `London ${i}`,
  //   });
  // }
  export default {
    name: "ReleaseApply",
    data() {
      return {
        envs_data:[],  // 环境数据
        envs_id:1, // 所选环境的id值
        app_data:[],  // 应用数据
        release_apply_data:[],  // 发布申请数据
        classify_release_apply_data:{},  // 所有分类归纳的发布申请数据
        different_status_release_apply:[], // 点击不同分类时的 发布申请数据
        app_id:1, // 用户新建发布申请时选择的应用id
        release_apply_status_data:[],  // 发布申请状态数据

        // 根据分类划分出5个数据
        release_apply_data_1 : [], // 待审核数据
        release_apply_data_2 : [], // 待发布数据
        release_apply_data_3 : [], // 发布成功数据
        release_apply_data_4 : [], // 发布异常数据
        release_apply_data_5 : [], // 其他类型数据

        git_branchs:[], // 不同应用的新建发布对应的git仓库的分支信息
        git_branchs_commit_info:[], // 不同分支的commit版本信息，默认先获得master分支的，业务级别就定好有master分支


        columns,
        // data,
        apply_category: '0',  // 发布申请分类，默认为全部
        choose_app_visible: false,
        new_release_visible: false,

        collapsed: false, // 环境分类菜单栏数据属性

        new_release_form_data: {
          labelCol: {span: 4},
          wrapperCol: {span: 14},
          other: '',
          form: {
            name: '', // 申请标题
            git_release_branch_or_tag:'1',  // 申请选择的是git分支还是标签
            git_release_version:'master', // 分支/标签 的版本, 也就是我们选择哪个分支
            git_release_commit_id: '', // git的commit id 数据
            release_record:0,
            description: '',  // 备注信息
          },
          rules: {
            name: [
              {required: true, message: '请输入申请标题', trigger: 'blur'},
              {min: 1, max: 10, message: 'Length should be 1 to 10', trigger: 'blur'},
            ],
            git_release_branch_or_tag: [{required: true, message: '请选择分支还是标签', trigger: 'change'}],
            git_release_version: [{required: true, message: '请选择版本', trigger: 'change'}],

            git_release_commit_id: [{required: true, message: '请选择commit ID', trigger: 'change'}],

          },
        }

      }
    },
    created() {
      this.get_envs_data();
      // this.get_app_data();
      this.change_env_event(); // 获取不同环境的应用，默认是测试环境，页面加载时触发一次，环境菜单切换时也触发
      this.get_release_apply_data();
      this.get_release_apply_status_data();
    },

    watch:{
      'new_release_form_data.form.git_release_version':function (val) {
        // this.get_branch_commit_history()
        // console.log('val', val);

        this.show_new_release_apply(); // 执行获取不同分支的版本数据

      }
    },

    methods: {

      // 切换环境时，展示对应的环境的应用
      change_env_event(){
        let token = sessionStorage.token || localStorage.token;
        this.$axios.get(`${this.$settings.host}/release/envs/apps`,{
          params:{
            envs_id:this.envs_id,
          }
        }, {
          headers:{
            Authorization: "jwt "+ token
          }
        }).then((res)=>{
          this.app_data = res.data.envs_apps_data;


        }).catch((error)=>{

        })


      },


      // 根据发布申请的状态，将发布申请数据进行分类,请求数据回来之后，就执行该方法
       classify_release_data_by_status(){
        this.release_apply_data_1 = []
        this.release_apply_data_2 = []
        this.release_apply_data_3 = []
        this.release_apply_data_4 = []
        this.release_apply_data_5 = []

        this.release_apply_data.forEach((k,v)=>{
           if (k.release_status === 1){
             this.release_apply_data_1.push(k);
           }
           else if (k.release_status === 2){
             this.release_apply_data_2.push(k);
           }
           else if (k.release_status === 3){
             this.release_apply_data_3.push(k);
           }
           else if (k.release_status === 4){
             this.release_apply_data_4.push(k);
           }
           else {
             this.release_apply_data_5.push(k);
           }

         });
        this.classify_release_apply_data['0'] = this.release_apply_data
        this.classify_release_apply_data['1'] = this.release_apply_data_1
        this.classify_release_apply_data['2'] = this.release_apply_data_2
        this.classify_release_apply_data['3'] = this.release_apply_data_3
        this.classify_release_apply_data['4'] = this.release_apply_data_4
        this.classify_release_apply_data['5'] = this.release_apply_data_5

       },

      // 点击新建发布的弹框中的确认按钮的效果，提交发布申请的数据
      onCreateApplySubmit() {
        this.$refs.ruleForm.validate(valid => {
          if (valid) {
            let token = sessionStorage.token || localStorage.token;
            this.$axios.post(`${this.$settings.host}/release/apply`,this.new_release_form_data.form,{
              headers:{
                Authorization: "jwt " + token
              }
            })
              .then((res)=>{
                this.release_apply_data.push(res.data);
                this.classify_release_data_by_status();
                this.different_status_release_apply = this.release_apply_data;
                this.resetCreateApplyForm();
              }).catch((error)=>{

            })

          } else {
            console.log('error submit!!');
            return false;
          }
        });
      },
      // 点击新建发布的弹框中的取消按钮的效果
      resetCreateApplyForm() {
        this.$refs.ruleForm.resetFields();
        this.new_release_visible = false;
      },


      // 点击新建发布按钮的弹框效果
      new_release_apply() {
        this.choose_app_visible = true;
      },
      // 点击应用，弹出新建发布申请的弹框,获取该应用新建的最新发布对应的git仓库的分支信息和版本信息，默认先展示的是master分支相关信息
      show_new_release_apply(app_id=null) {
         console.log('app_id>> ',app_id);
         // 发送请求，获取分支数据以及不同分支的commits版本数据
        if (app_id){
          this.app_id = app_id;
        }

        this.$axios.get(`${this.$settings.host}/release/git/branch`,{
          params:{
            app_id: this.app_id,
            branchs:this.new_release_form_data.form.git_release_version,
          }
        }).then((res)=>{
          // res.data.branch_list -- ["dev" ,"master"]

          this.git_branchs = res.data.branch_list;
          this.git_branchs_commit_info = res.data.commits;
          this.new_release_form_data.form.release_record = res.data.release_record_id;
        }).catch((error)=>{

        })
        this.choose_app_visible = false;
        this.new_release_visible = true;
      },




      // // 点击新建发布的确认按钮效果
      // handle_new_release_apply(e) {
      //   console.log(e);
      //   this.new_release_visible = false;
      // },
      // 新建发布弹框中，选择不同环境的切换效果,antd官网中就有这个select事件如何使用
      envs_menu_change({item, key, selectedKeys}) {
        // console.log(item, key, selectedKeys);  key是环境id
        this.envs_id = key;
        this.change_env_event();


      },


      // 发布类型按钮点击切换效果
      handleCategoryChange(e) {

        this.apply_category = e.target.value;
        this.different_status_release_apply = this.classify_release_apply_data[this.apply_category]
        // console.log(0)
        console.log(this.apply_category, typeof this.apply_category);
      },

      // 获取所有环境数据
      get_envs_data(){
          let token = sessionStorage.token || localStorage.token;
        this.$axios.get(`${this.$settings.host}/conf_center/environment`, {
          headers:{
            Authorization: "jwt "+ token
          }
        })
        .then((res)=>{
          this.envs_data = res.data;
        }).catch((error)=>{

        })
      },


      // // 获取所有应用数据
      // get_app_data(){
      //   let token = sessionStorage.token || localStorage.token;
      //   this.$axios.get(`${this.$settings.host}/release/app`, {
      //     headers:{
      //       Authorization: "jwt "+ token
      //     }
      //   })
      //   .then((res)=>{
      //     this.app_data = res.data;
      //   }).catch((error)=>{
      //
      //   })
      // },
      // 获取所有发布申请数据

      get_release_apply_data(){
          let token = sessionStorage.token || localStorage.token;
        this.$axios.get(`${this.$settings.host}/release/apply`, {
          headers:{
            Authorization: "jwt "+ token
          }
        })
        .then((res)=>{
          this.release_apply_data = res.data;
          this.classify_release_data_by_status();
          this.different_status_release_apply = this.release_apply_data;
        }).catch((error)=>{

        })
      },
      // 获取所有发布申请的状态数据

      get_release_apply_status_data(){
          let token = sessionStorage.token || localStorage.token;
        this.$axios.get(`${this.$settings.host}/release/apply/status`, {
          headers:{
            Authorization: "jwt "+ token
          }
        })
        .then((res)=>{
          this.release_apply_status_data = res.data;
        }).catch((error)=>{

        })
      },

    },




  }
</script>

<style scoped>

</style>
```



##### 代码审核

###### 后端实现

Release/models.py添加三个字段

```python
# 先进行发布，然后进行发布申请，在发布申请阶段进行真正的发布流程
# 发布申请记录表
class ReleaseApply(BaseModel):

    release_status_choices = (
        (1, '待审核'),
        (2, '待发布'),
        (3, '发布成功'),
        (4, '发布异常'),
        (5, '其他'),
    )

    branch_or_tag_choices = (
        (1, '分支'),
        (2, '标签'),
    )

    release_record = models.ForeignKey('ReleaseRecord', on_delete=models.CASCADE, verbose_name='发布记录', related_name='release_record_apply')
    # git_release_branch = models.CharField(max_length=128,verbose_name='分支',null=True, blank=True)
    # git_release_tag = models.CharField(max_length=128,verbose_name='git标签',null=True, blank=True)
    git_release_branch_or_tag = models.IntegerField(verbose_name='分支/标签', choices=branch_or_tag_choices, default=1)
    git_release_version = models.CharField(max_length=128, verbose_name='发布版本(其实是哪个分支或者哪个标签)')
    git_release_commit_id = models.CharField(max_length=256,verbose_name='git_commit_id',null=True,blank=True)

    release_status = models.IntegerField(choices=release_status_choices, default=1, verbose_name='状态')
    user = models.ForeignKey(User, verbose_name='申请人', on_delete=models.CASCADE, related_name='release_apply_user')

    # 新增如下三个字段
    review_user = models.ForeignKey(User, verbose_name='审核人', on_delete=models.CASCADE, related_name='release_apply_review_user', null=True, blank=True)
    review_desc = models.CharField(max_length=128, null=True, blank=True, verbose_name='审核意见')
    release_user = models.ForeignKey(User, verbose_name='发布人', on_delete=models.CASCADE, related_name='release_apply_release_user', null=True, blank=True)

    class Meta:
        db_table = "hp_release_apply"
        verbose_name = "发布申请记录表"
        verbose_name_plural = verbose_name

    def git_release_branch_or_tag_name(self):
        # self.git_release_branch_or_tag # 获取choices对应的子成员的第一个信息，保存数据库中的数值
        return self.get_git_release_branch_or_tag_display() # 获取choices选项中对应的文本提示
```

执行数据库同步指令

```python
python manage.py makemigrations
python manage.py migrate
```



Release/urls.py

```python
from django.urls import path,re_path
from . import views

urlpatterns = [
    path('app', views.ReleaseAPIView.as_view()),
    path('new', views.NewReleaseAPIView.as_view()),
    path('apply', views.ReleaseApplyViewSet.as_view({'get': 'list', 'post': 'create',})),
    # 获取发布申请的状态数据 接口路径
    path('apply/status', views.ReleaseApplyStatusAPIView.as_view()),
    # 切换环境时获取当前环境下的所有发布应用
    path('envs/apps', views.EnvsAppsAPIView.as_view()),
    # 获取git 仓库的分支数据
    path('git/branch', views.GitBranchAPIView.as_view()),
    # 审核发布记录的接口，这里仅仅涉及到部分字段的修改，所以我们绑定路由的请求方法使用patch，
    # 调用ModelViewSet中partial_update
    re_path('release_ap/(?P<pk>\d+)/', views.ReleaseApplyViewSet.as_view({'patch': 'partial_update', })),
]
```

release/views.py

```python
from .serializers import ReleaseApplyModelSerializer
from rest_framework.viewsets import ModelViewSet
from .models import ReleaseApply
from rest_framework.permissions import IsAuthenticated
class ReleaseApplyViewSet(ModelViewSet):
    permission_classes = [IsAuthenticated]
    queryset = ReleaseApply.objects.filter(is_show=True, is_deleted=False).order_by("-id")
    serializer_class = ReleaseApplyModelSerializer
```

Release/serializers.py

对ReleaseApplyModelSerializer这个类做一些调整，添加上我们models里面添加的字段

```python
from .models import ReleaseApply
class ReleaseApplyModelSerializer(serializers.ModelSerializer):
    app_name = serializers.CharField(source='release_record.release_app.name', read_only=True)
    envs_name = serializers.CharField(source='release_record.envs.name', read_only=True)
    username = serializers.CharField(source='user.username', read_only=True)
    # 关于git_release_commit_id只有现在选择的是git分支时才需要传递过来进行序列化器的校验，所有我们暂时不对他进行校验，回头再补充

    class Meta:
        model = ReleaseApply
        fields = ['id', 'name', 'app_name', 'envs_name', 'git_release_branch_or_tag',
                  'git_release_branch_or_tag_name', 'git_release_version', 'release_status',
                  'get_release_status_display', 'username', 'created_time', 'release_record', 'git_release_commit_id',
                  'review_user','review_desc']

        # branch_or_tag_choices为发布申请的状态数据
        extra_kwargs = {
            'release_status': {'read_only': True},
            'created_time': {'read_only': True},

        }

    # 对数据进行额外的校验
    # def validate(self, attrs):
    #     pass

    # 自定定制create，因为保存的数据不仅仅是用提交过来的数据，并且该方法的返回值是新创建的记录的模型类对象
    def create(self, validated_data):
        # 1. self 在这里代表的就是序列化器
        # 2. self.context 是一个字典类型的数据，里面有3个成员，分别是本次客户端的request请求对象，本次调用序列化器的view视图对象，和本次客户端提交请求时的format数据格式
        # 3. self.context 是 ModelSerializerd的父类Serializer->BaseSerializer->Field中定义的，在BaseSerializer中被赋值，本质上就是 BaseSerializer的 _context属性
        # 4. self.context 的最终结果是在通用视图类 ModelViewSet的父类GenericViewSet-->GenericAPIView-->get_serializer_context方法中被最终赋值。
        user_id = self.context['request'].user.id  # 用户信息
        # user_id = 1

        new_obj = ReleaseApply.objects.create(**{
            "git_release_branch_or_tag": validated_data.get('git_release_branch_or_tag'),
            "git_release_version": validated_data.get('git_release_version'),
            "name": validated_data.get('name'),
            "git_release_commit_id": validated_data.get('git_release_commit_id'),
            "description": validated_data.get('description'),
            "release_record": validated_data.get('release_record'),
            "user_id": user_id,
        })

        return new_obj
```



###### 前端实现

```html
<template>

  <div class="release_apply">
    <!--    <h1>发布申请</h1>-->
    <div class="release_apply_category" style="display: flex;justify-content: space-between;">
      <a-radio-group :value="apply_category" @change="handleCategoryChange">
        <a-radio-button value="0">
          全部({{release_apply_data.length}})
        </a-radio-button>
        <a-radio-button :value="status_value[0]" v-for="(status_value,status_index) in release_apply_status_data" :key="status_index">
          {{status_value[1]}} ({{classify_release_apply_data[status_value[0]].length}})
        </a-radio-button>

      </a-radio-group>
      <a-button type="primary" icon="plus" @click="new_release_apply">
        新建发布申请
      </a-button>

    </div>

    <div class="choose_app">

      <a-modal v-model="choose_app_visible" title="选择应用" width="800px">
        <a-row>
          <a-col :span="6">
            <div>
              <a-menu
                :default-selected-keys="['1']"
                mode="inline"
                :inline-collapsed="collapsed"
                @select="envs_menu_change"
              >
                <a-menu-item :key="envs_value.id" v-for="(envs_value,envs_index) in envs_data" @click="change_env_event(envs_value.id)">
                  <a-icon type="pie-chart"/>
                  <span>{{envs_value.name}}</span>
                </a-menu-item>


              </a-menu>
            </div>
          </a-col>
          <a-col :span="18">
            <a-row type="flex" justify="space-around" align="middle">
              <a-col :span="8" :key="app_index" v-for="(app_value,app_index) in app_data">
                <p style="height: 80px;line-height: 80px;text-align: center">

                  <a-button @click="show_new_release_apply(app_value.release_app__id)" type="primary" style="height: 50px;width: 150px;">
                    {{app_value.release_app__name}}
                  </a-button>

                </p>
              </a-col>

            </a-row>
          </a-col>
        </a-row>


      </a-modal>
    </div>

    <div class="new_release_apply_modal">

      <a-modal v-model="new_release_visible" title="新建发布申请" width="800px" >
        <template slot="footer">
          <a-button key="back" @click="resetCreateApplyForm">
            取消
          </a-button>
          <a-button key="submit" type="primary" @click="onCreateApplySubmit">
            提交
          </a-button>
        </template>

        <div class="new_release_model_from">
          <a-form-model
            ref="ruleForm"
            :model="new_release_form_data.form"
            :rules="new_release_form_data.rules"
            :label-col="new_release_form_data.labelCol"
            :wrapper-col="new_release_form_data.wrapperCol"
          >
            <a-form-model-item ref="name" label="申请标题" prop="name">
              <a-input
                v-model="new_release_form_data.form.name"
                @blur="
          () => {
            $refs.name.onFieldBlur();
          }
        "
              />
            </a-form-model-item>
            <a-form-model-item label="选择分支/标签版本" prop="version">
              <a-input-group compact>

                <a-select style="width: 30%" v-model="new_release_form_data.form.git_release_branch_or_tag" default-value="1">

                  <a-select-option value="1">
                    branch
                  </a-select-option>
                  <a-select-option value="2">
                    Tag
                  </a-select-option>
                </a-select>
                <a-select style="width: 70%" v-model="new_release_form_data.form.git_release_version" default-value="1">
                  <a-select-option :value="branch_value" v-for="(branch_value, branch_index) in git_branchs" :key="branch_index">
                    {{branch_value}}
                  </a-select-option>

                </a-select>
              </a-input-group>
            </a-form-model-item>
            <a-form-model-item label="选择Commit ID" required prop="git_release_commit_id" v-if="new_release_form_data.form.git_release_branch_or_tag==='1'">
              <a-select v-model="new_release_form_data.form.git_release_commit_id" default-value="1">
                  <a-select-option :value="commit_info_index" v-for="(commit_info_value, commit_info_index) in git_branchs_commit_info" :key="commit_info_index">
                    {{commit_info_value}}>>>>{{commit_info_index}}
                  </a-select-option>

                </a-select>

            </a-form-model-item>


            <a-form-model-item label="备注信息" prop="description">
              <a-input v-model="new_release_form_data.form.description" type="textarea"/>
            </a-form-model-item>

          </a-form-model>
        </div>

      </a-modal>
    </div>
    <div class="release_apply_list" style="margin-top: 20px;">
      <a-table :columns="columns" :data-source="different_status_release_apply" rowKey="id">
        <a slot="action" slot-scope="text, record" v-if="record.release_status===1">
          <a-button size="small" @click="review_info(record.id)" type="link">审核</a-button> |
          <a-button size="small"  type="link">编辑</a-button> |
          <a-button size="small"  type="link">删除</a-button>
        </a>
        <a slot="action" slot-scope="text, record" v-else-if="record.release_status===2">
          <a-button size="small"  type="link">发布</a-button> |
          <a-button size="small"  type="link">查看</a-button>

        </a>
        <a slot="action" slot-scope="text, record" v-else-if="record.release_status===3">
          <a-button size="small" type="link">查看</a-button> |
          <a-button size="small"  type="link">回滚</a-button>
        </a>

        <a slot="action" slot-scope="text, record" v-else-if="record.release_status===4">
          <a-button size="small" type="link" style="color:Red;">快查看吧</a-button>

        </a>
        <a slot="action" slot-scope="text, record" v-else>
          <a-button size="small"  type="link">查看</a-button>
        </a>
      </a-table>
    </div>
    <!-- 审核发布代码记录的弹窗 -->
    <div class="review_modal">
      <a-modal v-model="review_visible" title="审核发布申请" @ok="handleReviewOk">
        <a-form-model ref="reviewForm" :model="review_data.form" :label-col="review_data.labelCol" :wrapper-col="review_data.wrapperCol">
          <a-form-model-item label="审核结果">
            <a-switch v-model="review_data.review_status"/>
          </a-form-model-item>

          <a-form-model-item label="审核意见">
            <a-input v-model="review_data.form.review_desc" type="textarea"/>
          </a-form-model-item>
        </a-form-model>
      </a-modal>
    </div>


  </div>


</template>

<script>
  const columns = [
    {title: '申请标题', width: 50, dataIndex: 'name', key: 'name',},
    {title: '应用', width: 50, dataIndex: 'app_name', key: 'app_name',},
    {title: '发布环境', dataIndex: 'envs_name', key: 'envs_name', width: 80},
    {title: '版本', dataIndex: 'git_release_commit_id', key: 'git_release_commit_id', width: 50},
    {title: '状态', dataIndex: 'get_release_status_display', key: 'get_release_status_display', width: 50},
    {title: '申请人', dataIndex: 'username', key: 'username', width: 50},
    {title: '申请时间', dataIndex: 'created_time', key: 'created_time', width: 100},

    {
      title: '操作',
      key: 'operation',
      width: 100,
      scopedSlots: {customRender: 'action'},
    },
  ];
  // const data = [];
  // for (let i = 0; i < 100; i++) {
  //   data.push({
  //     id: i,
  //     name: `Edrward ${i}`,
  //     age: 32,
  //     address: `London ${i}`,
  //   });
  // }
  export default {
    name: "ReleaseApply",
    data() {
      return {
        envs_data:[],  // 环境数据
        envs_id:1, // 所选环境的id值
        app_data:[],  // 应用数据
        release_apply_data:[],  // 发布申请数据
        classify_release_apply_data:{},  // 所有分类归纳的发布申请数据
        different_status_release_apply:[], // 点击不同分类时的 发布申请数据
        app_id:1, // 用户新建发布申请时选择的应用id
        release_apply_status_data:[],  // 发布申请状态数据

        // 根据分类划分出5个数据
        release_apply_data_1 : [], // 待审核数据
        release_apply_data_2 : [], // 待发布数据
        release_apply_data_3 : [], // 发布成功数据
        release_apply_data_4 : [], // 发布异常数据
        release_apply_data_5 : [], // 其他类型数据

        git_branchs:[], // 不同应用的新建发布对应的git仓库的分支信息
        git_branchs_commit_info:[], // 不同分支的commit版本信息，默认先获得master分支的，业务级别就定好有master分支


        columns,
        // data,
        apply_category: '0',  // 发布申请分类，默认为全部
        choose_app_visible: false,
        new_release_visible: false,

        collapsed: false, // 环境分类菜单栏数据属性

        new_release_form_data: {
          labelCol: {span: 4},
          wrapperCol: {span: 14},
          other: '',
          form: {
            name: '', // 申请标题
            git_release_branch_or_tag:'1',  // 申请选择的是git分支还是标签
            git_release_version:'master', // 分支/标签 的版本, 也就是我们选择哪个分支
            git_release_commit_id: '', // git的commit id 数据
            release_record:0,
            description: '',  // 备注信息
          },
          rules: {
            name: [
              {required: true, message: '请输入申请标题', trigger: 'blur'},
              {min: 1, max: 10, message: 'Length should be 1 to 10', trigger: 'blur'},
            ],
            git_release_branch_or_tag: [{required: true, message: '请选择分支还是标签', trigger: 'change'}],
            git_release_version: [{required: true, message: '请选择版本', trigger: 'change'}],

            git_release_commit_id: [{required: true, message: '请选择commit ID', trigger: 'change'}],

          },

        },

        review_visible: false, // 审核弹框显示或者隐藏
        review_data:{
          labelCol: { span: 4 },
          wrapperCol: { span: 14 },
          release_id:0,// 点击审核的申请记录id
          review_status: false, // 审核状态，
          form: {
            release_status: 1, // 审核状态为true时，它的值为2，表示待发布
            review_user:1,  // 审核用户的id
            review_desc: '',// 审核意见
          },
        },
      }
    },
    created() {
      this.get_envs_data();
      // this.get_app_data();
      this.change_env_event(); // 获取不同环境的应用，默认是测试环境，页面加载时触发一次，环境菜单切换时也触发
      this.get_release_apply_data();
      this.get_release_apply_status_data();
    },

    watch:{
      'new_release_form_data.form.git_release_version':function (val) {
        // this.get_branch_commit_history()
        // console.log('val', val);

        this.show_new_release_apply(); // 执行获取不同分支的版本数据

      }
    },

    methods: {

      // 切换环境时，展示对应的环境的应用
      change_env_event(){
        let token = sessionStorage.token || localStorage.token;
        this.$axios.get(`${this.$settings.host}/release/envs/apps`,{
          params:{
            envs_id:this.envs_id,
          }
        }, {
          headers:{
            Authorization: "jwt "+ token
          }
        }).then((res)=>{
          this.app_data = res.data.envs_apps_data;


        }).catch((error)=>{

        })


      },


      // 根据发布申请的状态，将发布申请数据进行分类,请求数据回来之后，就执行该方法
       classify_release_data_by_status(){
        this.release_apply_data_1 = []
        this.release_apply_data_2 = []
        this.release_apply_data_3 = []
        this.release_apply_data_4 = []
        this.release_apply_data_5 = []

        this.release_apply_data.forEach((k,v)=>{
           if (k.release_status === 1){
             this.release_apply_data_1.push(k);
           }
           else if (k.release_status === 2){
             this.release_apply_data_2.push(k);
           }
           else if (k.release_status === 3){
             this.release_apply_data_3.push(k);
           }
           else if (k.release_status === 4){
             this.release_apply_data_4.push(k);
           }
           else {
             this.release_apply_data_5.push(k);
           }

         });
        this.classify_release_apply_data['0'] = this.release_apply_data
        this.classify_release_apply_data['1'] = this.release_apply_data_1
        this.classify_release_apply_data['2'] = this.release_apply_data_2
        this.classify_release_apply_data['3'] = this.release_apply_data_3
        this.classify_release_apply_data['4'] = this.release_apply_data_4
        this.classify_release_apply_data['5'] = this.release_apply_data_5

       },

      // 点击新建发布的弹框中的确认按钮的效果，提交发布申请的数据
      onCreateApplySubmit() {
        this.$refs.ruleForm.validate(valid => {
          if (valid) {
            let token = sessionStorage.token || localStorage.token;
            this.$axios.post(`${this.$settings.host}/release/apply`,this.new_release_form_data.form,{
              headers:{
                Authorization: "jwt " + token
              }
            })
              .then((res)=>{
                this.release_apply_data.push(res.data);
                this.classify_release_data_by_status();
                this.different_status_release_apply = this.release_apply_data;
                this.resetCreateApplyForm();
              }).catch((error)=>{

            })

          } else {
            console.log('error submit!!');
            return false;
          }
        });
      },
      // 点击新建发布的弹框中的取消按钮的效果
      resetCreateApplyForm() {
        this.$refs.ruleForm.resetFields();
        this.new_release_visible = false;
      },


      // 点击新建发布按钮的弹框效果
      new_release_apply() {
        this.choose_app_visible = true;
      },
      // 点击应用，弹出新建发布申请的弹框,获取该应用新建的最新发布对应的git仓库的分支信息和版本信息，默认先展示的是master分支相关信息
      show_new_release_apply(app_id=null) {
         console.log('app_id>> ',app_id);
         // 发送请求，获取分支数据以及不同分支的commits版本数据
        if (app_id){
          this.app_id = app_id;
        }

        this.$axios.get(`${this.$settings.host}/release/git/branch`,{
          params:{
            app_id: this.app_id,
            branchs:this.new_release_form_data.form.git_release_version,
          }
        }).then((res)=>{
          // res.data.branch_list -- ["dev" ,"master"]

          this.git_branchs = res.data.branch_list;
          this.git_branchs_commit_info = res.data.commits;
          this.new_release_form_data.form.release_record = res.data.release_record_id;
        }).catch((error)=>{

        })
        this.choose_app_visible = false;
        this.new_release_visible = true;
      },




      // // 点击新建发布的确认按钮效果
      // handle_new_release_apply(e) {
      //   console.log(e);
      //   this.new_release_visible = false;
      // },
      // 新建发布弹框中，选择不同环境的切换效果,antd官网中就有这个select事件如何使用
      envs_menu_change({item, key, selectedKeys}) {
        // console.log(item, key, selectedKeys);  key是环境id
        this.envs_id = key;
        this.change_env_event();


      },

      // 发布类型按钮点击切换效果
      handleCategoryChange(e) {

        this.apply_category = e.target.value;
        this.different_status_release_apply = this.classify_release_apply_data[this.apply_category]
        // console.log(0)
        console.log(this.apply_category, typeof this.apply_category);
      },

      // 获取所有环境数据
      get_envs_data(){
          let token = sessionStorage.token || localStorage.token;
        this.$axios.get(`${this.$settings.host}/conf_center/environment`, {
          headers:{
            Authorization: "jwt "+ token
          }
        })
        .then((res)=>{
          this.envs_data = res.data;
        }).catch((error)=>{

        })
      },


      // // 获取所有应用数据
      // get_app_data(){
      //   let token = sessionStorage.token || localStorage.token;
      //   this.$axios.get(`${this.$settings.host}/release/app`, {
      //     headers:{
      //       Authorization: "jwt "+ token
      //     }
      //   })
      //   .then((res)=>{
      //     this.app_data = res.data;
      //   }).catch((error)=>{
      //
      //   })
      // },
      // 获取所有发布申请数据

      get_release_apply_data(){
          let token = sessionStorage.token || localStorage.token;
        this.$axios.get(`${this.$settings.host}/release/apply`, {
          headers:{
            Authorization: "jwt "+ token
          }
        })
        .then((res)=>{
          this.release_apply_data = res.data;
          this.classify_release_data_by_status();
          this.different_status_release_apply = this.release_apply_data;
        }).catch((error)=>{

        })
      },

      // 获取所有发布申请的状态数据
      get_release_apply_status_data(){
          let token = sessionStorage.token || localStorage.token;
        this.$axios.get(`${this.$settings.host}/release/apply/status`, {
          headers:{
            Authorization: "jwt "+ token
          }
        })
        .then((res)=>{
          this.release_apply_status_data = res.data;
        }).catch((error)=>{

        })
      },

      // 点击审核,记录id值并弹出审核对话框
      review_info(release_id) {
        console.log('release_id>>>', release_id);
        // this.$axios.put()
        this.review_data.release_id = release_id;
        this.review_visible = true;
      },
      // 审核弹框中点击提交，发送请求，修改申请记录的状态为待发布
      handleReviewOk() {
        let release_status = 1
        if( this.review_data.review_status ){
          this.review_data.form.release_status = 2;
        }else{
          this.review_data.form.release_status = 5;
        }
        let token = sessionStorage.token || localStorage.token;
        this.$axios.patch(`${this.$settings.host}/release/release_ap/${this.review_data.release_id}/`, this.review_data.form,{
          headers:{
            Authorization: "jwt " + token,
          }
        })
        .then((res)=>{
          for(let data of this.release_apply_data){
            if(data.id === res.data.id){
              data.release_status = res.data.release_status
              data.review_desc    = res.data.review_desc
              data.review_user    = res.data.review_user
            }
          }
          this.classify_release_data_by_status();
          this.different_status_release_apply = this.release_apply_data;
          this.resetReviewApplyForm();
        }).catch((error)=>{

        })

      },

      resetReviewApplyForm() {
        this.review_data.review_status = false,
        this.review_data.form = {
            release_status: 1, // 审核状态为true时，它的值为2，表示待发布
            review_user:1,     // 审核用户的id
            review_desc: '',   // 审核意见
        }
        this.apply_category = '0';
        this.review_visible = false;
      },
    },
  }
</script>

<style scoped>

</style>
```



##### 点击发布

我们必须在projects有至少一个git仓库，里面存放要发布的代码，作为我们的部署项目

###### 前端实现

创建一个ReleaseResult.vue

```html
<template>
  <div class="release_result">
    <h1>发布结果: </h1>
    <ul>
      <li :key="result_index" v-for="(result_value,result_index) in result_list">{{result_value}}</li>
    </ul>
  </div>
</template>
<script>
    export default {
      name: "ReleaseResult",
      data(){
        return {
          release_apply_id:0,
          result_list:[

          ]
        }
      },
      created() {
        let ths = this;
        this.release_apply_id = this.$route.params.id
        let ws = new WebSocket(`${this.$settings.ws_host}/ws/release/${this.release_apply_id}/`);
        ws.onmessage = function (event) {
          console.log('>>>>>',event.data);
          ths.result_list.push(event.data)
        }
      }

    }
</script>

<style scoped>

</style>

```

src/settings.js，代码：

```javascript
import zhCN from 'ant-design-vue/lib/locale-provider/zh_CN';
export default {  // 注意，对象要抛出后，其他文件中才能引入使用
  host:'http://api.hippo.cn:8000',   //http服务端 我们的后台项目将来就通过这个域名和端口来启动
  ws_host: "ws://api.hippo.cn:8000", //weboscket服务端
  locale: zhCN, // 语言
}
```



Router/index.js  配置前端路由

```js
import ReleaseResult from '@/components/ReleaseResult'
    // ....
   ,{
      path: 'release_result/:id',
      name: 'ReleaseResult',
      component: ReleaseResult,
    },
```



修改展示的每条发布记录，在发布按钮的地方添加一个router-link

```vue
        <a slot="action" slot-scope="text, record" v-else-if="record.release_status===2">
          <router-link :to="`/release_result/${record.id}`">发布</router-link> |
          <a-button size="small"  type="link">查看</a-button>
        </a>
```



###### 后端实现

由于客户端要展示部署过程中的相关信息，所以我们还是通过websocket来实现。

Consumer/routing.py

```python
from django.urls import path
from channels.routing import URLRouter
from .middleware import AuthMiddleware
from .consumers import *

# 由于我们可能会对websocket请求进行一些验证或者身份认证，所以我们在consumer应用下面在创建一个middleware文件，里面可以配置一些认证规则
ws_router = AuthMiddleware(
    URLRouter([
        # path('ws/exec/<str:token>/', ExecConsumer),
        path('ws/ssh/<int:id>/', SSHConsumer),
        path('ws/release/<int:id>/', ReleaseConsumer),
    ])
)
```



consumer/consumer.py

```python
# websocket的视图类代码
# channels中所有的webscoetk视图类，都必须直接或间接继承于WebsocketConsumer
from channels.generic.websocket import WebsocketConsumer
from host.models import Host
from threading import Thread
from hippo_api.utils.key import AppSetting
from django.conf import settings

class SSHConsumer(WebsocketConsumer):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.id = self.scope['url_route']['kwargs']['id']
        # websocket通讯的管道对象
        self.chan = None
        # 这就是基于paramiko连接远程服务器时的ssh操作对象
        self.ssh = None

    # 3 接受连接返回结果并返回给客户端    # 5 接受主机指令的执行结果，并返回给客户端
    def loop_read(self):

        while True:
            data = self.chan.recv(32 * 1024)
            if not data:
                self.close(3333)
                break
            self.send(data.decode())

    #4 结果客户端发送过来的指令，并发送给主机执行指令
    def receive(self, text_data=None, bytes_data=None):
        data = text_data or bytes_data
        print('receive:  xxxxxx',data,type(data))
        if data:
            self.chan.send(data+'\r\n')

    def disconnect(self, code):
        """websocket断开连接以后，服务端这边也要和远程主机关闭ssh通信"""
        self.chan.close()
        self.ssh.close()
        print('Connection close')

    # 1 请求来了自动触发父类connect方法，我们继承拓展父类的connect方法，因为我们和客户端建立连接的同时，就可以和客户端想要操作的主机建立一个ssh连接通道。
    def connect(self):
        print('connect连接来啦')
        self.accept()  # 建立websocket连接，进行连接的三次握手
        self._init()   # 建立和主机的ssh连接

    # 2 建立和主机的ssh连接
    def _init(self):
        # self.send(bytes_data=b'Connecting ...\r\n')
        self.send('Connecting ...\r\n')
        host = Host.objects.filter(pk=self.id).first()
        if not host:
            self.send(text_data='Unknown host\r\n')
            self.close()
        try:
            primary_key, public_key = AppSetting.get(settings.DEFAULT_KEY_NAME)
            self.ssh = host.get_ssh(primary_key).get_client()

        except Exception as e:
            self.send(f'Exception: {e}\r\n')
            self.close()
            return

        self.chan = self.ssh.invoke_shell(term='xterm') # invoke_shell激活shell终端模式，也就是长连接模式，exec_command()函数是将服务器执行完的结果一次性返回给你；invoke_shell()函数类似shell终端，可以将执行结果分批次返回，所以我们接受数据时需要循环的取数据

        self.chan.transport.set_keepalive(30)  # 连接中没有任何信息时，该连接能够维持30秒

        # 和主机的连接一旦建立，主机就会将连接信息返回给服务端和主机的连接通道中，并且以后我们还要在这个通道中进行指令发送和指令结果的读取，所以我们开启单独的线程，去连接中一直等待和获取指令执行结果的返回数据
        Thread(target=self.loop_read).start()


from django.conf import settings
# 发布过程记录的类
from release.models import ReleaseApply
import subprocess,json,os


def put_code_to_target(host_obj,cli,cmd_list, obj):
    """推送代码到远程主机"""
    pass

class ReleaseConsumer(WebsocketConsumer):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # self.user = self.scope['user']
        # print('SSHConsumer>>>41')
        self.id = self.scope['url_route']['kwargs']['id']
        print('>>>>id', self.id)
        # print(self.scope['url_route'])
        self.chan = None
        self.ssh = None

    def connect(self):
        print('发布连接来啦！！！！')
        self.accept()
        self._init()

    def _init(self):
        self.send('Connecting ...\r\n')
        # 查询本次发布的记录
        release_apply_obj = ReleaseApply.objects.filter(pk=self.id).first()
        release_record_obj = release_apply_obj.release_record
        # print(release_record_obj)

        # 1 检出(git clone)前的动作
        self.send('执行检出前的动作。。。')

        '''
            filefilterway   文件过滤方式
            file_filter_cmd_content  过滤的文件或目录
            before_code_check_out_value  代码检出前的指令(针对本机)
            before_release_content  代码发布前的指令(针对目标主机)
            custom_global_variable 部署运行的项目时给项目设置的全局变量
            after_code_check_out_value  代码检出后的指令(针对本机)
            after_release_value 代码发布后的指令(针对目标主机)
        '''
        code, output = subprocess.getstatusoutput(release_record_obj.before_code_check_out_value)
        # code, output = subprocess.getstatusoutput(release_record_obj.before_code_check_out_value)
        if code != 0:
            error_msg = {
                'step': 1,  # 表示自动化部署进行到第几步了
                'error': output, # 错误信息
                'status': 1,  # status不等于0，表示有错误
            }
            error_msg_str = json.dumps(error_msg)

            self.send(error_msg_str) # 发送错误信息
            self.close()  # 并关闭wbsocket通道
            # 并还原为执行动作之前的状态（这里我就不写了）
            return code
        self.send('执行代码检出前动作完成。。。')

        # 2 检出代码
        self.send('执行代码检出中。。。')
        # git仓库地址
        git_addr = release_record_obj.code_git_addr
        # git仓库的存储目录
        git_path_name = "/".join(git_addr.split("@")[-1].replace(":", "/")[:-4].split("/")[:-1])
        # # 获取项目名称，方便后面创建文件夹和打包项目代码目录
        pro_name = git_addr.rsplit('/')[-1].split('.')[0]
        git_code_dir = settings.GIT_CODE_DIR
        git_dir_path = f'{git_code_dir}/{git_path_name}'  # '/home/moluo/Desktop/hippo/hippo_api/projects/gitee.com/mooluo_admin'
        git_pro_path = f'{git_code_dir}/{git_path_name}/{pro_name}'  # '/home/moluo/Desktop/hippo/hippo_api/projects/gitee.com/mooluo_admin/hippo'

        # print('project_name>>', project_name)
        if os.path.exists(git_pro_path):
            code, output = subprocess.getstatusoutput(f'cd {git_pro_path} && git pull {git_addr}')
        else:
            code, output = subprocess.getstatusoutput(f'mkdir -p -m 777 {git_dir_path} && cd {git_dir_path} && git clone {git_addr} && cd {pro_name} && git branch -r')
        # code, output = subprocess.getstatusoutput(f'git clone {release_record_obj.code_git_addr}')
        if code != 0:
            error_msg = {
                'step': 2,
                'error': output,
                'status': 1,
            }
            error_msg_str = json.dumps(error_msg)

            self.send(error_msg_str)# 发送错误信息
            self.close()  # 并关闭wbsocket通道
            # 并还原为执行动作之前的状态（这里我就不写了）
            return code

        self.send('执行代码检出完成。。。')

        # 3 检出后动作
        self.send('执行代码检出后的动作。。。')
        code, output = subprocess.getstatusoutput(f'cd {git_dir_path} && {release_record_obj.after_code_check_out_value} {pro_name}.tar.gz {pro_name}')
        # code, output = subprocess.getstatusoutput(release_record_obj.after_code_check_out_value)
        if code != 0:
            error_msg = {
                'step': 3,
                'error': output,
                'status': 1,
            }
            error_msg_str = json.dumps(error_msg)
            self.send(error_msg_str)  # 发送错误信息

            self.close()  # 并关闭wbsocket通道
            # 并还原为执行动作之前的状态

        self.send('执行代码检出后的动作完成。。。')
        # 如果检出没有问题的话，代码继续往下面执行
        # self.send('执行代码发布前动作。。。')
        # 后面3步是在点击发布的时候进行的

        # 4. 发布前，对目标主机执行的动作
        release_record_detail_list = release_record_obj.release_record.all()

        # 根据本次发布查询到的主机列表
        target_host_list = []
        for record_detail in release_record_detail_list:
            target_host_list.append(record_detail.hosts)

        # 开启多线程或者线程池来并发执行多个主机的代码推送
        # 并且将推送的结果和错误保存到redis中，
        # 将代码发布前  发布  发布后的指令作为成一个列表交给线程任务
        cmd_list = [
            {'step': '4','cmd': release_record_obj.before_release_content, 'msg': '代码发布前动作。。。', },

            {'step': '5','cmd': 'ls', 'msg': '代码发布中。。。', 'local_path': f'{git_dir_path}/{pro_name}.tar.gz', 'remote_path': f'{release_record_obj.target_host_pub_path}/{pro_name}.tar.gz'},

            {'step': '6','cmd': release_record_obj.after_release_value, 'msg': '代码发布后动作。。。', }

        ]

        # print('---',target_host_list)
        # pkey = AppSetting.get('private_key')
        # for host_obj in target_host_list:
        #     cli = host_obj.get_ssh(pkey)
        #     put_code_to_target(host_obj,cli,cmd_list, self)

        primary_key, public_key = AppSetting.get(settings.DEFAULT_KEY_NAME)
        t_list = []
        for host_obj in target_host_list:
            cli = host_obj.get_ssh(primary_key)
            # print(cli)
            t = Thread(target=put_code_to_target, args=(host_obj,cli,cmd_list, self) )
            t.start()
            t_list.append(t)

        for tt in t_list:
            tt.join()

        # self.send(json.dumps(a))
        self.send('代码发布完成！！！！')

        self.close()  # 并关闭wbsocket通道
        # 并还原为执行动作之前的状态
```



**推送代码到远程主机中**

`consumer.consumers`，代码：

```python
# websocket的视图类代码
# channels中所有的webscoetk视图类，都必须直接或间接继承于WebsocketConsumer
from channels.generic.websocket import WebsocketConsumer
from host.models import Host
from threading import Thread
from hippo_api.utils.key import AppSetting
from django.conf import settings

class SSHConsumer(WebsocketConsumer):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.id = self.scope['url_route']['kwargs']['id']
        # websocket通讯的管道对象
        self.chan = None
        # 这就是基于paramiko连接远程服务器时的ssh操作对象
        self.ssh = None

    # 3 接受连接返回结果并返回给客户端    # 5 接受主机指令的执行结果，并返回给客户端
    def loop_read(self):

        while True:
            data = self.chan.recv(32 * 1024)
            if not data:
                self.close(3333)
                break
            self.send(data.decode())

    #4 结果客户端发送过来的指令，并发送给主机执行指令
    def receive(self, text_data=None, bytes_data=None):
        data = text_data or bytes_data
        print('receive:  xxxxxx',data,type(data))
        if data:
            self.chan.send(data+'\r\n')

    def disconnect(self, code):
        """websocket断开连接以后，服务端这边也要和远程主机关闭ssh通信"""
        self.chan.close()
        self.ssh.close()
        print('Connection close')

    # 1 请求来了自动触发父类connect方法，我们继承拓展父类的connect方法，因为我们和客户端建立连接的同时，就可以和客户端想要操作的主机建立一个ssh连接通道。
    def connect(self):
        print('connect连接来啦')
        self.accept()  # 建立websocket连接，进行连接的三次握手
        self._init()   # 建立和主机的ssh连接

    # 2 建立和主机的ssh连接
    def _init(self):
        # self.send(bytes_data=b'Connecting ...\r\n')
        self.send('Connecting ...\r\n')
        host = Host.objects.filter(pk=self.id).first()
        if not host:
            self.send(text_data='Unknown host\r\n')
            self.close()
        try:
            primary_key, public_key = AppSetting.get(settings.DEFAULT_KEY_NAME)
            self.ssh = host.get_ssh(primary_key).get_client()

        except Exception as e:
            self.send(f'Exception: {e}\r\n')
            self.close()
            return

        self.chan = self.ssh.invoke_shell(term='xterm') # invoke_shell激活shell终端模式，也就是长连接模式，exec_command()函数是将服务器执行完的结果一次性返回给你；invoke_shell()函数类似shell终端，可以将执行结果分批次返回，所以我们接受数据时需要循环的取数据

        self.chan.transport.set_keepalive(30)  # 连接中没有任何信息时，该连接能够维持30秒

        # 和主机的连接一旦建立，主机就会将连接信息返回给服务端和主机的连接通道中，并且以后我们还要在这个通道中进行指令发送和指令结果的读取，所以我们开启单独的线程，去连接中一直等待和获取指令执行结果的返回数据
        Thread(target=self.loop_read).start()


from django.conf import settings
# 发布过程记录的类
from release.models import ReleaseApply
import subprocess,json,os


def put_code_to_target(host_obj, cli, cmd_list, self):
    """推送代码到远程主机"""
    for cmd_info in cmd_list:
        self.send(cmd_info.get('msg'))
        if cmd_info.get('step') == '5':
            try:
                # 创建代码存储目录
                code, output = cli.exec_command(f"mkdir -p -m 777 {cmd_info.get('remote_dir')}")
                # 上传文件
                cli.put_file(cmd_info.get('local_path'), cmd_info.get('remote_path'))
                # 解压文件
                code, output = cli.exec_command(f"cd {cmd_info.get('remote_dir')} && tar -zxf {cmd_info.get('remote_path')}" )
            except Exception as e:
                error_msg = {
                    'step': cmd_info.get('step'),  # 表示自动化部署进行到第几步了
                    'error': str(e),  # 错误信息
                    'ip_addr': host_obj.ip_addr,  # 错误主机ip地址
                    'hostname': host_obj.name,  # 错误主机名称
                    'status': 1,  # status不等于0，表示有错误
                }
                error_msg_str = json.dumps(error_msg)
                self.send(error_msg_str)  # 发送错误信息
                self.close()  # 并关闭wbsocket通道
                break
        else:
            code, output = cli.exec_command(cmd_info.get('cmd'))
            if code != 0:
                # host_obj
                error_msg = {
                    'step': cmd_info.get('step'),  # 表示自动化部署进行到第几步了
                    'error': output,  # 错误信息
                    'ip_addr': host_obj.ip_addr,  # 错误主机ip地址
                    'hostname': host_obj.name,  # 错误主机名称
                    'status': 1,  # status不等于0，表示有错误
                }
                error_msg_str = json.dumps(error_msg)
                self.send(error_msg_str)  # 发送错误信息
                self.close()  # 并关闭wbsocket通道
                break


class ReleaseConsumer(WebsocketConsumer):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # self.user = self.scope['user']
        # print('SSHConsumer>>>41')
        self.id = self.scope['url_route']['kwargs']['id']
        print('>>>>id', self.id)
        # print(self.scope['url_route'])
        self.chan = None
        self.ssh = None

    def connect(self):
        print('发布连接来啦！！！！')
        self.accept()
        self._init()

    def _init(self):
        self.send('Connecting ...\r\n')
        # 查询本次发布的记录
        release_apply_obj = ReleaseApply.objects.filter(pk=self.id).first()
        release_record_obj = release_apply_obj.release_record
        # print(release_record_obj)

        # 1 检出(git clone)前的动作
        self.send('执行检出前的动作。。。')

        '''
            filefilterway   文件过滤方式
            file_filter_cmd_content  过滤的文件或目录
            before_code_check_out_value  代码检出前的指令(针对本机)
            before_release_content  代码发布前的指令(针对目标主机)
            custom_global_variable 部署运行的项目时给项目设置的全局变量
            after_code_check_out_value  代码检出后的指令(针对本机)
            after_release_value 代码发布后的指令(针对目标主机)
        '''
        code, output = subprocess.getstatusoutput(release_record_obj.before_code_check_out_value)
        if code != 0:
            error_msg = {
                'step': 1,  # 表示自动化部署进行到第几步了
                'error': output, # 错误信息
                'status': 1,  # status不等于0，表示有错误
            }
            error_msg_str = json.dumps(error_msg)

            self.send(error_msg_str) # 发送错误信息
            self.close()  # 并关闭wbsocket通道
            # 并还原为执行动作之前的状态（这里我就不写了）
            return code
        self.send('执行代码检出前动作完成。。。')

        # 2 检出代码
        self.send('执行代码检出中。。。')
        # git仓库地址
        git_addr = release_record_obj.code_git_addr
        # git仓库的存储目录
        git_path_name = "/".join(git_addr.split("@")[-1].replace(":", "/")[:-4].split("/")[:-1])
        # # 获取项目名称，方便后面创建文件夹和打包项目代码目录
        pro_name = git_addr.rsplit('/')[-1].split('.')[0]
        git_code_dir = settings.GIT_CODE_DIR
        git_dir_path = f'{git_code_dir}/{git_path_name}'  # '/home/moluo/Desktop/hippo/hippo_api/projects/gitee.com/mooluo_admin'
        git_pro_path = f'{git_code_dir}/{git_path_name}/{pro_name}'  # '/home/moluo/Desktop/hippo/hippo_api/projects/gitee.com/mooluo_admin/hippo'

        if os.path.exists(git_pro_path):
            code, output = subprocess.getstatusoutput(f'cd {git_pro_path} && git pull {git_addr}')
        else:
            code, output = subprocess.getstatusoutput(f'mkdir -p -m 777 {git_dir_path} && cd {git_dir_path} && git clone {git_addr} && cd {pro_name} && git branch -r')
        if code != 0:
            error_msg = {
                'step': 2,
                'error': output,
                'status': 1,
            }
            error_msg_str = json.dumps(error_msg)

            self.send(error_msg_str)# 发送错误信息
            self.close()  # 并关闭wbsocket通道
            # 并还原为执行动作之前的状态（这里我就不写了）
            return code

        self.send('执行代码检出完成。。。')

        # 3 检出后动作
        self.send('执行代码检出后的动作。。。')
        code, output = subprocess.getstatusoutput(f'cd {git_dir_path} && {release_record_obj.after_code_check_out_value} {pro_name}.tar.gz {pro_name}')
        # code, output = subprocess.getstatusoutput(release_record_obj.after_code_check_out_value)
        if code != 0:
            error_msg = {
                'step': 3,
                'error': output,
                'status': 1,
            }
            error_msg_str = json.dumps(error_msg)
            self.send(error_msg_str)  # 发送错误信息

            self.close()  # 并关闭wbsocket通道
            # 并还原为执行动作之前的状态

        self.send('执行代码检出后的动作完成。。。')
        # 如果检出没有问题的话，代码继续往下面执行
        # self.send('执行代码发布前动作。。。')
        # 后面3步是在点击发布的时候进行的

        # 4. 发布前，对目标主机执行的动作
        release_record_detail_list = release_record_obj.release_record.all()

        # 根据本次发布查询到的主机列表
        target_host_list = []
        for record_detail in release_record_detail_list:
            target_host_list.append(record_detail.hosts)

        # 开启多线程或者线程池来并发执行多个主机的代码推送
        # 并且将推送的结果和错误保存到redis中，
        # 将代码发布前  发布  发布后的指令作为成一个列表交给线程任务
        cmd_list = [
            {'step': '4','cmd': release_record_obj.before_release_content, 'msg': '代码发布前动作。。。', },

            {'step': '5','cmd': "", 'msg': '代码发布中。。。', 'local_path': f'{git_dir_path}/{pro_name}.tar.gz', 'remote_path': f'{release_record_obj.target_host_pub_path}/{pro_name}.tar.gz', 'remote_dir': release_record_obj.target_host_pub_path},

            {'step': '6','cmd': release_record_obj.after_release_value, 'msg': '代码发布后动作。。。', }

        ]

        # print('---',target_host_list)
        # primary_key, public_key = AppSetting.get(settings.DEFAULT_KEY_NAME)
        # for host_obj in target_host_list:
        #     cli = host_obj.get_ssh(primary_key)
        #     put_code_to_target(host_obj,cli,cmd_list, self)

        primary_key, public_key = AppSetting.get(settings.DEFAULT_KEY_NAME)
        t_list = []
        for host_obj in target_host_list:
            cli = host_obj.get_ssh(primary_key)
            print(f"cli={cli}")
            t = Thread(target=put_code_to_target, args=(host_obj,cli,cmd_list, self) )
            t.start()
            t_list.append(t)

        for tt in t_list:
            tt.join()

        self.send('代码发布完成！！！！')

        self.close()  # 并关闭wbsocket通道
        # 并还原为执行动作之前的状态
```

新增put_file上传文件方法，并解决ssh的连接断开以后，client属性没有清空导致出错的bug。

```python
from paramiko.client import SSHClient, AutoAddPolicy
from paramiko.config import SSH_PORT
from paramiko.rsakey import RSAKey
from paramiko.ssh_exception import AuthenticationException, SSHException
from io import StringIO

class SSH(object):
    def __init__(self,hostname, port=SSH_PORT, username='root', pkey=None, password=None, connect_timeout=30):
        if pkey is None and password is None:
            raise SSHException('私钥或者密码必须有一个不为空')

        self.client = None

        self.arguments = {
            'hostname': hostname,
            'port'    : port,
            'username': username,
            'password': password,
            'pkey'    : RSAKey.from_private_key(StringIO(pkey)) if isinstance(pkey, str) else pkey,
            'timeout' : connect_timeout,
        }

        # print(self.arguments)

    @staticmethod
    def generate_key():
        # 生成公私钥键值对
        key_obj = StringIO()
        key = RSAKey.generate(2048) # 生成长度为2024的秘钥对
        key.write_private_key(key_obj)
        # 返回值是一个元祖，两个成员分别是私钥和公钥
        return key_obj.getvalue(), 'ssh-rsa ' + key.get_base64()

    # 将公钥上传到对应主机
    def add_public_key(self, public_key):
        # 700 是文档拥有可读可写可执行，同一组用户或者其他用户都不具有操作权限
        # 600 是文件拥有者可读可写，不可执行，同一组用户或者其他用户都不具有操作权限
        command = f'mkdir -p -m 700 ~/.ssh && \
        echo {public_key!r} >> ~/.ssh/authorized_keys && \
        chmod 600 ~/.ssh/authorized_keys'
        code, out = self.exec_command(command)
        print(f"code={code},out={out},command={command}")
        if code != 0:
            raise SSHException(f'添加公钥失败: {out}')

    def exec_command(self, command, timeout=1800, environment=None):
        # 设置执行指令过程，一旦遇到错误/异常，则直接退出操作，不再继续执行。
        command = 'set -e\n' + command
        with self as cli:
            chan = cli.get_transport().open_session()
            chan.settimeout(timeout)
            chan.set_combine_stderr(True)  # 正确和错误输出都在一个管道对象里面输出出来
            # if environment:
            #     str_env = ' '.join(f"{k}='{v}'" for k, v in environment.items())
            #     command = f'export {str_env} && {command}'
            chan.exec_command(command)
            stdout = chan.makefile("rb", -1)
            return chan.recv_exit_status(), self._decode(stdout.read())

    def _decode(self, out: bytes):
        # 解码方法[把bytes类型数据转换成普通字符]
        try:
            return out.decode()
        except UnicodeDecodeError:
            return out.decode('GBK')

    # 检测连接并获取连接
    def ping(self):
        """ping远程主机，连接成功则返回True"""

        with self: # self 实际上就是 self.get_client() 的 返回值
            print("ping......")
            return True

    def put_file(self, lacal_path, remote_path, callback=None):
        """
        根据本地路径上传文件到远程主机
        """
        with self as cli:
            sftp = cli.open_sftp()
            sftp.put(lacal_path, remote_path, callback=callback)
            sftp.close()

    def put_file_by_fl(self, fl, remote_path, callback=None):
        """
        上传文件到远程主机
        fl:文件对象(文件句柄或类文件句柄)
        remote_path: 远程主机中存储当前文件的路径
        callback: 上传文件以后的回调方法
        """
        with self as cli:
            sftp = cli.open_sftp()
            # 这里之所以上传的是文件对象的主要原因是我们api服务器上传到远程主机的文件，往往来自于客户端上传过来的。
            # 所以我们api服务器中得到的本来就是一个文件对象，因此没必要保存到api服务器，直接转发给远程主机即可
            sftp.putfo(fl, remote_path, callback=callback)
            sftp.close()

    # 从远程主机下载文件到本地
    def download_file(self, local_path, remote_path):
        """
        local_path: 指定保存下载文件的本地地址
        remote_path: 要下载文件在远程主机的路径
        """
        with self as cli:
            sftp = cli.open_sftp()
            sftp.get(remote_path, local_path)

    # 获取指定目录路径下的文件和文件夹列表详细信息,结果为列表，列表里面的每一项是from paramiko.sftp_attr import SFTPAttributes  类的对象，通过对象.属性可以获取对应的数据，比如获取修改时间用对象.st_mtime
    def list_dir_attr(self, remote_path):
        with self as cli:
            sftp = cli.open_sftp()
            return sftp.listdir_attr(remote_path)

    # 根据指定路径删除对应文件,没有对应文件会报错，有返回None
    def remove_file(self, remote_path):
        with self as cli:
            sftp = cli.open_sftp()
            sftp.remove(remote_path)

    # 删除远程主机上的目录
    def remove_dir(self, remote_path):
        with self as cli:
            sftp = cli.open_sftp()
            sftp.rmdir(remote_path)

    # 获取文件详情
    def file_stat(self, remote_path):
        with self as cli:
            sftp = cli.open_sftp()
            return sftp.stat(remote_path)

    # 直接获取连接
    def get_client(self):
        if self.client is not None:
            return self.client
        try:
            # 创建客户端连接对象
            self.client = SSHClient()
            # 在本机第一次连接远程主机时记录指纹信息
            self.client.set_missing_host_key_policy(AutoAddPolicy)
            # 建立连接
            self.client.connect(**self.arguments)
        except AuthenticationException as e:
          return None

        return self.client

    # with self: 先执行__enter__方法
    def __enter__(self):
        if self.client is not None:
            # 告知当前执行上下文，self.client已经实例化
            raise RuntimeError('已经建立连接了！！！')

        return self.get_client()
        # with self: 语句体内容结束后执行如下方法 先执行__enter__方法

    def __exit__(self, Type, value, traceback):
        self.client.close()
        self.client = None
```
