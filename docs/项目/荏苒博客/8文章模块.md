# 文章模块

创建子引用

```bash
cd renranapi/apps
python ../../manage.py startapp article
```

注册子应用settings/dev.py，代码：

```python
INSTALLED_APPS = [
	# ....
    'article',

]
```



## 模型代码

aricle/models.py,代码:

```python
from django.db import models
from renranapi.utils.models import BaseModel
from users.models import User

class ArticleCollection(BaseModel):
    user = models.ForeignKey(User, related_name="mycollections", on_delete=models.DO_NOTHING, verbose_name="用户")
    name = models.CharField(max_length=150, db_index=True, verbose_name="文集名称")

    class Meta:
        db_table = "rr_article_collection"
        verbose_name = "文集"
        verbose_name_plural = verbose_name

class Article(BaseModel):
    title = models.CharField(max_length=150, db_index=True, verbose_name="文章")
    content = models.TextField(verbose_name="文章内容")
    html_content = models.TextField(verbose_name="文章内容[html格式]")
    user = models.ForeignKey(User,related_name="myarticles", on_delete=models.DO_NOTHING, verbose_name="作者")
    collection = models.ForeignKey(ArticleCollection, related_name="article_list", on_delete=models.CASCADE, verbose_name="文集")
    pub_date = models.DateTimeField(null=True, default=None, verbose_name="发布时间")
    access_pwd = models.CharField(max_length=15, null=True, blank=True, verbose_name="访问密码")
    read_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="阅读量")
    like_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="点赞量")
    collect_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="收藏量")
    comment_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="评论量")
    reward_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="赞赏量")
    is_public = models.BooleanField(default=False, verbose_name="是否公开")

    class Meta:
        db_table = "rr_article"
        verbose_name = "文章"
        verbose_name_plural = verbose_name

class ArticleSpecial(BaseModel):
    """专题模型"""
    image = models.ImageField(null=True, blank=True, verbose_name="封面图片")
    notice = models.TextField(null=True, blank=True, verbose_name="专题公告")
    article_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="文章总数")
    follow_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="关注数量")
    user = models.ForeignKey(User,related_name="myspecials", on_delete=models.DO_NOTHING, verbose_name="创建人")

    class Meta:
        db_table = "rr_article_special"
        verbose_name = "专题"
        verbose_name_plural = verbose_name

class ArticlePostSpecial(BaseModel):
    """文章和专题的绑定关系"""
    STATUS_OPTION = (
        (0, "投稿中"),
        (1, "等待审核"),
        (2, "已审核"),
        (3, "审核不通过"),
    )
    article = models.ForeignKey(Article, on_delete=models.CASCADE, verbose_name="文章")
    special = models.ForeignKey(ArticleSpecial, on_delete=models.CASCADE, verbose_name="专题")
    status = models.SmallIntegerField(choices=STATUS_OPTION, default=0, verbose_name="审核状态")
    user = models.ForeignKey(User, null=True, blank=True, on_delete=models.DO_NOTHING, verbose_name="审核管理员")

    class Meta:
        db_table = "rr_article_post_special"
        verbose_name = "专题的文章"
        verbose_name_plural = verbose_name

class SpecialManager(BaseModel):
    """专题管理员"""
    user = models.ForeignKey(User, on_delete=models.DO_NOTHING, verbose_name="用户")
    special = models.ForeignKey(ArticleSpecial, on_delete=models.CASCADE, verbose_name="专题")

    class Meta:
        db_table = "rr_special_manager"
        verbose_name = "专题管理员"
        verbose_name_plural = verbose_name

class SpecialFocus(BaseModel):
    """专题关注"""
    user = models.ForeignKey(User, on_delete=models.DO_NOTHING, verbose_name="用户")
    special = models.ForeignKey(ArticleSpecial, on_delete=models.CASCADE, verbose_name="专题")

    class Meta:
        db_table = "rr_special_focus"
        verbose_name = "专题粉丝"
        verbose_name_plural = verbose_name

class ArticleImage(BaseModel):
    """文章图片素材库"""
    group = models.CharField(max_length=15, null=True, blank=True, verbose_name="组名")
    image = models.ImageField(null=True, blank=True, verbose_name="图片地址")
    sha1_files = models.CharField(max_length=64, null=True, blank=True, verbose_name="文件指纹")

    class Meta:
        db_table = "rr_article_image"
        verbose_name = "文章图片"
        verbose_name_plural = verbose_name
```

数据迁移

```
python manage.py makemigrations
python manage.py migrate
```



## 相关依赖

### 在vue中引入集成markdown富文本编辑器

这里我们使用 mavonEditor，链接：https://github.com/hinesboy/mavonEditor

#### 安装

```bash
cd renran_pc
npm install mavon-editor --save
```

在main.js中注册编辑器组件

```javascript
    import mavonEditor from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
	// 注册mavon-editor组件
    Vue.use(mavonEditor);
```



## 写文章页面

创建Writer.vue组件，提供给用户编写文章

```vue
<template>
  <div class="write">
    <div class="_2v5v5">
      <div class="_3zibT"><a href="/">回首页</a></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=true"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." name="name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w _31PCv" title="日记本">
          <div class="_3P4JX _2VLy-">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="true?'':'NvfK4'">
                <li class="_2po2r cRfUr" title="">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" title="">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>日记本</span>
        </li>
        <li class="_3DM7w" title="随笔"><span>随笔</span></li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv _33nt7" title="ABC">
                <i class="_13kgp _2m93u"></i>
                <div class="_3P4JX poOXI">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn">
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" title="随笔"><span class="">随笔</span></li>
                          </ul>
                        </div>
                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">ABC</span>
                <span class="hLzJv">题目：有四个数字：1、2、3、4，能组成多少个互不相同且无重复数字的三位数？各是多少？

题目：企业发放的奖金根据利润提成</span>
                <span class="_29C-V">字数:905</span>
              </li>
              <li class="_25Ilv" title="2020-01-12">
                <i class="_13kgp"></i>
                <span class="NariC">2020-01-12</span>
                <span class="hLzJv">题目：有四个数字：1、2、3、4，能组成多少个互不相同且无重复数字的三位数？各是多少？

题目：企业发放的奖金根据利润提成</span>
              </li>
            </ul>
            <div class="_2cVn3"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" value="2020-01-12">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>
  </div>
</template>
<script>
  import { mavonEditor } from 'mavon-editor'
  import 'mavon-editor/dist/css/index.css'
    export default {
        name: "Writer",
        data(){
            return {
                editorContent:"",
                img_file:[],
                collection_form:false,
            }
        },
        watch:{
            editorContent(){
                console.log(this.editorContent)
            }
        },
        mounted(){
            document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
        },
        components: {
          mavonEditor
        },
        methods:{
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          }
        }
    }
</script>

<style scoped>
  body *{
    box-sizing: border-box;
  }
  .write{
    position: absolute;
    top: 0;
    right: 0;
    left: 0;
    bottom: 0;
    margin: 0;
  }
  ._2v5v5 {
    position: relative;
    height: 100%;
    overflow-y: auto;
    background-color: #404040;
    color: #f2f2f2;
    z-index: 100;
    width: 16.66666667%;
    display: block;
    flex: 0 0 auto;
    float: left;
    padding-right: 0;
    padding-left: 0;
    min-height: 1px;
  }
  ._3zibT {
    padding: 30px 18px 5px;
    text-align: center;
    font-size: 14px;
  }
  ._3zibT a {
    display: block;
    font-size: 15px;
    padding: 9px 0;
    color: #ec7259;
    border: 1px solid rgba(236,114,89,.8);
    border-radius: 20px;
    -webkit-transition: border-color .2s ease-in;
    -o-transition: border-color .2s ease-in;
    transition: border-color .2s ease-in;
  }
  ._1iZMb {
    padding: 0 15px;
    margin-top: 20px;
    margin-bottom: 10px;
    font-size: 14px;
    line-height: 1.5;
  }
  ._1iZMb ._33Zlg {
    cursor: pointer;
    color: #f2f2f2;
    transition: color .2s cubic-bezier(.645,.045,.355,1);
    font-size: 14px;
  }
  ._1iZMb ._33Zlg .fa+span {
    margin-left: 4px;
  }
  ._1iZMb ._2G97m {
    overflow: hidden;
  }
  ._1iZMb ._2a1Rp {
    height: 85px;
    opacity: 1;
    margin-top: 10px;
    transition: all .2s ease-out;
    overflow: hidden;
  }
  ._1CtV4 {
    width: 100%;
    height: 35px;
    color: #ccc;
    background-color: #595959;
    border: 1px solid #333;
    padding: 4px 6px;
    font-size: 14px;
    line-height: 20px;
    outline: 0;
    overflow: visible;
    margin: 10px 0 0;
    margin-bottom: 10px;
  }
._3zXcJ {
    position: relative;
    display: inline-block;
    text-align: center;
    height: 30px;
    line-height: 20px;
    padding: 4px 12px;
    border: 1px solid transparent;
    border-radius: 15px;
    font-size: 14px;
    font-weight: 500;
    -ms-touch-action: manipulation;
    touch-action: manipulation;
    cursor: pointer;
    background-image: none;
    white-space: nowrap;
    user-select: none;
    transition: all .2s cubic-bezier(.645,.045,.355,1);
    text-transform: none;
    color: #42c02e;
    border-color: #42c02e;
    margin-left: 4px;
    background-color: #404040;
  }
  .vIzwB {
    color: #999;
    outline: 0;
  }
  ._1iZMb ._1mU5v {
    height: 0;
    opacity: 0;
    margin-top: 0;
  }
  ._1iZMb ._2a1Rp {
    height: 85px;
    opacity: 1;
    margin-top: 10px;
  }
  ._1iZMb ._1mU5v, ._1iZMb ._2a1Rp {
    transition: all .2s ease-out;
  }
  .vIzwB, .vIzwB:focus, .vIzwB:hover {
    background-color: #404040;
    border-color: transparent;
  }
  .dwU8Q {
      margin-left: 4px;
      background-color: #404040;
  }
._3t059 {
    position: relative;
    z-index: 0;
    background-color: #8c8c8c;
}
._3MbJ4 {
    margin-bottom: 0;
}
._3DM7w {
    position: relative;
    line-height: 40px;
    list-style: none;
    font-size: 15px;
    color: #f2f2f2;
    background-color: #404040;
    padding: 0 15px;
    cursor: pointer;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
._31PCv {
    background-color: #666;
    border-left: 3px solid #ec7259;
    padding-left: 12px;

}
._3DM7w ._2VLy- {
    float: right;
}
._3P4JX {
    font-size: 16px;
    width: 40px;
    text-align: center;
    position: relative;
    min-height: 30px;
    max-height: 50px;
}
._3DM7w span {
    display: block;
    margin-right: 20px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
._2w9pn {
    font-size: 14px;
    -webkit-box-shadow: 0 5px 10px rgba(0,0,0,.2);
    box-shadow: 0 5px 10px rgba(0,0,0,.2);
    list-style: none;
    background-color: #fff;
    color: #595959;
    border-radius: 6px;
}
._3P4JX ul._2V8zt {
    display: none;
    position: absolute;
    z-index: 99;
    right: 0;
}
._3P4JX ul._3FcHm {
    top: 100%;
}
._2po2r {
    padding: 10px 20px;
    line-height: 20px;
    white-space: nowrap;
    text-align: left;
    position: relative;
    border-bottom: 1px solid #d9d9d9;
}
._3DM7w:hover, .JUBSP {
    background-color: #666;
}
.h-5Am {
    display: block;
    width: 16.66666667%;
    position: fixed;
    bottom: 0;
    height: 50px;
    line-height: 50px;
    font-size: 15px;
    padding-left: 15px;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    z-index: 150;
    background-color: #404040;
}
.cRfUr {
    border-bottom: 1px solid #d9d9d9;
}
._2po2r:last-child {
    border-radius: 0 0 4px 4px;
    border-bottom: 0;
}
._2po2r:first-child {
    border-radius: 4px 4px 0 0;
}
._2po2r ._22XWG {
    margin-right: 5px;
}
._2po2r:hover {
    background-color: #666;
    color: #fff;
}
._3DM7w span {
    display: block;
    margin-right: 20px;
    overflow: hidden;
    -o-text-overflow: ellipsis;
    text-overflow: ellipsis;
    white-space: nowrap;
}
._3P4JX ul.NvfK4 {
    display: block;
}
._3P4JX ul._2V8zt:before {
    position: absolute;
    right: 12px;
    content: "";
    display: inline-block;
}
._3P4JX ul._3FcHm:before {
    border-left: 9px solid transparent;
    border-right: 9px solid transparent;
    border-bottom: 9px solid #fff;
    top: -9px;
}
.h-5Am .ant-dropdown-trigger {
    display: inline-block;
    color: #999;
    cursor: pointer;
    -webkit-transition: color .2s cubic-bezier(.645,.045,.355,1);
    -o-transition: color .2s cubic-bezier(.645,.045,.355,1);
    transition: color .2s cubic-bezier(.645,.045,.355,1);
}
.h-5Am .fa+span {
    margin-left: 4px;
}
.h-5Am .Yv5Zx {
    float: right;
    margin-right: 15px;
    color: #999;
    cursor: pointer;
  }
  .h-5Am .Yv5Zx i {
      margin-left: 5px;
  }
  .rQQG7{
    height: 100%;
    display: block;
    width: 33.33333%;
    border-right: 1px solid #d9d9d9;
  }
  ._3revO {
    overflow-y: scroll;
    height: 100%;
    position: relative;
  }
  ._3br9T {
    position: relative;
    transition: opacity .3s cubic-bezier(.645,.045,.355,1);
    opacity: 1;
  }
  ._1GsW5 {
    line-height: 20px;
    font-size: 15px;
    font-weight: 400;
    padding: 20px 0 20px 25px;
    cursor: pointer;
    color: #595959;
  }
  ._1GsW5:hover {
    color: #262626;
  }
  ._2TxA- {
    position: relative;
    margin-bottom: 0;
    background-color: #efe9d9;
    border-top: 1px solid #d9d9d9;
  }
  ._25Ilv {
    position: relative;
    height: 90px;
    color: #595959;
    background-color: #fff;
    margin-bottom: 0;
    padding: 15px 10px 15px 60px;
    box-shadow: 0 0 0 1px #d9d9d9;
    border-left: 5px solid transparent;
    list-style: none;
    line-height: 60px;
    cursor: pointer;
    user-select: none;
  }
  ._25Ilv ._2m93u {
    background: url(/static/image/sprite.9d24217.png) no-repeat -50px -25px;
    background-size: 250px;
    position: absolute;
    top: 30px;
    left: 20px;
    width: 22px;
    height: 30px;
  }
  ._1tqbw, ._25Ilv:hover, ._33nt7 {
    background-color: #e6e6e6;
  }
  ._25Ilv ._2m93u {
    background: url(/static/image/sprite.9d24217.png) no-repeat -50px -25px;
    background-size: 250px;
    position: absolute;
    top: 30px;
    left: 20px;
    width: 22px;
    height: 30px;
  }
  ._3P4JX {
    font-size: 16px;
    width: 40px;
    text-align: center;
    position: relative;
    min-height: 30px;
    max-height: 50px;
}
  ._25Ilv .poOXI {
    float: right;
}
  ._33nt7 {
    border-left-color: #ec7259;
  }
  ._25Ilv .hLzJv, ._25Ilv .NariC {
    display: block;
    height: 30px;
    line-height: 30px;
    margin-right: 40px;
    overflow: hidden;
    -o-text-overflow: ellipsis;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 18px;
    font-family: sans-serif;
}
  ._2TxA- {
    position: relative;
    margin-bottom: 0;
    background-color: #efe9d9;
    border-top: 1px solid #d9d9d9;
}
  ._3P4JX ul._2V8zt {
    display: none;
    position: absolute;
    z-index: 99;
    right: 0;
}
  ._3P4JX ul._3FcHm {
    top: 100%;
}
  ._2w9pn {
    font-size: 14px;
    box-shadow: 0 5px 10px rgba(0,0,0,.2);
    list-style: none;
    background-color: #fff;
    color: #595959;
    border-radius: 6px;
}
  ._3P4JX ul.NvfK4 {
    display: block;
}
  ._3P4JX ul._3FcHm:before {
    border-left: 9px solid transparent;
    border-right: 9px solid transparent;
    border-bottom: 9px solid #fff;
    top: -9px;
}
  ._3P4JX ul._2V8zt:before {
    position: absolute;
    right: 12px;
    content: "";
    display: inline-block;
}
._25Ilv ._13kgp {
    position: absolute;
    top: 30px;
    left: 20px;
    width: 22px;
    height: 30px;
    background: url(/static/image/sprite.9d24217.png) no-repeat 0 -25px;
    background-size: 250px;
}
._25Ilv ._13kgp {
    position: absolute;
    top: 30px;
    left: 20px;
    width: 22px;
    height: 30px;
    background: url(/static/image/sprite.9d24217.png) no-repeat 0 -25px;
    background-size: 250px;
}
._25Ilv ._2m93u {
    background: url(/static/image/sprite.9d24217.png) no-repeat -50px -25px;
    background-size: 250px;
}
._25Ilv ._29C-V {
    position: absolute;
    bottom: 2px;
    left: 5px;
    font-size: 9px;
    line-height: 16px;
    color: #595959;
}
._2cVn3 {
    line-height: 30px;
    padding: 20px 0 20px 25px;
    cursor: pointer;
    color: #999;
    margin-bottom: 80px;
}
._24i7u {
    flex-shrink: 0;
    padding: 0 80px 10px 40px;
    margin-bottom: 0;
    border: none;
    font-size: 30px;
    font-weight: 400;
    line-height: 30px;
    box-shadow: none;
    color: #595959;
    background-color: transparent;
    outline: none;
    border-radius: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    position: absolute;
    top: 0;
    right: 0;
    width: 66.666666%;
}
  #editor {
    margin: auto;
    width: 66.666666%;
    position: absolute;
    right: 0;
    top: 44px;
    height: 580px;
  }
</style>
```

路由代码：

```javascript
// 。。。
import Write from "@/components/Writer"


export default new Router({
  mode: "history",
  routes: [
     // ....
      {
       name:"Writer",
       path:"/writer",
       component: Writer,
     },
  ]
})

```

在 Header.vue提供跳转链接

```vue
<router-link class="btn write-btn" to="/writer"><img class="icon-write" src="/static/image/write.svg">写文章</router-link>
```

## 判断用户是否已经登录

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=true"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." name="name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w _31PCv" title="日记本">
          <div class="_3P4JX _2VLy-">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="true?'':'NvfK4'">
                <li class="_2po2r cRfUr" title="">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" title="">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>日记本</span>
        </li>
        <li class="_3DM7w" title="随笔"><span>随笔</span></li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv _33nt7" title="ABC">
                <i class="_13kgp _2m93u"></i>
                <div class="_3P4JX poOXI">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn">
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" title="随笔"><span class="">随笔</span></li>
                          </ul>
                        </div>
                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">ABC</span>
                <span class="hLzJv">题目：有四个数字：1、2、3、4，能组成多少个互不相同且无重复数字的三位数？各是多少？

题目：企业发放的奖金根据利润提成</span>
                <span class="_29C-V">字数:905</span>
              </li>
              <li class="_25Ilv" title="2020-01-12">
                <i class="_13kgp"></i>
                <span class="NariC">2020-01-12</span>
                <span class="hLzJv">题目：有四个数字：1、2、3、4，能组成多少个互不相同且无重复数字的三位数？各是多少？

题目：企业发放的奖金根据利润提成</span>
              </li>
            </ul>
            <div class="_2cVn3"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" value="2020-01-12">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>
  </div>
</template>
<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    export default {
        name: "Writer",
        data(){
            return {
                token: "",
                editorContent:"",
                img_file:[],
                collection_form:false,
                is_show_page: false, // 控制是否显示页面
            }
        },
        watch:{
            editorContent(){
                console.log(this.editorContent)
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
        },
        components: {
          mavonEditor
        },
        methods:{
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          }
        }
    }
</script>

```

settings.py，代码：

```python
export default {
  Host: "http://api.renran.cn:8000", // ajax请求服务器的地址
  TC_captcha:{
    // 这里的appid必须和django中的配置里面的appid一致，否则报错
    app_id: "2044977606",
  },
  check_user_login(vm){
    let token = localStorage.user_token || sessionStorage.user_token;
    if(!token){
        vm.$confirm('您尚未登录,是否登录后继续操作', '荏苒提示', {
            confirmButtonText: '去登录',
            cancelButtonText: '回首页',
            type: 'info'
          }).then(() => {
            // 前往登录页面
            vm.$router.push("/login");
          }).catch(() => {
            // 返回站点首页
            vm.$router.push("/");
          });
    }else{
      vm.is_show_page = true;
      return token;
    }
  },
}

```



## 显示当前登录用户的所有文集

视图代码：

```python
from django.shortcuts import render

from rest_framework.generics import ListAPIView
from rest_framework.permissions import IsAuthenticated
from .models import ArticleCollection
from .serializers import CollectionModelSerializer
class CollectionAPIView(ListAPIView):
    """文集接口"""
    # 限制只能是登录用户才能访问操作当前视图的接口
    permission_classes = [IsAuthenticated]
    queryset = ArticleCollection.objects.all()
    serializer_class = CollectionModelSerializer
```

序列化器，代码：

```python
from rest_framework import serializers
from .models import ArticleCollection
class CollectionModelSerializer(serializers.ModelSerializer):
    """文集序列化器"""
    class Meta:
        model = ArticleCollection
        fields = ["id","name"]
```

路由代码：

```python
# article/urls.py，代码：
from django.urls import path
from . import views
urlpatterns = [
    path("collection/", views.CollectionAPIView.as_view()),
]

# 总路由，代码：
    path('article/', include("article.urls")),
```

经过代码编写，我们通过访问，看到没有数据，所以我们可以直接xadmin中注册文集的模型管理器，让开发者可以在xadmin中添加文件信息。article/adminx.py，代码：

```python
import xadmin
# 轮播图
from .models import ArticleCollection
class ArticleCollectionModelAdmin(object):
    list_display = ["id","name"]
xadmin.site.register(ArticleCollection,ArticleCollectionModelAdmin)
```

注册了模型管理器能够在xadmin后台添加文集以后，我们可以发现上面的视图代码有问题，因为这里查询显示了所有的文集，包括所有用户的，因此，我们当前功能很明显要求查询的只是当前登录用户自己的文集。

所以调整视图代码如下，代码：

```python
from django.shortcuts import render

# Create your views here.
from rest_framework.generics import ListAPIView
from rest_framework.permissions import IsAuthenticated
from .models import ArticleCollection
from .serializers import CollectionModelSerializer


class CollectionAPIView(ListAPIView):
    """文集接口"""
    # 限制只能是登录用户才能访问操作当前视图的接口
    permission_classes = [IsAuthenticated]
    # queryset = ArticleCollection.objects.all()
    serializer_class = CollectionModelSerializer
    def get_queryset(self):
        # request.user # 代表的就是当前访问视图的用户[当然是用户已经登录的情况下]
        # self.request.user # 获取当前登录用户
        # print(self.request)
        # print(self.request.user)
        # return ArticleCollection.objects.filter(user__id=self.request.user.id)
        collection_list = ArticleCollection.objects.filter(is_deleted=False, is_show=True, user=self.request.user).order_by("orders","id")
        if len(collection_list) < 1:
            """针对新用户默认创建2个文集提供给用户[当然也可以在用户注册的时候给用户默认添加2个文集]"""
            collection1 = ArticleCollection.objects.create(name="日记本", user=self.request.user)
            collection2 = ArticleCollection.objects.create(name="随笔", user=self.request.user)
            collection_list = [ collection1,collection2 ]
        return collection_list
```



客户端中展示所有文集，代码：

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=true"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." name="name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="key==current_collection?'_31PCv':''" :title="collection.name" v-for="collection,key in collection_list">
          <div class="_3P4JX _2VLy-">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="true?'':'NvfK4'">
                <li class="_2po2r cRfUr" title="">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" title="">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv _33nt7" title="ABC">
                <i class="_13kgp _2m93u"></i>
                <div class="_3P4JX poOXI">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn">
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" title="随笔"><span class="">随笔</span></li>
                          </ul>
                        </div>
                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">ABC</span>
                <span class="hLzJv">题目：有四个数字：1、2、3、4，能组成多少个互不相同且无重复数字的三位数？各是多少？

题目：企业发放的奖金根据利润提成</span>
                <span class="_29C-V">字数:905</span>
              </li>
              <li class="_25Ilv" title="2020-01-12">
                <i class="_13kgp"></i>
                <span class="NariC">2020-01-12</span>
                <span class="hLzJv">题目：有四个数字：1、2、3、4，能组成多少个互不相同且无重复数字的三位数？各是多少？

题目：企业发放的奖金根据利润提成</span>
              </li>
            </ul>
            <div class="_2cVn3"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" value="2020-01-12">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>
  </div>
</template>
<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    import '../../static/font-awesome/css/font-awesome.css'
    export default {
        name: "Writer",
        data(){
          return {
            token: "",
            editorContent:"",
            img_file:[],
            collection_form:false,
            is_show_page: false,   // 控制是否显示页面
            collection_list:[],    // 当前登录用户的文集列表
            current_collection: 0, // 当前用户选中操作的文集下标,默认为第一个文集,也就是下标为0的文集
          }
        },
        watch:{
            editorContent(){
                console.log(this.editorContent)
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
            if(this.token){
                this.get_collection();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          get_collection(){
            // 获取当前用户的文集列表
            this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                headers:{  // 设置本次http的请求头信息
                    Authorization: "jwt "+ this.token,
                }
            }).then(response=>{
               this.collection_list = response.data;
            }).catch(error=>{
               this.$message.error("网络异常,获取文集列表失败!");
            });
          },
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          }
        }
    }
</script>
```

高亮显示当前操作的文集，组件代码：

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=true"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." name="name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="key==current_collection?'_31PCv':''" @click="current_collection=key" :title="collection.name" v-for="collection,key in collection_list">
          <div class="_3P4JX _2VLy-" v-if="key==current_collection">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="true?'':'NvfK4'">
                <li class="_2po2r cRfUr" title="">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" title="">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv _33nt7" title="ABC">
                <i class="_13kgp _2m93u"></i>
                <div class="_3P4JX poOXI">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn">
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" title="随笔"><span class="">随笔</span></li>
                          </ul>
                        </div>
                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">ABC</span>
                <span class="hLzJv">题目：有四个数字：1、2、3、4，能组成多少个互不相同且无重复数字的三位数？各是多少？

题目：企业发放的奖金根据利润提成</span>
                <span class="_29C-V">字数:905</span>
              </li>
              <li class="_25Ilv" title="2020-01-12">
                <i class="_13kgp"></i>
                <span class="NariC">2020-01-12</span>
                <span class="hLzJv">题目：有四个数字：1、2、3、4，能组成多少个互不相同且无重复数字的三位数？各是多少？

题目：企业发放的奖金根据利润提成</span>
              </li>
            </ul>
            <div class="_2cVn3"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" value="2020-01-12">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>
  </div>
</template>
<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    import '../../static/font-awesome/css/font-awesome.css'
    export default {
        name: "Writer",
        data(){
          return {
            token: "",
            editorContent:"",
            img_file:[],
            collection_form:false,
            is_show_page: false,   // 控制是否显示页面
            collection_list:[],    // 当前登录用户的文集列表
            current_collection: 0, // 当前用户选中操作的文集下标,默认为第一个文集,也就是下标为0的文集
          }
        },
        watch:{
            editorContent(){
                console.log(this.editorContent)
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
            if(this.token){
                this.get_collection();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          get_collection(){
            // 获取当前用户的文集列表
            this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                headers:{  // 设置本次http的请求头信息
                    Authorization: "jwt "+ this.token,
                }
            }).then(response=>{
               this.collection_list = response.data;
            }).catch(error=>{
               this.$message.error("网络异常,获取文集列表失败!");
            });
          },
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          }
        }
    }
</script>

```

对于文集列表中的图标丢失，我们需要把 font-awesome 目录放到项目的static目录下即可。



## 控制文集菜单的显示隐藏[扩展]

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=true"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." name="name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="key==current_collection?'_31PCv':''" @click="current_collection=key" :title="collection.name" v-for="collection,key in collection_list">
          <div class="_3P4JX _2VLy-" v-if="key==current_collection" @click.stop="is_show_collection_menu=!is_show_collection_menu">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_collection_menu?'NvfK4':''">
                <li class="_2po2r cRfUr" title="">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" title="">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv _33nt7" title="ABC">
                <i class="_13kgp _2m93u"></i>
                <div class="_3P4JX poOXI">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn">
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" title="随笔"><span class="">随笔</span></li>
                          </ul>
                        </div>
                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">ABC</span>
                <span class="hLzJv">题目：有四个数字：1、2、3、4，能组成多少个互不相同且无重复数字的三位数？各是多少？

题目：企业发放的奖金根据利润提成</span>
                <span class="_29C-V">字数:905</span>
              </li>
              <li class="_25Ilv" title="2020-01-12">
                <i class="_13kgp"></i>
                <span class="NariC">2020-01-12</span>
                <span class="hLzJv">题目：有四个数字：1、2、3、4，能组成多少个互不相同且无重复数字的三位数？各是多少？

题目：企业发放的奖金根据利润提成</span>
              </li>
            </ul>
            <div class="_2cVn3"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" value="2020-01-12">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>
  </div>
</template>
<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    import '../../static/font-awesome/css/font-awesome.css'
    export default {
        name: "Writer",
        data(){
          return {
            token: "",
            editorContent:"",
            img_file:[],
            collection_form:false,
            is_show_page: false,   // 控制是否显示页面
            collection_list:[],    // 当前登录用户的文集列表
            current_collection: 0, // 当前用户选中操作的文集下标,默认为第一个文集,也就是下标为0的文集
            is_show_collection_menu:false, // 控制文集菜单是否显示
          }
        },
        watch:{
            editorContent(){
                console.log(this.editorContent)
            },
            current_collection(){
                // 切换操作的文集
                this.is_show_collection_menu = false;
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
                // 点选页面其他位置，关闭菜单
                document.onclick = (event)=>{
                    // 关闭文集菜单
                    this.is_show_collection_menu = false;
                }
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
            if(this.token){
                this.get_collection();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          get_collection(){
            // 获取当前用户的文集列表
            this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                headers:{  // 设置本次http的请求头信息
                    Authorization: "JWT "+ this.token,
                }
            }).then(response=>{
               this.collection_list = response.data;
            }).catch(error=>{
               this.$message.error("网络异常,获取文集列表失败!");
            });
          },
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          }
        }
    }
</script>

```



## 添加文集

在原来文集列表的视图接口基础上，增加一个父类CreateAPIView，代码：

```python
from rest_framework.generics import ListAPIView, CreateAPIView
from rest_framework.permissions import IsAuthenticated
from .models import ArticleCollection
from .serializers import CollectionModelSerializer
class CollectionAPIView(ListAPIView,CreateAPIView):
    """文集接口"""
    # 限制只能是登录用户才能访问操作当前视图的接口
    permission_classes = [IsAuthenticated]
    # queryset = ArticleCollection.objects.all()
    serializer_class = CollectionModelSerializer
    def get_queryset(self):
        # request.user # 代表的就是当前访问视图的用户[当然是用户已经登录的情况下]
        # self.request.user # 获取当前登录用户
        # print(self.request)
        # print(self.request.user)
        # return ArticleCollection.objects.filter(user__id=self.request.user.id)
        collection_list = ArticleCollection.objects.filter(is_deleted=False, is_show=True, user=self.request.user).order_by("orders","id")
        if len(collection_list) < 1:
            """针对新用户默认创建2个文集提供给用户[当然也可以在用户注册的时候给用户默认添加2个文集]"""
            collection1 = ArticleCollection.objects.create(name="日记本", user=self.request.user)
            collection2 = ArticleCollection.objects.create(name="随笔", user=self.request.user)
            collection_list = [ collection1,collection2 ]
        return collection_list
```

序列化器增加验证和create方法，代码：

```python
from rest_framework import serializers
from .models import ArticleCollection
class CollectionModelSerializer(serializers.ModelSerializer):
    """文集序列化器"""
    class Meta:
        model = ArticleCollection
        fields = ["id","name"]
        
    def validate(self, attrs):
        # 必须保证同一个用户的文集名称是唯一的
        name = attrs.get("name")
        # 获取当前登录用户信息，可以直接通过self.context["request"]
        user = self.context["request"].user
        try:
            ArticleCollection.objects.get(user=user,name=name)
            raise serializers.ValidationError("对不起，当前文集已存在！")
        except ArticleCollection.DoesNotExist:
            return attrs

    def create(self, validated_data):
        name = validated_data.get("name")
        user = self.context["request"].user
        try:
            instance = ArticleCollection.objects.create(
                name=name,
                user=user
            )
            return instance
        except:
            raise serializers.ValidationError("添加文集失败！")
```

路由代码没有任何调整。



客户端发起请求添加文集

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=!collection_form"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW" @click.prevent="add_collection"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="key==current_collection?'_31PCv':''" @click="current_collection=key" :title="collection.name" v-for="collection,key in collection_list">
          <div class="_3P4JX _2VLy-" v-if="key==current_collection" @click.stop="is_show_collection_menu=!is_show_collection_menu">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_collection_menu?'NvfK4':''">
                <li class="_2po2r cRfUr" title="">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" title="">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv _33nt7" title="ABC">
                <i class="_13kgp _2m93u"></i>
                <div class="_3P4JX poOXI">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn">
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" title="随笔"><span class="">随笔</span></li>
                          </ul>
                        </div>
                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">ABC</span>
                <span class="hLzJv">题目：有四个数字：1、2、3、4，能组成多少个互不相同且无重复数字的三位数？各是多少？

题目：企业发放的奖金根据利润提成</span>
                <span class="_29C-V">字数:905</span>
              </li>
              <li class="_25Ilv" title="2020-01-12">
                <i class="_13kgp"></i>
                <span class="NariC">2020-01-12</span>
                <span class="hLzJv">题目：有四个数字：1、2、3、4，能组成多少个互不相同且无重复数字的三位数？各是多少？

题目：企业发放的奖金根据利润提成</span>
              </li>
            </ul>
            <div class="_2cVn3"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" value="2020-01-12">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>
  </div>
</template>
<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    import '../../static/font-awesome/css/font-awesome.css'
    export default {
        name: "Writer",
        data(){
          return {
            token: "",
            editorContent:"",
            img_file:[],
            collection_form:false,
            collection_name:"",  // 本次新增的文集名称
            is_show_page: false,   // 控制是否显示页面
            collection_list:[],    // 当前登录用户的文集列表
            current_collection: 0, // 当前用户选中操作的文集下标,默认为第一个文集,也就是下标为0的文集
            is_show_collection_menu:false, // 控制文集菜单是否显示
          }
        },
        watch:{
            editorContent(){
                console.log(this.editorContent)
            },
            current_collection(){
                // 切换操作的文集
                this.is_show_collection_menu = false;
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
                // 点选页面其他位置，关闭菜单
                document.onclick = (event)=>{
                    // 关闭文集菜单
                    this.is_show_collection_menu = false;
                }
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
            if(this.token){
                this.get_collection();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          get_collection(){
            // 获取当前用户的文集列表
            this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                headers:{  // 设置本次http的请求头信息
                    Authorization: "JWT "+ this.token,
                }
            }).then(response=>{
               this.collection_list = response.data;
            }).catch(error=>{
               this.$message.error("网络异常,获取文集列表失败!");
            });
          },
          add_collection(){
              // 添加文集
              this.$axios.post(`${this.$settings.Host}/article/collection/`,{
                  name: this.collection_name
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("新增文集成功！");
                  this.collection_list.push(response.data);
                  // 清空和关闭添加文集的表单
                  this.collection_name="";
                  this.collection_form=false;
              }).catch(error=>{
                  this.$message.error("对不起，新增文集失败！");
              });

          },
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          }
        }
    }
</script>
```



## 删除文集

思路：

1. 客户端根据current_collection来获取当前文集的id

2. 通过ajax把文集id和jwt发送到服务端，服务端实现根据ID删除文集的操作

视图中在文集接口的视图类中新增父类DestoryAPIView，代码：

```python
from django.shortcuts import render

# Create your views here.
from rest_framework.generics import ListAPIView, CreateAPIView,DestroyAPIView
from rest_framework.permissions import IsAuthenticated
from .models import ArticleCollection
from .serializers import CollectionModelSerializer
class CollectionAPIView(ListAPIView,CreateAPIView,DestroyAPIView):
    """文集接口"""
    # 限制只能是登录用户才能访问操作当前视图的接口
    permission_classes = [IsAuthenticated]
    # queryset = ArticleCollection.objects.all()
    serializer_class = CollectionModelSerializer
    def get_queryset(self):
        # request.user # 代表的就是当前访问视图的用户[当然是用户已经登录的情况下]
        # self.request.user # 获取当前登录用户
        # print(self.request)
        # print(self.request.user)
        # return ArticleCollection.objects.filter(user__id=self.request.user.id)
        collection_list = ArticleCollection.objects.filter(is_deleted=False, is_show=True, user=self.request.user).order_by("orders","id")
        if len(collection_list) < 1:
            """针对新用户默认创建2个文集提供给用户[当然也可以在用户注册的时候给用户默认添加2个文集]"""
            collection1 = ArticleCollection.objects.create(name="日记本", user=self.request.user)
            collection2 = ArticleCollection.objects.create(name="随笔", user=self.request.user)
            collection_list = [ collection1,collection2 ]
        return collection_list
```

因为删除方法必须指定删除数据的ID主键，所以路由中新增url用于调用删除方法，代码：

```python
from django.urls import path,re_path
from . import views
urlpatterns = [
    path("collection/", views.CollectionAPIView.as_view()),
    re_path("collection/(?P<pk>\d+)/", views.CollectionAPIView.as_view()),
]
```

客户端发起ajax，请求删除文集：

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=!collection_form"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW" @click.prevent="add_collection"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="key==current_collection?'_31PCv':''" @click="current_collection=key" :title="collection.name" v-for="collection,key in collection_list">
          <div class="_3P4JX _2VLy-" v-if="key==current_collection" @click.stop="is_show_collection_menu=!is_show_collection_menu">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_collection_menu?'NvfK4':''">
                <li class="_2po2r cRfUr" title="">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" @click.prevent.stop="del_collection">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv _33nt7" title="ABC">
                <i class="_13kgp _2m93u"></i>
                <div class="_3P4JX poOXI">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn">
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" title="随笔"><span class="">随笔</span></li>
                          </ul>
                        </div>
                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">ABC</span>
                <span class="hLzJv">题目：有四个数字：1、2、3、4，能组成多少个互不相同且无重复数字的三位数？各是多少？

题目：企业发放的奖金根据利润提成</span>
                <span class="_29C-V">字数:905</span>
              </li>
              <li class="_25Ilv" title="2020-01-12">
                <i class="_13kgp"></i>
                <span class="NariC">2020-01-12</span>
                <span class="hLzJv">题目：有四个数字：1、2、3、4，能组成多少个互不相同且无重复数字的三位数？各是多少？

题目：企业发放的奖金根据利润提成</span>
              </li>
            </ul>
            <div class="_2cVn3"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" value="2020-01-12">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>
  </div>
</template>
<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    import '../../static/font-awesome/css/font-awesome.css'
    export default {
        name: "Writer",
        data(){
          return {
            token: "",
            editorContent:"",
            img_file:[],
            collection_form:false,
            collection_name:"",  // 本次新增的文集名称
            is_show_page: false,   // 控制是否显示页面
            collection_list:[],    // 当前登录用户的文集列表
            current_collection: 0, // 当前用户选中操作的文集下标,默认为第一个文集,也就是下标为0的文集
            is_show_collection_menu:false, // 控制文集菜单是否显示
          }
        },
        watch:{
            editorContent(){
                console.log(this.editorContent)
            },
            current_collection(){
                // 切换操作的文集
                this.is_show_collection_menu = false;
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
                // 点选页面其他位置，关闭菜单
                document.onclick = (event)=>{
                    // 关闭文集菜单
                    this.is_show_collection_menu = false;
                }
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
            if(this.token){
                this.get_collection();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          get_collection(){
            // 获取当前用户的文集列表
            this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                headers:{  // 设置本次http的请求头信息
                    Authorization: "JWT "+ this.token,
                }
            }).then(response=>{
               this.collection_list = response.data;
            }).catch(error=>{
               this.$message.error("网络异常,获取文集列表失败!");
            });
          },
          add_collection(){
              // 添加文集
              this.$axios.post(`${this.$settings.Host}/article/collection/`,{
                  name: this.collection_name
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("新增文集成功！");
                  this.collection_list.push(response.data);
                  // 清空和关闭添加文集的表单
                  this.collection_name="";
                  this.collection_form=false;
              }).catch(error=>{
                  this.$message.error("对不起，新增文集失败！");
              });

          },
          del_collection(){
              // 删除文集
              if(this.collection_list.length<2){
                  this.$message.error("对不起，当前文集列表只剩下一个文集了，所以不能删除！");
                  return false;
              }
              // 获取本次操作的文集，提取文集的id
              let collection_id = this.collection_list[this.current_collection].id;
              this.$axios.delete(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("成功删除当前文集！");
                  // 客户端从文集列表移除当前文集，并重置当前操作的文集ID为0
                  this.collection_list.splice(this.current_collection,1);
                  this.current_collection = 0;
              }).catch(error=>{
                  this.$message.error("删除文集失败！");
              })
          },
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          }
        }
    }
</script>
```

针对现有的删除操作，是一种真实的物理操作，真的把数据从数据库中删除了，那么这种情况在工作中基本不会出现，我们在工作中大部分情况都是逻辑删除，防止用户找回数据。所以我们针对当前删除功能，可以提供进一步用户确认提示，并在后台实现逻辑删除。

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=!collection_form"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW" @click.prevent="add_collection"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="key==current_collection?'_31PCv':''" @click="current_collection=key" :title="collection.name" v-for="collection,key in collection_list">
          <div class="_3P4JX _2VLy-" v-if="key==current_collection" @click.stop="is_show_collection_menu=!is_show_collection_menu">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_collection_menu?'NvfK4':''">
                <li class="_2po2r cRfUr" title="">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" @click.prevent.stop="del_collection">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv _33nt7" title="ABC">
                <i class="_13kgp _2m93u"></i>
                <div class="_3P4JX poOXI">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn">
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" title="随笔"><span class="">随笔</span></li>
                          </ul>
                        </div>
                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">ABC</span>
                <span class="hLzJv">题目：有四个数字：1、2、3、4，能组成多少个互不相同且无重复数字的三位数？各是多少？

题目：企业发放的奖金根据利润提成</span>
                <span class="_29C-V">字数:905</span>
              </li>
              <li class="_25Ilv" title="2020-01-12">
                <i class="_13kgp"></i>
                <span class="NariC">2020-01-12</span>
                <span class="hLzJv">题目：有四个数字：1、2、3、4，能组成多少个互不相同且无重复数字的三位数？各是多少？

题目：企业发放的奖金根据利润提成</span>
              </li>
            </ul>
            <div class="_2cVn3"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" value="2020-01-12">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>
  </div>
</template>
<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    import '../../static/font-awesome/css/font-awesome.css'
    export default {
        name: "Writer",
        data(){
          return {
            token: "",
            editorContent:"",
            img_file:[],
            collection_form:false,
            collection_name:"",  // 本次新增的文集名称
            is_show_page: false,   // 控制是否显示页面
            collection_list:[],    // 当前登录用户的文集列表
            current_collection: 0, // 当前用户选中操作的文集下标,默认为第一个文集,也就是下标为0的文集
            is_show_collection_menu:false, // 控制文集菜单是否显示
          }
        },
        watch:{
            editorContent(){
                console.log(this.editorContent)
            },
            current_collection(){
                // 切换操作的文集
                this.is_show_collection_menu = false;
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
                // 点选页面其他位置，关闭菜单
                document.onclick = (event)=>{
                    // 关闭文集菜单
                    this.is_show_collection_menu = false;
                }
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
            if(this.token){
                this.get_collection();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          get_collection(){
            // 获取当前用户的文集列表
            this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                headers:{  // 设置本次http的请求头信息
                    Authorization: "JWT "+ this.token,
                }
            }).then(response=>{
               this.collection_list = response.data;
            }).catch(error=>{
               this.$message.error("网络异常,获取文集列表失败!");
            });
          },
          add_collection(){
              // 添加文集
              this.$axios.post(`${this.$settings.Host}/article/collection/`,{
                  name: this.collection_name
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("新增文集成功！");
                  this.collection_list.push(response.data);
                  // 清空和关闭添加文集的表单
                  this.collection_name="";
                  this.collection_form=false;
              }).catch(error=>{
                  this.$message.error("对不起，新增文集失败！");
              });

          },
          del_collection(){
              // 删除文集
              if(this.collection_list.length<2){
                  this.$message.error("对不起，当前文集列表只剩下一个文集了，所以不能删除！");
                  return false;
              }

              // 获取本次操作的文集，提取文集的id
              let collection_id = this.collection_list[this.current_collection].id;
              let collection_name = this.collection_list[this.current_collection].name;
              this.$confirm(`确认要删除当前文集《${collection_name}》吗？`, '危险操作', {
                confirmButtonText: '删除',
                cancelButtonText: '取消',
                type: 'warning'
              }).then(() => {
                // 确认删除
                this.$axios.delete(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                    headers:{
                        Authorization: "jwt " + this.token,
                    }
                }).then(response=>{
                    this.$message.success("成功删除当前文集！");
                    // 客户端从文集列表移除当前文集，并重置当前操作的文集ID为0
                    this.collection_list.splice(this.current_collection,1);
                    this.current_collection = 0;
                }).catch(error=>{
                    this.$message.error("删除文集失败！");
                });

              }).catch(() => {
                // 取消

              });
          },
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          }
        }
    }
</script>

```

视图代码调整，代码：

```python
from django.shortcuts import render

# Create your views here.
from rest_framework.generics import ListAPIView, CreateAPIView,DestroyAPIView
from rest_framework.permissions import IsAuthenticated
from .models import ArticleCollection
from .serializers import CollectionModelSerializer
class CollectionAPIView(ListAPIView,CreateAPIView,DestroyAPIView):
    """文集接口"""
    # 限制只能是登录用户才能访问操作当前视图的接口
    permission_classes = [IsAuthenticated]
    # queryset = ArticleCollection.objects.all()
    serializer_class = CollectionModelSerializer
    def get_queryset(self):
        # request.user # 代表的就是当前访问视图的用户[当然是用户已经登录的情况下]
        # self.request.user # 获取当前登录用户
        # print(self.request)
        # print(self.request.user)
        # return ArticleCollection.objects.filter(user__id=self.request.user.id)
        collection_list = ArticleCollection.objects.filter(is_deleted=False, is_show=True, user=self.request.user).order_by("orders","id")
        if len(collection_list) < 1:
            """针对新用户默认创建2个文集提供给用户[当然也可以在用户注册的时候给用户默认添加2个文集]"""
            collection1 = ArticleCollection.objects.create(name="日记本", user=self.request.user)
            collection2 = ArticleCollection.objects.create(name="随笔", user=self.request.user)
            collection_list = [ collection1,collection2 ]
        return collection_list

    def perform_destroy(self, instance):
        # 逻辑删除文集
        instance.is_deleted=True
        instance.save()
```

因为用户删除了文集以后，在用户的角度来说，是真的已经删除了，但事实上针对数据库来说，只是is_deleted值的切换，所以在用户添加文集的时候，防止文集名称出现的代码中需要增加删除状态的判断。序列化器代码：

```python
from rest_framework import serializers
from .models import ArticleCollection
class CollectionModelSerializer(serializers.ModelSerializer):
    """文集序列化器"""
    class Meta:
        model = ArticleCollection
        fields = ["id","name"]

    def validate(self, attrs):
        # 必须保证同一个用户的文集名称是唯一的
        name = attrs.get("name")
        # 获取当前登录用户信息，可以直接通过self.context["request"]
        user = self.context["request"].user
        try:
            ArticleCollection.objects.get(user=user,name=name, is_deleted=False)
            raise serializers.ValidationError("对不起，当前文集已存在！")
        except ArticleCollection.DoesNotExist:
            return attrs

    def create(self, validated_data):
        name = validated_data.get("name")
        user = self.context["request"].user
        try:
            instance = ArticleCollection.objects.create(
                name=name,
                user=user
            )
            return instance
        except:
            raise serializers.ValidationError("添加文集失败！")
```



## 修改文集

文件的api视图新增父类UpdateAPIView，代码：

```python
from django.shortcuts import render

# Create your views here.
from rest_framework.generics import ListAPIView, CreateAPIView, DestroyAPIView, UpdateAPIView
from rest_framework.permissions import IsAuthenticated
from .models import ArticleCollection
from .serializers import CollectionModelSerializer
class CollectionAPIView(ListAPIView,CreateAPIView,DestroyAPIView, UpdateAPIView):
    """文集接口"""
    # 限制只能是登录用户才能访问操作当前视图的接口
    permission_classes = [IsAuthenticated]
    # queryset = ArticleCollection.objects.all()
    serializer_class = CollectionModelSerializer
    def get_queryset(self):
        # request.user # 代表的就是当前访问视图的用户[当然是用户已经登录的情况下]
        # self.request.user # 获取当前登录用户
        # print(self.request)
        # print(self.request.user)
        # return ArticleCollection.objects.filter(user__id=self.request.user.id)
        collection_list = ArticleCollection.objects.filter(is_deleted=False, is_show=True, user=self.request.user).order_by("orders","id")
        if len(collection_list) < 1:
            """针对新用户默认创建2个文集提供给用户[当然也可以在用户注册的时候给用户默认添加2个文集]"""
            collection1 = ArticleCollection.objects.create(name="日记本", user=self.request.user)
            collection2 = ArticleCollection.objects.create(name="随笔", user=self.request.user)
            collection_list = [ collection1,collection2 ]
        return collection_list

    def perform_destroy(self, instance):
        # 逻辑删除文集
        instance.is_deleted=True
        instance.save()

```

序列化器，代码：

```python
from rest_framework import serializers
from .models import ArticleCollection
class CollectionModelSerializer(serializers.ModelSerializer):
    """文集序列化器"""
    class Meta:
        model = ArticleCollection
        fields = ["id","name"]

    def validate(self, attrs):
        # 必须保证同一个用户的文集名称是唯一的
        name = attrs.get("name")
        # 获取当前登录用户信息，可以直接通过self.context["request"]
        user = self.context["request"].user
        try:
            ArticleCollection.objects.get(user=user,name=name, is_deleted=False)
            raise serializers.ValidationError("对不起，当前文集已存在！")
        except ArticleCollection.DoesNotExist:
            return attrs

    def create(self, validated_data):
        name = validated_data.get("name")
        user = self.context["request"].user
        try:
            instance = ArticleCollection.objects.create(
                name=name,
                user=user
            )
            return instance
        except:
            raise serializers.ValidationError("添加文集失败！")

    def update(self, instance, validated_data):
        instance.name=validated_data.get("name")
        instance.save()
        return instance
```

路由没有新增代码。



客户端使用ElementUI提供的弹窗，提供输入框给用户输入新的文集名称，并发送ajax提交数据到服务端。

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=!collection_form"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW" @click.prevent="add_collection"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="key==current_collection?'_31PCv':''" @click="current_collection=key" :title="collection.name" v-for="collection,key in collection_list">
          <div class="_3P4JX _2VLy-" v-if="key==current_collection" @click.stop="is_show_collection_menu=!is_show_collection_menu">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_collection_menu?'NvfK4':''">
                <li class="_2po2r cRfUr" @click.prevent.stop="put_collection">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" @click.prevent.stop="del_collection">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv _33nt7" title="ABC">
                <i class="_13kgp _2m93u"></i>
                <div class="_3P4JX poOXI">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn">
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" title="随笔"><span class="">随笔</span></li>
                          </ul>
                        </div>
                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">ABC</span>
                <span class="hLzJv">题目：有四个数字：1、2、3、4，能组成多少个互不相同且无重复数字的三位数？各是多少？

题目：企业发放的奖金根据利润提成</span>
                <span class="_29C-V">字数:905</span>
              </li>
              <li class="_25Ilv" title="2020-01-12">
                <i class="_13kgp"></i>
                <span class="NariC">2020-01-12</span>
                <span class="hLzJv">题目：有四个数字：1、2、3、4，能组成多少个互不相同且无重复数字的三位数？各是多少？

题目：企业发放的奖金根据利润提成</span>
              </li>
            </ul>
            <div class="_2cVn3"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" value="2020-01-12">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>
  </div>
</template>
<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    import '../../static/font-awesome/css/font-awesome.css'
    export default {
        name: "Writer",
        data(){
          return {
            token: "",
            editorContent:"",
            img_file:[],
            collection_form:false,
            collection_name:"",  // 本次新增的文集名称
            is_show_page: false,   // 控制是否显示页面
            collection_list:[],    // 当前登录用户的文集列表
            current_collection: 0, // 当前用户选中操作的文集下标,默认为第一个文集,也就是下标为0的文集
            is_show_collection_menu:false, // 控制文集菜单是否显示
          }
        },
        watch:{
            editorContent(){
                console.log(this.editorContent)
            },
            current_collection(){
                // 切换操作的文集
                this.is_show_collection_menu = false;
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
                // 点选页面其他位置，关闭菜单
                document.onclick = (event)=>{
                    // 关闭文集菜单
                    this.is_show_collection_menu = false;
                }
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
            if(this.token){
                this.get_collection();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          get_collection(){
            // 获取当前用户的文集列表
            this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                headers:{  // 设置本次http的请求头信息
                    Authorization: "JWT "+ this.token,
                }
            }).then(response=>{
               this.collection_list = response.data;
            }).catch(error=>{
               this.$message.error("网络异常,获取文集列表失败!");
            });
          },
          add_collection(){
              // 添加文集
              this.$axios.post(`${this.$settings.Host}/article/collection/`,{
                  name: this.collection_name
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("新增文集成功！");
                  this.collection_list.push(response.data);
                  // 清空和关闭添加文集的表单
                  this.collection_name="";
                  this.collection_form=false;
              }).catch(error=>{
                  this.$message.error("对不起，新增文集失败！");
              });

          },
          del_collection(){
              // 删除文集
              if(this.collection_list.length<2){
                  this.$message.error("对不起，当前文集列表只剩下一个文集了，所以不能删除！");
                  return false;
              }

              // 获取本次操作的文集，提取文集的id
              let collection_id = this.collection_list[this.current_collection].id;
              let collection_name = this.collection_list[this.current_collection].name;
              this.$confirm(`确认要删除当前文集《${collection_name}》吗？`, '危险操作', {
                confirmButtonText: '删除',
                cancelButtonText: '取消',
                type: 'warning'
              }).then(() => {
                // 确认删除
                this.$axios.delete(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                    headers:{
                        Authorization: "jwt " + this.token,
                    }
                }).then(response=>{
                    this.$message.success("成功删除当前文集！");
                    // 客户端从文集列表移除当前文集，并重置当前操作的文集ID为0
                    this.collection_list.splice(this.current_collection,1);
                    this.current_collection = 0;
                }).catch(error=>{
                    this.$message.error("删除文集失败！");
                });

              }).catch(() => {
                // 取消

              });
          },
          put_collection(){
            // 修改文集名称
            let collection_id = this.collection_list[this.current_collection].id;
            let collection_name = this.collection_list[this.current_collection].name;
            // 显示修改文集名称的弹窗
            this.$prompt('请输入新的文集名称', '修改文集', {
              confirmButtonText: '更新',
              cancelButtonText: '取消',
              inputValidator(val){
                if(val==collection_name){
                    return "对不起，文集名称没有进行修改！";
                }
              },
            }).then(({ value }) => {
              // 发送ajax请求服务端修改文集名称
              this.$axios.put(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                  name: value,
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                 this.collection_list[this.current_collection].name = value;
              }).catch(error=>{
                 // 取消不需要做任何事情

              });

            }).catch(() => {

            });
          },
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          }
        }
    }
</script>
```



## 显示当前文集的文章列表

为方便开发，我们把文章模型注册到xadmin中，article/adminx，代码：

```python
import xadmin
# 文集
from .models import ArticleCollection
class ArticleCollectionModelAdmin(object):
    list_display = ["id","name"]
xadmin.site.register(ArticleCollection,ArticleCollectionModelAdmin)
# 文章
from .models import Article
class ArticleModelAdmin(object):
    list_display = ["id","title","collection", "user","is_public","pub_date"]
xadmin.site.register(Article,ArticleModelAdmin)
```



调整模型，修改了下文章模型的代码，其他没变化，不需要数据迁移，代码：

```python
class Article(BaseModel):
    title = models.CharField(max_length=150, db_index=True, verbose_name="文章")
    content = models.TextField(verbose_name="文章内容")
    html_content = models.TextField(verbose_name="文章内容[html格式]")
    user = models.ForeignKey(User,related_name="myarticles", on_delete=models.DO_NOTHING, verbose_name="作者")
    collection = models.ForeignKey(ArticleCollection, related_name="article_list", on_delete=models.CASCADE, verbose_name="文集")
    pub_date = models.DateTimeField(null=True,blank=True, default=None, verbose_name="发布时间")
    access_pwd = models.CharField(max_length=15, null=True, blank=True, verbose_name="访问密码")
    read_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="阅读量")
    like_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="点赞量")
    collect_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="收藏量")
    comment_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="评论量")
    reward_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="赞赏量")
    is_public = models.BooleanField(default=False, verbose_name="是否公开")

    class Meta:
        db_table = "rr_article"
        verbose_name = "文章"
        verbose_name_plural = verbose_name

    def __str__(self):
        return self.title
```

视图，代码：

```python
from .models import Article
from .serializers import ArticleModelSerializer
class ArticleAPIView(ListAPIView):
    """文章视图接口"""
    # queryset = Article.objects.all()
    serializer_class = ArticleModelSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        # /article/collection/<collection>\d/articles/
        # 获取路由参数的另一种方式 self.kwargs.get("参数名称")
        collection_id = self.kwargs.get("collection")
        return Article.objects.filter(is_deleted=False, is_show=True, user=self.request.user, collection_id=collection_id).order_by("orders", "id")
```

序列化器，代码：

```python
from .models import Article
class ArticleModelSerializer(serializers.ModelSerializer):
    """文章序列化器"""
    class Meta:
        model = Article
        fields = ["id","title","content","html_content","is_public","pub_date"]
```

路由代码：

```python
from django.urls import path,re_path
from . import views
urlpatterns = [
    path("collection/", views.CollectionAPIView.as_view()),
    # 开发中如果出现多条正则路由存在部分相同,则需要加上正则的开始^和结束$
    re_path("^collection/(?P<pk>\d+)/$", views.CollectionAPIView.as_view()),
    re_path("^collection/(?P<collection>\d+)/articles/$", views.ArticleAPIView.as_view()),
]
```

前端展示当前文集的文章列表，代码：

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=!collection_form"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW" @click.prevent="add_collection"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="key==current_collection?'_31PCv':''" @click="current_collection=key" :title="collection.name" v-for="collection,key in collection_list">
          <div class="_3P4JX _2VLy-" v-if="key==current_collection" @click.stop="is_show_collection_menu=!is_show_collection_menu">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_collection_menu?'NvfK4':''">
                <li class="_2po2r cRfUr" @click.prevent.stop="put_collection">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" @click.prevent.stop="del_collection">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv" :class="key==current_article?'_33nt7':''" @click="current_article=key" :title="article.title" v-for="article,key in article_list">
                <!-- 文章的发布状态 -->
                <i class="_13kgp" :class="article.is_public?'_2m93u':''"></i>
                <div class="_3P4JX poOXI" v-if="key==current_article">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn">
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" title="随笔"><span class="">随笔</span></li>
                          </ul>
                        </div>
                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">{{article.title}}</span>
                <span class="hLzJv">{{article.content.substr(0,20)}}</span>
                <span class="_29C-V" v-if="key==current_article">字数:{{article.content.length}}</span>
              </li>
            </ul>
            <div class="_2cVn3"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" value="2020-01-12">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>
  </div>
</template>
<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    import '../../static/font-awesome/css/font-awesome.css'
    export default {
        name: "Writer",
        data(){
          return {
            token: "",
            editorContent:"",
            img_file:[],
            collection_form:false,
            collection_name:"",  // 本次新增的文集名称
            is_show_page: false,   // 控制是否显示页面
            collection_list:[],    // 当前登录用户的文集列表
            current_collection: 0, // 当前用户选中操作的文集下标,默认为第一个文集,也就是下标为0的文集
            is_show_collection_menu:false, // 控制文集菜单是否显示
            article_list: [],     // 当前文集的文章列表
            current_article: 0,   // 当前用户选中操作的文章下标,默认为第一个文章,也就是下标为0的文章
          }
        },
        watch:{
            editorContent(){
                console.log(this.editorContent)
            },
            current_collection(){
                // 切换操作的文集
                this.is_show_collection_menu = false;
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
                // 点选页面其他位置，关闭菜单
                document.onclick = (event)=>{
                    // 关闭文集菜单
                    this.is_show_collection_menu = false;
                }
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
            if(this.token){
                this.get_collection();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          get_collection(){
            // 获取当前用户的文集列表
            this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                headers:{  // 设置本次http的请求头信息
                    Authorization: "JWT "+ this.token,
                }
            }).then(response=>{
               this.collection_list = response.data;
               // 成功获取文集列表以后, 再发送ajax请求获取当前文集下的文章列表
               this.get_article();
            }).catch(error=>{
               this.$message.error("网络异常,获取文集列表失败!");
            });
          },
          add_collection(){
              // 添加文集
              this.$axios.post(`${this.$settings.Host}/article/collection/`,{
                  name: this.collection_name
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("新增文集成功！");
                  this.collection_list.push(response.data);
                  // 清空和关闭添加文集的表单
                  this.collection_name="";
                  this.collection_form=false;
              }).catch(error=>{
                  this.$message.error("对不起，新增文集失败！");
              });

          },
          del_collection(){
              // 删除文集
              if(this.collection_list.length<2){
                  this.$message.error("对不起，当前文集列表只剩下一个文集了，所以不能删除！");
                  return false;
              }

              // 获取本次操作的文集，提取文集的id
              let collection_id = this.collection_list[this.current_collection].id;
              let collection_name = this.collection_list[this.current_collection].name;
              this.$confirm(`确认要删除当前文集《${collection_name}》吗？`, '危险操作', {
                confirmButtonText: '删除',
                cancelButtonText: '取消',
                type: 'warning'
              }).then(() => {
                // 确认删除
                this.$axios.delete(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                    headers:{
                        Authorization: "jwt " + this.token,
                    }
                }).then(response=>{
                    this.$message.success("成功删除当前文集！");
                    // 客户端从文集列表移除当前文集，并重置当前操作的文集ID为0
                    this.collection_list.splice(this.current_collection,1);
                    this.current_collection = 0;
                }).catch(error=>{
                    this.$message.error("删除文集失败！");
                });

              }).catch(() => {
                // 取消

              });
          },
          put_collection(){
            // 修改文集名称
            let collection_id = this.collection_list[this.current_collection].id;
            let collection_name = this.collection_list[this.current_collection].name;
            // 显示修改文集名称的弹窗
            this.$prompt('请输入新的文集名称', '修改文集', {
              confirmButtonText: '更新',
              cancelButtonText: '取消',
              inputValidator(val){
                if(val==collection_name){
                    return "对不起，文集名称没有进行修改！";
                }
              },
            }).then(({ value }) => {
              // 发送ajax请求服务端修改文集名称
              this.$axios.put(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                  name: value,
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                 this.collection_list[this.current_collection].name = value;
              }).catch(error=>{
                 // 取消不需要做任何事情

              });

            }).catch(() => {

            });
          },
          get_article(){
            // 获取当前文集的文章列表
            // 当前文集ID
            let collection_id = this.collection_list[this.current_collection].id;
            this.$axios.get(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
               this.article_list = response.data;
            }).catch(error=>{
               this.$message.error("获取文章列表失败!");
            });
          },
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          }
        }
    }
</script>
```



控制文章操作菜单的显示和隐藏，代码：

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=!collection_form"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW" @click.prevent="add_collection"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="key==current_collection?'_31PCv':''" @click="current_collection=key" :title="collection.name" v-for="collection,key in collection_list">
          <div class="_3P4JX _2VLy-" v-if="key==current_collection" @click.stop="is_show_collection_menu=!is_show_collection_menu">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_collection_menu?'NvfK4':''">
                <li class="_2po2r cRfUr" @click.prevent.stop="put_collection">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" @click.prevent.stop="del_collection">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv" :class="key==current_article?'_33nt7':''" @click="current_article=key" :title="article.title" v-for="article,key in article_list">
                <!-- 文章的发布状态 -->
                <i class="_13kgp" :class="article.is_public?'_2m93u':''"></i>
                <div class="_3P4JX poOXI" v-if="key==current_article" @click.stop.prevent="is_show_article_menu=!is_show_article_menu">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_article_menu?'NvfK4':''">
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" title="随笔"><span class="">随笔</span></li>
                          </ul>
                        </div>
                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">{{article.title}}</span>
                <span class="hLzJv">{{article.content.substr(0,20)}}</span>
                <span class="_29C-V" v-if="key==current_article">字数:{{article.content.length}}</span>
              </li>
            </ul>
            <div class="_2cVn3"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" value="2020-01-12">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>
  </div>
</template>
<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    import '../../static/font-awesome/css/font-awesome.css'
    export default {
        name: "Writer",
        data(){
          return {
            token: "",
            editorContent:"",
            img_file:[],
            collection_form:false,
            collection_name:"",  // 本次新增的文集名称
            is_show_page: false,   // 控制是否显示页面
            collection_list:[],    // 当前登录用户的文集列表
            current_collection: 0, // 当前用户选中操作的文集下标,默认为第一个文集,也就是下标为0的文集
            is_show_collection_menu:false, // 控制文集菜单是否显示
            article_list: [],     // 当前文集的文章列表
            current_article: 0,   // 当前用户选中操作的文章下标,默认为第一个文章,也就是下标为0的文章
            is_show_article_menu:false, // 控制文章菜单是否显示
          }
        },
        watch:{
            editorContent(){
                console.log(this.editorContent)
            },
            current_collection(){
              // 切换操作的文集
              this.is_show_collection_menu = false;
              // 重新获取当前文集的文章列表
              this.get_article();
            },
            current_article(){
              // 切换操作的文章
              this.is_show_article_menu = false;
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
                // 点选页面其他位置，关闭菜单
                document.onclick = (event)=>{
                    // 关闭文集菜单
                    this.is_show_collection_menu = false;
                    // 关闭文章菜单
                    this.is_show_article_menu = false;
                }
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
            if(this.token){
                this.get_collection();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          get_collection(){
            // 获取当前用户的文集列表
            this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                headers:{  // 设置本次http的请求头信息
                    Authorization: "JWT "+ this.token,
                }
            }).then(response=>{
               this.collection_list = response.data;
               // 成功获取文集列表以后, 再发送ajax请求获取当前文集下的文章列表
               this.get_article();
            }).catch(error=>{
               this.$message.error("网络异常,获取文集列表失败!");
            });
          },
          add_collection(){
              // 添加文集
              this.$axios.post(`${this.$settings.Host}/article/collection/`,{
                  name: this.collection_name
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("新增文集成功！");
                  this.collection_list.push(response.data);
                  // 清空和关闭添加文集的表单
                  this.collection_name="";
                  this.collection_form=false;
              }).catch(error=>{
                  this.$message.error("对不起，新增文集失败！");
              });

          },
          del_collection(){
              // 删除文集
              if(this.collection_list.length<2){
                  this.$message.error("对不起，当前文集列表只剩下一个文集了，所以不能删除！");
                  return false;
              }

              // 获取本次操作的文集，提取文集的id
              let collection_id = this.collection_list[this.current_collection].id;
              let collection_name = this.collection_list[this.current_collection].name;
              this.$confirm(`确认要删除当前文集《${collection_name}》吗？`, '危险操作', {
                confirmButtonText: '删除',
                cancelButtonText: '取消',
                type: 'warning'
              }).then(() => {
                // 确认删除
                this.$axios.delete(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                    headers:{
                        Authorization: "jwt " + this.token,
                    }
                }).then(response=>{
                    this.$message.success("成功删除当前文集！");
                    // 客户端从文集列表移除当前文集，并重置当前操作的文集ID为0
                    this.collection_list.splice(this.current_collection,1);
                    this.current_collection = 0;
                    // 重新获取文章列表
                    this.get_article();
                }).catch(error=>{
                    this.$message.error("删除文集失败！");
                });

              }).catch(() => {
                // 取消

              });
          },
          put_collection(){
            // 修改文集名称
            let collection_id = this.collection_list[this.current_collection].id;
            let collection_name = this.collection_list[this.current_collection].name;
            // 显示修改文集名称的弹窗
            this.$prompt('请输入新的文集名称', '修改文集', {
              confirmButtonText: '更新',
              cancelButtonText: '取消',
              inputValidator(val){
                if(val==collection_name){
                    return "对不起，文集名称没有进行修改！";
                }
              },
            }).then(({ value }) => {
              // 发送ajax请求服务端修改文集名称
              this.$axios.put(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                  name: value,
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                 this.collection_list[this.current_collection].name = value;
              }).catch(error=>{
                 // 取消不需要做任何事情

              });

            }).catch(() => {

            });
          },
          get_article(){
            // 获取当前文集的文章列表
            // 当前文集ID
            let collection_id = this.collection_list[this.current_collection].id;
            this.$axios.get(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
               this.article_list = response.data;
            }).catch(error=>{
               this.$message.error("获取文章列表失败!");
            });
          },
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          }
        }
    }
</script>

```



## 添加文章

调整模型，因为新增文章，是用户通过点击按钮来生成的，所以不会有内容出现。因此调整内容字段不是必填的。

```python
class Article(BaseModel):
    title = models.CharField(max_length=150, db_index=True, verbose_name="文章")
    content = models.TextField(null=True, blank=True, verbose_name="文章内容")
    html_content = models.TextField(null=True, blank=True, verbose_name="文章内容[html格式]")
    user = models.ForeignKey(User,related_name="myarticles", on_delete=models.DO_NOTHING, verbose_name="作者")
    collection = models.ForeignKey(ArticleCollection, related_name="article_list", on_delete=models.CASCADE, verbose_name="文集")
    pub_date = models.DateTimeField(null=True,blank=True, default=None, verbose_name="发布时间")
    access_pwd = models.CharField(max_length=15, null=True, blank=True, verbose_name="访问密码")
    read_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="阅读量")
    like_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="点赞量")
    collect_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="收藏量")
    comment_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="评论量")
    reward_count = models.IntegerField(default=0, null=True, blank=True, verbose_name="赞赏量")
    is_public = models.BooleanField(default=False, verbose_name="是否公开")

    class Meta:
        db_table = "rr_article"
        verbose_name = "文章"
        verbose_name_plural = verbose_name

    def __str__(self):
        return self.title
```

数据迁移：

```bash
python manage.py makemigrations
python manage.py migrate
```

在文章视图的视图类中新增父类CreateAPIView，代码：

```python
from .models import Article
from .serializers import ArticleModelSerializer
class ArticleAPIView(ListAPIView,CreateAPIView):
    """文章视图接口"""
    # queryset = Article.objects.all()
    serializer_class = ArticleModelSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        # /article/collection/<collection>\d/articles/
        # 获取路由参数的另一种方式 self.kwargs.get("参数名称")
        collection_id = self.kwargs.get("collection")
        return Article.objects.filter(is_deleted=False, is_show=True, user=self.request.user, collection_id=collection_id).order_by("orders", "id")
```

序列化器，代码：

```python
from .models import Article
from django.utils import timezone as datetime
class ArticleModelSerializer(serializers.ModelSerializer):
    """文章序列化器"""
    insert = serializers.BooleanField(write_only=True,required=False, default=True, help_text="新增文章的排序位置: True表示开头,False表示末尾")
    class Meta:
        model = Article
        fields = ["id","title","content","html_content","is_public","pub_date","insert"]

    def create(self, validated_data):
        """添加文章"""
        # 如果希望在序列化器中获取视图中的路由参数,必须先获取视图对象
        # self.context["view"] # 调用当前序列化器的视图对象
        # self.context["request"] # 本次客户端发送的http请求
        # self.context["format"]  # 本次客户端期望服务端发送的数据格
        collection_id = int( self.context["view"].kwargs.get("collection") )

        instance = Article.objects.create(
            title= datetime.now().strftime("%Y-%m-%d"),
            user = self.context["request"].user,
            collection_id=collection_id,
        )

        # 处理文章的顺序
        if not validated_data.get("insert"):
            """把文章调整到末尾"""
            instance.orders = 0-instance.id
            instance.save()

        return instance
```

路由代码没有变化。

客户端发送ajax，代码：

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=!collection_form"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW" @click.prevent="add_collection"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="key==current_collection?'_31PCv':''" @click="current_collection=key" :title="collection.name" v-for="collection,key in collection_list">
          <div class="_3P4JX _2VLy-" v-if="key==current_collection" @click.stop="is_show_collection_menu=!is_show_collection_menu">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_collection_menu?'NvfK4':''">
                <li class="_2po2r cRfUr" @click.prevent.stop="put_collection">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" @click.prevent.stop="del_collection">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5" @click="add_article(true)"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv" :class="key==current_article?'_33nt7':''" @click="current_article=key" :title="article.title" v-for="article,key in article_list">
                <!-- 文章的发布状态 -->
                <i class="_13kgp" :class="article.is_public?'_2m93u':''"></i>
                <div class="_3P4JX poOXI" v-if="key==current_article" @click.stop.prevent="is_show_article_menu=!is_show_article_menu">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_article_menu?'NvfK4':''">
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" title="随笔"><span class="">随笔</span></li>
                          </ul>
                        </div>
                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">{{article.title}}</span>
                <span class="hLzJv" v-if="article.content">{{article.content.substr(0,20)}}</span>
                <span class="hLzJv" v-else></span>
                <span class="_29C-V" v-if="key==current_article">
                  字数:
                  <span v-if="article.content">{{article.content.length}}</span>
                  <span v-else>0</span>
                </span>
              </li>
            </ul>
            <div class="_2cVn3" @click="add_article(false)"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" value="2020-01-12">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>
  </div>
</template>
<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    import '../../static/font-awesome/css/font-awesome.css'
    export default {
        name: "Writer",
        data(){
          return {
            token: "",
            editorContent:"",
            img_file:[],
            collection_form:false,
            collection_name:"",  // 本次新增的文集名称
            is_show_page: false,   // 控制是否显示页面
            collection_list:[],    // 当前登录用户的文集列表
            current_collection: 0, // 当前用户选中操作的文集下标,默认为第一个文集,也就是下标为0的文集
            is_show_collection_menu:false, // 控制文集菜单是否显示
            article_list: [],     // 当前文集的文章列表
            current_article: 0,   // 当前用户选中操作的文章下标,默认为第一个文章,也就是下标为0的文章
            is_show_article_menu:false, // 控制文章菜单是否显示
          }
        },
        watch:{
            editorContent(){
                console.log(this.editorContent)
            },
            current_collection(){
              // 切换操作的文集
              this.is_show_collection_menu = false;
              // 重新获取当前文集的文章列表
              this.get_article();
            },
            current_article(){
              // 切换操作的文章
              this.is_show_article_menu = false;
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
                // 点选页面其他位置，关闭菜单
                document.onclick = (event)=>{
                    // 关闭文集菜单
                    this.is_show_collection_menu = false;
                    // 关闭文章菜单
                    this.is_show_article_menu = false;
                }
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
            if(this.token){
                this.get_collection();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          get_collection(){
            // 获取当前用户的文集列表
            this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                headers:{  // 设置本次http的请求头信息
                    Authorization: "JWT "+ this.token,
                }
            }).then(response=>{
               this.collection_list = response.data;
               // 成功获取文集列表以后, 再发送ajax请求获取当前文集下的文章列表
               this.get_article();
            }).catch(error=>{
               this.$message.error("网络异常,获取文集列表失败!");
            });
          },
          add_collection(){
              // 添加文集
              this.$axios.post(`${this.$settings.Host}/article/collection/`,{
                  name: this.collection_name
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("新增文集成功！");
                  this.collection_list.push(response.data);
                  // 清空和关闭添加文集的表单
                  this.collection_name="";
                  this.collection_form=false;
              }).catch(error=>{
                  this.$message.error("对不起，新增文集失败！");
              });

          },
          del_collection(){
              // 删除文集
              if(this.collection_list.length<2){
                  this.$message.error("对不起，当前文集列表只剩下一个文集了，所以不能删除！");
                  return false;
              }

              // 获取本次操作的文集，提取文集的id
              let collection_id = this.collection_list[this.current_collection].id;
              let collection_name = this.collection_list[this.current_collection].name;
              this.$confirm(`确认要删除当前文集《${collection_name}》吗？`, '危险操作', {
                confirmButtonText: '删除',
                cancelButtonText: '取消',
                type: 'warning'
              }).then(() => {
                // 确认删除
                this.$axios.delete(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                    headers:{
                        Authorization: "jwt " + this.token,
                    }
                }).then(response=>{
                    this.$message.success("成功删除当前文集！");
                    // 客户端从文集列表移除当前文集，并重置当前操作的文集ID为0
                    this.collection_list.splice(this.current_collection,1);
                    this.current_collection = 0;
                    // 重新获取文章列表
                    this.get_article();
                }).catch(error=>{
                    this.$message.error("删除文集失败！");
                });

              }).catch(() => {
                // 取消

              });
          },
          put_collection(){
            // 修改文集名称
            let collection_id = this.collection_list[this.current_collection].id;
            let collection_name = this.collection_list[this.current_collection].name;
            // 显示修改文集名称的弹窗
            this.$prompt('请输入新的文集名称', '修改文集', {
              confirmButtonText: '更新',
              cancelButtonText: '取消',
              inputValidator(val){
                if(val==collection_name){
                    return "对不起，文集名称没有进行修改！";
                }
              },
            }).then(({ value }) => {
              // 发送ajax请求服务端修改文集名称
              this.$axios.put(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                  name: value,
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                 this.collection_list[this.current_collection].name = value;
              }).catch(error=>{
                 // 取消不需要做任何事情

              });

            }).catch(() => {

            });
          },
          get_article(){
            // 获取当前文集的文章列表
            // 当前文集ID
            let collection_id = this.collection_list[this.current_collection].id;
            this.$axios.get(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
               this.article_list = response.data;
            }).catch(error=>{
               this.$message.error("获取文章列表失败!");
            });
          },
          add_article(insert){
              let collection_id = this.collection_list[this.current_collection].id;
              this.$axios.post(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                  insert, // insert:insert的简写
                  title: new Date().toLocaleDateString().split("/").join("-"),
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  // 根据insert的值判断是插入文章还是追加文章
                  if(insert){
                      this.article_list.unshift(response.data);
                      this.current_article=0;
                  }else{
                      this.article_list.push(response.data);
                      this.current_article=this.article_list.length-1;
                  }
              }).catch(error=>{
                  this.$message.error("添加文章失败!请联系客服工作人员!");
              })
          },
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          }
        }
    }
</script>
```





## 文章发布

默认情况下，新建的文章属于未发布状态下的，这时候除了作者本人和后台管理员，其他人看不到的。

1.  在写文章页面，我们需要给用户区分哪些文章已经发布了，哪些文章没有发布。
2.  在写文章页面，提供一个api，用于修改发布状态。同时，需要提供发布后的文章页面。

### 切换文章的发布状态

服务端提供切换文章发布状态的功能。、

视图代码：

```python
from .models import Article
from .serializers import ArticleModelSerializer
from rest_framework.response import Response

class ArticleAPIView(ListAPIView,CreateAPIView):
    """文章视图接口"""
    # queryset = Article.objects.all()
    serializer_class = ArticleModelSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        # /article/collection/<collection>\d/articles/
        # 获取路由参数的另一种方式 self.kwargs.get("参数名称")
        collection_id = self.kwargs.get("collection")
        return Article.objects.filter(is_deleted=False, is_show=True, user=self.request.user, collection_id=collection_id).order_by("orders", "id")

    def patch(self,request,pk):
        try:
            article = Article.objects.get(pk=pk,is_deleted=False, is_show=True, user=self.request.user)
        except Article.DoesNotExist:
            return Response({"detail":"当前文章不存在!"})

        article.is_public=not article.is_public
        article.save()
        return Response({"detail":"发布状态切换成功!"})
```

路由代码：

```python
from django.urls import path,re_path
from . import views
urlpatterns = [
    path("collection/", views.CollectionAPIView.as_view()),
    # 开发中如果出现多条正则路由存在部分相同,则需要加上正则的开始^和结束$
    re_path("^collection/(?P<pk>\d+)/$", views.CollectionAPIView.as_view()),
    re_path("^collection/(?P<collection>\d+)/articles/$", views.ArticleAPIView.as_view()),
    re_path("^(?P<pk>\d+)/$", views.ArticleAPIView.as_view()),
]
```

前端代码：

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=!collection_form"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW" @click.prevent="add_collection"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="key==current_collection?'_31PCv':''" @click="current_collection=key" :title="collection.name" v-for="collection,key in collection_list">
          <div class="_3P4JX _2VLy-" v-if="key==current_collection" @click.stop="is_show_collection_menu=!is_show_collection_menu">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_collection_menu?'NvfK4':''">
                <li class="_2po2r cRfUr" @click.prevent.stop="put_collection">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" @click.prevent.stop="del_collection">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5" @click="add_article(true)"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv" :class="key==current_article?'_33nt7':''" @click="current_article=key" :title="article.title" v-for="article,key in article_list">
                <!-- 文章的发布状态 -->
                <i class="_13kgp" :class="article.is_public?'_2m93u':''"></i>
                <div class="_3P4JX poOXI" v-if="key==current_article" @click.stop.prevent="is_show_article_menu=!is_show_article_menu">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_article_menu?'NvfK4':''">
                      <li class="_2po2r cRfUr" @click.stop.prevent="pub_article" v-if="!article.is_public"><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" @click.stop.prevent="pub_article" v-else><span class=""><i class="fa fa-share _22XWG"></i>设置为隐私文章</span></li>
                      <li class="_2po2r cRfUr"><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr"><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr"><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" title="随笔"><span class="">随笔</span></li>
                          </ul>
                        </div>
                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">{{article.title}}</span>
                <span class="hLzJv" v-if="article.content">{{article.content.substr(0,20)}}</span>
                <span class="hLzJv" v-else></span>
                <span class="_29C-V" v-if="key==current_article">
                  字数:
                  <span v-if="article.content">{{article.content.length}}</span>
                  <span v-else>0</span>
                </span>
              </li>
            </ul>
            <div class="_2cVn3" @click="add_article(false)"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" value="2020-01-12">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>
  </div>
</template>
<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    import '../../static/font-awesome/css/font-awesome.css'
    export default {
        name: "Writer",
        data(){
          return {
            token: "",
            editorContent:"",
            img_file:[],
            collection_form:false,
            collection_name:"",  // 本次新增的文集名称
            is_show_page: false,   // 控制是否显示页面
            collection_list:[],    // 当前登录用户的文集列表
            current_collection: 0, // 当前用户选中操作的文集下标,默认为第一个文集,也就是下标为0的文集
            is_show_collection_menu:false, // 控制文集菜单是否显示
            article_list: [],     // 当前文集的文章列表
            current_article: 0,   // 当前用户选中操作的文章下标,默认为第一个文章,也就是下标为0的文章
            is_show_article_menu:false, // 控制文章菜单是否显示
          }
        },
        watch:{
            editorContent(){
                console.log(this.editorContent)
            },
            current_collection(){
              // 切换操作的文集
              this.is_show_collection_menu = false;
              // 重新获取当前文集的文章列表
              this.get_article();
            },
            current_article(){
              // 切换操作的文章
              this.is_show_article_menu = false;
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
                // 点选页面其他位置，关闭菜单
                document.onclick = (event)=>{
                    // 关闭文集菜单
                    this.is_show_collection_menu = false;
                    // 关闭文章菜单
                    this.is_show_article_menu = false;
                }
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
            if(this.token){
                this.get_collection();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          get_collection(){
            // 获取当前用户的文集列表
            this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                headers:{  // 设置本次http的请求头信息
                    Authorization: "JWT "+ this.token,
                }
            }).then(response=>{
               this.collection_list = response.data;
               // 成功获取文集列表以后, 再发送ajax请求获取当前文集下的文章列表
               this.get_article();
            }).catch(error=>{
               this.$message.error("网络异常,获取文集列表失败!");
            });
          },
          add_collection(){
              // 添加文集
              this.$axios.post(`${this.$settings.Host}/article/collection/`,{
                  name: this.collection_name
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("新增文集成功！");
                  this.collection_list.push(response.data);
                  // 清空和关闭添加文集的表单
                  this.collection_name="";
                  this.collection_form=false;
              }).catch(error=>{
                  this.$message.error("对不起，新增文集失败！");
              });

          },
          del_collection(){
              // 删除文集
              if(this.collection_list.length<2){
                  this.$message.error("对不起，当前文集列表只剩下一个文集了，所以不能删除！");
                  return false;
              }

              // 获取本次操作的文集，提取文集的id
              let collection_id = this.collection_list[this.current_collection].id;
              let collection_name = this.collection_list[this.current_collection].name;
              this.$confirm(`确认要删除当前文集《${collection_name}》吗？`, '危险操作', {
                confirmButtonText: '删除',
                cancelButtonText: '取消',
                type: 'warning'
              }).then(() => {
                // 确认删除
                this.$axios.delete(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                    headers:{
                        Authorization: "jwt " + this.token,
                    }
                }).then(response=>{
                    this.$message.success("成功删除当前文集！");
                    // 客户端从文集列表移除当前文集，并重置当前操作的文集ID为0
                    this.collection_list.splice(this.current_collection,1);
                    this.current_collection = 0;
                    // 重新获取文章列表
                    this.get_article();
                }).catch(error=>{
                    this.$message.error("删除文集失败！");
                });

              }).catch(() => {
                // 取消

              });
          },
          put_collection(){
            // 修改文集名称
            let collection_id = this.collection_list[this.current_collection].id;
            let collection_name = this.collection_list[this.current_collection].name;
            // 显示修改文集名称的弹窗
            this.$prompt('请输入新的文集名称', '修改文集', {
              confirmButtonText: '更新',
              cancelButtonText: '取消',
              inputValidator(val){
                if(val==collection_name){
                    return "对不起，文集名称没有进行修改！";
                }
              },
            }).then(({ value }) => {
              // 发送ajax请求服务端修改文集名称
              this.$axios.put(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                  name: value,
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                 this.collection_list[this.current_collection].name = value;
              }).catch(error=>{
                 // 取消不需要做任何事情

              });

            }).catch(() => {

            });
          },
          get_article(){
            // 获取当前文集的文章列表
            // 当前文集ID
            let collection_id = this.collection_list[this.current_collection].id;
            this.$axios.get(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
               this.article_list = response.data;
            }).catch(error=>{
               this.$message.error("获取文章列表失败!");
            });
          },
          add_article(insert){
              let collection_id = this.collection_list[this.current_collection].id;
              this.$axios.post(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                  insert, // insert:insert的简写
                  title: new Date().toLocaleDateString().split("/").join("-"),
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  // 根据insert的值判断是插入文章还是追加文章
                  if(insert){
                      this.article_list.unshift(response.data);
                      this.current_article=0;
                  }else{
                      this.article_list.push(response.data);
                      this.current_article=this.article_list.length-1;
                  }
              }).catch(error=>{
                  this.$message.error("添加文章失败!请联系客服工作人员!");
              })
          },
          pub_article(){
            // 切换文章发布状态
              let article = this.article_list[this.current_article];
              this.$axios.patch(`${this.$settings.Host}/article/${article.id}/`,{
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  article.is_public=!article.is_public;
              }).catch(error=>{
                  this.$message.error("添加文章失败!请联系客服工作人员!");
              });
              this.is_show_article_menu=false;
          },
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          }
        }
    }
</script>
```

![1584154673910](8%E6%96%87%E7%AB%A0%E6%A8%A1%E5%9D%97.assets/1584154673910-16414728079113.png)



## 移动文章

首先修复文章菜单中的文集列表，在css代码中这个位置放置以下代码：

```css
._2_WAp ._2KzJx, ._2_WAp ._3x4X_ {
    position: absolute;
    right: 100%;
    top: 0;
    display: none;
}
._2_WAp:hover ._2KzJx, ._2_WAp:hover ._3x4X_ {
    display: block;
}

# 修改组件的316和511代码中的宽度从16.66666667%改成13.6666667%：
.h-5Am {
    display: block;
    width: 13.66666667%;
    ....
}
  ._2v5v5 {
    position: relative;
    height: 100%;
    overflow-y: auto;
    background-color: #404040;
    color: #f2f2f2;
    z-index: 100;
    width: 13.66666667%;
```

服务端提供修改文章的文集ID的接口，代码：

```python
from .models import Article
from .serializers import ArticleModelSerializer
from rest_framework.response import Response

class ArticleAPIView(ListAPIView,CreateAPIView):
    """文章视图接口"""
    # queryset = Article.objects.all()
    serializer_class = ArticleModelSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        # /article/collection/<collection>\d/articles/
        # 获取路由参数的另一种方式 self.kwargs.get("参数名称")
        collection_id = self.kwargs.get("collection")
        return Article.objects.filter(is_deleted=False, is_show=True, user=self.request.user, collection_id=collection_id).order_by("orders", "id")

    def patch(self,request,pk):
        try:
            article = Article.objects.get(pk=pk,is_deleted=False, is_show=True, user=self.request.user)
        except Article.DoesNotExist:
            return Response({"detail":"当前文章不存在!"})

        article.is_public=not article.is_public
        article.save()
        return Response({"detail":"发布状态切换成功!"})

    def put(self,request,pk):
        try:
            article = Article.objects.get(pk=pk,is_deleted=False, is_show=True, user=self.request.user)
        except Article.DoesNotExist:
            return Response({"detail":"当前文章不存在!"})

        collection_id = int( request.data.get("collection") )
        article.collection_id=collection_id
        article.save()
        return Response({"detail":"移动文章成功!"})
```

路由没有任何调整。

客户端实现切换文集代码效果：

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=!collection_form"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW" @click.prevent="add_collection"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="key==current_collection?'_31PCv':''" @click="current_collection=key" :title="collection.name" v-for="collection,key in collection_list">
          <div class="_3P4JX _2VLy-" v-if="key==current_collection" @click.stop="is_show_collection_menu=!is_show_collection_menu">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_collection_menu?'NvfK4':''">
                <li class="_2po2r cRfUr" @click.prevent.stop="put_collection">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" @click.prevent.stop="del_collection">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5" @click="add_article(true)"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv" :class="key==current_article?'_33nt7':''" @click="current_article=key" :title="article.title" v-for="article,key in article_list">
                <!-- 文章的发布状态 -->
                <i class="_13kgp" :class="article.is_public?'_2m93u':''"></i>
                <div class="_3P4JX poOXI" v-if="key==current_article" @click.stop.prevent="is_show_article_menu=!is_show_article_menu">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_article_menu?'NvfK4':''">
                      <li class="_2po2r cRfUr" @click.stop.prevent="pub_article" v-if="!article.is_public"><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" @click.stop.prevent="pub_article" v-else><span class=""><i class="fa fa-share _22XWG"></i>设置为隐私文章</span></li>
                      <li class="_2po2r cRfUr"><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr"><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr"><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" @click="mov_article(collection.id)" :title="collection.name" v-if="key!=current_collection" v-for="collection,key in collection_list"><span class="">{{collection.name}}</span></li>
                          </ul>
                        </div>

                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">{{article.title}}</span>
                <span class="hLzJv" v-if="article.content">{{article.content.substr(0,20)}}</span>
                <span class="hLzJv" v-else></span>
                <span class="_29C-V" v-if="key==current_article">
                  字数:
                  <span v-if="article.content">{{article.content.length}}</span>
                  <span v-else>0</span>
                </span>
              </li>
            </ul>
            <div class="_2cVn3" @click="add_article(false)"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" value="2020-01-12">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>
  </div>
</template>
<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    import '../../static/font-awesome/css/font-awesome.css'
    export default {
        name: "Writer",
        data(){
          return {
            token: "",
            editorContent:"",
            img_file:[],
            collection_form:false,
            collection_name:"",  // 本次新增的文集名称
            is_show_page: false,   // 控制是否显示页面
            collection_list:[],    // 当前登录用户的文集列表
            current_collection: 0, // 当前用户选中操作的文集下标,默认为第一个文集,也就是下标为0的文集
            is_show_collection_menu:false, // 控制文集菜单是否显示
            article_list: [],     // 当前文集的文章列表
            current_article: 0,   // 当前用户选中操作的文章下标,默认为第一个文章,也就是下标为0的文章
            is_show_article_menu:false, // 控制文章菜单是否显示
          }
        },
        watch:{
            editorContent(){
                console.log(this.editorContent)
            },
            current_collection(){
              // 切换操作的文集
              this.is_show_collection_menu = false;
              // 重新获取当前文集的文章列表
              this.get_article();
            },
            current_article(){
              // 切换操作的文章
              this.is_show_article_menu = false;
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
                // 点选页面其他位置，关闭菜单
                document.onclick = (event)=>{
                    // 关闭文集菜单
                    this.is_show_collection_menu = false;
                    // 关闭文章菜单
                    this.is_show_article_menu = false;
                }
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
            if(this.token){
                this.get_collection();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          get_collection(){
            // 获取当前用户的文集列表
            this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                headers:{  // 设置本次http的请求头信息
                    Authorization: "JWT "+ this.token,
                }
            }).then(response=>{
               this.collection_list = response.data;
               // 成功获取文集列表以后, 再发送ajax请求获取当前文集下的文章列表
               this.get_article();
            }).catch(error=>{
               this.$message.error("网络异常,获取文集列表失败!");
            });
          },
          add_collection(){
              // 添加文集
              this.$axios.post(`${this.$settings.Host}/article/collection/`,{
                  name: this.collection_name
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("新增文集成功！");
                  this.collection_list.push(response.data);
                  // 清空和关闭添加文集的表单
                  this.collection_name="";
                  this.collection_form=false;
              }).catch(error=>{
                  this.$message.error("对不起，新增文集失败！");
              });

          },
          del_collection(){
              // 删除文集
              if(this.collection_list.length<2){
                  this.$message.error("对不起，当前文集列表只剩下一个文集了，所以不能删除！");
                  return false;
              }

              // 获取本次操作的文集，提取文集的id
              let collection_id = this.collection_list[this.current_collection].id;
              let collection_name = this.collection_list[this.current_collection].name;
              this.$confirm(`确认要删除当前文集《${collection_name}》吗？`, '危险操作', {
                confirmButtonText: '删除',
                cancelButtonText: '取消',
                type: 'warning'
              }).then(() => {
                // 确认删除
                this.$axios.delete(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                    headers:{
                        Authorization: "jwt " + this.token,
                    }
                }).then(response=>{
                    this.$message.success("成功删除当前文集！");
                    // 客户端从文集列表移除当前文集，并重置当前操作的文集ID为0
                    this.collection_list.splice(this.current_collection,1);
                    this.current_collection = 0;
                    // 重新获取文章列表
                    this.get_article();
                }).catch(error=>{
                    this.$message.error("删除文集失败！");
                });

              }).catch(() => {
                // 取消

              });
          },
          put_collection(){
            // 修改文集名称
            let collection_id = this.collection_list[this.current_collection].id;
            let collection_name = this.collection_list[this.current_collection].name;
            // 显示修改文集名称的弹窗
            this.$prompt('请输入新的文集名称', '修改文集', {
              confirmButtonText: '更新',
              cancelButtonText: '取消',
              inputValidator(val){
                if(val==collection_name){
                    return "对不起，文集名称没有进行修改！";
                }
              },
            }).then(({ value }) => {
              // 发送ajax请求服务端修改文集名称
              this.$axios.put(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                  name: value,
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                 this.collection_list[this.current_collection].name = value;
              }).catch(error=>{
                 // 取消不需要做任何事情

              });

            }).catch(() => {

            });
          },
          get_article(){
            // 获取当前文集的文章列表
            // 当前文集ID
            let collection_id = this.collection_list[this.current_collection].id;
            this.$axios.get(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
               this.article_list = response.data;
            }).catch(error=>{
               this.$message.error("获取文章列表失败!");
            });
          },
          add_article(insert){
              let collection_id = this.collection_list[this.current_collection].id;
              this.$axios.post(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                  insert, // insert:insert的简写
                  title: new Date().toLocaleDateString().split("/").join("-"),
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  // 根据insert的值判断是插入文章还是追加文章
                  if(insert){
                      this.article_list.unshift(response.data);
                      this.current_article=0;
                  }else{
                      this.article_list.push(response.data);
                      this.current_article=this.article_list.length-1;
                  }
              }).catch(error=>{
                  this.$message.error("添加文章失败!请联系客服工作人员!");
              })
          },
          pub_article(){
            // 切换文章发布状态
              let article = this.article_list[this.current_article];
              this.$axios.patch(`${this.$settings.Host}/article/${article.id}/`,{
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  article.is_public=!article.is_public;
              }).catch(error=>{
                  this.$message.error("添加文章失败!请联系客服工作人员!");
              });
              this.is_show_article_menu=false;
          },
          mov_article(collection_id){
            // 移动文章
            let article = this.article_list[this.current_article];
            this.$axios.put(`${this.$settings.Host}/article/${article.id}/`,{
                collection: collection_id,
            },{
                headers:{
                    Authorization: "jwt "+ this.token,
                }
            }).then(response=>{
                // 把已经移动到其他文集的文章从当前的文章列表中删除
                this.article_list.splice(this.current_article,1);
            }).catch(error=>{
                this.$message.error("移动文章失败!");
            });
          },
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          }
        }
    }
</script>

```



## 定时发布[扩展知识点]

```
原理：使用celery完成定时任务！
步骤：
1. 当用户点选了定时发布, 页面中弹出一个选择时间的窗口。
2. 当用户设置完成发布时间以后，点击“确认”以后,把这个时间和文章id发送到服务端。
3. 服务端中文章模型的pub_date记录这个定时发布时间。
4. 在celery中创建一个定时任务，在每个固定时间段，检查文章表中，对应时间段的pub_date把对应的文章进行发布。
```

前端增加一个选择时间的弹窗，代码；

```vue
<template>
  <div class="write" v-show="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><a href="/">回首页</a></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=true"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW" @click.prevent.stop="add_collection"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="current_collection==key?'_31PCv':''" :title="collection.name" v-for="collection,key in collection_list" :key="key">
          <div class="_3P4JX _2VLy-" v-if="current_collection==key" @click.stop="show_collection_menu">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_collection_menu?'NvfK4':''">
                <li class="_2po2r cRfUr" title="" @click.stop="edit_collection">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" title="">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span @click="current_collection=key">{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5" @click.stop="add_article(0)"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv" @click.stop="current_article=key" :class="current_article==key?'_33nt7':''" :title="article.name" v-for="article,key in article_list" :key="key">
                <i class="_13kgp" :class="article.is_public?'_2m93u':''"></i>
                <div class="_3P4JX poOXI" v-if="current_article==key" @click.stop="show_article_menu">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_article_menu?'NvfK4':''">
                      <li class="_2po2r cRfUr" title="" v-if="!article.is_public" @click.stop="public_article(true)"><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" title="" v-else @click.stop="public_article(false)"><span class=""><i class="fa fa-lock _22XWG"></i>设为私密</span></li>
                      <li class="_2po2r cRfUr" title="" @click.stop="interval_public(article)"><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr" title=""><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
<!--                      <li class="_2po2r cRfUr" title=""><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>-->
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" :title="collection.name" v-for="collection in collection_list" v-if="collection.id!=article.collection" @click.stop="move_article(collection.id)"><span class="">{{collection.name}}</span></li>
                          </ul>
                        </div>
                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">{{article.name}}</span>
                <span class="hLzJv" v-show="current_article==key">{{article.content}}</span>
                <span class="_29C-V" v-show="current_article==key">字数:{{article.content?article.content.length:0}}</span>
              </li>
            </ul>
            <div class="_2cVn3" @click.stop="add_article(1)"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" value="2020-01-12" v-if="article_list.length>0">
      <div id="editor" v-if="article_list.length>0">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>
    <!-- 定时发布弹窗 -->
    <div class="interval_box" style="">
      <transition name="el-fade-in-linear">
        <div class="transition-box">
          <div class="_2tIvb">
            <div class="ZTNas" aria-label="Close"><i class="fa fa-close"></i></div>
            <div class="_1KgC3">
              <div class="-K8Re">定时发文 </div>
            </div>
            <div class="_1LROK PWCkH">
              <div class="wzwGh">选择定时发文的时间：</div>
              <div class="On4jq">
                  <el-date-picker
                  v-model="pub_date"
                  type="datetime"
                  format="yyyy-MM-dd HH:mm"
                  placeholder="选择日期时间">
                </el-date-picker>
              </div>
              <div class="_3mEYS">本文章将于<span class="yfqan">{{timeformat(pub_date)}}</span>发布。
              </div>
            </div>
            <div class="RzhZ5 pCffa">
              <button type="button" class="_3zXcJ"><span>取 消</span></button>
              <button type="button" class="_3zXcJ _3QfkW"><span>确 认</span></button>
            </div>
          </div>

        </div>
      </transition>
    </div>

  </div>
</template>
<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css';
    import "../../static/font-awesome/css/font-awesome.css";
    export default {
        name: "Write",
        data(){
            return {
                is_show_page: false,
                editorContent:"",
                img_file:[],
                collection_form:false,
                token: "",
                collection_list:[],     // 当前用户的文集列表
                current_collection: 0,  // 默认让用户选中的文集的下标为0
                collection_name: "",    // 新建文集表单中的文集名称
                is_show_collection_menu: false,    // 是否显示文集菜单
                article_list: [],
                current_article: 0,     // 默认让用户选中的文章的下标为0
                is_show_article_menu: false,    // 是否显示文章菜单
                pub_date: new Date().toLocaleDateString(),  // 定时发布文章的事件设置
            }
        },
        watch:{
            editorContent(){
                console.log(this.editorContent);
            },
            current_collection(){
                this.get_article_list();
            },
        },
        created(){
          this.token = this.$settings.check_user_login(this);
          if(this.token){
              // 显示页面
              this.is_show_page = true;
              // 获取文集
              this.get_collection();
          }
        },
        mounted(){
            if(this.article_list.length>0){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
            }
            // 给当前网页绑定点击事件
            document.onclick = ()=>{
                // 点击文档,隐藏操作文集的的菜单
                this.hide_collection_menu();
                this.hide_article_menu();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          },
          get_collection(){
              // 获取当前登陆用户的文集
              this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.collection_list = response.data;
                  // 获取当前文集下的所有文章
                  this.get_article_list();
              }).catch(error=>{
                  this.$message.error("对不起,无法获取当前用户的文集列表!");
              });
          },
          add_collection(){
              // 添加文集
              if(this.collection_name.length<1){
                  // 不能为空!
                  this.$message.error("对不起,文集名称不能为空!");
                  return;
              }

              // 发送ajax
              this.$axios.post(`${this.$settings.Host}/article/collect/`,{
                  name: this.collection_name
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("添加文集成功!");
                  this.collection_name = "";
                  this.collection_form = false; // 隐藏添加文集的表单
                  // 把服务端中添加返回的文集信息,保存到collection_list中
                  this.collection_list.unshift(response.data);
              }).catch(error=>{
                  this.$message.error(error.response.data);
              })

          },
          show_collection_menu(){
              // 控制当前文集菜单的显示隐藏
              this.is_show_collection_menu = !this.is_show_collection_menu;
          },
          hide_collection_menu(){
              // 隐藏操作文集的菜单
              this.is_show_collection_menu = false;
          },
          edit_collection(){
              // 修改文集
              this.$prompt('请输入新文集名', '提示', {
                confirmButtonText: '确定',
                cancelButtonText: '取消',
                inputPattern: /.{1,}/,
                inputErrorMessage: '文集名称不能为空!'
              }).then(({ value }) => {
                 // 点击确定,需要把当前文集名称提交到服务端进行修改
                 let collection_id = this.collection_list[this.current_collection].id;
                 this.$axios.put(`${this.$settings.Host}/article/collect/${collection_id}/`,{
                     name: value,
                 },{
                     headers:{
                         Authorization:"jwt " + this.token,
                     }
                 }).then(response=>{
                     this.collection_list[this.current_collection].name = value;
                 }).catch(error=>{
                     this.$message.error(error.response.data);
                 })
              }).catch(() => {

              });
          },
          del_collection(){
              // 删除文集
              // 获取当前文件的id
              let collection_id = this.collection_list[this.current_collection].id;
              // 刚发送ajax

          },
          get_article_list(){
              // 获取文章列表
              this.$axios.get(`${this.$settings.Host}/article/`,{
                  params:{
                      collection: this.collection_list[this.current_collection].id,
                  },
                  headers:{
                     Authorization:"jwt " + this.token,
                  }
              }).then(response=>{
                  this.article_list = response.data;
              }).catch(error=>{
                  this.$message.error(error.response.data);
              })
          },
          show_article_menu(){
              // 控制当前文章菜单的显示隐藏
             this.is_show_article_menu = !this.is_show_article_menu;
          },
          hide_article_menu(){
             this.is_show_article_menu = false;
          },
          add_article(position){ // position 表示添加文章位置
              // 在前面添加文章
              this.$axios.post(`${this.$settings.Host}/article/`,{
                  position: position,
                  collection: this.collection_list[this.current_collection].id,
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  if(position==0){
                      // 把文章设置为前面位置
                      this.article_list.unshift(response.data);
                  }else {
                      // 把文章设置为后面位置
                      this.article_list.push(response.data);
                  }
              }).catch(error=>{
                  this.$message.error(error.response.data);
              })
          },
          public_article(is_public){
              // 文章发布状态的切换
              let article_id = this.article_list[this.current_article].id;
              this.$axios.put(`${this.$settings.Host}/article/public/${article_id}/`,{
                  is_public: is_public,
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.article_list[this.current_article].is_public=is_public;
                  this.is_show_article_menu = false;
                  if(is_public){
                      this.$message.success("文章发布成功!");
                      // todo 接下来我们还需要对页面进行跳转到文章发布投稿页面
                  }else{
                      this.$message.success("文章设置成功!");
                  }

              }).catch(error=>{
                  this.$message.error("操作失败!请联系客服工作人员!");
              })
          },
          move_article(collection_id){
              // 文章发布状态的切换
              let article_id = this.article_list[this.current_article].id;
              this.$axios.put(`${this.$settings.Host}/article/move/${article_id}/`,{
                  collection_id: collection_id,
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.article_list.splice(this.current_article,1);
                  this.is_show_article_menu = false;
                  this.$message.success("文章设置成功!");

              }).catch(error=>{
                  this.$message.error("操作失败!请联系客服工作人员!");
              })
          },
          interval_public(article){

          },
          timeformat(time){
              time = new Date(time);
              return `${time.getFullYear()}-${time.getMonth()+1}-${time.getDate()} ${time.getHours()}:${time.getMinutes()}`;
          }
        }
    }
</script>

<style scoped>
  /* 页面原来的样式不要删除 */
  /* 新增以下定时发布文章的相关样式 */

    .interval_box{
      display: flex;
      height: 280px;
      width: 400px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      margin: auto;
      background: #fff;
      border-radius: 4px;
      z-index: 2000;
    }
    .NVdZF{display:block}

  ._20JYe {
    position: fixed;
    top: 0;
    right: 0;
    left: 0;
    bottom: 0;
    background-color: hsla(0, 0%, 100%, .7);
    height: 100%;
    z-index: 1000;
    filter: alpha(opacity=30)
  }

  body.reader-night-mode ._20JYe {
    background-color: hsla(0, 0%, 40%, .7)
  }

  ._3WS2u {
    display: none
  }

  ._23VW8 {
    position: fixed;
    overflow: auto;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    z-index: 1010;
    -webkit-overflow-scrolling: touch;
    outline: 0
  }

  ._3cgNz {
    position: relative;
    background-color: #fff;
    width: auto;
    border: 0;
    border-radius: 6px;
    margin: 0 auto 24px;
    background-clip: padding-box;
    -webkit-box-shadow: 0 2px 8px rgba(0, 0, 0, .2);
    box-shadow: 0 2px 8px rgba(0, 0, 0, .2)
  }

  body.reader-night-mode ._3cgNz {
    background-color: #3d3d3d
  }

  .cjahm {
    position: absolute;
    top: 50%;
    left: 50%;
    -webkit-transform: translate(-50%, -50%);
    -ms-transform: translate(-50%, -50%);
    transform: translate(-50%, -50%)
  }

  .cjahm.move-up-appear.move-up-appear-active, .cjahm.move-up-enter.move-up-enter-active {
    -webkit-animation-name: _2oyZp;
    animation-name: _2oyZp
  }

  .cjahm.move-up-leave.move-up-leave-active {
    -webkit-animation-name: _3g8pf;
    animation-name: _3g8pf
  }

  ._2tIvb {
    position: relative;
    border-radius: 6px;
    background-color: #eee;
  }

  body.reader-night-mode ._2tIvb {
    background-color: #3d3d3d
  }

  .ZTNas {
    position: absolute;
    right: 0;
    top: 0;
    width: 48px;
    height: 48px;
    line-height: 46px;
    text-align: center;
    font-size: 16px;
    cursor: pointer;
    color: #999;
    -webkit-transition: color .3s ease;
    -o-transition: color .3s ease;
    transition: color .3s ease
  }

  .ZTNas:hover {
    color: #4d4d4d
  }

  ._1KgC3 {
    padding: 13px 16px;
    border-radius: 4px 4px 0 0;
    color: #595959;
    border-bottom: 1px solid #d9d9d9
  }

  body.reader-night-mode ._1KgC3 {
    border-color: #2e2e2e
  }

  .-K8Re {
    margin: 0;
    font-size: 16px;
    line-height: 21px;
    font-weight: 500;
    color: #4d4d4d
  }

  body.reader-night-mode .-K8Re {
    color: #b3b3b3
  }

  ._3O4M2 {
    font-size: 13px;
    padding-left: 10px;
    color: #999
  }

  ._3O4M2 a {
    color: #3294d0
  }

  .PWCkH {
    padding: 16px;
    font-size: 12px;
    line-height: 1.5;
    color: #595959
  }

  body.reader-night-mode .PWCkH {
    color: #b3b3b3
  }

  .pCffa {
    padding: 0 16px 16px;
    text-align: right;
    border-radius: 0 0 2px 2px
  }

  ._26mjB {
    display: block
  }

  .HhIYk {
    zoom: 1
  }

  .HhIYk:after, .HhIYk:before {
    content: " ";
    display: table
  }

  .HhIYk:after {
    clear: both;
    visibility: hidden;
    font-size: 0;
    height: 0
  }

  ._37SYn {
    font-size: 13px;
    line-height: 20px;
    padding: 30px 30px 20px;
    color: #333
  }

  body.reader-night-mode ._37SYn {
    color: #b3b3b3
  }

  ._2BmdS {
    padding: 0 16px 16px;
    text-align: right;
    border-radius: 0 0 2px 2px
  }

  ._26mjB .PWCkH {
    padding: 0;
    border-radius: 2px
  }

  ._26mjB .PWCkH a {
    color: #3194d0
  }

  ._26mjB .PWCkH a:active, ._26mjB .PWCkH a:hover {
    color: #2b86bc
  }

  ._26mjB ._38pIX {
    padding: 30px 16px;
    border: 0
  }

  ._26mjB ._38pIX input {
    display: block;
    border-radius: 4px;
    width: 100%;
    line-height: 20px;
    padding: 5px 10px;
    font-size: 15px;
    background-color: transparent;
    border: 1px solid #ccc
  }

  body.reader-night-mode ._26mjB ._38pIX input {
    border-color: #2e2e2e
  }

  ._26mjB .ZTNas {
    width: 32px;
    height: 32px;
    line-height: 32px
  }

  .HSpeJ .PWCkH {
    border: 0
  }
</style>

```

服务端提供修改pub_date发布时间的api接口

配置文件中调整时区代码：

```python
# 必须设置为True，否则后面提交发布时间到服务端会报错！
USE_TZ = True
```



视图代码：

```python
from rest_framework.views import APIView
from django.utils import timezone as datetime
class ArticleInfoAPIView(APIView):
    permission_classes = [IsAuthenticated]
    def patch(self,request,pk):
        try:
            article = Article.objects.get(pk=pk,is_deleted=False, is_show=True, user=self.request.user)
        except Article.DoesNotExist:
            return Response({"detail":"当前文章不存在!"})

        if article.is_public:
            return Response({"detial":"已经发布的文章不能设置定时发布!"})

        # 判断定时发布的时候是否是未来时间
        now_time = datetime.now().timestamp()
        pub_time_str = request.data.get("pub_date")
        put_time = datetime.datetime.strptime(pub_time_str,"%Y-%m-%d %H:%M").timestamp()
        if put_time <=now_time:
            return Response({"detail":"定时发布的文章必须是未来的时间点!"})

        article.pub_date = pub_time_str
        article.save()

        return Response({"detail":"定时发布文章设置成功!"})
```

路由，代码：

```python
from django.urls import path,re_path
from . import views
urlpatterns = [
    path("collection/", views.CollectionAPIView.as_view()),
    # 开发中如果出现多条正则路由存在部分相同,则需要加上正则的开始^和结束$
    re_path("^collection/(?P<pk>\d+)/$", views.CollectionAPIView.as_view()),
    re_path("^collection/(?P<collection>\d+)/articles/$", views.ArticleAPIView.as_view()),
    re_path("^(?P<pk>\d+)/$", views.ArticleAPIView.as_view()),
    re_path("^(?P<pk>\d+)/interval/$", views.ArticleInfoAPIView.as_view()),
]
```

客户端发送ajax请求，代码：

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=!collection_form"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW" @click.prevent="add_collection"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="key==current_collection?'_31PCv':''" @click="current_collection=key" :title="collection.name" v-for="collection,key in collection_list">
          <div class="_3P4JX _2VLy-" v-if="key==current_collection" @click.stop="is_show_collection_menu=!is_show_collection_menu">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_collection_menu?'NvfK4':''">
                <li class="_2po2r cRfUr" @click.prevent.stop="put_collection">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" @click.prevent.stop="del_collection">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5" @click="add_article(true)"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv" :class="key==current_article?'_33nt7':''" @click="current_article=key" :title="article.title" v-for="article,key in article_list">
                <!-- 文章的发布状态 -->
                <i class="_13kgp" :class="article.is_public?'_2m93u':(article.pub_date==null?'':'interval')"></i>
                <div class="_3P4JX poOXI" v-if="key==current_article" @click.stop.prevent="is_show_article_menu=!is_show_article_menu">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_article_menu?'NvfK4':''">
                      <li class="_2po2r cRfUr" @click.stop.prevent="pub_article" v-if="!article.is_public && !article.pub_date"><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" @click.stop.prevent="pub_article" v-else><span class=""><i class="fa fa-share _22XWG"></i>设置为隐私文章</span></li>
                      <li class="_2po2r cRfUr" v-if="!article.is_public && !article.pub_date" @click="is_interval_window=true"><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr"><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr"><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" @click="mov_article(collection.id)" :title="collection.name" v-if="key!=current_collection" v-for="collection,key in collection_list"><span class="">{{collection.name}}</span></li>
                          </ul>
                        </div>

                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">{{article.title}}</span>
                <span class="hLzJv" v-if="article.content">{{article.content.substr(0,20)}}</span>
                <span class="hLzJv" v-else></span>
                <span class="_29C-V" v-if="key==current_article">
                  字数:
                  <span v-if="article.content">{{article.content.length}}</span>
                  <span v-else>0</span>
                </span>
              </li>
            </ul>
            <div class="_2cVn3" @click="add_article(false)"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" value="2020-01-12">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>

    <!-- 定时发布弹窗 -->
    <div class="interval_box" v-show="is_interval_window">
      <transition name="el-fade-in-linear">
        <div class="transition-box">
          <div class="_2tIvb">
            <div class="ZTNas" aria-label="Close" @click="is_interval_window=false"><i class="fa fa-close"></i></div>
            <div class="_1KgC3">
              <div class="-K8Re">定时发布</div>
            </div>
            <div class="_1LROK PWCkH">
              <div class="wzwGh">选择定时发布的时间：</div>
              <div class="On4jq">
                  <el-date-picker
                  v-model="pub_date"
                  type="datetime"
                  format="yyyy-MM-dd HH:mm"
                  placeholder="选择日期时间">
                </el-date-picker>
              </div>
              <div class="_3mEYS">本文章将于<span class="yfqan">{{timeformat(pub_date)}}</span>发布。
              </div>
            </div>
            <div class="RzhZ5 pCffa">
              <button type="button" class="_3zXcJ" @click="is_interval_window=false"><span>取 消</span></button>
              <button type="button" class="_3zXcJ _3QfkW"><span @click="int_article">确 认</span></button>
            </div>
          </div>

        </div>
      </transition>
    </div>

  </div>
</template>

<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    import '../../static/font-awesome/css/font-awesome.css'
    export default {
        name: "Writer",
        data(){
          return {
            token: "",
            editorContent:"",
            img_file:[],
            collection_form:false,
            collection_name:"",  // 本次新增的文集名称
            is_show_page: false,   // 控制是否显示页面
            collection_list:[],    // 当前登录用户的文集列表
            current_collection: 0, // 当前用户选中操作的文集下标,默认为第一个文集,也就是下标为0的文集
            is_show_collection_menu:false, // 控制文集菜单是否显示
            article_list: [],     // 当前文集的文章列表
            current_article: 0,   // 当前用户选中操作的文章下标,默认为第一个文章,也就是下标为0的文章
            is_show_article_menu:false, // 控制文章菜单是否显示
            is_interval_window: false, // 控制定时发布窗口是否显示
            pub_date: new Date().toLocaleDateString(),  // 定时发布文章的事件设置
          }
        },
        watch:{
            editorContent(){
                console.log(this.editorContent)
            },
            current_collection(){
              // 切换操作的文集
              this.is_show_collection_menu = false;
              // 重新获取当前文集的文章列表
              this.get_article();
            },
            current_article(){
              // 切换操作的文章
              this.is_show_article_menu = false;
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
                // 点选页面其他位置，关闭菜单
                document.onclick = (event)=>{
                    // 关闭文集菜单
                    this.is_show_collection_menu = false;
                    // 关闭文章菜单
                    this.is_show_article_menu = false;
                }
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
            if(this.token){
                this.get_collection();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          get_collection(){
            // 获取当前用户的文集列表
            this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                headers:{  // 设置本次http的请求头信息
                    Authorization: "JWT "+ this.token,
                }
            }).then(response=>{
               this.collection_list = response.data;
               // 成功获取文集列表以后, 再发送ajax请求获取当前文集下的文章列表
               this.get_article();
            }).catch(error=>{
               this.$message.error("网络异常,获取文集列表失败!");
            });
          },
          add_collection(){
              // 添加文集
              this.$axios.post(`${this.$settings.Host}/article/collection/`,{
                  name: this.collection_name
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("新增文集成功！");
                  this.collection_list.push(response.data);
                  // 清空和关闭添加文集的表单
                  this.collection_name="";
                  this.collection_form=false;
              }).catch(error=>{
                  this.$message.error("对不起，新增文集失败！");
              });

          },
          del_collection(){
              // 删除文集
              if(this.collection_list.length<2){
                  this.$message.error("对不起，当前文集列表只剩下一个文集了，所以不能删除！");
                  return false;
              }

              // 获取本次操作的文集，提取文集的id
              let collection_id = this.collection_list[this.current_collection].id;
              let collection_name = this.collection_list[this.current_collection].name;
              this.$confirm(`确认要删除当前文集《${collection_name}》吗？`, '危险操作', {
                confirmButtonText: '删除',
                cancelButtonText: '取消',
                type: 'warning'
              }).then(() => {
                // 确认删除
                this.$axios.delete(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                    headers:{
                        Authorization: "jwt " + this.token,
                    }
                }).then(response=>{
                    this.$message.success("成功删除当前文集！");
                    // 客户端从文集列表移除当前文集，并重置当前操作的文集ID为0
                    this.collection_list.splice(this.current_collection,1);
                    this.current_collection = 0;
                    // 重新获取文章列表
                    this.get_article();
                }).catch(error=>{
                    this.$message.error("删除文集失败！");
                });

              }).catch(() => {
                // 取消

              });
          },
          put_collection(){
            // 修改文集名称
            let collection_id = this.collection_list[this.current_collection].id;
            let collection_name = this.collection_list[this.current_collection].name;
            // 显示修改文集名称的弹窗
            this.$prompt('请输入新的文集名称', '修改文集', {
              confirmButtonText: '更新',
              cancelButtonText: '取消',
              inputValidator(val){
                if(val==collection_name){
                    return "对不起，文集名称没有进行修改！";
                }
              },
            }).then(({ value }) => {
              // 发送ajax请求服务端修改文集名称
              this.$axios.put(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                  name: value,
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                 this.collection_list[this.current_collection].name = value;
              }).catch(error=>{
                 // 取消不需要做任何事情

              });

            }).catch(() => {

            });
          },
          get_article(){
            // 获取当前文集的文章列表
            // 当前文集ID
            let collection_id = this.collection_list[this.current_collection].id;
            this.$axios.get(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
               this.article_list = response.data;
            }).catch(error=>{
               this.$message.error("获取文章列表失败!");
            });
          },
          add_article(insert){
              let collection_id = this.collection_list[this.current_collection].id;
              this.$axios.post(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                  insert, // insert:insert的简写
                  title: new Date().toLocaleDateString().split("/").join("-"),
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  // 根据insert的值判断是插入文章还是追加文章
                  if(insert){
                      this.article_list.unshift(response.data);
                      this.current_article=0;
                  }else{
                      this.article_list.push(response.data);
                      this.current_article=this.article_list.length-1;
                  }
              }).catch(error=>{
                  this.$message.error("添加文章失败!请联系客服工作人员!");
              })
          },
          pub_article(){
            // 切换文章发布状态
              let article = this.article_list[this.current_article];
              this.$axios.patch(`${this.$settings.Host}/article/${article.id}/`,{
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  article.is_public=!article.is_public;
              }).catch(error=>{
                  this.$message.error("添加文章失败!请联系客服工作人员!");
              });
              this.is_show_article_menu=false;
          },
          mov_article(collection_id){
            // 移动文章
            let article = this.article_list[this.current_article];
            this.$axios.put(`${this.$settings.Host}/article/${article.id}/`,{
                collection: collection_id,
            },{
                headers:{
                    Authorization: "jwt "+ this.token,
                }
            }).then(response=>{
                // 把已经移动到其他文集的文章从当前的文章列表中删除
                this.article_list.splice(this.current_article,1);
            }).catch(error=>{
                this.$message.error("移动文章失败!");
            });
          },
          int_article(){
              // 定时发布文章
              let article = this.article_list[this.current_article];

              if( article.is_public ){
                  this.$message.error("当前文章已经发布过,不能设置定时发布!");
                  return false;
              }

              this.$axios.patch(`${this.$settings.Host}/article/${article.id}/interval/`,{
                  pub_date: this.timeformat(this.pub_date),
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("定时发布文章设置成功!");
                  this.is_interval_window=false;
                  this.article_list[this.current_article].pub_date=this.timeformat(this.pub_date);
              }).catch(error=>{
                  this.$message.error("定时发布文章设置失败!");
              });
          },
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          },
          timeformat(time){
              time = new Date(time);
              return `${time.getFullYear()}-${time.getMonth()+1}-${time.getDate()} ${time.getHours()}:${time.getMinutes()}`;
          }
        }
    }
</script>

<style>

  /* 新增定时发布的图标样式 */
  ._2TxA- ._25Ilv .interval{
    background: url(/static/image/sprite.9d24217.png) no-repeat -74px -25px;
    background-size: 250px;
    position: absolute;
    top: 30px;
    left: 20px;
    width: 22px;
    height: 30px;
  }
</style>
```

当用户取消发布时，我们应该把发布时间pub_date清空！

视图代码：

```python
class ArticleAPIView(ListAPIView,CreateAPIView):
    """文章视图接口"""
    # queryset = Article.objects.all()
    serializer_class = ArticleModelSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        # /article/collection/<collection>\d/articles/
        # 获取路由参数的另一种方式 self.kwargs.get("参数名称")
        collection_id = self.kwargs.get("collection")
        return Article.objects.filter(is_deleted=False, is_show=True, user=self.request.user, collection_id=collection_id).order_by("orders", "id")

    def patch(self,request,pk):
        try:
            article = Article.objects.get(pk=pk,is_deleted=False, is_show=True, user=self.request.user)
        except Article.DoesNotExist:
            return Response({"detail":"当前文章不存在!"})
        """
        1. 隐私文章 is_public=False, pub_date=None
        2. 发布文章 is_public=True, pub_date=None
        3. 定时文章 is_public=False, pub_date=时间
        """
        if article.pub_date:
            """取消定时发布文章"""
            article.pub_date=None
        elif article.is_public:
            """把文章设置为隐私文章"""
            article.is_public=False
        else:
            """发布文章"""
            article.is_public=True
        article.save()
        return Response({"detail":"发布状态切换成功!"})

    def put(self,request,pk):
        try:
            article = Article.objects.get(pk=pk,is_deleted=False, is_show=True, user=self.request.user)
        except Article.DoesNotExist:
            return Response({"detail":"当前文章不存在!"})

        collection_id = int( request.data.get("collection") )
        article.collection_id=collection_id
        article.save()
        return Response({"detail":"移动文章成功!"})

```

客户端同时进行文章发布状态的判断，代码：

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=!collection_form"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW" @click.prevent="add_collection"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="key==current_collection?'_31PCv':''" @click="current_collection=key" :title="collection.name" v-for="collection,key in collection_list">
          <div class="_3P4JX _2VLy-" v-if="key==current_collection" @click.stop="is_show_collection_menu=!is_show_collection_menu">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_collection_menu?'NvfK4':''">
                <li class="_2po2r cRfUr" @click.prevent.stop="put_collection">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" @click.prevent.stop="del_collection">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5" @click="add_article(true)"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv" :class="key==current_article?'_33nt7':''" @click="current_article=key" :title="article.title" v-for="article,key in article_list">
                <!-- 文章的发布状态 -->
                <i class="_13kgp" :class="article.is_public?'_2m93u':(article.pub_date==null?'':'interval')"></i>
                <div class="_3P4JX poOXI" v-if="key==current_article" @click.stop.prevent="is_show_article_menu=!is_show_article_menu">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_article_menu?'NvfK4':''">
                      <li class="_2po2r cRfUr" @click.stop.prevent="pub_article" v-if="!article.is_public && !article.pub_date"><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" @click.stop.prevent="pub_article" v-else><span class=""><i class="fa fa-share _22XWG"></i>设置为隐私文章</span></li>
                      <li class="_2po2r cRfUr" v-if="!article.is_public && !article.pub_date" @click="is_interval_window=true"><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr"><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr"><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" @click="mov_article(collection.id)" :title="collection.name" v-if="key!=current_collection" v-for="collection,key in collection_list"><span class="">{{collection.name}}</span></li>
                          </ul>
                        </div>

                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">{{article.title}}</span>
                <span class="hLzJv" v-if="article.content">{{article.content.substr(0,20)}}</span>
                <span class="hLzJv" v-else></span>
                <span class="_29C-V" v-if="key==current_article">
                  字数:
                  <span v-if="article.content">{{article.content.length}}</span>
                  <span v-else>0</span>
                </span>
              </li>
            </ul>
            <div class="_2cVn3" @click="add_article(false)"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" value="2020-01-12">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>

    <!-- 定时发布弹窗 -->
    <div class="interval_box" v-show="is_interval_window">
      <transition name="el-fade-in-linear">
        <div class="transition-box">
          <div class="_2tIvb">
            <div class="ZTNas" aria-label="Close" @click="is_interval_window=false"><i class="fa fa-close"></i></div>
            <div class="_1KgC3">
              <div class="-K8Re">定时发布</div>
            </div>
            <div class="_1LROK PWCkH">
              <div class="wzwGh">选择定时发布的时间：</div>
              <div class="On4jq">
                  <el-date-picker
                  v-model="pub_date"
                  type="datetime"
                  format="yyyy-MM-dd HH:mm"
                  placeholder="选择日期时间">
                </el-date-picker>
              </div>
              <div class="_3mEYS">本文章将于<span class="yfqan">{{timeformat(pub_date)}}</span>发布。
              </div>
            </div>
            <div class="RzhZ5 pCffa">
              <button type="button" class="_3zXcJ" @click="is_interval_window=false"><span>取 消</span></button>
              <button type="button" class="_3zXcJ _3QfkW"><span @click="int_article">确 认</span></button>
            </div>
          </div>

        </div>
      </transition>
    </div>

  </div>
</template>

<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    import '../../static/font-awesome/css/font-awesome.css'
    export default {
        name: "Writer",
        data(){
          return {
            token: "",
            editorContent:"",
            img_file:[],
            collection_form:false,
            collection_name:"",  // 本次新增的文集名称
            is_show_page: false,   // 控制是否显示页面
            collection_list:[],    // 当前登录用户的文集列表
            current_collection: 0, // 当前用户选中操作的文集下标,默认为第一个文集,也就是下标为0的文集
            is_show_collection_menu:false, // 控制文集菜单是否显示
            article_list: [],     // 当前文集的文章列表
            current_article: 0,   // 当前用户选中操作的文章下标,默认为第一个文章,也就是下标为0的文章
            is_show_article_menu:false, // 控制文章菜单是否显示
            is_interval_window: false, // 控制定时发布窗口是否显示
            pub_date: new Date().toLocaleDateString(),  // 定时发布文章的事件设置
          }
        },
        watch:{
            editorContent(){
                console.log(this.editorContent)
            },
            current_collection(){
              // 切换操作的文集
              this.is_show_collection_menu = false;
              // 重新获取当前文集的文章列表
              this.get_article();
            },
            current_article(){
              // 切换操作的文章
              this.is_show_article_menu = false;
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
                // 点选页面其他位置，关闭菜单
                document.onclick = (event)=>{
                    // 关闭文集菜单
                    this.is_show_collection_menu = false;
                    // 关闭文章菜单
                    this.is_show_article_menu = false;
                }
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
            if(this.token){
                this.get_collection();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          get_collection(){
            // 获取当前用户的文集列表
            this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                headers:{  // 设置本次http的请求头信息
                    Authorization: "JWT "+ this.token,
                }
            }).then(response=>{
               this.collection_list = response.data;
               // 成功获取文集列表以后, 再发送ajax请求获取当前文集下的文章列表
               this.get_article();
            }).catch(error=>{
               this.$message.error("网络异常,获取文集列表失败!");
            });
          },
          add_collection(){
              // 添加文集
              this.$axios.post(`${this.$settings.Host}/article/collection/`,{
                  name: this.collection_name
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("新增文集成功！");
                  this.collection_list.push(response.data);
                  // 清空和关闭添加文集的表单
                  this.collection_name="";
                  this.collection_form=false;
              }).catch(error=>{
                  this.$message.error("对不起，新增文集失败！");
              });

          },
          del_collection(){
              // 删除文集
              if(this.collection_list.length<2){
                  this.$message.error("对不起，当前文集列表只剩下一个文集了，所以不能删除！");
                  return false;
              }

              // 获取本次操作的文集，提取文集的id
              let collection_id = this.collection_list[this.current_collection].id;
              let collection_name = this.collection_list[this.current_collection].name;
              this.$confirm(`确认要删除当前文集《${collection_name}》吗？`, '危险操作', {
                confirmButtonText: '删除',
                cancelButtonText: '取消',
                type: 'warning'
              }).then(() => {
                // 确认删除
                this.$axios.delete(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                    headers:{
                        Authorization: "jwt " + this.token,
                    }
                }).then(response=>{
                    this.$message.success("成功删除当前文集！");
                    // 客户端从文集列表移除当前文集，并重置当前操作的文集ID为0
                    this.collection_list.splice(this.current_collection,1);
                    this.current_collection = 0;
                    // 重新获取文章列表
                    this.get_article();
                }).catch(error=>{
                    this.$message.error("删除文集失败！");
                });

              }).catch(() => {
                // 取消

              });
          },
          put_collection(){
            // 修改文集名称
            let collection_id = this.collection_list[this.current_collection].id;
            let collection_name = this.collection_list[this.current_collection].name;
            // 显示修改文集名称的弹窗
            this.$prompt('请输入新的文集名称', '修改文集', {
              confirmButtonText: '更新',
              cancelButtonText: '取消',
              inputValidator(val){
                if(val==collection_name){
                    return "对不起，文集名称没有进行修改！";
                }
              },
            }).then(({ value }) => {
              // 发送ajax请求服务端修改文集名称
              this.$axios.put(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                  name: value,
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                 this.collection_list[this.current_collection].name = value;
              }).catch(error=>{
                 // 取消不需要做任何事情

              });

            }).catch(() => {

            });
          },
          get_article(){
            // 获取当前文集的文章列表
            // 当前文集ID
            let collection_id = this.collection_list[this.current_collection].id;
            this.$axios.get(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
               this.article_list = response.data;
            }).catch(error=>{
               this.$message.error("获取文章列表失败!");
            });
          },
          add_article(insert){
              let collection_id = this.collection_list[this.current_collection].id;
              this.$axios.post(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                  insert, // insert:insert的简写
                  title: new Date().toLocaleDateString().split("/").join("-"),
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  // 根据insert的值判断是插入文章还是追加文章
                  if(insert){
                      this.article_list.unshift(response.data);
                      this.current_article=0;
                  }else{
                      this.article_list.push(response.data);
                      this.current_article=this.article_list.length-1;
                  }
              }).catch(error=>{
                  this.$message.error("添加文章失败!请联系客服工作人员!");
              })
          },
          pub_article(){
            // 切换文章发布状态
              let article = this.article_list[this.current_article];
              this.$axios.patch(`${this.$settings.Host}/article/${article.id}/`,{
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  /**
                    1. 隐私文章 is_public=False, pub_date=None
                    2. 发布文章 is_public=True, pub_date=None
                    3. 定时文章 is_public=False, pub_date=时间
                   */
                  if(article.pub_date){
                      // 取消定时
                      article.pub_date = null
                  }else if(article.is_public){
                      // 取消发布
                      article.is_public=false;
                  }else{
                      // 文章发布
                      article.is_public=true;
                  }
              }).catch(error=>{
                  this.$message.error("添加文章失败!请联系客服工作人员!");
              });
              this.is_show_article_menu=false;
          },
          mov_article(collection_id){
            // 移动文章
            let article = this.article_list[this.current_article];
            this.$axios.put(`${this.$settings.Host}/article/${article.id}/`,{
                collection: collection_id,
            },{
                headers:{
                    Authorization: "jwt "+ this.token,
                }
            }).then(response=>{
                // 把已经移动到其他文集的文章从当前的文章列表中删除
                this.article_list.splice(this.current_article,1);
            }).catch(error=>{
                this.$message.error("移动文章失败!");
            });
          },
          int_article(){
              // 定时发布文章
              let article = this.article_list[this.current_article];

              if( article.is_public ){
                  this.$message.error("当前文章已经发布过,不能设置定时发布!");
                  return false;
              }

              this.$axios.patch(`${this.$settings.Host}/article/${article.id}/interval/`,{
                  pub_date: this.timeformat(this.pub_date),
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("定时发布文章设置成功!");
                  this.is_interval_window=false;
                  this.article_list[this.current_article].pub_date=this.timeformat(this.pub_date);
              }).catch(error=>{
                  this.$message.error("定时发布文章设置失败!");
              });
          },
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          },
          timeformat(time){
              time = new Date(time);
              return `${time.getFullYear()}-${time.getMonth()+1}-${time.getDate()} ${time.getHours()}:${time.getMinutes()}`;
          }
        }
    }
</script>

```

```text
开发中针对于定时发布任务的解决方案：
1. 基于操作系统的计划任务来完成，例如：linux的crontab命令,celery本质上就是借助了计划任务。
2. redis的发布订阅，可以使用setex，然后开启redis的key过期事件进行监控.
```





使用celery的定时任务，每2分钟执行一次定时发布操作，让pub_date时间到了，则更新对应文章的发布状态。

在mycelery中创建article任务目录，在目录下创建任务文件tasks.py，编写异步任务：

```python
from mycelery.main import app
from article.models import Article
from django.utils import timezone as datetime
@app.task(name="interval_pub_article")
def interval_pub_article():
    """定时发布"""
    article_list = Article.objects.filter(pub_date__lte=datetime.now())
    print(article_list)
    for article in article_list:
        article.is_public = True
        article.pub_date = None
        article.save()
        print("文章《%s》发布成功" % article.title )


```

注册异步任务到main.py中。并重启celery，代码：

```python
from celery import Celery
# 初始化celery对象
app = Celery("renran")

# 初始化django
import os
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'renranapi.settings.dev')
import django
django.setup()

# 加载配置
app.config_from_object("mycelery.config")

# 注册异步任务
# 任务以包进行管理,每一个包必须里面包含了一个tasks.py文件
app.autodiscover_tasks(["mycelery.sms","mycelery.article"])

# 在终端下面运行celery,将来在线上服务器中,可以使用supervisor以守护进程的方式启动
# celery -A mycelery.main worker --loglevel=info
```

接下来，我们就可以使用celery的定时任务调度器，让celery定时执行异步任务。

Celery官方文档中关于定时任务使用的说明：

```python
http://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html
```

在mycelery中config.py配置异步任务定时执行，代码：

```python
# 任务队列的链接地址
# broker_url = '消息队列软件类型://服务端地址:端口/仓库地址'
broker_url = 'redis://127.0.0.1:6379/15'
# 结果队列的链接地址
result_backend = 'redis://127.0.0.1:6379/14'

from mycelery.main import app
from celery.schedules import crontab

# 和django框架同步时区
from django.conf import settings
app.conf.timezone = settings.TIME_ZONE


app.conf.beat_schedule = {
    # 定时任务列表
    'pub-article-every-two-minute': {
        'task': 'interval_pub_article',     # 指定定时执行的的异步任务
        # 'schedule': crontab(),            # 时间间隔,一分钟
        # 'schedule': 120.0,                # 时间间隔,默认:秒
        'schedule': crontab(minute='*/2'),  # 时间间隔,每2分钟
        # 'args': (16, 16)                  # 如果任务有固定参数,则可以写在args
    },
}
```

接下来，我们就可以重启Celery并启用Celery的定时任务调度器

先在终端下，运行celery的定时任务程序，以下命令：

```bash
celery -A mycelery.main beat  # mycelery.main 是celery的主应用文件
```

然后再新建一个终端，运行以下命令，上面的命令必须先指定：

```python
celery -A mycelery.main worker --loglevel=info
```

注意，使用的时候，如果有时区必须先配置好系统时区。





## 文章内容保存

当用户点击指定文章时，需要显示当前文章的标题和内容.

Writer.vue，组件代码：

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=!collection_form"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW" @click.prevent="add_collection"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="key==current_collection?'_31PCv':''" @click="current_collection=key" :title="collection.name" v-for="collection,key in collection_list">
          <div class="_3P4JX _2VLy-" v-if="key==current_collection" @click.stop="is_show_collection_menu=!is_show_collection_menu">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_collection_menu?'NvfK4':''">
                <li class="_2po2r cRfUr" @click.prevent.stop="put_collection">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" @click.prevent.stop="del_collection">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5" @click="add_article(true)"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv" :class="key==current_article?'_33nt7':''" @click="current_article=key" :title="article.title" v-for="article,key in article_list">
                <!-- 文章的发布状态 -->
                <i class="_13kgp" :class="article.is_public?'_2m93u':(article.pub_date==null?'':'interval')"></i>
                <div class="_3P4JX poOXI" v-if="key==current_article" @click.stop.prevent="is_show_article_menu=!is_show_article_menu">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_article_menu?'NvfK4':''">
                      <li class="_2po2r cRfUr" @click.stop.prevent="pub_article" v-if="!article.is_public && !article.pub_date"><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" @click.stop.prevent="pub_article" v-else><span class=""><i class="fa fa-share _22XWG"></i>设置为隐私文章</span></li>
                      <li class="_2po2r cRfUr" v-if="!article.is_public && !article.pub_date" @click="is_interval_window=true"><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr"><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr"><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" @click="mov_article(collection.id)" :title="collection.name" v-if="key!=current_collection" v-for="collection,key in collection_list"><span class="">{{collection.name}}</span></li>
                          </ul>
                        </div>

                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">{{article.title}}</span>
                <span class="hLzJv" v-if="article.content">{{article.content.substr(0,20)}}</span>
                <span class="hLzJv" v-else></span>
                <span class="_29C-V" v-if="key==current_article">
                  字数:
                  <span v-if="article.content">{{article.content.length}}</span>
                  <span v-else>0</span>
                </span>
              </li>
            </ul>
            <div class="_2cVn3" @click="add_article(false)"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" v-model="editorTitle">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>

    <!-- 定时发布弹窗 -->
    <div class="interval_box" v-show="is_interval_window">
      <transition name="el-fade-in-linear">
        <div class="transition-box">
          <div class="_2tIvb">
            <div class="ZTNas" aria-label="Close" @click="is_interval_window=false"><i class="fa fa-close"></i></div>
            <div class="_1KgC3">
              <div class="-K8Re">定时发布</div>
            </div>
            <div class="_1LROK PWCkH">
              <div class="wzwGh">选择定时发布的时间：</div>
              <div class="On4jq">
                  <el-date-picker
                  v-model="pub_date"
                  type="datetime"
                  format="yyyy-MM-dd HH:mm"
                  placeholder="选择日期时间">
                </el-date-picker>
              </div>
              <div class="_3mEYS">本文章将于<span class="yfqan">{{timeformat(pub_date)}}</span>发布。
              </div>
            </div>
            <div class="RzhZ5 pCffa">
              <button type="button" class="_3zXcJ" @click="is_interval_window=false"><span>取 消</span></button>
              <button type="button" class="_3zXcJ _3QfkW"><span @click="int_article">确 认</span></button>
            </div>
          </div>

        </div>
      </transition>
    </div>

  </div>
</template>

<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    import '../../static/font-awesome/css/font-awesome.css'
    export default {
        name: "Writer",
        data(){
          return {
            token: "",
            editorTitle: "",  // 当前操作的文章标题
            editorContent:"", // 当前操作的文章内容
            img_file:[],
            collection_form:false,
            collection_name:"",  // 本次新增的文集名称
            is_show_page: false,   // 控制是否显示页面
            collection_list:[],    // 当前登录用户的文集列表
            current_collection: 0, // 当前用户选中操作的文集下标,默认为第一个文集,也就是下标为0的文集
            is_show_collection_menu:false, // 控制文集菜单是否显示
            article_list: [],     // 当前文集的文章列表
            current_article: 0,   // 当前用户选中操作的文章下标,默认为第一个文章,也就是下标为0的文章
            is_show_article_menu:false, // 控制文章菜单是否显示
            is_interval_window: false, // 控制定时发布窗口是否显示
            pub_date: new Date().toLocaleDateString(),  // 定时发布文章的事件设置

          }
        },
        watch:{
            editorContent(){
                console.log(this.editorContent);
            },
            current_collection(){
              // 切换操作的文集
              this.is_show_collection_menu = false;
              // 重新获取当前文集的文章列表
              this.get_article();
            },
            current_article(){
              // 切换操作的文章
              this.is_show_article_menu = false;
              if(this.article_list.length>0){
                this.editorTitle=this.article_list[this.current_article].title;
                this.editorContent=this.article_list[this.current_article].content;
              }
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
                // 点选页面其他位置，关闭菜单
                document.onclick = (event)=>{
                    // 关闭文集菜单
                    this.is_show_collection_menu = false;
                    // 关闭文章菜单
                    this.is_show_article_menu = false;
                }
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
            if(this.token){
                this.get_collection();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          get_collection(){
            // 获取当前用户的文集列表
            this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                headers:{  // 设置本次http的请求头信息
                    Authorization: "JWT "+ this.token,
                }
            }).then(response=>{
               this.collection_list = response.data;
               // 成功获取文集列表以后, 再发送ajax请求获取当前文集下的文章列表
               this.get_article();
            }).catch(error=>{
               this.$message.error("网络异常,获取文集列表失败!");
            });
          },
          add_collection(){
              // 添加文集
              this.$axios.post(`${this.$settings.Host}/article/collection/`,{
                  name: this.collection_name
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("新增文集成功！");
                  this.collection_list.push(response.data);
                  // 清空和关闭添加文集的表单
                  this.collection_name="";
                  this.collection_form=false;
              }).catch(error=>{
                  this.$message.error("对不起，新增文集失败！");
              });

          },
          del_collection(){
              // 删除文集
              if(this.collection_list.length<2){
                  this.$message.error("对不起，当前文集列表只剩下一个文集了，所以不能删除！");
                  return false;
              }

              // 获取本次操作的文集，提取文集的id
              let collection_id = this.collection_list[this.current_collection].id;
              let collection_name = this.collection_list[this.current_collection].name;
              this.$confirm(`确认要删除当前文集《${collection_name}》吗？`, '危险操作', {
                confirmButtonText: '删除',
                cancelButtonText: '取消',
                type: 'warning'
              }).then(() => {
                // 确认删除
                this.$axios.delete(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                    headers:{
                        Authorization: "jwt " + this.token,
                    }
                }).then(response=>{
                    this.$message.success("成功删除当前文集！");
                    // 客户端从文集列表移除当前文集，并重置当前操作的文集ID为0
                    this.collection_list.splice(this.current_collection,1);
                    this.current_collection = 0;
                    // 重新获取文章列表
                    this.get_article();
                }).catch(error=>{
                    this.$message.error("删除文集失败！");
                });

              }).catch(() => {
                // 取消

              });
          },
          put_collection(){
            // 修改文集名称
            let collection_id = this.collection_list[this.current_collection].id;
            let collection_name = this.collection_list[this.current_collection].name;
            // 显示修改文集名称的弹窗
            this.$prompt('请输入新的文集名称', '修改文集', {
              confirmButtonText: '更新',
              cancelButtonText: '取消',
              inputValidator(val){
                if(val==collection_name){
                    return "对不起，文集名称没有进行修改！";
                }
              },
            }).then(({ value }) => {
              // 发送ajax请求服务端修改文集名称
              this.$axios.put(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                  name: value,
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                 this.collection_list[this.current_collection].name = value;
              }).catch(error=>{
                 // 取消不需要做任何事情

              });

            }).catch(() => {

            });
          },
          get_article(){
            // 获取当前文集的文章列表
            // 当前文集ID
            let collection_id = this.collection_list[this.current_collection].id;
            this.$axios.get(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
               this.article_list = response.data;
               if(this.article_list.length>0){
                this.editorTitle=this.article_list[this.current_article].title;
                this.editorContent=this.article_list[this.current_article].content;
               }
            }).catch(error=>{
               this.$message.error("获取文章列表失败!");
            });
          },
          add_article(insert){
              let collection_id = this.collection_list[this.current_collection].id;
              this.$axios.post(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                  insert, // insert:insert的简写
                  title: new Date().toLocaleDateString().split("/").join("-"),
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  // 根据insert的值判断是插入文章还是追加文章
                  if(insert){
                      this.article_list.unshift(response.data);
                      this.current_article=0;
                  }else{
                      this.article_list.push(response.data);
                      this.current_article=this.article_list.length-1;
                  }
                  if(this.article_list.length>0){
                    this.editorTitle=this.article_list[this.current_article].title;
                    this.editorContent=this.article_list[this.current_article].content;
                  }
              }).catch(error=>{
                  this.$message.error("添加文章失败!请联系客服工作人员!");
              })
          },
          pub_article(){
            // 切换文章发布状态
              let article = this.article_list[this.current_article];
              this.$axios.patch(`${this.$settings.Host}/article/${article.id}/`,{
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  /**
                    1. 隐私文章 is_public=False, pub_date=None
                    2. 发布文章 is_public=True, pub_date=None
                    3. 定时文章 is_public=False, pub_date=时间
                   */
                  if(article.pub_date){
                      // 取消定时
                      article.pub_date = null
                  }else if(article.is_public){
                      // 取消发布
                      article.is_public=false;
                  }else{
                      // 文章发布
                      article.is_public=true;
                  }
              }).catch(error=>{
                  this.$message.error("添加文章失败!请联系客服工作人员!");
              });
              this.is_show_article_menu=false;
          },
          mov_article(collection_id){
            // 移动文章
            let article = this.article_list[this.current_article];
            this.$axios.put(`${this.$settings.Host}/article/${article.id}/`,{
                collection: collection_id,
            },{
                headers:{
                    Authorization: "jwt "+ this.token,
                }
            }).then(response=>{
                // 把已经移动到其他文集的文章从当前的文章列表中删除
                this.article_list.splice(this.current_article,1);
            }).catch(error=>{
                this.$message.error("移动文章失败!");
            });
          },
          int_article(){
              // 定时发布文章
              let article = this.article_list[this.current_article];

              if( article.is_public ){
                  this.$message.error("当前文章已经发布过,不能设置定时发布!");
                  return false;
              }

              this.$axios.patch(`${this.$settings.Host}/article/${article.id}/interval/`,{
                  pub_date: this.timeformat(this.pub_date),
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("定时发布文章设置成功!");
                  this.is_interval_window=false;
                  this.article_list[this.current_article].pub_date=this.timeformat(this.pub_date);
              }).catch(error=>{
                  this.$message.error("定时发布文章设置失败!");
              });
          },
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          },
          timeformat(time){
              time = new Date(time);
              return `${time.getFullYear()}-${time.getMonth()+1}-${time.getDate()} ${time.getHours()}:${time.getMinutes()}`;
          }
        }
    }
</script>

```

当用户对于标题和内容进行修改时，我们需要时刻完成内容的提交。

服务端提供保存文章标题和内容的api接口，视图代码：

```python
from rest_framework.views import APIView
from django.utils import timezone as datetime
class ArticleInfoAPIView(APIView):
    """文章信息"""
    permission_classes = [IsAuthenticated]
    def patch(self,request,pk):
        try:
            article = Article.objects.get(pk=pk,is_deleted=False, is_show=True, user=self.request.user)
        except Article.DoesNotExist:
            return Response({"detail":"当前文章不存在!"})

        if article.is_public:
            return Response({"detial":"已经发布的文章不能设置定时发布!"})

        # 判断定时发布的时候是否是未来时间
        now_time = datetime.now().timestamp()
        pub_time_str = request.data.get("pub_date")
        put_time = datetime.datetime.strptime(pub_time_str,"%Y-%m-%d %H:%M").timestamp()
        if put_time <=now_time:
            return Response({"detail":"定时发布的文章必须是未来的时间点!"})

        article.pub_date = pub_time_str
        article.save()

        return Response({"detail":"定时发布文章设置成功!"})

    def put(self,request,pk):
        """文章内容保存"""
        try:
            article = Article.objects.get(pk=pk,is_deleted=False, is_show=True, user=self.request.user)
        except Article.DoesNotExist:
            return Response({"detail":"当前文章不存在!"})

        article.title = request.data.get("title")
        article.content = request.data.get("content")
        article.html_content = request.data.get("html_content")
        article.save()

        return Response({"detail": "编辑文章保存成功!"})
```

url，代码：

```python
from django.urls import path,re_path
from . import views
urlpatterns = [
    path("collection/", views.CollectionAPIView.as_view()),
    # 开发中如果出现多条正则路由存在部分相同,则需要加上正则的开始^和结束$
    re_path("^collection/(?P<pk>\d+)/$", views.CollectionAPIView.as_view()),
    re_path("^collection/(?P<collection>\d+)/articles/$", views.ArticleAPIView.as_view()),
    re_path("^(?P<pk>\d+)/$", views.ArticleAPIView.as_view()),
    re_path("^(?P<pk>\d+)/interval/$", views.ArticleInfoAPIView.as_view()),
    re_path("^(?P<pk>\d+)/info/$", views.ArticleInfoAPIView.as_view()),
]
```



客户端，代码：

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=!collection_form"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW" @click.prevent="add_collection"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="key==current_collection?'_31PCv':''" @click="current_collection=key" :title="collection.name" v-for="collection,key in collection_list">
          <div class="_3P4JX _2VLy-" v-if="key==current_collection" @click.stop="is_show_collection_menu=!is_show_collection_menu">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_collection_menu?'NvfK4':''">
                <li class="_2po2r cRfUr" @click.prevent.stop="put_collection">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" @click.prevent.stop="del_collection">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5" @click="add_article(true)"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv" :class="key==current_article?'_33nt7':''" @click="current_article=key" :title="article.title" v-for="article,key in article_list">
                <!-- 文章的发布状态 -->
                <i class="_13kgp" :class="article.is_public?'_2m93u':(article.pub_date==null?'':'interval')"></i>
                <div class="_3P4JX poOXI" v-if="key==current_article" @click.stop.prevent="is_show_article_menu=!is_show_article_menu">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_article_menu?'NvfK4':''">
                      <li class="_2po2r cRfUr" @click.stop.prevent="pub_article" v-if="!article.is_public && !article.pub_date"><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" @click.stop.prevent="pub_article" v-else><span class=""><i class="fa fa-share _22XWG"></i>设置为隐私文章</span></li>
                      <li class="_2po2r cRfUr" v-if="!article.is_public && !article.pub_date" @click="is_interval_window=true"><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr"><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr"><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" @click="mov_article(collection.id)" :title="collection.name" v-if="key!=current_collection" v-for="collection,key in collection_list"><span class="">{{collection.name}}</span></li>
                          </ul>
                        </div>

                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">{{article.title}}</span>
                <span class="hLzJv" v-if="article.content">{{article.content.substr(0,20)}}</span>
                <span class="hLzJv" v-else></span>
                <span class="_29C-V" v-if="key==current_article">
                  字数:
                  <span v-if="article.content">{{article.content.length}}</span>
                  <span v-else>0</span>
                </span>
              </li>
            </ul>
            <div class="_2cVn3" @click="add_article(false)"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" v-model="editorTitle">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @change="change_article"
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>

    <!-- 定时发布弹窗 -->
    <div class="interval_box" v-show="is_interval_window">
      <transition name="el-fade-in-linear">
        <div class="transition-box">
          <div class="_2tIvb">
            <div class="ZTNas" aria-label="Close" @click="is_interval_window=false"><i class="fa fa-close"></i></div>
            <div class="_1KgC3">
              <div class="-K8Re">定时发布</div>
            </div>
            <div class="_1LROK PWCkH">
              <div class="wzwGh">选择定时发布的时间：</div>
              <div class="On4jq">
                  <el-date-picker
                  v-model="pub_date"
                  type="datetime"
                  format="yyyy-MM-dd HH:mm"
                  placeholder="选择日期时间">
                </el-date-picker>
              </div>
              <div class="_3mEYS">本文章将于<span class="yfqan">{{timeformat(pub_date)}}</span>发布。
              </div>
            </div>
            <div class="RzhZ5 pCffa">
              <button type="button" class="_3zXcJ" @click="is_interval_window=false"><span>取 消</span></button>
              <button type="button" class="_3zXcJ _3QfkW"><span @click="int_article">确 认</span></button>
            </div>
          </div>

        </div>
      </transition>
    </div>

  </div>
</template>

<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    import '../../static/font-awesome/css/font-awesome.css'
    export default {
        name: "Writer",
        data(){
          return {
            token: "",
            editorTitle: "",  // 当前操作的文章标题
            editorContent:"", // 当前操作的文章内容
            editorRender:"", //  当前操作的文章内容[html格式内容]
            img_file:[],
            collection_form:false,
            collection_name:"",  // 本次新增的文集名称
            is_show_page: false,   // 控制是否显示页面
            collection_list:[],    // 当前登录用户的文集列表
            current_collection: 0, // 当前用户选中操作的文集下标,默认为第一个文集,也就是下标为0的文集
            is_show_collection_menu:false, // 控制文集菜单是否显示
            article_list: [],     // 当前文集的文章列表
            current_article: 0,   // 当前用户选中操作的文章下标,默认为第一个文章,也就是下标为0的文章
            is_show_article_menu:false, // 控制文章菜单是否显示
            is_interval_window: false, // 控制定时发布窗口是否显示
            pub_date: new Date().toLocaleDateString(),  // 定时发布文章的事件设置

          }
        },
        watch:{
            editorTitle(){
              this.save_article();
            },
            editorContent(){
                this.article_list[this.current_article].content = this.editorContent;
            },
            current_collection(){
              // 切换操作的文集
              this.is_show_collection_menu = false;
              // 重新获取当前文集的文章列表
              this.get_article();
            },
            current_article(){
              // 切换操作的文章
              this.is_show_article_menu = false;
              if(this.article_list.length>0){
                this.editorTitle=this.article_list[this.current_article].title;
                this.editorContent=this.article_list[this.current_article].content||"";
              }
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
                // 点选页面其他位置，关闭菜单
                document.onclick = (event)=>{
                    // 关闭文集菜单
                    this.is_show_collection_menu = false;
                    // 关闭文章菜单
                    this.is_show_article_menu = false;
                }
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
            if(this.token){
                this.get_collection();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          get_collection(){
            // 获取当前用户的文集列表
            this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                headers:{  // 设置本次http的请求头信息
                    Authorization: "JWT "+ this.token,
                }
            }).then(response=>{
               this.collection_list = response.data;
               // 成功获取文集列表以后, 再发送ajax请求获取当前文集下的文章列表
               this.get_article();
            }).catch(error=>{
               this.$message.error("网络异常,获取文集列表失败!");
            });
          },
          add_collection(){
              // 添加文集
              this.$axios.post(`${this.$settings.Host}/article/collection/`,{
                  name: this.collection_name
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("新增文集成功！");
                  this.collection_list.push(response.data);
                  // 清空和关闭添加文集的表单
                  this.collection_name="";
                  this.collection_form=false;
              }).catch(error=>{
                  this.$message.error("对不起，新增文集失败！");
              });

          },
          del_collection(){
              // 删除文集
              if(this.collection_list.length<2){
                  this.$message.error("对不起，当前文集列表只剩下一个文集了，所以不能删除！");
                  return false;
              }

              // 获取本次操作的文集，提取文集的id
              let collection_id = this.collection_list[this.current_collection].id;
              let collection_name = this.collection_list[this.current_collection].name;
              this.$confirm(`确认要删除当前文集《${collection_name}》吗？`, '危险操作', {
                confirmButtonText: '删除',
                cancelButtonText: '取消',
                type: 'warning'
              }).then(() => {
                // 确认删除
                this.$axios.delete(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                    headers:{
                        Authorization: "jwt " + this.token,
                    }
                }).then(response=>{
                    this.$message.success("成功删除当前文集！");
                    // 客户端从文集列表移除当前文集，并重置当前操作的文集ID为0
                    this.collection_list.splice(this.current_collection,1);
                    this.current_collection = 0;
                    // 重新获取文章列表
                    this.get_article();
                }).catch(error=>{
                    this.$message.error("删除文集失败！");
                });

              }).catch(() => {
                // 取消

              });
          },
          put_collection(){
            // 修改文集名称
            let collection_id = this.collection_list[this.current_collection].id;
            let collection_name = this.collection_list[this.current_collection].name;
            // 显示修改文集名称的弹窗
            this.$prompt('请输入新的文集名称', '修改文集', {
              confirmButtonText: '更新',
              cancelButtonText: '取消',
              inputValidator(val){
                if(val==collection_name){
                    return "对不起，文集名称没有进行修改！";
                }
              },
            }).then(({ value }) => {
              // 发送ajax请求服务端修改文集名称
              this.$axios.put(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                  name: value,
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                 this.collection_list[this.current_collection].name = value;
              }).catch(error=>{
                 // 取消不需要做任何事情

              });

            }).catch(() => {

            });
          },
          get_article(){
            // 获取当前文集的文章列表
            // 当前文集ID
            let collection_id = this.collection_list[this.current_collection].id;
            this.$axios.get(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
               this.article_list = response.data;
               if(this.article_list.length>0){
                this.editorTitle=this.article_list[this.current_article].title;
                this.editorContent=this.article_list[this.current_article].content||"";
               }
            }).catch(error=>{
               this.$message.error("获取文章列表失败!");
            });
          },
          add_article(insert){
              let collection_id = this.collection_list[this.current_collection].id;
              this.$axios.post(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                  insert, // insert:insert的简写
                  title: new Date().toLocaleDateString().split("/").join("-"),
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  // 根据insert的值判断是插入文章还是追加文章
                  if(insert){
                      this.article_list.unshift(response.data);
                      this.current_article=0;
                  }else{
                      this.article_list.push(response.data);
                      this.current_article=this.article_list.length-1;
                  }
                  if(this.article_list.length>0){
                    this.editorTitle=this.article_list[this.current_article].title;
                    this.editorContent=this.article_list[this.current_article].content;
                  }
              }).catch(error=>{
                  this.$message.error("添加文章失败!请联系客服工作人员!");
              })
          },
          pub_article(){
            // 切换文章发布状态
              let article = this.article_list[this.current_article];
              this.$axios.patch(`${this.$settings.Host}/article/${article.id}/`,{
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  /**
                    1. 隐私文章 is_public=False, pub_date=None
                    2. 发布文章 is_public=True, pub_date=None
                    3. 定时文章 is_public=False, pub_date=时间
                   */
                  if(article.pub_date){
                      // 取消定时
                      article.pub_date = null
                  }else if(article.is_public){
                      // 取消发布
                      article.is_public=false;
                  }else{
                      // 文章发布
                      article.is_public=true;
                  }
              }).catch(error=>{
                  this.$message.error("添加文章失败!请联系客服工作人员!");
              });
              this.is_show_article_menu=false;
          },
          mov_article(collection_id){
            // 移动文章
            let article = this.article_list[this.current_article];
            this.$axios.put(`${this.$settings.Host}/article/${article.id}/`,{
                collection: collection_id,
            },{
                headers:{
                    Authorization: "jwt "+ this.token,
                }
            }).then(response=>{
                // 把已经移动到其他文集的文章从当前的文章列表中删除
                this.article_list.splice(this.current_article,1);
            }).catch(error=>{
                this.$message.error("移动文章失败!");
            });
          },
          int_article(){
              // 定时发布文章
              let article = this.article_list[this.current_article];

              if( article.is_public ){
                  this.$message.error("当前文章已经发布过,不能设置定时发布!");
                  return false;
              }

              this.$axios.patch(`${this.$settings.Host}/article/${article.id}/interval/`,{
                  pub_date: this.timeformat(this.pub_date),
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("定时发布文章设置成功!");
                  this.is_interval_window=false;
                  this.article_list[this.current_article].pub_date=this.timeformat(this.pub_date);
              }).catch(error=>{
                  this.$message.error("定时发布文章设置失败!");
              });
          },
          save_article(){
            // 保存文章标题和内容信息
            let article = this.article_list[this.current_article];
            if(this.editorContent==null){
               this.editorContent="";
            }
            if(this.editorRender==null){
               this.editorRender="";
            }
            this.$axios.put(`${this.$settings.Host}/article/${article.id}/info/`,{
                title: this.editorTitle,
                content: this.editorContent,
                html_content: this.editorRender,
            },{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
               article.title = this.editorTitle;
               article.content = this.editorContent;
               article.html_content = this.editorRender;
            }).catch(error=>{
               this.$message.error("网络异常，编辑的文章内容无法保存，请及时对当前内容进行备份处理并联系客服工作人员！");
            });
          },
          change_article(content,html_content){
              this.editorContent = content;
              this.editorRender = html_content;
          },
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          },
          timeformat(time){
              time = new Date(time);
              return `${time.getFullYear()}-${time.getMonth()+1}-${time.getDate()} ${time.getHours()}:${time.getMinutes()}`;
          }
        }
    }
</script>
```



### 前端ajax节流

>   现在用户每一次粒度很小的操作都会导致前端发送一次ajax请求，所以我们可以通过定时器setTimeout来让ajax延时发送请求，例如，当用户进行修改操作时，我们可以调用setTimeout来让ajax2秒发送请求，如果2秒内，用户有继续操作了文章，则重新计算2秒。 这种解决问题的思路，在前端里面叫函数节流/ajax节流。

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=!collection_form"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW" @click.prevent="add_collection"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="key==current_collection?'_31PCv':''" @click="current_collection=key" :title="collection.name" v-for="collection,key in collection_list">
          <div class="_3P4JX _2VLy-" v-if="key==current_collection" @click.stop="is_show_collection_menu=!is_show_collection_menu">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_collection_menu?'NvfK4':''">
                <li class="_2po2r cRfUr" @click.prevent.stop="put_collection">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" @click.prevent.stop="del_collection">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5" @click="add_article(true)"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv" :class="key==current_article?'_33nt7':''" @click="current_article=key" :title="article.title" v-for="article,key in article_list">
                <!-- 文章的发布状态 -->
                <i class="_13kgp" :class="article.is_public?'_2m93u':(article.pub_date==null?'':'interval')"></i>
                <div class="_3P4JX poOXI" v-if="key==current_article" @click.stop.prevent="is_show_article_menu=!is_show_article_menu">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_article_menu?'NvfK4':''">
                      <li class="_2po2r cRfUr" @click.stop.prevent="pub_article" v-if="!article.is_public && !article.pub_date"><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" @click.stop.prevent="pub_article" v-else><span class=""><i class="fa fa-share _22XWG"></i>设置为隐私文章</span></li>
                      <li class="_2po2r cRfUr" v-if="!article.is_public && !article.pub_date" @click="is_interval_window=true"><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr"><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr"><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" @click="mov_article(collection.id)" :title="collection.name" v-if="key!=current_collection" v-for="collection,key in collection_list"><span class="">{{collection.name}}</span></li>
                          </ul>
                        </div>

                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">{{article.title}}</span>
                <span class="hLzJv" v-if="article.content">{{article.content.substr(0,20)}}</span>
                <span class="hLzJv" v-else></span>
                <span class="_29C-V" v-if="key==current_article">
                  字数:
                  <span v-if="article.content">{{article.content.length}}</span>
                  <span v-else>0</span>
                </span>
              </li>
            </ul>
            <div class="_2cVn3" @click="add_article(false)"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" v-model="editorTitle">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @change="change_article"
          @save="save_article"
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>

    <!-- 定时发布弹窗 -->
    <div class="interval_box" v-show="is_interval_window">
      <transition name="el-fade-in-linear">
        <div class="transition-box">
          <div class="_2tIvb">
            <div class="ZTNas" aria-label="Close" @click="is_interval_window=false"><i class="fa fa-close"></i></div>
            <div class="_1KgC3">
              <div class="-K8Re">定时发布</div>
            </div>
            <div class="_1LROK PWCkH">
              <div class="wzwGh">选择定时发布的时间：</div>
              <div class="On4jq">
                  <el-date-picker
                  v-model="pub_date"
                  type="datetime"
                  format="yyyy-MM-dd HH:mm"
                  placeholder="选择日期时间">
                </el-date-picker>
              </div>
              <div class="_3mEYS">本文章将于<span class="yfqan">{{timeformat(pub_date)}}</span>发布。
              </div>
            </div>
            <div class="RzhZ5 pCffa">
              <button type="button" class="_3zXcJ" @click="is_interval_window=false"><span>取 消</span></button>
              <button type="button" class="_3zXcJ _3QfkW"><span @click="int_article">确 认</span></button>
            </div>
          </div>

        </div>
      </transition>
    </div>

  </div>
</template>

<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    import '../../static/font-awesome/css/font-awesome.css'
    export default {
        name: "Writer",
        data(){
          return {
            token: "",
            editorTitle: "",  // 当前操作的文章标题
            editorContent:"", // 当前操作的文章内容
            editorRender:"", //  当前操作的文章内容[html格式内容]
            img_file:[],
            collection_form:false,
            collection_name:"",  // 本次新增的文集名称
            is_show_page: false,   // 控制是否显示页面
            collection_list:[],    // 当前登录用户的文集列表
            current_collection: 0, // 当前用户选中操作的文集下标,默认为第一个文集,也就是下标为0的文集
            is_show_collection_menu:false, // 控制文集菜单是否显示
            article_list: [],     // 当前文集的文章列表
            current_article: 0,   // 当前用户选中操作的文章下标,默认为第一个文章,也就是下标为0的文章
            is_show_article_menu:false, // 控制文章菜单是否显示
            is_interval_window: false, // 控制定时发布窗口是否显示
            pub_date: new Date().toLocaleDateString(),  // 定时发布文章的事件设置
            timer: null, // 定时器的返回标记
          }
        },
        watch:{
            editorTitle(){
              this.int_save_article();
            },
            current_collection(){
              // 切换操作的文集
              this.is_show_collection_menu = false;
              // 重新获取当前文集的文章列表
              this.get_article();
            },
            current_article(){
              // 切换操作的文章
              this.is_show_article_menu = false;
              if(this.article_list.length>0){
                this.editorTitle=this.article_list[this.current_article].title;
                this.editorContent=this.article_list[this.current_article].content||"";
              }
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
                // 点选页面其他位置，关闭菜单
                document.onclick = (event)=>{
                    // 关闭文集菜单
                    this.is_show_collection_menu = false;
                    // 关闭文章菜单
                    this.is_show_article_menu = false;
                }
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
            if(this.token){
                this.get_collection();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          get_collection(){
            // 获取当前用户的文集列表
            this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                headers:{  // 设置本次http的请求头信息
                    Authorization: "JWT "+ this.token,
                }
            }).then(response=>{
               this.collection_list = response.data;
               // 成功获取文集列表以后, 再发送ajax请求获取当前文集下的文章列表
               this.get_article();
            }).catch(error=>{
               this.$message.error("网络异常,获取文集列表失败!");
            });
          },
          add_collection(){
              // 添加文集
              this.$axios.post(`${this.$settings.Host}/article/collection/`,{
                  name: this.collection_name
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("新增文集成功！");
                  this.collection_list.push(response.data);
                  // 清空和关闭添加文集的表单
                  this.collection_name="";
                  this.collection_form=false;
              }).catch(error=>{
                  this.$message.error("对不起，新增文集失败！");
              });

          },
          del_collection(){
              // 删除文集
              if(this.collection_list.length<2){
                  this.$message.error("对不起，当前文集列表只剩下一个文集了，所以不能删除！");
                  return false;
              }

              // 获取本次操作的文集，提取文集的id
              let collection_id = this.collection_list[this.current_collection].id;
              let collection_name = this.collection_list[this.current_collection].name;
              this.$confirm(`确认要删除当前文集《${collection_name}》吗？`, '危险操作', {
                confirmButtonText: '删除',
                cancelButtonText: '取消',
                type: 'warning'
              }).then(() => {
                // 确认删除
                this.$axios.delete(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                    headers:{
                        Authorization: "jwt " + this.token,
                    }
                }).then(response=>{
                    this.$message.success("成功删除当前文集！");
                    // 客户端从文集列表移除当前文集，并重置当前操作的文集ID为0
                    this.collection_list.splice(this.current_collection,1);
                    this.current_collection = 0;
                    // 重新获取文章列表
                    this.get_article();
                }).catch(error=>{
                    this.$message.error("删除文集失败！");
                });

              }).catch(() => {
                // 取消

              });
          },
          put_collection(){
            // 修改文集名称
            let collection_id = this.collection_list[this.current_collection].id;
            let collection_name = this.collection_list[this.current_collection].name;
            // 显示修改文集名称的弹窗
            this.$prompt('请输入新的文集名称', '修改文集', {
              confirmButtonText: '更新',
              cancelButtonText: '取消',
              inputValidator(val){
                if(val==collection_name){
                    return "对不起，文集名称没有进行修改！";
                }
              },
            }).then(({ value }) => {
              // 发送ajax请求服务端修改文集名称
              this.$axios.put(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                  name: value,
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                 this.collection_list[this.current_collection].name = value;
              }).catch(error=>{
                 // 取消不需要做任何事情

              });

            }).catch(() => {

            });
          },
          get_article(){
            // 获取当前文集的文章列表
            // 当前文集ID
            let collection_id = this.collection_list[this.current_collection].id;
            this.$axios.get(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
               this.article_list = response.data;
               if(this.article_list.length>0){
                this.editorTitle=this.article_list[this.current_article].title;
                this.editorContent=this.article_list[this.current_article].content||"";
               }
            }).catch(error=>{
               this.$message.error("获取文章列表失败!");
            });
          },
          add_article(insert){
              let collection_id = this.collection_list[this.current_collection].id;
              this.$axios.post(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                  insert, // insert:insert的简写
                  title: new Date().toLocaleDateString().split("/").join("-"),
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  // 根据insert的值判断是插入文章还是追加文章
                  if(insert){
                      this.article_list.unshift(response.data);
                      this.current_article=0;
                  }else{
                      this.article_list.push(response.data);
                      this.current_article=this.article_list.length-1;
                  }
                  if(this.article_list.length>0){
                    this.editorTitle=this.article_list[this.current_article].title;
                    this.editorContent=this.article_list[this.current_article].content;
                  }
              }).catch(error=>{
                  this.$message.error("添加文章失败!请联系客服工作人员!");
              })
          },
          pub_article(){
            // 切换文章发布状态
              let article = this.article_list[this.current_article];
              this.$axios.patch(`${this.$settings.Host}/article/${article.id}/`,{
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  /**
                    1. 隐私文章 is_public=False, pub_date=None
                    2. 发布文章 is_public=True, pub_date=None
                    3. 定时文章 is_public=False, pub_date=时间
                   */
                  if(article.pub_date){
                      // 取消定时
                      article.pub_date = null
                  }else if(article.is_public){
                      // 取消发布
                      article.is_public=false;
                  }else{
                      // 文章发布
                      article.is_public=true;
                  }
              }).catch(error=>{
                  this.$message.error("添加文章失败!请联系客服工作人员!");
              });
              this.is_show_article_menu=false;
          },
          mov_article(collection_id){
            // 移动文章
            let article = this.article_list[this.current_article];
            this.$axios.put(`${this.$settings.Host}/article/${article.id}/`,{
                collection: collection_id,
            },{
                headers:{
                    Authorization: "jwt "+ this.token,
                }
            }).then(response=>{
                // 把已经移动到其他文集的文章从当前的文章列表中删除
                this.article_list.splice(this.current_article,1);
            }).catch(error=>{
                this.$message.error("移动文章失败!");
            });
          },
          int_article(){
              // 定时发布文章
              let article = this.article_list[this.current_article];

              if( article.is_public ){
                  this.$message.error("当前文章已经发布过,不能设置定时发布!");
                  return false;
              }

              this.$axios.patch(`${this.$settings.Host}/article/${article.id}/interval/`,{
                  pub_date: this.timeformat(this.pub_date),
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("定时发布文章设置成功!");
                  this.is_interval_window=false;
                  this.article_list[this.current_article].pub_date=this.timeformat(this.pub_date);
              }).catch(error=>{
                  this.$message.error("定时发布文章设置失败!");
              });
          },
          save_article(){
            // 保存文章标题和内容信息
            let article = this.article_list[this.current_article];
            if(this.editorContent==null){
               this.editorContent="";
            }
            if(this.editorRender==null){
               this.editorRender="";
            }
            this.$axios.put(`${this.$settings.Host}/article/${article.id}/info/`,{
                title: this.editorTitle,
                content: this.editorContent,
                html_content: this.editorRender,
            },{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
               article.title = this.editorTitle;
               article.content = this.editorContent;
               article.html_content = this.editorRender;
            }).catch(error=>{
               this.$message.error("网络异常，编辑的文章内容无法保存，请及时对当前内容进行备份处理并联系客服工作人员！");
            });
          },
          int_save_article(){
             // 延时保存文章内容
             clearTimeout(this.timer); // 每次调用保存时，先把目前运行的定时器关闭，重新进行3秒倒计时
             this.timer = setTimeout( this.save_article,3000);
          },
          change_article(content,html_content){
              this.editorContent = content;
              this.editorRender = html_content;
              this.int_save_article();
          },
          // 绑定@imgAdd event
          imgAdd(pos, $file){
              // 添加文件
          },
          imgDel(pos) {
              // 删除文件
          },
          timeformat(time){
              time = new Date(time);
              return `${time.getFullYear()}-${time.getMonth()+1}-${time.getDate()} ${time.getHours()}:${time.getMinutes()}`;
          }
        }
    }
</script>

```





## 完善富文本编辑器添加图片到服务端功能

服务端实现上传图片的API接口

视图代码：

```python
from .models import ArticleImage
from .serializers import ArticleImageModelSerializer
class ArticleImageAPIView(CreateAPIView):
    queryset = ArticleImage.objects.all()
    serializer_class = ArticleImageModelSerializer
```

序列化器：

```python
from rest_framework import serializers
from .models import ArticleImage
class ArticleImageModelSerializer(serializers.ModelSerializer):
    class Meta:
        model = ArticleImage
        fields = ("image",)

    def create(self, validated_data):
        user_id = self.context["request"].user.id
        instance = ArticleImage.objects.create(
            image=validated_data.get("image"),
            orders=0,
            user=user_id,
        )
        instance.group = str(instance.image).split("/")[0]
        instance.save()
        return instance
```

路由代码：

```python
from django.urls import path
from . import views
from rest_framework_jwt.views import obtain_jwt_token
urlpatterns = [
    # ...
    path("image/", views.ArticleImageAPIView.as_view()),
]
```



客户端实现在富文本编辑器中用户添加图片时直接上传文件到服务端FastDFS系统。

```vue
<template>
  <div class="write" v-if="is_show_page">
    <div class="_2v5v5">
      <div class="_3zibT"><router-link to="/">回首页</router-link></div>
      <div class="_1iZMb">
        <div class="_33Zlg" @click="collection_form=!collection_form"><i class="fa fa-plus"></i><span>新建文集</span></div>
        <div class="_2G97m">
          <form class="M8J6Q" :class="collection_form?'_2a1Rp':'_1mU5v'">
            <input type="text" placeholder="请输入文集名..." v-model="collection_name" class="_1CtV4">
            <button type="submit" class="dwU8Q _3zXcJ _3QfkW" @click.prevent="add_collection"><span>提 交</span></button>
            <button type="button" class="vIzwB _3zXcJ" @click="collection_form=false"><span>取 消</span></button>
          </form>
        </div>
      </div>
      <ul class="_3MbJ4 _3t059">
        <li class="_3DM7w" :class="key==current_collection?'_31PCv':''" @click="current_collection=key" :title="collection.name" v-for="collection,key in collection_list">
          <div class="_3P4JX _2VLy-" v-if="key==current_collection" @click.stop="is_show_collection_menu=!is_show_collection_menu">
            <i class="fa fa-gear"></i>
            <span>
              <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_collection_menu?'NvfK4':''">
                <li class="_2po2r cRfUr" @click.prevent.stop="put_collection">
                  <span class=""><i class="fa fa-pencil-square-o _22XWG"></i>修改文集</span>
                </li>
                <li class="_2po2r cRfUr" @click.prevent.stop="del_collection">
                  <span class=""><i class="fa fa-trash-o _22XWG"></i>删除文集</span>
                </li>
              </ul>
            </span>
          </div>
          <span>{{collection.name}}</span>
        </li>
      </ul>
      <div style="height: 50px;"></div>
      <div role="button" class="h-5Am">
        <span class="ant-dropdown-trigger"><i class="fa fa-bars"></i><span>设置</span></span>
        <span class="Yv5Zx">遇到问题<i class="fa fa-question-circle-o"></i></span>
      </div>
    </div>
    <div class="rQQG7">
      <div class="_3revO _2mnPN">
        <div class="_3br9T">
          <div>
            <div class="_1GsW5" @click="add_article(true)"><i class="fa fa-plus-circle"></i><span> 新建文章</span></div>
            <ul class="_2TxA-">
              <li class="_25Ilv" :class="key==current_article?'_33nt7':''" @click="current_article=key" :title="article.title" v-for="article,key in article_list">
                <!-- 文章的发布状态 -->
                <i class="_13kgp" :class="article.is_public?'_2m93u':(article.pub_date==null?'':'interval')"></i>
                <div class="_3P4JX poOXI" v-if="key==current_article" @click.stop.prevent="is_show_article_menu=!is_show_article_menu">
                  <i class="fa fa-gear"></i>
                  <span>
                    <ul class="_2V8zt _3FcHm _2w9pn" :class="is_show_article_menu?'NvfK4':''">
                      <li class="_2po2r cRfUr" @click.stop.prevent="pub_article" v-if="!article.is_public && !article.pub_date"><span class=""><i class="fa fa-share _22XWG"></i>直接发布</span></li>
                      <li class="_2po2r cRfUr" @click.stop.prevent="pub_article" v-else><span class=""><i class="fa fa-share _22XWG"></i>设置为隐私文章</span></li>
                      <li class="_2po2r cRfUr" v-if="!article.is_public && !article.pub_date" @click="is_interval_window=true"><span class=""><i class="fa fa-clock-o _22XWG"></i>定时发布</span></li>
                      <li class="_2po2r cRfUr"><span class="_20tIi"><i class="iconfont ic-paid _22XWG"></i>发布为付费文章</span></li>
                      <li class="_2po2r cRfUr"><span class=""><i class="iconfont ic-set _22XWG"></i>设置发布样式</span></li>
                      <li class="_3nZXj _2_WAp _3df2u _2po2r cRfUr" title=""><span class=""><i class="fa fa-folder-open _22XWG"></i>移动文章
                        <div class="_3x4X_">
                          <ul class="_2KzJx oGKRI _3DXDE _2w9pn">
                            <li class="_2po2r cRfUr" @click="mov_article(collection.id)" :title="collection.name" v-if="key!=current_collection" v-for="collection,key in collection_list"><span class="">{{collection.name}}</span></li>
                          </ul>
                        </div>

                      </span>
                      </li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-history _22XWG"></i>历史版本</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-trash-o _22XWG"></i>删除文章</span></li>
                      <li class="_2po2r cRfUr" title=""><span class=""><i class="fa fa-ban _22XWG"></i>设置禁止转载</span></li>
                    </ul>
                  </span>
                </div>
                <span class="NariC">{{article.title}}</span>
                <span class="hLzJv" v-if="article.content">{{article.content.substr(0,20)}}</span>
                <span class="hLzJv" v-else></span>
                <span class="_29C-V" v-if="key==current_article">
                  字数:
                  <span v-if="article.content">{{article.content.length}}</span>
                  <span v-else>0</span>
                </span>
              </li>
            </ul>
            <div class="_2cVn3" @click="add_article(false)"><i class="fa fa-plus"></i><span> 在下方新建文章</span></div>
          </div>
        </div>
      </div>
      <input type="text" class="_24i7u" v-model="editorTitle">
      <div id="editor">
        <mavon-editor
          style="height: 100%"
          v-model="editorContent"
          :ishljs="true"
          ref=md
          @change="change_article"
          @save="save_article"
          @imgAdd="imgAdd"
          @imgDel="imgDel"
        ></mavon-editor>
      </div>
    </div>

    <!-- 定时发布弹窗 -->
    <div class="interval_box" v-show="is_interval_window">
      <transition name="el-fade-in-linear">
        <div class="transition-box">
          <div class="_2tIvb">
            <div class="ZTNas" aria-label="Close" @click="is_interval_window=false"><i class="fa fa-close"></i></div>
            <div class="_1KgC3">
              <div class="-K8Re">定时发布</div>
            </div>
            <div class="_1LROK PWCkH">
              <div class="wzwGh">选择定时发布的时间：</div>
              <div class="On4jq">
                  <el-date-picker
                  v-model="pub_date"
                  type="datetime"
                  format="yyyy-MM-dd HH:mm"
                  placeholder="选择日期时间">
                </el-date-picker>
              </div>
              <div class="_3mEYS">本文章将于<span class="yfqan">{{timeformat(pub_date)}}</span>发布。
              </div>
            </div>
            <div class="RzhZ5 pCffa">
              <button type="button" class="_3zXcJ" @click="is_interval_window=false"><span>取 消</span></button>
              <button type="button" class="_3zXcJ _3QfkW"><span @click="int_article">确 认</span></button>
            </div>
          </div>

        </div>
      </transition>
    </div>

  </div>
</template>

<script>
    import { mavonEditor } from 'mavon-editor'
    import 'mavon-editor/dist/css/index.css'
    import '../../static/font-awesome/css/font-awesome.css'
    export default {
        name: "Writer",
        data(){
          return {
            token: "",
            editorTitle: "",  // 当前操作的文章标题
            editorContent:"", // 当前操作的文章内容
            editorRender:"", //  当前操作的文章内容[html格式内容]
            img_file:[],
            collection_form:false,
            collection_name:"",  // 本次新增的文集名称
            is_show_page: false,   // 控制是否显示页面
            collection_list:[],    // 当前登录用户的文集列表
            current_collection: 0, // 当前用户选中操作的文集下标,默认为第一个文集,也就是下标为0的文集
            is_show_collection_menu:false, // 控制文集菜单是否显示
            article_list: [],     // 当前文集的文章列表
            current_article: 0,   // 当前用户选中操作的文章下标,默认为第一个文章,也就是下标为0的文章
            is_show_article_menu:false, // 控制文章菜单是否显示
            is_interval_window: false, // 控制定时发布窗口是否显示
            pub_date: new Date().toLocaleDateString(),  // 定时发布文章的事件设置
            timer: null, // 定时器的返回标记
          }
        },
        watch:{
            editorTitle(){
              this.int_save_article();
            },
            current_collection(){
              // 切换操作的文集
              this.is_show_collection_menu = false;
              // 重新获取当前文集的文章列表
              this.get_article();
            },
            current_article(){
              // 切换操作的文章
              this.is_show_article_menu = false;
              if(this.article_list.length>0){
                this.editorTitle=this.article_list[this.current_article].title;
                this.editorContent=this.article_list[this.current_article].content||"";
              }
            }
        },
        mounted(){
            if(this.is_show_page){
              document.querySelector("#editor").style.height = document.documentElement.clientHeight-document.querySelector("._24i7u").clientHeight+"px";
                // 点选页面其他位置，关闭菜单
                document.onclick = (event)=>{
                    // 关闭文集菜单
                    this.is_show_collection_menu = false;
                    // 关闭文章菜单
                    this.is_show_article_menu = false;
                }
            }
        },
        created(){
            this.token = this.$settings.check_user_login(this);
            if(this.token){
                this.get_collection();
            }
        },
        components: {
          mavonEditor
        },
        methods:{
          get_collection(){
            // 获取当前用户的文集列表
            this.$axios.get(`${this.$settings.Host}/article/collection/`,{
                headers:{  // 设置本次http的请求头信息
                    Authorization: "JWT "+ this.token,
                }
            }).then(response=>{
               this.collection_list = response.data;
               // 成功获取文集列表以后, 再发送ajax请求获取当前文集下的文章列表
               this.get_article();
            }).catch(error=>{
               this.$message.error("网络异常,获取文集列表失败!");
            });
          },
          add_collection(){
              // 添加文集
              this.$axios.post(`${this.$settings.Host}/article/collection/`,{
                  name: this.collection_name
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("新增文集成功！");
                  this.collection_list.push(response.data);
                  // 清空和关闭添加文集的表单
                  this.collection_name="";
                  this.collection_form=false;
              }).catch(error=>{
                  this.$message.error("对不起，新增文集失败！");
              });

          },
          del_collection(){
              // 删除文集
              if(this.collection_list.length<2){
                  this.$message.error("对不起，当前文集列表只剩下一个文集了，所以不能删除！");
                  return false;
              }

              // 获取本次操作的文集，提取文集的id
              let collection_id = this.collection_list[this.current_collection].id;
              let collection_name = this.collection_list[this.current_collection].name;
              this.$confirm(`确认要删除当前文集《${collection_name}》吗？`, '危险操作', {
                confirmButtonText: '删除',
                cancelButtonText: '取消',
                type: 'warning'
              }).then(() => {
                // 确认删除
                this.$axios.delete(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                    headers:{
                        Authorization: "jwt " + this.token,
                    }
                }).then(response=>{
                    this.$message.success("成功删除当前文集！");
                    // 客户端从文集列表移除当前文集，并重置当前操作的文集ID为0
                    this.collection_list.splice(this.current_collection,1);
                    this.current_collection = 0;
                    // 重新获取文章列表
                    this.get_article();
                }).catch(error=>{
                    this.$message.error("删除文集失败！");
                });

              }).catch(() => {
                // 取消

              });
          },
          put_collection(){
            // 修改文集名称
            let collection_id = this.collection_list[this.current_collection].id;
            let collection_name = this.collection_list[this.current_collection].name;
            // 显示修改文集名称的弹窗
            this.$prompt('请输入新的文集名称', '修改文集', {
              confirmButtonText: '更新',
              cancelButtonText: '取消',
              inputValidator(val){
                if(val==collection_name){
                    return "对不起，文集名称没有进行修改！";
                }
              },
            }).then(({ value }) => {
              // 发送ajax请求服务端修改文集名称
              this.$axios.put(`${this.$settings.Host}/article/collection/${collection_id}/`,{
                  name: value,
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                 this.collection_list[this.current_collection].name = value;
              }).catch(error=>{
                 // 取消不需要做任何事情

              });

            }).catch(() => {

            });
          },
          get_article(){
            // 获取当前文集的文章列表
            // 当前文集ID
            let collection_id = this.collection_list[this.current_collection].id;
            this.$axios.get(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
               this.article_list = response.data;
               if(this.article_list.length>0){
                this.editorTitle=this.article_list[this.current_article].title;
                this.editorContent=this.article_list[this.current_article].content||"";
               }
            }).catch(error=>{
               this.$message.error("获取文章列表失败!");
            });
          },
          add_article(insert){
              let collection_id = this.collection_list[this.current_collection].id;
              this.$axios.post(`${this.$settings.Host}/article/collection/${collection_id}/articles/`,{
                  insert, // insert:insert的简写
                  title: new Date().toLocaleDateString().split("/").join("-"),
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  // 根据insert的值判断是插入文章还是追加文章
                  if(insert){
                      this.article_list.unshift(response.data);
                      this.current_article=0;
                  }else{
                      this.article_list.push(response.data);
                      this.current_article=this.article_list.length-1;
                  }
                  if(this.article_list.length>0){
                    this.editorTitle=this.article_list[this.current_article].title;
                    this.editorContent=this.article_list[this.current_article].content;
                  }
              }).catch(error=>{
                  this.$message.error("添加文章失败!请联系客服工作人员!");
              })
          },
          pub_article(){
            // 切换文章发布状态
              let article = this.article_list[this.current_article];
              this.$axios.patch(`${this.$settings.Host}/article/${article.id}/`,{
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  /**
                    1. 隐私文章 is_public=False, pub_date=None
                    2. 发布文章 is_public=True, pub_date=None
                    3. 定时文章 is_public=False, pub_date=时间
                   */
                  if(article.pub_date){
                      // 取消定时
                      article.pub_date = null
                  }else if(article.is_public){
                      // 取消发布
                      article.is_public=false;
                  }else{
                      // 文章发布
                      article.is_public=true;
                  }
              }).catch(error=>{
                  this.$message.error("添加文章失败!请联系客服工作人员!");
              });
              this.is_show_article_menu=false;
          },
          mov_article(collection_id){
            // 移动文章
            let article = this.article_list[this.current_article];
            this.$axios.put(`${this.$settings.Host}/article/${article.id}/`,{
                collection: collection_id,
            },{
                headers:{
                    Authorization: "jwt "+ this.token,
                }
            }).then(response=>{
                // 把已经移动到其他文集的文章从当前的文章列表中删除
                this.article_list.splice(this.current_article,1);
            }).catch(error=>{
                this.$message.error("移动文章失败!");
            });
          },
          int_article(){
              // 定时发布文章
              let article = this.article_list[this.current_article];

              if( article.is_public ){
                  this.$message.error("当前文章已经发布过,不能设置定时发布!");
                  return false;
              }

              this.$axios.patch(`${this.$settings.Host}/article/${article.id}/interval/`,{
                  pub_date: this.timeformat(this.pub_date),
              },{
                  headers:{
                      Authorization: "jwt " + this.token,
                  }
              }).then(response=>{
                  this.$message.success("定时发布文章设置成功!");
                  this.is_interval_window=false;
                  this.article_list[this.current_article].pub_date=this.timeformat(this.pub_date);
              }).catch(error=>{
                  this.$message.error("定时发布文章设置失败!");
              });
          },
          save_article(){
            // 保存文章标题和内容信息
            let article = this.article_list[this.current_article];
            if(this.editorContent==null){
               this.editorContent="";
            }
            if(this.editorRender==null){
               this.editorRender="";
            }
            this.$axios.put(`${this.$settings.Host}/article/${article.id}/info/`,{
                title: this.editorTitle,
                content: this.editorContent,
                html_content: this.editorRender,
            },{
                headers:{
                    Authorization: "jwt " + this.token,
                }
            }).then(response=>{
               article.title = this.editorTitle;
               article.content = this.editorContent;
               article.html_content = this.editorRender;
            }).catch(error=>{
               this.$message.error("网络异常，编辑的文章内容无法保存，请及时对当前内容进行备份处理并联系客服工作人员！");
            });
          },
          int_save_article(){
             // 延时保存文章内容
             clearTimeout(this.timer); // 每次调用保存时，先把目前运行的定时器关闭，重新进行2秒倒计时
             this.timer = setTimeout( this.save_article,2000);
          },
          change_article(content,html_content){
              this.editorContent = content;
              this.editorRender = html_content;
              this.int_save_article();
          },
          // 绑定@imgAdd event
          imgAdd(filename, $file){
           // 把富文本编辑器中的图片上传到服务端，因为服务端使用了docker部署的FastDFS，所以一定要检查nginx容器是否启动了
           var formdata = new FormData();
           formdata.append('image', $file);
           // formdata.append('title', '新增数据');
           // formdata.append('title', '新增数据');
           this.$axios.post(`${this.$settings.Host}/article/image/`,formdata,{
               headers: {
                 'Content-Type': 'multipart/form-data',
                 Authorization: "jwt " + this.token,
               },
           }).then(response => {
               // 第二步.将返回的url替换到文本原位置![...](0) -> ![...](url)
               this.$refs.md.$img2Url(filename, response.data.image);
           });
          },
          imgDel(filename) {
              // 删除文件
              delete this.img_file[filename];  // 前段删除,一般服务端不删除
              this.$refs.toolbar_left.$imgDelByFilename(filename);
              // 发送ajax删除后端图片

          },
          timeformat(time){
              time = new Date(time);
              return `${time.getFullYear()}-${time.getMonth()+1}-${time.getDate()} ${time.getHours()}:${time.getMinutes()}`;
          }
        }
    }
</script>
```



