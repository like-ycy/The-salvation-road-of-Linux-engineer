# 用户的登陆认证

### 2.3.9 多条件登录

JWT扩展的登录视图，在收到用户名与密码时，也是调用Django的认证系统中提供的**authenticate()**来检查用户名与密码是否正确。

我们可以通过修改Django认证系统的认证后端（主要是authenticate方法）来支持登录账号既可以是用户名也可以是手机号。

**修改Django认证系统的认证后端需要继承django.contrib.auth.backends.ModelBackend，并重写authenticate方法。**

`authenticate(self, request, username=None, password=None, **kwargs)`方法的参数说明：

- request 本次认证的请求对象
- username 本次认证提供的用户账号
- password 本次认证提供的密码

**我们想要让用户既可以以用户名登录，也可以以手机号登录，那么对于authenticate方法而言，username参数即表示用户名或者手机号。**

重写authenticate方法的思路：

1. 根据username参数查找用户User对象，username参数可能是用户名，也可能是手机号
2. 若查找到User对象，调用User对象的 check_password 方法检查密码是否正确

在users/utils.py中编写：

```python
def jwt_response_payload_handler(token, user=None, request=None):
    """
    自定义jwt认证成功返回数据
    :param token: jwt token字符串
    :param user: 本次成功登录的用户模型对象
    :param request: 本次登录用户的http请求对象
    :return: dict
    """
    return {
        'token': token,
        'id': user.id,
        'username': user.username if user.username else "暂无",
        'avatar': user.avatar.url if user.avatar else "",
    }

from django.contrib.auth.backends import ModelBackend
from .models import User
from django.db.models import Q
def get_user_by_account(account):
    try:
        return User.objects.get(Q(username=account) | Q(mobile=account) | Q(email=account))
    except User.DoesNotExist:
        return None

class CustomAuthUserModelBackend(ModelBackend):
    def authenticate(self, request, username=None, password=None, **kwargs):
        # 根据客户端提交的账户信息获取用户模型对象
        user = get_user_by_account(username)
        # 账号通过了还要进行密码的验证,以及判断当前站好是否是激活状态
        if user is not None and user.check_password(raw_password=password) and self.user_can_authenticate(user):
            return user
```

在配置文件settings/dev.py中告知Django使用我们自定义的认证后端

```python
AUTHENTICATION_BACKENDS = [
    'users.utils.CustomAuthUserModelBackend',
]
```





## 2.4 在登录认证中接入腾讯防水墙验证码

验证码有三种：图片验证码，短信验证码，滑动验证码

官网： [https://007.qq.com](https://007.qq.com/)

使用微信扫码登录腾讯云控制台，然后根据官方文档，把验证码集成到项目中

快速接入：<https://007.qq.com/python-access.html?ADTAG=acces.start>

1. 访问地址: https://cloud.tencent.com/document/product/1110/36839

2. 访问云API秘钥

3. 访问验证码控制台: https://console.cloud.tencent.com/captcha

4. 新建验证应用[ 新用户可以领取一个免费的验证码套餐 ]

   ![1578277301522](4%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C.assets/1578277301522.png)

![1578277415727](4%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C.assets/1578277415727.png)

点击详情:

![1578277442350](4%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C.assets/1578277442350.png)

获取当前验证码应用的应用ID和应用秘钥.

![1578277500168](4%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C.assets/1578277500168.png)

把秘钥和ID保存到settings/dev.py配置文件中.

```python
# 腾讯防水墙配置
TENCENT_CAPTCHA = {
    "GATEWAY": "https://ssl.captcha.qq.com/ticket/verify",
    "APPID": "2044977606",
    "App_Secret_Key": "0Ns8dOGHAAFiaDwPhdo2HBg**",
}
```





### 前端获取显示并校验验证码

把防水墙的前端核心js文件在客户端根目录下index.html中使用script引入或者在src/main.js中通过import引入。

下载地址：https://ssl.captcha.qq.com/TCaptcha.js

![1594175710552](4%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C.assets/1594175710552.png)

在客户端项目的src/settings.js中添加配置：

```javascript
export default {
  Host:"http://api.renran.cn:8000",
  TC_captcha:{
    app_id: "2044977606",
  },
}
```



Login.vue代码

```vue
<template>
    <div class="sign">
    <div class="logo"><router-link to="/"><img src="/static/image/nav-logo.png" alt="Logo"></router-link></div>
    <div class="main">


<h4 class="title">
  <div class="normal-title">
    <router-link class="active" to="/login">登录</router-link>
    <b>·</b>
    <router-link id="js-sign-up-btn" class="" to="/register">注册</router-link>
  </div>
</h4>
<div class="js-sign-in-container">
  <form id="new_session" action="" method="post">
      <div class="input-prepend restyle js-normal">
        <input placeholder="手机号或邮箱" type="text" v-model="username" id="session_email_or_mobile_number">
        <i class="iconfont ic-user"></i>
      </div>

    <div class="input-prepend">
      <input placeholder="密码" type="password" v-model="password" id="session_password">
      <i class="iconfont ic-password"></i>
    </div>
    <div class="remember-btn">
      <input type="checkbox" v-model="remember_me" id="session_remember_me"><span>记住我</span>
    </div>
    <div class="forget-btn">
      <a class="" data-toggle="dropdown" href="">登录遇到问题?</a>
    </div>
    <button class="sign-in-button" id="sign-in-form-submit-btn" type="button" @click="show_captcha">
      <span id="sign-in-loading"></span>
      登录
    </button>
</form>
  <!-- 更多登录方式 -->
  <div class="more-sign">
    <h6>社交帐号登录</h6>
    <ul>
  <li id="weibo-link-wrap" class="">
    <a class="weibo" id="weibo-link">
      <i class="iconfont ic-weibo"></i>
    </a>
  </li>
  <li><a id="weixin" class="weixin" target="_blank" href=""><i class="iconfont ic-wechat"></i></a></li>
  <li><a id="qq" class="qq" target="_blank" href=""><i class="iconfont ic-qq_connect"></i></a></li>
</ul>
  </div>
</div>

    </div>
  </div>
</template>

<script>
    export default {
        name: "Login",
        data(){
          return {
            username: "",
            password: "",
            remember_me: "", // 设置是否要记录登录状态
          }
        },
        methods:{
            show_captcha(){
                // 显示验证码

                // 判断手机号或者密码是否为空！
                if(this.username.length<1 || this.password.length<1){
                    // 阻止代码继续往下执行
                    return false;
                }


                var captcha1 = new TencentCaptcha(this.$settings.TC_captcha.app_id, res=>{
                    // 用户操作验证码成功以后的回调函数，这个函数将会在对象创建以后，在页面那种进行监听用户的操作
                    // res就是用户操作成功以后，验证码服务器返回的内容
                    /**
                   res:
                    appid: "2086888489"  # 验证码的APPID
                    randstr: "@G0V"      # 随机字符串，防止重复
                    ret: 0               # 0表示用户操作成功，2表示用户主动关闭验证码窗口
                    ticket: ""           # 验证通过以后的票据，提供给python后端，将来到验证码服务器中进行
                    */
                    this.$axios.get(`${this.$settings.Host}/users/captcha/`,{
                        params:{
                          ticket: res.ticket,
                          randstr: res.randstr
                        }
                    }).then(response=>{
                        if(response.data.detail){
                            // 继续进行登录处理
                            this.loginhandler();
                        }
                    }).catch(error=>{
                        this.$message.error("对不起，验证码校验不通过！");
                    });
                });
                captcha1.show(); // 显示验证码
            },
            loginhandler(){
                // 登录处理
                this.$axios.post(`${this.$settings.Host}/users/login/`,{
                  username: this.username,
                  password: this.password,
                }).then(response=>{
                    // 根据remember_me的值来保存登录状态到本地[vuex，本地存储]
                    if(this.remember_me){
                        // 永久存储
                        localStorage.user_token = response.data.token;
                        localStorage.user_id    = response.data.id;
                        localStorage.user_name  = response.data.username;
                        localStorage.user_avatar= response.data.avatar;
                        sessionStorage.removeItem("user_token");
                        sessionStorage.removeItem("user_id");
                        sessionStorage.removeItem("user_name");
                        sessionStorage.removeItem("user_avatar");
                    }else{
                        // 临时存储
                        sessionStorage.user_token = response.data.token;
                        sessionStorage.user_id = response.data.id;
                        sessionStorage.user_name = response.data.username;
                        sessionStorage.user_avatar = response.data.avatar;
                        localStorage.removeItem("user_token");
                        localStorage.removeItem("user_id");
                        localStorage.removeItem("user_name");
                        localStorage.removeItem("user_avatar");
                    }
                    // 页面跳转
                    this.$confirm('是否跳转到个人中心', '登录成功', {
                      confirmButtonText: '个人中心',
                      cancelButtonText: '返回首页',
                      type: 'success'
                    }).then(() => {
                      // 前往个人中心
                      this.$router.push("/users");
                    }).catch(() => {
                      // 返回站点首页
                      this.$router.push("/");
                    });
                }).catch(error=>{
                    this.$message.error("登录失败！");
                    this.username = "";
                    this.password = "";
                });
            }
        }
    }
</script>

```

api服务端接入验证码的文档说明: https://007.qq.com/python-access.html?ADTAG=acces.start

服务端接受验证结果并返回，代码：

```python
# Create your views here.
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from django.conf import settings
# urllib python内置的标准模块，用于发送http请求，类似vue里面的axios
from urllib.parse import urlencode
from urllib.request import urlopen
import json
class CaptchaAPIView(APIView):
    """验证码"""
    def get(self,request):
        """接受客户端提交的验证码相关信息"""
        params = {
            "aid": settings.TENCENT_CAPTCHA.get("APPID"),
            "AppSecretKey": settings.TENCENT_CAPTCHA.get("App_Secret_Key"),
            "Ticket": request.query_params.get("ticket"),
            "Randstr": request.query_params.get("randstr"),
            # request._request表示获取django框架的request对象
            # request._request.META获取本次客户端的请求头
            "UserIP": request._request.META.get("REMOTE_ADDR")
        }
        # 把字典数据转换成地址栏的查询字符串格式
        # aid=xxx&AppSecretKey=xxx&xxxxx
        params = urlencode(params)
        url = settings.TENCENT_CAPTCHA.get("GATEWAY")
        # 发送http的get请求
        # urlopen(url=请求地址，data=请求体数据)
        # 如果get请求，只需要填写参数1
        # 如果post请求，则需要填写参数1和参数2，其中参数2的格式为字典格式
        # urlopen是一个资源对象
        f = urlopen("%s?%s" % (url, params))
        # https://ssl.captcha.qq.com/ticket/verify?aid=xxx&AppSecretKey=xxx&xxxxx

        # f.read() 读取响应信息
        content = f.read()
        res = json.loads(content)
        if int(res.get("response")) == 1:
            # 验证成功
            return Response({"detail":1})
        else:
            # 验证失败
            return Response({"detail":0}, status=status.HTTP_400_BAD_REQUEST)
```

路由users/urls.py，代码：

```python
from django.urls import path
from rest_framework_jwt.views import obtain_jwt_token
from . import views
urlpatterns = [
    path("login/", obtain_jwt_token),
    path("captcha/", views.CaptchaAPIView.as_view() ),
]
```



# 用户的注册认证

前端显示注册页面并调整首页头部和登陆页面的注册按钮的链接。

注册页面Register.vue,主要是通过登录页面进行改成而成

```vue
<template>
<div class="sign">
    <div class="logo"><router-link to="/"><img src="/static/image/nav-logo.png" alt="Logo"></router-link></div>
    <div class="main">
      <h4 class="title">
        <div class="normal-title">
          <router-link to="/login">登录</router-link>
          <b>·</b>
          <router-link id="js-sign-up-btn" class="active" to="/register">注册</router-link>
        </div>
      </h4>

      <div class="js-sign-up-container">
        <form class="new_user" id="new_user" action="" accept-charset="UTF-8" method="post">
          <div class="input-prepend restyle">
              <input placeholder="你的昵称" type="text" value="" v-model="nickname" id="user_nickname">
            <i class="iconfont ic-user"></i>
          </div>
            <div class="input-prepend restyle no-radius js-normal">
                <input placeholder="手机号" type="tel" v-model="mobile" id="user_mobile_number">
              <i class="iconfont ic-phonenumber"></i>
            </div>
          <div class="input-prepend restyle no-radius security-up-code js-security-number" v-if="is_show_sms_code">
              <input type="text" v-model="sms_code" id="sms_code" placeholder="手机验证码">
            <i class="iconfont ic-verify"></i>
            <a tabindex="-1" class="btn-up-resend js-send-code-button disable" href="javascript:void(0);" id="send_code">{{sms_code_text}}</a>
          </div>
          <input type="hidden" name="security_number" id="security_number">
          <div class="input-prepend">
            <input placeholder="设置密码" type="password" v-model="password" id="user_password">
            <i class="iconfont ic-password"></i>
          </div>
          <input type="submit" name="commit" value="注册" class="sign-up-button" id="sign_up_btn" data-disable-with="注册">
          <p class="sign-up-msg">点击 “注册” 即表示您同意并愿意遵守荏苒<br> <a target="_blank" href="">用户协议</a> 和 <a target="_blank" href="">隐私政策</a> 。</p>
        </form>
        <!-- 更多注册方式 -->
        <div class="more-sign">
          <h6>社交帐号直接注册</h6>
            <ul>
            <li><a id="weixin" class="weixin" target="_blank" href=""><i class="iconfont ic-wechat"></i></a></li>
            <li><a id="qq" class="qq" target="_blank" href=""><i class="iconfont ic-qq_connect"></i></a></li>
          </ul>

        </div>
      </div>

    </div>
  </div>
</template>

<script>
    export default {
        name: "Register",
        data(){
          return {
            nickname:"",
            mobile:"",
            sms_code:"",
            password:"",
            sms_code_text:"发送验证码",
            is_show_sms_code:false,
          }
        },
        watch:{
          mobile(){
            if(/^1[3-9]\d{9}$/.test(this.mobile)){
              this.is_show_sms_code = true;
            }else{
              this.is_show_sms_code = false;
            }
          }
        }
    }
</script>

<style scoped>
input{
  outline: none;
}
*, :after, :before {
    box-sizing: border-box;
}
.sign {
	height: 100%;
	min-height: 750px;
	text-align: center;
	font-size: 14px;
	background-color: #f1f1f1
}

.sign:before {
	content: "";
	display: inline-block;
	height: 85%;
	vertical-align: middle
}

.sign .disable,.sign .disable-gray {
	opacity: .5;
	pointer-events: none
}

.sign .disable-gray {
	background-color: #969696
}

.sign .tooltip-error {
	font-size: 14px;
	line-height: 25px;
	white-space: nowrap;
	background: none
}

.sign .tooltip-error .tooltip-inner {
	max-width: 280px;
	color: #333;
	border: 1px solid #ea6f5a;
	background-color: #fff
}

.sign .tooltip-error .tooltip-inner i {
	position: static;
	margin-right: 5px;
	font-size: 20px;
	color: #ea6f5a;
	vertical-align: middle
}

.sign .tooltip-error .tooltip-inner span {
	vertical-align: middle;
	display: inline-block;
	white-space: normal;
	max-width: 230px
}

.sign .tooltip-error.right .tooltip-arrow-border {
	border-right-color: #ea6f5a
}

.sign .tooltip-error.right .tooltip-arrow-bg {
	left: 2px;
	border-right-color: #fff
}

.sign .slide-error {
	position: relative;
	padding: 10px 0;
	border: 1px solid #c8c8c8;
	border-radius: 4px
}

.sign .slide-error i {
	position: static!important;
	margin-right: 10px;
	color: #ea6f5a!important;
	vertical-align: middle
}

.sign .slide-error span {
	font-size: 15px;
	vertical-align: middle
}

.sign .slide-error div {
	margin-top: 10px;
	font-size: 13px
}

.sign .slide-error a {
	color: #3194d0
}

.sign .js-sign-up-forbidden {
	color: #999;
	padding: 80px 0 100px
}

.sign .js-sign-up-container .slide-error {
	border-bottom: none;
	border-radius: 0
}

.sign .logo {
	position: absolute;
	top: 56px;
	margin-left: 50px
}

.sign .logo img {
	width: 100px
}

.sign .main {
	width: 400px;
	margin: 60px auto 0;
	padding: 50px 50px 30px;
	background-color: #fff;
	border-radius: 4px;
	box-shadow: 0 0 8px rgba(0,0,0,.1);
	vertical-align: middle;
	display: inline-block
}

.sign .reset-title,.sign .title {
	margin: 0 auto 50px;
	padding: 10px;
	font-weight: 400;
	color: #969696
}

.sign .reset-title a,.sign .title a {
	padding: 10px;
	color: #969696
}

.sign .reset-title a:hover,.sign .title a:hover {
	border-bottom: 2px solid #ea6f5a
}

.sign .reset-title .active,.sign .title .active {
	font-weight: 700;
	color: #ea6f5a;
	border-bottom: 2px solid #ea6f5a
}

.sign .reset-title b,.sign .title b {
	padding: 10px
}

.sign .reset-title {
	color: #333;
	font-weight: 700
}

.sign form {
	margin-bottom: 30px
}

.sign form .input-prepend {
	position: relative;
	width: 100%
}

.sign form .input-prepend input {
	width: 100%;
	height: 50px;
	margin-bottom: 0;
	padding: 4px 12px 4px 35px;
	border: 1px solid #c8c8c8;
	border-radius: 0 0 4px 4px;
	background-color: hsla(0,0%,71%,.1);
	vertical-align: middle
}

.sign form .input-prepend i {
	position: absolute;
	top: 14px;
	left: 10px;
	font-size: 18px;
	color: #969696
}

.sign form .input-prepend span {
	color: #333
}

.sign form .input-prepend .ic-show {
	top: 18px;
	left: auto;
	right: 8px;
	font-size: 12px
}

.sign form .geetest-placeholder {
	height: 44px;
	border-radius: 4px;
	background-color: hsla(0,0%,71%,.1);
	text-align: center;
	line-height: 44px;
	font-size: 14px;
	color: #999
}

.sign form .restyle {
	margin-bottom: 0
}

.sign form .restyle input {
	border-bottom: none;
	border-radius: 4px 4px 0 0
}

.sign form .no-radius input {
	border-radius: 0
}

.sign form .slide-security-placeholder {
	height: 32px;
	background-color: hsla(0,0%,71%,.1);
	border-radius: 4px
}

.sign form .slide-security-placeholder p {
	padding-top: 7px;
	color: #999;
	margin-right: -7px
}

.sign .overseas-btn {
	font-size: 14px;
	color: #999
}

.sign .overseas-btn:hover {
	color: #2f2f2f
}

.sign .remember-btn {
	float: left;
	margin: 15px 0
}

.sign .remember-btn span {
	margin-left: 5px;
	font-size: 15px;
	color: #969696;
	vertical-align: middle
}

.sign .forget-btn {
	float: right;
	position: relative;
	margin: 15px 0;
	font-size: 14px
}

.sign .forget-btn a {
	color: #999
}

.sign .forget-btn a:hover {
	color: #333
}

.sign .forget-btn .dropdown-menu {
	top: 20px;
	left: auto;
	right: 0;
	border-radius: 4px
}

.sign .forget-btn .dropdown-menu a {
	padding: 10px 20px;
	color: #333
}

.sign #sign-in-loading {
	position: relative;
	width: 20px;
	height: 20px;
	vertical-align: middle;
	margin-top: -4px;
	margin-right: 2px;
	display: none
}

.sign #sign-in-loading:after {
	content: "";
	position: absolute;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	background-color: transparent
}

.sign #sign-in-loading:before {
	content: "";
	position: absolute;
	top: 50%;
	left: 50%;
	width: 20px;
	height: 20px;
	margin: -10px 0 0 -10px;
	border-radius: 10px;
	border: 2px solid #fff;
	border-bottom-color: transparent;
	vertical-align: middle;
	-webkit-animation: rolling .8s infinite linear;
	animation: rolling .8s infinite linear;
	z-index: 1
}

.sign .sign-in-button,.sign .sign-up-button {
	margin-top: 20px;
	width: 100%;
	padding: 9px 18px;
	font-size: 18px;
	border: none;
	border-radius: 25px;
	color: #fff;
	background: #42c02e;
	cursor: pointer;
	outline: none;
	display: block;
	clear: both
}

.sign .sign-in-button:hover,.sign .sign-up-button:hover {
	background: #3db922
}

.sign .sign-in-button {
	background: #3194d0
}

.sign .sign-in-button:hover {
	background: #187cb7
}

.sign .btn-in-resend,.sign .btn-up-resend {
	position: absolute;
	top: 7px;
	right: 7px;
	width: 100px;
	height: 36px;
	font-size: 13px;
	color: #fff;
	background-color: #42c02e;
	border-radius: 20px;
	line-height: 36px
}

.sign .btn-in-resend {
	background-color: #3194d0
}

.sign .sign-up-msg {
	margin: 10px 0;
	padding: 0;
	text-align: center;
	font-size: 12px;
	line-height: 20px;
	color: #969696
}

.sign .sign-up-msg a,.sign .sign-up-msg a:hover {
	color: #3194d0
}

.sign .overseas input {
	padding-left: 110px!important
}

.sign .overseas .overseas-number {
	position: absolute;
	top: 0;
	left: 0;
	width: 100px;
	height: 50px;
	font-size: 18px;
	color: #969696;
	border-right: 1px solid #c8c8c8
}

.sign .overseas .overseas-number span {
	margin-top: 17px;
	padding-left: 35px;
	text-align: left;
	font-size: 14px;
	display: block
}

.sign .overseas .dropdown-menu {
	width: 100%;
	max-height: 285px;
	font-size: 14px;
	border-radius: 0 0 4px 4px;
	overflow-y: auto
}

.sign .overseas .dropdown-menu li .nation-code {
	width: 65px;
	display: inline-block
}

.sign .overseas .dropdown-menu li a {
	padding: 6px 20px;
	font-size: 14px;
	line-height: 20px
}

.sign .overseas .dropdown-menu li a::hover {
	color: #fff;
	background-color: #f5f5f5
}

.sign .more-sign {
	margin-top: 50px
}

.sign .more-sign h6 {
	position: relative;
	margin: 0 0 10px;
	font-size: 12px;
	color: #b5b5b5
}

.sign .more-sign h6:before {
	left: 30px
}

.sign .more-sign h6:after,.sign .more-sign h6:before {
	content: "";
	border-top: 1px solid #b5b5b5;
	display: block;
	position: absolute;
	width: 60px;
	top: 5px
}

.sign .more-sign h6:after {
	right: 30px
}

.sign .more-sign ul {
	margin-bottom: 10px;
	list-style: none
}

.sign .more-sign ul li {
	margin: 0 5px;
	display: inline-block
}

.sign .more-sign ul a {
	width: 50px;
	height: 50px;
	line-height: 50px;
	display: block
}

.sign .more-sign ul i {
	font-size: 28px
}

.sign .more-sign .ic-weibo {
	color: #e05244
}

.sign .more-sign .ic-wechat {
	color: #00bb29
}

.sign .more-sign .ic-qq_connect {
	color: #498ad5
}

.sign .more-sign .ic-douban {
	color: #00820f
}

.sign .more-sign .ic-more {
	color: #999
}

.sign .more-sign .weibo-loading {
	pointer-events: none;
	cursor: pointer;
	position: relative
}

.sign .more-sign .weibo-loading:after {
	content: "";
	position: absolute;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	background-color: #fff
}

body.reader-night-mode .sign .more-sign .weibo-loading:after {
	background-color: #3f3f3f
}

.sign .more-sign .weibo-loading:before {
	content: "";
	position: absolute;
	top: 50%;
	left: 50%;
	width: 20px;
	height: 20px;
	margin: -10px 0 0 -10px;
	border-radius: 10px;
	border: 2px solid #e05244;
	border-bottom-color: transparent;
	vertical-align: middle;
	-webkit-animation: rolling .8s infinite linear;
	animation: rolling .8s infinite linear;
	z-index: 1
}

@keyframes rolling {
	0% {
		-webkit-transform: rotate(0deg);
		transform: rotate(0deg)
	}

	to {
		-webkit-transform: rotate(1turn);
		transform: rotate(1turn)
	}
}

@-webkit-keyframes rolling {
	0% {
		-webkit-transform: rotate(0deg)
	}

	to {
		-webkit-transform: rotate(1turn)
	}
}

.sign .reset-password-input {
	border-radius: 4px!important
}

.sign .return {
	margin-left: -8px;
	color: #969696
}

.sign .return:hover {
	color: #333
}

.sign .return i {
	margin-right: 5px
}

.sign .icheckbox_square-green {
	display: inline-block;
	*display: inline;
	vertical-align: middle;
	margin: 0;
	padding: 0;
	width: 18px;
	height: 18px;
	background: url(/static/image/green.png) no-repeat;
	border: none;
	cursor: pointer;
	background-position: 0 0
}

.sign .icheckbox_square-green.hover {
	background-position: -20px 0
}

.sign .icheckbox_square-green.checked {
	background-position: -40px 0
}

.sign .icheckbox_square-green.disabled {
	background-position: -60px 0;
	cursor: default
}

.sign .icheckbox_square-green.checked.disabled {
	background-position: -80px 0
}


.geetest_panel_box>* {
	box-sizing: content-box
}

@media (max-width:768px) {
	body {
		min-width: 0
	}

	.sign {
		height: auto;
		min-height: 0;
		background-color: transparent
	}

	.sign .logo {
		display: none
	}

	.sign .main {
		position: absolute;
		left: 50%;
		margin: 0 0 0 -200px;
		box-shadow: none
	}
}
</style>

```



前端注册路由:

```javascript
import Register from "../components/Register"

// 配置路由列表
export default new Router({
  mode:"history",
  routes:[
    // 路由列表
	...
    {
      name:"Register",
      path: "/register",
      component:Register,
    }
  ]
})

```

修改首页头部的连接:

```html
# Header.vue
<span class="header-register"><router-link to="/register">注册</router-link></span>
#Login.vue
<p class="go_login" >没有账号 <router-link to="/register">立即注册</router-link></p>
```





## 注册功能的实现

### 实现基本的账号信息注册

模型中确认是否已经新增了昵称[nickname]字段，没有的话，则在模型中新增字段。模型代码：

```python
from django.db import models
from django.contrib.auth.models import AbstractUser
# Create your models here.
# AbstractUser 是django内部的auth模块里面声明的抽象模型，
# 抽象模型，是django内部用于提供给开发者声明模型父类的工具类，这种模型类，
# 在数据迁移的时候django不会为他们单独建表，所以这种模型的作用就是用于声明公共字段的
# 怎么声明一个django的抽象模型类？
"""
class 模型类(models.Model):
    字段列表
    字段列表
    class Meta:
        abstract = True # 表示当前模型是抽象模型
"""
class User(AbstractUser):
    nickname = models.CharField(max_length=20, null=True, verbose_name="用户昵称")
    mobile = models.CharField(max_length=15, unique=True, verbose_name="手机号")
    avatar = models.ImageField(upload_to="avatar", null=True, verbose_name="头像")
    wxchat = models.CharField(max_length=100, null=True, unique=True, verbose_name="微信账号")
    alipay = models.CharField(max_length=100, null=True, unique=True, verbose_name="支付宝账号")
    qq_number = models.CharField(max_length=11, null=True, unique=True, verbose_name="QQ号")

    class Meta:
        # 自定义表名
        db_table = "rr_users"
        verbose_name = "用户信息"
        verbose_name_plural = verbose_name

    def __str__(self):
        return self.nickname if self.nickname else self.username
```

数据迁移

```bash
# cd ~/Deskstop/renran/renranapi
python manage.py makemigrations
python manage.py migrate
```



视图代码:

```python
from rest_framework.generics import CreateAPIView
from .models import User
from .serializers import UserModelSerializer
class UserAPIView(CreateAPIView):
    """用户信息"""
    queryset = User.objects.all()
    serializer_class = UserModelSerializer
```

序列化器中,验证和保存数据,并返回jwt登录认证

```python
from rest_framework import serializers
from .models import User
import re
class UserModelSerializer(serializers.ModelSerializer):
    """用户信息的序列化器"""
    # 验证字段
    sms_code = serializers.CharField(max_length=6,min_length=4, required=True, write_only=True, help_text="短信验证码",label="短信验证码")
    token    = serializers.CharField(max_length=1000, read_only=True, label="jwt登录令牌")
    # 模型信息
    class Meta:
        model = User
        fields = ["id","username","mobile","password","nickname","sms_code","token"]
        extra_kwargs = {
            "nickname":{"required": True,},
            "password":{"write_only":True,"min_length": 6, "max_length": 16,},
            "mobile":{"write_only":True},
            "username":{"read_only":True},
        }
    # 验证数据方法
    def validate(self, attrs):
        # 验证手机号格式
        mobile = attrs.get("mobile")
        if not re.match("^1[3-9]\d{9}$",mobile):
            raise serializers.ValidationError("手机号码格式不正确！")

        # todo 验证短信验证码

        # 验证码校验通过以后，删除验证码
        attrs.pop("sms_code")
        return attrs

    # 模型更新和添加操作
    def create(self, validated_data):
        """用户注册"""
        # 添加用户
        try:
            user = User.objects.create_user(
                username=validated_data.get("mobile"),
                mobile  =validated_data.get("mobile"),
                nickname=validated_data.get("nickname"),
            )
        except:
            raise serializers.ValidationError("用户注册失败！")

        # 密码要加密
        user.set_password(validated_data.get("password"))
        user.save()

        # 返回jwt登录状态
        from rest_framework_jwt.settings import api_settings

        jwt_payload_handler = api_settings.JWT_PAYLOAD_HANDLER
        jwt_encode_handler = api_settings.JWT_ENCODE_HANDLER

        payload = jwt_payload_handler(user)
        user.token = jwt_encode_handler(payload)

        return user
```

路由,代码:

```python
from django.urls import path
from rest_framework_jwt.views import obtain_jwt_token
from . import views
urlpatterns = [
    path("login/", obtain_jwt_token),
    path("captcha/", views.CaptchaAPIView.as_view() ),
    path("", views.UserAPIView.as_view() ),
]
```



#### 客户端提交注册信息

register.vue,代码:

```vue
<template>
<div class="sign">
    <div class="logo"><router-link to="/"><img src="/static/image/nav-logo.png" alt="Logo"></router-link></div>
    <div class="main">
      <h4 class="title">
        <div class="normal-title">
          <router-link to="/login">登录</router-link>
          <b>·</b>
          <router-link id="js-sign-up-btn" class="active" to="/register">注册</router-link>
        </div>
      </h4>

      <div class="js-sign-up-container">
        <form class="new_user" id="new_user" action="" accept-charset="UTF-8" method="post">
          <div class="input-prepend restyle">
              <input placeholder="你的昵称" type="text" value="" v-model="nickname" id="user_nickname">
            <i class="iconfont ic-user"></i>
          </div>
            <div class="input-prepend restyle no-radius js-normal">
                <input placeholder="手机号" type="tel" v-model="mobile" id="user_mobile_number">
              <i class="iconfont ic-phonenumber"></i>
            </div>
          <div class="input-prepend restyle no-radius security-up-code js-security-number" v-if="is_show_sms_code">
              <input type="text" v-model="sms_code" id="sms_code" placeholder="手机验证码">
            <i class="iconfont ic-verify"></i>
            <a tabindex="-1" class="btn-up-resend js-send-code-button disable" href="javascript:void(0);" id="send_code">{{sms_code_text}}</a>
          </div>
          <input type="hidden" name="security_number" id="security_number">
          <div class="input-prepend">
            <input placeholder="设置密码" type="password" v-model="password" id="user_password">
            <i class="iconfont ic-password"></i>
          </div>
          <input type="submit" name="commit" value="注册" class="sign-up-button" id="sign_up_btn" @click.prevent="show_captcha">
          <p class="sign-up-msg">点击 “注册” 即表示您同意并愿意遵守荏苒<br> <a target="_blank" href="">用户协议</a> 和 <a target="_blank" href="">隐私政策</a> 。</p>
        </form>
        <!-- 更多注册方式 -->
        <div class="more-sign">
          <h6>社交帐号直接注册</h6>
            <ul>
            <li><a id="weixin" class="weixin" target="_blank" href=""><i class="iconfont ic-wechat"></i></a></li>
            <li><a id="qq" class="qq" target="_blank" href=""><i class="iconfont ic-qq_connect"></i></a></li>
          </ul>

        </div>
      </div>

    </div>
  </div>
</template>

<script>
    export default {
        name: "Register",
        data(){
          return {
            nickname:"",
            mobile:"",
            sms_code:"",
            password:"",
            sms_code_text:"发送验证码",
            is_show_sms_code:false, // 控制是否显示短信验证码输入框
          }
        },
        watch:{
          mobile(){
            if(/^1[3-9]\d{9}$/.test(this.mobile)){
              this.is_show_sms_code = true;
            }else{
              this.is_show_sms_code = false;
            }
          }
        },
        methods:{
            show_captcha(){
                // 显示验证码

                // 判断手机号或者密码是否为空！
                if(this.mobile.length<1 || this.password.length<1){
                    // 阻止代码继续往下执行
                    this.$message.error("手机号码或密码不能为空！");
                    return false;
                }

                if(this.nickname.length<1 || this.sms_code.length<1){
                    // 阻止代码继续往下执行
                    this.$message.error("昵称或短信验证码不能为空！");
                    return false;
                }

                var captcha1 = new TencentCaptcha(this.$settings.TC_captcha.app_id, res=>{
                    // 用户操作验证码成功以后的回调函数，这个函数将会在对象创建以后，在页面那种进行监听用户的操作
                    // res就是用户操作成功以后，验证码服务器返回的内容
                    /**
                   res:
                    appid: "2086888489"  # 验证码的APPID
                    randstr: "@G0V"      # 随机字符串，防止重复
                    ret: 0               # 0表示用户操作成功，2表示用户主动关闭验证码窗口
                    ticket: ""           # 验证通过以后的票据，提供给python后端，将来到验证码服务器中进行
                    */
                    this.$axios.get(`${this.$settings.Host}/users/captcha/`,{
                        params:{
                          ticket: res.ticket,
                          randstr: res.randstr
                        }
                    }).then(response=>{
                        if(response.data.detail){
                            // 继续进行注册处理
                            this.registerhandler();
                        }
                    }).catch(error=>{
                        this.$message.error("对不起，验证码校验不通过！");
                    });
                });
                captcha1.show(); // 显示验证码
            },
            registerhandler(){
                // 注册处理
                this.$axios.post(`${this.$settings.Host}/users/`,{
                    nickname: this.nickname,
                    mobile: this.mobile,
                    sms_code: this.sms_code,
                    password: this.password,
                }).then(response=>{
                    // 注册成功，默认已经登录，所以我们这里临时保存登录状态
                    sessionStorage.user_token = response.data.token;
                    sessionStorage.user_id = response.data.id;
                    sessionStorage.user_name = response.data.username;
                    sessionStorage.user_avatar = null;
                    localStorage.removeItem("user_token");
                    localStorage.removeItem("user_id");
                    localStorage.removeItem("user_name");
                    localStorage.removeItem("user_avatar");

                    // 页面跳转
                    this.$confirm('是否跳转到个人中心', '注册成功', {
                      confirmButtonText: '个人中心',
                      cancelButtonText: '返回首页',
                      type: 'success'
                    }).then(() => {
                      // 前往个人中心
                      this.$router.push("/users");
                    }).catch(() => {
                      // 返回站点首页
                      this.$router.push("/");
                    });

                }).catch(error=>{
                    // 注册失败！
                    this.$message.error("注册用户失败！");
                })
            }
        }
    }
</script>
```



## 在注册功能中集成短信验证码功能

接下来，我们把注册过程中一些注册信息（例如：短信验证码）和session缓存到redis数据库中。

安装django-redis。

```python
pip install django-redis
```

在settings/dev.py配置中添加一下代码：

```python
# 设置redis缓存
CACHES = {
    # 默认缓存
    "default": {
        "BACKEND": "django_redis.cache.RedisCache",
        # 项目上线时,需要调整这里的路径
        "LOCATION": "redis://127.0.0.1:6379/0",

        "OPTIONS": {
            "CLIENT_CLASS": "django_redis.client.DefaultClient",
        }
    },
    # 提供给xadmin或者admin的session存储
    "session": {
        "BACKEND": "django_redis.cache.RedisCache",
        "LOCATION": "redis://127.0.0.1:6379/1",
        "OPTIONS": {
            "CLIENT_CLASS": "django_redis.client.DefaultClient",
        }
    },
    # 提供存储短信验证码
    "sms_code":{
        "BACKEND": "django_redis.cache.RedisCache",
        "LOCATION": "redis://127.0.0.1:6379/2",
        "OPTIONS": {
            "CLIENT_CLASS": "django_redis.client.DefaultClient",
        }
    }
}

# 设置xadmin用户登录时,登录信息session保存到redis
SESSION_ENGINE = "django.contrib.sessions.backends.cache"
SESSION_CACHE_ALIAS = "session"
```

**关于django-redis 的使用，说明文档可见http://django-redis-chs.readthedocs.io/zh_CN/latest/**

**django-redis提供了get_redis_connection的方法，通过调用get_redis_connection方法传递redis的配置名称可获取到redis的连接对象，通过redis连接对象可以执行redis命令**

<https://redis-py.readthedocs.io/en/latest/>

使用范例：

```python
from django_redis import get_redis_connection
// 链接redis数据库
redis_conn = get_redis_connection("default")
```





### 使用云通讯发送短信

官网：`https://www.yuntongxun.com`

在登录后的平台上面获取一下信息:

```
ACCOUNT SID：8a216da863f8e6c20164139687e80c1b
AUTH TOKEN : 6dd01b2b60104b3dbc88b2b74158bac6
AppID(默认)：8a216da863f8e6c20164139688400c21
Rest URL(生产)： app.cloopen.com:8883         [短信发送服务器]
```

找到sdkdemo进行安装配置

![1553677987640](4%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C.assets/1553677987640.png)



在开发过程中,为了节约发送短信的成本,可以把自己的或者同事的手机加入到测试号码中.

![1553678528811](4%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C.assets/1553678528811.png)

安装云通讯模块到虚拟环境中

github地址：https://github.com/cloopen/python-sms-sdk

```bash
pip install ronglian_sms_sdk
```



### 后端生成短信验证码

settings/dev.py，配置代码：

```python
# 短信配置
SMS = {
    # 容联云通讯分配的主账号ID
    "accId": '8a216da863f8e6c20164139687e80c1b',
    # 容联云通讯分配的主账号TOKEN
    "accToken": '6dd01b2b60104b3dbc88b2b74158bac6',
    # 容联云通讯分配的应用ID
    "appId": '8a216da863f8e6c20164139688400c21',
    # 容联云通讯创建的模板,1表示使用测试模板
    "tid":1
}

```

settings/constants.py，新建常量文件，保存开发中一些具有特俗作用的数值或者数据，代码：

```python
# 常量配置文件
# 这里的所有信息,线上线下都一样
# 短信有效期[单位: s]
SMS_EXPIRE_TIME = 10 * 60
# 短信发送间隔[单位: s]
SMS_INTERVAL_TIME = 60
```



users/views.py，视图代码：

```python
import random,json
from django_redis import get_redis_connection
from ronglian_sms_sdk import SmsSDK
import logging
logger = logging.getLogger("django")
from django.conf import settings
from renranapi.settings import constants
class SMSAPIView(APIView):
    """
    短信api接口
    /users/sms/(?P<mobile>1[3-9]\d{9})/
    """
    def get(self,request,mobile):
        """发送短信"""
        redis_conn = get_redis_connection("sms_code")
        # 1. 限制用户60s内只能发送一条短信[基于redis中的字符串有效期来完成]
        ret = redis_conn.get("interval_%s" % mobile)
        if ret is not None:
            # 如果ret有值,则表示60s内用户曾经发送短信,不能让用户频繁发送
            return Response({"detail":"对不起, 发送短信过于频繁!"})

        # 2. 生成6位随机验证码
        sms_code = "%06d" % ( random.randint(1,999999) )

        # 3. 保存验证码和手机到redis中
        redis_conn.setex("sms_%s" % mobile, constants.SMS_EXPIRE_TIME, sms_code)
        redis_conn.setex("interval_%s" % mobile, constants.SMS_INTERVAL_TIME, "_")

        # 发送短信
        # 实例化短信接口SDK对象
        sdk = SmsSDK(settings.SMS["accId"], settings.SMS["accToken"], settings.SMS["appId"])
        # 短信模板中的数据: 测试模板格式: 云通讯】您的验证码是{1}，请于{2}分钟内正确输入。
        datas = (sms_code, constants.SMS_EXPIRE_TIME//60)
        resp = sdk.sendMessage(settings.SMS["tid"], mobile, datas)
        resp = json.loads(resp)
        if resp.get("statusCode") != "000000":
            # 记录错误信息
            logger.error("发送短信失败!手机号:%s" % mobile)

        # 返回响应信息
        return Response({"detail":"短信已发送!请留意您的手机短信!"})
```

redis操作如果是同时进行多条语句的写操作[ 添加/设置/修改/删除]，则可以使用redis中提供的事务操作[管道命令]来保存多条命令操作的原子性

users/views.py，代码：

```python
import random,json
from django_redis import get_redis_connection
from ronglian_sms_sdk import SmsSDK
import logging
logger = logging.getLogger("django")
from django.conf import settings
from renranapi.settings import constants
class SMSAPIView(APIView):
    """
    短信api接口
    /users/sms/(?P<mobile>1[3-9]\d{9})/
    """
    def get(self,request,mobile):
        """发送短信"""
        redis_conn = get_redis_connection("sms_code")
        # 1. 限制用户60s内只能发送一条短信[基于redis中的字符串有效期来完成]
        ret = redis_conn.get("interval_%s" % mobile)
        if ret is not None:
            # 如果ret有值,则表示60s内用户曾经发送短信,不能让用户频繁发送
            return Response({"detail":"对不起, 发送短信过于频繁!"})

        # 2. 生成6位随机验证码
        sms_code = "%06d" % ( random.randint(1,999999) )

        # 3. 保存验证码和手机到redis中
        # 3.1 初始化管道对象
        pipe = redis_conn.pipeline()
        # 3.2 开启事务
        pipe.multi()
        # 3.3 添加本次事务相关的命令到管道对象中,注意,管道中的命令不会被自动执行
        pipe.setex("sms_%s" % mobile, constants.SMS_EXPIRE_TIME, sms_code)
        pipe.setex("interval_%s" % mobile, constants.SMS_INTERVAL_TIME, "_")
        # 3.4 执行管道中所有命令,也就是事务提交
        pipe.execute() # 上面所有的命令都被一次性执行,要么一起成功,要么一起失败!

        # 发送短信
        # 实例化短信接口SDK对象
        sdk = SmsSDK(settings.SMS["accId"], settings.SMS["accToken"], settings.SMS["appId"])
        # 短信模板中的数据: 测试模板格式: 云通讯】您的验证码是{1}，请于{2}分钟内正确输入。
        datas = (sms_code, constants.SMS_EXPIRE_TIME//60)
        resp = sdk.sendMessage(settings.SMS["tid"], mobile, datas)
        resp = json.loads(resp)
        if resp.get("statusCode") != "000000":
            # 记录错误信息
            logger.error("发送短信失败!手机号:%s" % mobile)

        # 返回响应信息
        return Response({"detail":"短信已发送!请留意您的手机短信!"})
```



客户端发送注册信息和发送短信

```vue
<template>
<div class="sign">
    <div class="logo"><router-link to="/"><img src="/static/image/nav-logo.png" alt="Logo"></router-link></div>
    <div class="main">
      <h4 class="title">
        <div class="normal-title">
          <router-link to="/login">登录</router-link>
          <b>·</b>
          <router-link id="js-sign-up-btn" class="active" to="/register">注册</router-link>
        </div>
      </h4>

      <div class="js-sign-up-container">
        <form class="new_user" id="new_user" action="" accept-charset="UTF-8" method="post">
          <div class="input-prepend restyle">
              <input placeholder="你的昵称" type="text" value="" v-model="nickname" id="user_nickname">
            <i class="iconfont ic-user"></i>
          </div>
            <div class="input-prepend restyle no-radius js-normal">
                <input placeholder="手机号" type="tel" v-model="mobile" id="user_mobile_number">
              <i class="iconfont ic-phonenumber"></i>
            </div>
          <div class="input-prepend restyle no-radius security-up-code js-security-number" v-if="is_show_sms_code">
              <input type="text" v-model="sms_code" id="sms_code" placeholder="手机验证码">
            <i class="iconfont ic-verify"></i>
            <a tabindex="-1" class="btn-up-resend js-send-code-button" href="javascript:void(0);" id="send_code" @click.stop.prevent="send_sms">{{sms_code_text}}</a>
          </div>
          <input type="hidden" name="security_number" id="security_number">
          <div class="input-prepend">
            <input placeholder="设置密码" type="password" v-model="password" id="user_password">
            <i class="iconfont ic-password"></i>
          </div>
          <input type="submit" name="commit" value="注册" class="sign-up-button" id="sign_up_btn" @click.prevent="show_captcha">
          <p class="sign-up-msg">点击 “注册” 即表示您同意并愿意遵守荏苒<br> <a target="_blank" href="">用户协议</a> 和 <a target="_blank" href="">隐私政策</a> 。</p>
        </form>
        <!-- 更多注册方式 -->
        <div class="more-sign">
          <h6>社交帐号直接注册</h6>
            <ul>
            <li><a id="weixin" class="weixin" target="_blank" href=""><i class="iconfont ic-wechat"></i></a></li>
            <li><a id="qq" class="qq" target="_blank" href=""><i class="iconfont ic-qq_connect"></i></a></li>
          </ul>

        </div>
      </div>

    </div>
  </div>
</template>

<script>
    export default {
        name: "Register",
        data(){
          return {
            nickname:"",
            mobile:"",
            sms_code:"",
            password:"",
            sms_code_text:"发送验证码",
            is_show_sms_code:false, // 控制是否显示短信验证码输入框
          }
        },
        watch:{
          mobile(){
            if(/^1[3-9]\d{9}$/.test(this.mobile)){
              this.is_show_sms_code = true;
            }else{
              this.is_show_sms_code = false;
            }
          }
        },
        methods:{
            show_captcha(){
                // 显示验证码

                // 判断手机号或者密码是否为空！
                if(this.mobile.length<1 || this.password.length<1){
                    // 阻止代码继续往下执行
                    this.$message.error("手机号码或密码不能为空！");
                    return false;
                }

                if(this.nickname.length<1 || this.sms_code.length<1){
                    // 阻止代码继续往下执行
                    this.$message.error("昵称或短信验证码不能为空！");
                    return false;
                }

                var captcha1 = new TencentCaptcha(this.$settings.TC_captcha.app_id, res=>{
                    // 用户操作验证码成功以后的回调函数，这个函数将会在对象创建以后，在页面那种进行监听用户的操作
                    // res就是用户操作成功以后，验证码服务器返回的内容
                    /**
                   res:
                    appid: "2086888489"  # 验证码的APPID
                    randstr: "@G0V"      # 随机字符串，防止重复
                    ret: 0               # 0表示用户操作成功，2表示用户主动关闭验证码窗口
                    ticket: ""           # 验证通过以后的票据，提供给python后端，将来到验证码服务器中进行
                    */
                    this.$axios.get(`${this.$settings.Host}/users/captcha/`,{
                        params:{
                          ticket: res.ticket,
                          randstr: res.randstr
                        }
                    }).then(response=>{
                        if(response.data.detail){
                            // 继续进行注册处理
                            this.registerhandler();
                        }
                    }).catch(error=>{
                        this.$message.error("对不起，验证码校验不通过！");
                    });
                });
                captcha1.show(); // 显示验证码
            },
            registerhandler(){
                // 注册处理
                this.$axios.post(`${this.$settings.Host}/users/`,{
                    nickname: this.nickname,
                    mobile: this.mobile,
                    sms_code: this.sms_code,
                    password: this.password,
                }).then(response=>{
                    // 注册成功，默认已经登录，所以我们这里临时保存登录状态
                    sessionStorage.user_token = response.data.token;
                    sessionStorage.user_id = response.data.id;
                    sessionStorage.user_name = response.data.username;
                    sessionStorage.user_avatar = null;
                    localStorage.removeItem("user_token");
                    localStorage.removeItem("user_id");
                    localStorage.removeItem("user_name");
                    localStorage.removeItem("user_avatar");

                    // 页面跳转
                    this.$confirm('是否跳转到个人中心', '注册成功', {
                      confirmButtonText: '个人中心',
                      cancelButtonText: '返回首页',
                      type: 'success'
                    }).then(() => {
                      // 前往个人中心
                      this.$router.push("/users");
                    }).catch(() => {
                      // 返回站点首页
                      this.$router.push("/");
                    });

                }).catch(error=>{
                    // 注册失败！
                    this.$message.error("注册用户失败！");
                })
            },
            send_sms(){
                // 发送短信
                if(this.mobile.length<1){
                    this.$message.error("对不起,手机号码不能为空!");
                    return false;
                }

                this.$axios.get(`${this.$settings.Host}/users/sms/${this.mobile}/`).then(response=>{
                    this.$message.info(response.data.detail);
                }).catch(error=>{
                    this.$message.error("短信发送错误!请联系客服工作人员!");
                });
            }
        }
    }
</script>
```



服务端用户的注册api接口中在序列化器里面完成手机短信的校验

users/serializers.py，代码：

```python
from rest_framework import serializers
from django_redis import get_redis_connection
from .models import User
import re
class UserModelSerializer(serializers.ModelSerializer):
    """用户信息的序列化器"""
    # 验证字段
    sms_code = serializers.CharField(max_length=6,min_length=4, required=True, write_only=True, help_text="短信验证码",label="短信验证码")
    token    = serializers.CharField(max_length=1000, read_only=True, label="jwt登录令牌")
    # 模型信息
    class Meta:
        model = User
        fields = ["id","username","mobile","password","nickname","sms_code","token"]
        extra_kwargs = {
            "nickname":{"required": True,},
            "password":{"write_only":True,"min_length": 6, "max_length": 16,},
            "mobile":{"write_only":True},
            "username":{"read_only":True},
        }
    # 验证数据方法
    def validate(self, attrs):
        # 验证手机号格式
        mobile = attrs.get("mobile")
        if not re.match("^1[3-9]\d{9}$",mobile):
            raise serializers.ValidationError("手机号码格式不正确！")

        # 验证短信验证码
        client_sms_code = attrs.get("sms_code")
        redis_conn = get_redis_connection("sms_code")
        server_sms_code_bytes = redis_conn.get("sms_%s" % mobile)
        if server_sms_code_bytes is None:
            raise serializers.ValidationError("短信验证码已过期!")

        server_sms_code = server_sms_code_bytes.decode()
        if server_sms_code != client_sms_code:
            raise serializers.ValidationError("短信验证码错误!请重新确认!")
        else:
            # 验证通过以后,redis中的验证码就没有必要保留了
            redis_conn.delete("sms_%s" % mobile)

        # 验证码校验通过以后，不需要保存验证码到数据库中, 所以删除验证码
        attrs.pop("sms_code")
        return attrs

    # 模型更新和添加操作
    def create(self, validated_data):
        """用户注册"""
        # 添加用户
        try:
            user = User.objects.create_user(
                username=validated_data.get("mobile"),
                mobile  =validated_data.get("mobile"),
                nickname=validated_data.get("nickname"),
            )
        except:
            raise serializers.ValidationError("用户注册失败！")

        # 密码要加密
        user.set_password(validated_data.get("password"))
        user.save()

        # 返回jwt登录状态
        from rest_framework_jwt.settings import api_settings

        jwt_payload_handler = api_settings.JWT_PAYLOAD_HANDLER
        jwt_encode_handler = api_settings.JWT_ENCODE_HANDLER

        payload = jwt_payload_handler(user)
        user.token = jwt_encode_handler(payload)

        return user
```

## 作业：手机号的唯一校验

>   用户注册表单中，用户输入正确的手机号以后，发送ajax到服务端查询当前手机是否已经被注册。
>
>   针对项目中一些简单的功能，如果单个视图编写更方便，则不需要使用序列化器参与进来。
>
>   编程不是什么奥数，不需要过于复杂，简单直接为主。

视图代码：

```python
from .models import User
class MobileAPIView(APIView):
    def get(self,request,mobile):
        try:
            User.objects.get(mobile=mobile)
            return Response({"detail":"当前手机号码已经被注册"}, status=status.HTTP_400_BAD_REQUEST)
        except User.DoesNotExist:
            return Response({"detail":"ok"})
```

路由代码：

```python
    re_path("mobile/(?P<mobile>1[3-9]\d{9})/", views.MobileAPIView.as_view() ),
```

客户端发送ajax，代码：`

```javascript
    export default {
        name: "Register",
        data(){
          return {
            nickname:"",
            mobile:"",
            sms_code:"",
            password:"",
            sms_code_text:"发送验证码",
            is_show_sms_code:false, // 控制是否显示短信验证码输入框
          }
        },
        watch:{
          mobile(){
            if(/^1[3-9]\d{9}$/.test(this.mobile)){
              // 发送ajax请求到服务器验证手机号是否已经注册了
              this.check_mobile();
            }else{
              this.is_show_sms_code = false;
            }
          }
        },
        methods:{
            check_mobile(){
                // 验证手机是否已经被注册了
                this.$axios.get(`${this.$settings.Host}/users/mobile/${this.mobile}/`).then(response=>{
                    console.log(response.data);
                    this.is_show_sms_code = true;  // 显示短信验证码框
                }).catch(error=>{
                    this.$message.error("对不起,手机号码已经被注册了!");
                    this.is_show_sms_code = false; // 关闭短信验证码框
                })
            },
		//	....
        }
    }
```



## 使用Celery异步发送短信

延时，耗时，定时的功能，可以交给celery进行异步执行，减少阻赛的出现。

安装

```bash
pip install -U celery==4.3.0
```

创建Celery相关目录

```bash
renranapi/
├── mycelery/
    ├── config.py     # 配置文件
    ├── __init__.py   
    ├── main.py       # 主程序
    └── sms/          # 一个目录可以放置多个任务,该目录下存放当前任务执行时需要的模块或依赖
        └── tasks.py  # 任务的文件，名称必须是这个!!!
```

创建Celery配置文件config.py

```python
# 任务队列的链接地址
broker_url = 'redis://127.0.0.1:6379/15'
# 结果队列的链接地址
result_backend = 'redis://127.0.0.1:6379/14'
```



在main.py主程序中对django的配置文件进行加载，把django和celery进行组合

```python
# 主程序
import os
from celery import Celery
# 创建celery实例对象
app = Celery("renran")

# 把celery和django进行组合，必须让celery能识别和加载django的配置文件以及django的类库
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'renranapi.settings.dev')

# 对django框架执行初始化
import django
django.setup()

# 通过app对象加载配置
app.config_from_object("mycelery.config")

# 加载任务
# 参数必须必须是一个列表，里面的每一个任务都是任务的路径名称
# app.autodiscover_tasks(["任务1","任务2"])
app.autodiscover_tasks(["mycelery.sms"])

# 启动Celery的命令
# 切换目录到mycelery上一级目录下启动
# celery -A mycelery.main worker --loglevel=info
```

在需要使用django配置的任务中，直接加载配置，所以我们把注册的短信发送功能，整合成一个任务函数，代码：

```python
from mycelery.main import app
from celery.task import Task

# 监听整个任务的钩子
class Mytask(Task):
    def on_success(self, retval, task_id, args, kwargs):
        print('task success 11111')
        return super(Mytask, self).on_success(retval, task_id, args, kwargs)

    def on_failure(self, exc, task_id, args, kwargs, einfo):
        print('task failed')
        # 可以记录到程序中或者任务队列中,让celery尝试重新执行
        return super(Mytask, self).on_failure(exc, task_id, args, kwargs, einfo)

    def after_return(self, status, retval, task_id, args, kwargs, einfo):
        print('this is after return')
        return super(Mytask, self).after_return(status, retval, task_id, args, kwargs, einfo)

    def on_retry(self, exc, task_id, args, kwargs, einfo):
        print('this is retry')
        return super(Mytask,self).on_retry(exc, task_id, args, kwargs, einfo)

from ronglian_sms_sdk import SmsSDK
from django.conf import settings
from renranapi.settings import constants
import json
import logging
logger = logging.getLogger("django")

@app.task(name="send_sms",base=Mytask)
def send_sms(mobile,sms_code):
    """发送短信验证码"""
    # 实例化短信接口SDK对象
    try:
        sdk = SmsSDK(settings.SMS["accId"], settings.SMS["accToken"], settings.SMS["appId"])
        # 短信模板中的数据: 测试模板格式: 云通讯】您的验证码是{1}，请于{2}分钟内正确输入。
        datas = (sms_code, constants.SMS_EXPIRE_TIME//60)
        resp = sdk.sendMessage(settings.SMS["tid"], mobile, datas)
        resp = json.loads(resp)
        if resp.get("statusCode") != "000000":
            # 记录错误信息
            logger.error("发送短信失败!手机号:%s" % mobile)
            raise Exception("发送短信失败!")
        else:
            return {"detail":"发送短信成功"}
    except:
        raise Exception("发送短信失败!")
```



最终在django里面，我们调用Celery来异步执行任务。需要完成2个步骤：

```python
# 1. 声明一个和celery一模一样的任务函数，但是我们可以导包来解决
from mycelery.sms.tasks import send_sms

# 2. 调用任务函数，发布任务
send_sms.delay(mobile,sms_code)
# send_sms.delay() 如果调用的任务函数没有参数，则不需要填写任何内容
```



## 找回密码（忘记密码）

#### 业务流程实现

1. vue客户端提供找回密码的页面，供用户输入当前帐号绑定的邮箱地址

   ![1578376915741](4%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C.assets/1578376915741.png)

2. 在用户点击<mark>发送邮件</mark>以后，ajax请求api服务端发送邮件到指定邮箱，并指定邮件内容为链接地址(链接中附带访问票据参数)，点击链接地址跳转到荏苒网的修改密码页面，新页面提供修改密码的表单。

   ![1578377078522](4%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C.assets/1578377078522.png)

3. 提供用户修改密码的服务端接口。



#### 代码实现

模仿登录页面, 创建找回密码的页面,并ajax发送邮箱地址到服务端,通知服务端发送邮件

```vue
<template>
    <div class="sign">
    <div class="logo"><a href="/"><img src="/static/image/nav-logo.png" alt="Logo"></a></div>
    <div class="main">


<h4 class="reset-title">用邮箱重置密码</h4>
<div class="js-sign-in-container">
  <form id="new_session" action="" method="post">
      <div class="input-prepend restyle js-normal">
        <input placeholder="请输入注册或绑定的邮箱" type="text" v-model="email">
        <i class="iconfont ic-email"></i>
      </div>
      <button class="sign-in-button" type="button" @click.prevent="show_captcha">
        <span id="sign-in-loading"></span>发送邮件
      </button>
  </form>
</div>

    </div>
  </div>
</template>

<script>
    import "../../static/js/TCaptcha";
    export default {
        name: "FindPassword",
        data(){
          return {
             email:"",
             password:"",
          }
        },
        methods:{
          send_email(){
            if(!/^\w+@\w+\.\w+$/.test(this.email)){
              this.$message.error("邮箱地址格式有误！");
              return false;
            }

            this.$axios.get(this.$settings.Host+"/users/find/password/",
              {
                params:{
                  email: this.email,
                }
              }).then(response=>{
                  this.$message.success(response.data);
              }).catch(error=>{
                  this.$message.error("发送邮件失败！");

              })
          },
          show_captcha(){
            // 判断手机号或者密码是否为空！
            if(this.email.length<1){
              return false; // 阻止代码继续往下执行
            }

            // 验证码
            let self = this;
            // 生成一个验证码对象
            var captcha1 = new TencentCaptcha(this.$settings.TC_captcha.app_id, function(res) {
              console.log(res);
              // res（未通过验证）= {ret: 1, ticket: null}

              // ticket	验证成功的票据，当且仅当ret=0时ticket有值
              // res（验证成功） = {ret: 0, ticket: "String", randstr: "String"}
              if (res.ret === 0) {
                // 随机码
                // api服务端校验验证码的结果
                self.$axios.get(`${self.$settings.Host}/users/captcha/`,{
                  params:{
                    ticket: res.ticket,
                    randstr: res.randstr,
                  }
                }).then(response=>{
                  // 进行登录处理
                  self.send_email();
                }).catch(error=>{
                  self.$message.error("验证码校验错误！");
                })
              }
            });

            // 显示验证码
            captcha1.show();
          }
        },
    }
</script>

<style scoped>
input{
  outline: none;
}
*, :after, :before {
    box-sizing: border-box;
}
.sign {
	height: 100%;
	min-height: 750px;
	text-align: center;
	font-size: 14px;
	background-color: #f1f1f1
}

.sign:before {
	content: "";
	display: inline-block;
	height: 85%;
	vertical-align: middle
}

.sign .disable,.sign .disable-gray {
	opacity: .5;
	pointer-events: none
}

.sign .disable-gray {
	background-color: #969696
}

.sign .tooltip-error {
	font-size: 14px;
	line-height: 25px;
	white-space: nowrap;
	background: none
}

.sign .tooltip-error .tooltip-inner {
	max-width: 280px;
	color: #333;
	border: 1px solid #ea6f5a;
	background-color: #fff
}

.sign .tooltip-error .tooltip-inner i {
	position: static;
	margin-right: 5px;
	font-size: 20px;
	color: #ea6f5a;
	vertical-align: middle
}

.sign .tooltip-error .tooltip-inner span {
	vertical-align: middle;
	display: inline-block;
	white-space: normal;
	max-width: 230px
}

.sign .tooltip-error.right .tooltip-arrow-border {
	border-right-color: #ea6f5a
}

.sign .tooltip-error.right .tooltip-arrow-bg {
	left: 2px;
	border-right-color: #fff
}

.sign .slide-error {
	position: relative;
	padding: 10px 0;
	border: 1px solid #c8c8c8;
	border-radius: 4px
}

.sign .slide-error i {
	position: static!important;
	margin-right: 10px;
	color: #ea6f5a!important;
	vertical-align: middle
}

.sign .slide-error span {
	font-size: 15px;
	vertical-align: middle
}

.sign .slide-error div {
	margin-top: 10px;
	font-size: 13px
}

.sign .slide-error a {
	color: #3194d0
}

.sign .js-sign-up-forbidden {
	color: #999;
	padding: 80px 0 100px
}

.sign .js-sign-up-container .slide-error {
	border-bottom: none;
	border-radius: 0
}

.sign .logo {
	position: absolute;
	top: 56px;
	margin-left: 50px
}

.sign .logo img {
	width: 100px
}

.sign .main {
	width: 400px;
	margin: 60px auto 0;
	padding: 50px 50px 30px;
	background-color: #fff;
	border-radius: 4px;
	box-shadow: 0 0 8px rgba(0,0,0,.1);
	vertical-align: middle;
	display: inline-block
}

.sign .reset-title,.sign .title {
	margin: 0 auto 50px;
	padding: 10px;
	font-weight: 400;
	color: #969696
}

.sign .reset-title a,.sign .title a {
	padding: 10px;
	color: #969696
}

.sign .reset-title a:hover,.sign .title a:hover {
	border-bottom: 2px solid #ea6f5a
}

.sign .reset-title .active,.sign .title .active {
	font-weight: 700;
	color: #ea6f5a;
	border-bottom: 2px solid #ea6f5a
}

.sign .reset-title b,.sign .title b {
	padding: 10px
}

.sign .reset-title {
	color: #333;
	font-weight: 700
}

.sign form {
	margin-bottom: 30px
}

.sign form .input-prepend {
	position: relative;
	width: 100%
}

.sign form .input-prepend input {
	width: 100%;
	height: 50px;
	margin-bottom: 0;
	padding: 4px 12px 4px 35px;
	border: 1px solid #c8c8c8;
	border-radius: 0 0 4px 4px;
	background-color: hsla(0,0%,71%,.1);
	vertical-align: middle
}

.sign form .input-prepend i {
	position: absolute;
	top: 14px;
	left: 10px;
	font-size: 18px;
	color: #969696
}

.sign form .input-prepend span {
	color: #333
}

.sign form .input-prepend .ic-show {
	top: 18px;
	left: auto;
	right: 8px;
	font-size: 12px
}

.sign form .geetest-placeholder {
	height: 44px;
	border-radius: 4px;
	background-color: hsla(0,0%,71%,.1);
	text-align: center;
	line-height: 44px;
	font-size: 14px;
	color: #999
}

.sign form .restyle {
	margin-bottom: 0
}

.sign form .restyle input {
	border-bottom: none;
	border-radius: 4px 4px 0 0
}

.sign form .no-radius input {
	border-radius: 0
}

.sign form .slide-security-placeholder {
	height: 32px;
	background-color: hsla(0,0%,71%,.1);
	border-radius: 4px
}

.sign form .slide-security-placeholder p {
	padding-top: 7px;
	color: #999;
	margin-right: -7px
}

.sign .overseas-btn {
	font-size: 14px;
	color: #999
}

.sign .overseas-btn:hover {
	color: #2f2f2f
}

.sign .remember-btn {
	float: left;
	margin: 15px 0
}

.sign .remember-btn span {
	margin-left: 5px;
	font-size: 15px;
	color: #969696;
	vertical-align: middle
}

.sign .forget-btn {
	float: right;
	position: relative;
	margin: 15px 0;
	font-size: 14px
}

.sign .forget-btn a {
	color: #999
}

.sign .forget-btn a:hover {
	color: #333
}

.sign .forget-btn .dropdown-menu {
	top: 20px;
	left: auto;
	right: 0;
	border-radius: 4px
}

.sign .forget-btn .dropdown-menu a {
	padding: 10px 20px;
	color: #333
}

.sign #sign-in-loading {
	position: relative;
	width: 20px;
	height: 20px;
	vertical-align: middle;
	margin-top: -4px;
	margin-right: 2px;
	display: none
}

.sign #sign-in-loading:after {
	content: "";
	position: absolute;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	background-color: transparent
}

.sign #sign-in-loading:before {
	content: "";
	position: absolute;
	top: 50%;
	left: 50%;
	width: 20px;
	height: 20px;
	margin: -10px 0 0 -10px;
	border-radius: 10px;
	border: 2px solid #fff;
	border-bottom-color: transparent;
	vertical-align: middle;
	-webkit-animation: rolling .8s infinite linear;
	animation: rolling .8s infinite linear;
	z-index: 1
}

.sign .sign-in-button,.sign .sign-up-button {
	margin-top: 20px;
	width: 100%;
	padding: 9px 18px;
	font-size: 18px;
	border: none;
	border-radius: 25px;
	color: #fff;
	background: #42c02e;
	cursor: pointer;
	outline: none;
	display: block;
	clear: both
}

.sign .sign-in-button:hover,.sign .sign-up-button:hover {
	background: #3db922
}

.sign .sign-in-button {
	background: #3194d0
}

.sign .sign-in-button:hover {
	background: #187cb7
}

.sign .btn-in-resend,.sign .btn-up-resend {
	position: absolute;
	top: 7px;
	right: 7px;
	width: 100px;
	height: 36px;
	font-size: 13px;
	color: #fff;
	background-color: #42c02e;
	border-radius: 20px;
	line-height: 36px
}

.sign .btn-in-resend {
	background-color: #3194d0
}

.sign .sign-up-msg {
	margin: 10px 0;
	padding: 0;
	text-align: center;
	font-size: 12px;
	line-height: 20px;
	color: #969696
}

.sign .sign-up-msg a,.sign .sign-up-msg a:hover {
	color: #3194d0
}

.sign .overseas input {
	padding-left: 110px!important
}

.sign .overseas .overseas-number {
	position: absolute;
	top: 0;
	left: 0;
	width: 100px;
	height: 50px;
	font-size: 18px;
	color: #969696;
	border-right: 1px solid #c8c8c8
}

.sign .overseas .overseas-number span {
	margin-top: 17px;
	padding-left: 35px;
	text-align: left;
	font-size: 14px;
	display: block
}

.sign .overseas .dropdown-menu {
	width: 100%;
	max-height: 285px;
	font-size: 14px;
	border-radius: 0 0 4px 4px;
	overflow-y: auto
}

.sign .overseas .dropdown-menu li .nation-code {
	width: 65px;
	display: inline-block
}

.sign .overseas .dropdown-menu li a {
	padding: 6px 20px;
	font-size: 14px;
	line-height: 20px
}

.sign .overseas .dropdown-menu li a::hover {
	color: #fff;
	background-color: #f5f5f5
}

.sign .more-sign {
	margin-top: 50px
}

.sign .more-sign h6 {
	position: relative;
	margin: 0 0 10px;
	font-size: 12px;
	color: #b5b5b5
}

.sign .more-sign h6:before {
	left: 30px
}

.sign .more-sign h6:after,.sign .more-sign h6:before {
	content: "";
	border-top: 1px solid #b5b5b5;
	display: block;
	position: absolute;
	width: 60px;
	top: 5px
}

.sign .more-sign h6:after {
	right: 30px
}

.sign .more-sign ul {
	margin-bottom: 10px;
	list-style: none
}

.sign .more-sign ul li {
	margin: 0 5px;
	display: inline-block
}

.sign .more-sign ul a {
	width: 50px;
	height: 50px;
	line-height: 50px;
	display: block
}

.sign .more-sign ul i {
	font-size: 28px
}

.sign .more-sign .ic-weibo {
	color: #e05244
}

.sign .more-sign .ic-wechat {
	color: #00bb29
}

.sign .more-sign .ic-qq_connect {
	color: #498ad5
}

.sign .more-sign .ic-douban {
	color: #00820f
}

.sign .more-sign .ic-more {
	color: #999
}

.sign .more-sign .weibo-loading {
	pointer-events: none;
	cursor: pointer;
	position: relative
}

.sign .more-sign .weibo-loading:after {
	content: "";
	position: absolute;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	background-color: #fff
}

body.reader-night-mode .sign .more-sign .weibo-loading:after {
	background-color: #3f3f3f
}

.sign .more-sign .weibo-loading:before {
	content: "";
	position: absolute;
	top: 50%;
	left: 50%;
	width: 20px;
	height: 20px;
	margin: -10px 0 0 -10px;
	border-radius: 10px;
	border: 2px solid #e05244;
	border-bottom-color: transparent;
	vertical-align: middle;
	-webkit-animation: rolling .8s infinite linear;
	animation: rolling .8s infinite linear;
	z-index: 1
}

@keyframes rolling {
	0% {
		-webkit-transform: rotate(0deg);
		transform: rotate(0deg)
	}

	to {
		-webkit-transform: rotate(1turn);
		transform: rotate(1turn)
	}
}

@-webkit-keyframes rolling {
	0% {
		-webkit-transform: rotate(0deg)
	}

	to {
		-webkit-transform: rotate(1turn)
	}
}

.sign .reset-password-input {
	border-radius: 4px!important
}

.sign .return {
	margin-left: -8px;
	color: #969696
}

.sign .return:hover {
	color: #333
}

.sign .return i {
	margin-right: 5px
}

.sign .icheckbox_square-green {
	display: inline-block;
	*display: inline;
	vertical-align: middle;
	margin: 0;
	padding: 0;
	width: 18px;
	height: 18px;
	background: url(/static/image/green.png) no-repeat;
	border: none;
	cursor: pointer;
	background-position: 0 0
}

.sign .icheckbox_square-green.hover {
	background-position: -20px 0
}

.sign .icheckbox_square-green.checked {
	background-position: -40px 0
}

.sign .icheckbox_square-green.disabled {
	background-position: -60px 0;
	cursor: default
}

.sign .icheckbox_square-green.checked.disabled {
	background-position: -80px 0
}


.geetest_panel_box>* {
	box-sizing: content-box
}

@media (max-width:768px) {
	body {
		min-width: 0
	}

	.sign {
		height: auto;
		min-height: 0;
		background-color: transparent
	}

	.sign .logo {
		display: none
	}

	.sign .main {
		position: absolute;
		left: 50%;
		margin: 0 0 0 -200px;
		box-shadow: none
	}
}
</style>
```

#### api服务端提供验证邮箱是否正确以及发送邮件的功能

###### 使用itsdangerous生成访问第2步修改页面的凭据access_token

itsdangerous模块的官方文档:`https://pythonhosted.org/itsdangerous/`

安装

```shell
pip install itsdangerous
```

`TimedJSONWebSignatureSerializer`的使用

使用TimedJSONWebSignatureSerializer可以生成带有有效期的token

```python
from itsdangerous import TimedJSONWebSignatureSerializer as Serializer
from django.conf import settings

"""加密"""
# serializer = Serializer(秘钥, 加密数据的有效期(秒))
serializer = Serializer(settings.SECRET_KEY, 300)
# serializer.dumps(数据), 返回bytes类型
access_token = serializer.dumps({'email': '649641514@qq.com'})
access_token = access_.decode()

# 检验token
# 验证失败，会抛出itsdangerous.BadData异常
serializer = Serializer(settings.SECRET_KEY, 300)
try:
    data = serializer.loads(access_token)
except BadData:
    return None
```



#### 使用Django发送邮件

Django中内置了邮件发送功能，被定义在django.core.mail模块中。发送邮件需要使用SMTP服务器，常用的免费服务器有：[163](http://help.163.com/09/1223/14/5R7P3QI100753VB8.html)、[126](http://www.126.com/help/client_04.htm)、[QQ](https://kf.qq.com/faq/120322fu63YV130422nqIrqu.html)，下面以163邮件为例。

1）注册163邮箱，登录后设置。

2）在新页面中点击“客户端授权密码”，勾选“开启”，弹出新窗口填写手机验证码。

3）填写授权码。

4）提示开启成功。

5) 在Django配置文件settings/dev.py中，设置邮箱的配置信息

```python
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = 'smtp.163.com'
EMAIL_PORT = 25
#发送邮件的邮箱
EMAIL_HOST_USER = 'mooluoo@163.com'
#在邮箱中设置的客户端授权密码
EMAIL_HOST_PASSWORD = 'renranwang2020'
#收件人看到的发件人
EMAIL_FROM = 'renran<649641514@163.com>'
```

6) 使用Django提供的模块发送邮件

在`django.core.mail`模块提供了`send_mail`来发送邮件。

`send_mail(subject, message, from_email, recipient_list,html_message=None)`

-   subject 邮件标题
-   message 普通邮件正文， 普通字符串
-   from_email 发件人
-   recipient_list 收件人列表
-   html_message 多媒体邮件正文，可以是html字符串

邮件发送找回密码的api接口

```python
from itsdangerous import TimedJSONWebSignatureSerializer as Serializer
from django.core.mail import send_mail

class ResetPasswordAPIView(APIView):
    def get(self,request):
        """发送找回密码的链接地址"""

        # 检测用户是否存在
        email = request.query_params.get("email")
        try:
            user = User.objects.get(email=email)
        except User.DoesNotExist:
            return Response("当前邮箱对应的用户不存在！", status=status.HTTP_400_BAD_REQUEST)

        # 生成找回密码的链接
        serializer = Serializer(settings.SECRET_KEY, constants.DATA_SIGNATURE_EXPIRE)
        # dumps的返回值是加密书的bytes信息
        access_token = serializer.dumps({"email":email}).decode()

        url = settings.CLIENT_HOST+"/reset_password?access_token="+access_token

        # 使用dango提供的email发送邮件
        send_mail(subject='找回密码',message='',from_email=settings.EMAIL_FROM,recipient_list=['1322349915@qq.com'], html_message='<a href="%s" target="_blank">重置密码</a>' % url)

        return Response("邮件已经发送，请留意您的邮箱")
```

 客户端参考原来的登录页面,提供重置密码的页面

ResetPassword.vue

```vue
<template>
    <div class="sign">
    <div class="logo"><a href="/"><img src="/static/image/nav-logo.png" alt="Logo"></a></div>
    <div class="main">


<h4 class="reset-title">
  使用邮箱重置密码
</h4>
<div class="js-sign-in-container">
  <form id="new_session" action="" method="post">
      <div class="input-prepend restyle js-normal">
        <input type="text" readonly :value="email" id="session_email_or_mobile_number">
        <i class="iconfont ic-email"></i>
      </div>

      <div class="input-prepend">
        <input placeholder="密码" type="password" v-model="password">
        <i class="iconfont ic-password"></i>
      </div>
      <div class="input-prepend">
        <input placeholder="确认密码" type="password" v-model="password2">
        <i class="iconfont ic-password"></i>
      </div>
      <button class="sign-in-button" id="sign-in-form-submit-btn" type="button" @click.prevent="show_captcha">
        <span id="sign-in-loading"></span>重置密码
      </button>
  </form>
  <!-- 更多登录方式 -->
  <div class="more-sign">
    <h6>社交帐号登录</h6>
    <ul>
  <li id="weibo-link-wrap" class="">
    <a class="weibo" id="weibo-link">
      <i class="iconfont ic-weibo"></i>
    </a>
  </li>
  <li><a id="weixin" class="weixin" target="_blank" href=""><i class="iconfont ic-wechat"></i></a></li>
  <li><a id="qq" class="qq" target="_blank" href=""><i class="iconfont ic-qq_connect"></i></a></li>
</ul>
  </div>
</div>

    </div>
  </div>
</template>

<script>
    import "../../static/js/TCaptcha";
    export default {
        name: "Login",
        data(){
          return {
             email: "",
             password:"",
             password2:"",
          }
        },
        created() {
          this.check_access_token();
        },
        methods:{
          check_access_token(){
            // 检测access_token访问票据是否正确并在有效期范围内

          },
          // 重置密码
          passwordhander(){
            this.$axios.post(this.$settings.Host+"/users/reset/password/",
              {
                "password":this.password,
                "password2":this.password2
              }).then(response=>{
                  this.$confirm('重置密码成功！', '提示', {
                    confirmButtonText: '立即登录',
                    cancelButtonText: '返回上一页',
                    type: 'success'
                  }).then(() => {
                    this.$router.push("/user/login");
                  }).catch(() => {
                    this.$router.go(-1);
                  });

              }).catch(error=>{
                  this.$message.error("重置密码成功！");
              })
          },
          show_captcha(){

            // 判断手机号或者密码是否为空！
            if(this.username.length<1 || this.password.length<1){
              return false; // 阻止代码继续往下执行
            }

            // 验证码
            let self = this;
            // 生成一个验证码对象
            var captcha1 = new TencentCaptcha(this.$settings.TC_captcha.app_id, function(res) {
              console.log(res);
              // res（未通过验证）= {ret: 1, ticket: null}

              // ticket	验证成功的票据，当且仅当ret=0时ticket有值
              // res（验证成功） = {ret: 0, ticket: "String", randstr: "String"}
              if (res.ret === 0) {
                // 随机码
                // api服务端校验验证码的结果
                self.$axios.get(`${self.$settings.Host}/users/captcha/`,{
                  params:{
                    ticket: res.ticket,
                    randstr: res.randstr,
                  }
                }).then(response=>{
                  // 进行登录处理
                  self.passwordhander();
                }).catch(error=>{
                  self.$message.error("验证码校验错误！");
                })
              }
            });

            // 显示验证码
            captcha1.show();
          }
        },
    }
</script>

<style scoped>
input{
  outline: none;
}
*, :after, :before {
    box-sizing: border-box;
}
.sign {
	height: 100%;
	min-height: 750px;
	text-align: center;
	font-size: 14px;
	background-color: #f1f1f1
}

.sign:before {
	content: "";
	display: inline-block;
	height: 85%;
	vertical-align: middle
}

.sign .disable,.sign .disable-gray {
	opacity: .5;
	pointer-events: none
}

.sign .disable-gray {
	background-color: #969696
}

.sign .tooltip-error {
	font-size: 14px;
	line-height: 25px;
	white-space: nowrap;
	background: none
}

.sign .tooltip-error .tooltip-inner {
	max-width: 280px;
	color: #333;
	border: 1px solid #ea6f5a;
	background-color: #fff
}

.sign .tooltip-error .tooltip-inner i {
	position: static;
	margin-right: 5px;
	font-size: 20px;
	color: #ea6f5a;
	vertical-align: middle
}

.sign .tooltip-error .tooltip-inner span {
	vertical-align: middle;
	display: inline-block;
	white-space: normal;
	max-width: 230px
}

.sign .tooltip-error.right .tooltip-arrow-border {
	border-right-color: #ea6f5a
}

.sign .tooltip-error.right .tooltip-arrow-bg {
	left: 2px;
	border-right-color: #fff
}

.sign .slide-error {
	position: relative;
	padding: 10px 0;
	border: 1px solid #c8c8c8;
	border-radius: 4px
}

.sign .slide-error i {
	position: static!important;
	margin-right: 10px;
	color: #ea6f5a!important;
	vertical-align: middle
}

.sign .slide-error span {
	font-size: 15px;
	vertical-align: middle
}

.sign .slide-error div {
	margin-top: 10px;
	font-size: 13px
}

.sign .slide-error a {
	color: #3194d0
}

.sign .js-sign-up-forbidden {
	color: #999;
	padding: 80px 0 100px
}

.sign .js-sign-up-container .slide-error {
	border-bottom: none;
	border-radius: 0
}

.sign .logo {
	position: absolute;
	top: 56px;
	margin-left: 50px
}

.sign .logo img {
	width: 100px
}

.sign .main {
	width: 400px;
	margin: 60px auto 0;
	padding: 50px 50px 30px;
	background-color: #fff;
	border-radius: 4px;
	box-shadow: 0 0 8px rgba(0,0,0,.1);
	vertical-align: middle;
	display: inline-block
}

.sign .reset-title,.sign .title {
	margin: 0 auto 50px;
	padding: 10px;
	font-weight: 400;
	color: #969696
}

.sign .reset-title a,.sign .title a {
	padding: 10px;
	color: #969696
}

.sign .reset-title a:hover,.sign .title a:hover {
	border-bottom: 2px solid #ea6f5a
}

.sign .reset-title .active,.sign .title .active {
	font-weight: 700;
	color: #ea6f5a;
	border-bottom: 2px solid #ea6f5a
}

.sign .reset-title b,.sign .title b {
	padding: 10px
}

.sign .reset-title {
	color: #333;
	font-weight: 700
}

.sign form {
	margin-bottom: 30px
}

.sign form .input-prepend {
	position: relative;
	width: 100%
}

.sign form .input-prepend input {
	width: 100%;
	height: 50px;
	margin-bottom: 0;
	padding: 4px 12px 4px 35px;
	border: 1px solid #c8c8c8;
	border-radius: 0 0 4px 4px;
	background-color: hsla(0,0%,71%,.1);
	vertical-align: middle
}

.sign form .input-prepend i {
	position: absolute;
	top: 14px;
	left: 10px;
	font-size: 18px;
	color: #969696
}

.sign form .input-prepend span {
	color: #333
}

.sign form .input-prepend .ic-show {
	top: 18px;
	left: auto;
	right: 8px;
	font-size: 12px
}

.sign form .geetest-placeholder {
	height: 44px;
	border-radius: 4px;
	background-color: hsla(0,0%,71%,.1);
	text-align: center;
	line-height: 44px;
	font-size: 14px;
	color: #999
}

.sign form .restyle {
	margin-bottom: 0
}

.sign form .restyle input {
	border-bottom: none;
	border-radius: 4px 4px 0 0
}

.sign form .no-radius input {
	border-radius: 0
}

.sign form .slide-security-placeholder {
	height: 32px;
	background-color: hsla(0,0%,71%,.1);
	border-radius: 4px
}

.sign form .slide-security-placeholder p {
	padding-top: 7px;
	color: #999;
	margin-right: -7px
}

.sign .overseas-btn {
	font-size: 14px;
	color: #999
}

.sign .overseas-btn:hover {
	color: #2f2f2f
}

.sign .remember-btn {
	float: left;
	margin: 15px 0
}

.sign .remember-btn span {
	margin-left: 5px;
	font-size: 15px;
	color: #969696;
	vertical-align: middle
}

.sign .forget-btn {
	float: right;
	position: relative;
	margin: 15px 0;
	font-size: 14px
}

.sign .forget-btn a {
	color: #999
}

.sign .forget-btn a:hover {
	color: #333
}

.sign .forget-btn .dropdown-menu {
	top: 20px;
	left: auto;
	right: 0;
	border-radius: 4px
}

.sign .forget-btn .dropdown-menu a {
	padding: 10px 20px;
	color: #333
}

.sign #sign-in-loading {
	position: relative;
	width: 20px;
	height: 20px;
	vertical-align: middle;
	margin-top: -4px;
	margin-right: 2px;
	display: none
}

.sign #sign-in-loading:after {
	content: "";
	position: absolute;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	background-color: transparent
}

.sign #sign-in-loading:before {
	content: "";
	position: absolute;
	top: 50%;
	left: 50%;
	width: 20px;
	height: 20px;
	margin: -10px 0 0 -10px;
	border-radius: 10px;
	border: 2px solid #fff;
	border-bottom-color: transparent;
	vertical-align: middle;
	-webkit-animation: rolling .8s infinite linear;
	animation: rolling .8s infinite linear;
	z-index: 1
}

.sign .sign-in-button,.sign .sign-up-button {
	margin-top: 20px;
	width: 100%;
	padding: 9px 18px;
	font-size: 18px;
	border: none;
	border-radius: 25px;
	color: #fff;
	background: #42c02e;
	cursor: pointer;
	outline: none;
	display: block;
	clear: both
}

.sign .sign-in-button:hover,.sign .sign-up-button:hover {
	background: #3db922
}

.sign .sign-in-button {
	background: #3194d0
}

.sign .sign-in-button:hover {
	background: #187cb7
}

.sign .btn-in-resend,.sign .btn-up-resend {
	position: absolute;
	top: 7px;
	right: 7px;
	width: 100px;
	height: 36px;
	font-size: 13px;
	color: #fff;
	background-color: #42c02e;
	border-radius: 20px;
	line-height: 36px
}

.sign .btn-in-resend {
	background-color: #3194d0
}

.sign .sign-up-msg {
	margin: 10px 0;
	padding: 0;
	text-align: center;
	font-size: 12px;
	line-height: 20px;
	color: #969696
}

.sign .sign-up-msg a,.sign .sign-up-msg a:hover {
	color: #3194d0
}

.sign .overseas input {
	padding-left: 110px!important
}

.sign .overseas .overseas-number {
	position: absolute;
	top: 0;
	left: 0;
	width: 100px;
	height: 50px;
	font-size: 18px;
	color: #969696;
	border-right: 1px solid #c8c8c8
}

.sign .overseas .overseas-number span {
	margin-top: 17px;
	padding-left: 35px;
	text-align: left;
	font-size: 14px;
	display: block
}

.sign .overseas .dropdown-menu {
	width: 100%;
	max-height: 285px;
	font-size: 14px;
	border-radius: 0 0 4px 4px;
	overflow-y: auto
}

.sign .overseas .dropdown-menu li .nation-code {
	width: 65px;
	display: inline-block
}

.sign .overseas .dropdown-menu li a {
	padding: 6px 20px;
	font-size: 14px;
	line-height: 20px
}

.sign .overseas .dropdown-menu li a::hover {
	color: #fff;
	background-color: #f5f5f5
}

.sign .more-sign {
	margin-top: 50px
}

.sign .more-sign h6 {
	position: relative;
	margin: 0 0 10px;
	font-size: 12px;
	color: #b5b5b5
}

.sign .more-sign h6:before {
	left: 30px
}

.sign .more-sign h6:after,.sign .more-sign h6:before {
	content: "";
	border-top: 1px solid #b5b5b5;
	display: block;
	position: absolute;
	width: 60px;
	top: 5px
}

.sign .more-sign h6:after {
	right: 30px
}

.sign .more-sign ul {
	margin-bottom: 10px;
	list-style: none
}

.sign .more-sign ul li {
	margin: 0 5px;
	display: inline-block
}

.sign .more-sign ul a {
	width: 50px;
	height: 50px;
	line-height: 50px;
	display: block
}

.sign .more-sign ul i {
	font-size: 28px
}

.sign .more-sign .ic-weibo {
	color: #e05244
}

.sign .more-sign .ic-wechat {
	color: #00bb29
}

.sign .more-sign .ic-qq_connect {
	color: #498ad5
}

.sign .more-sign .ic-douban {
	color: #00820f
}

.sign .more-sign .ic-more {
	color: #999
}

.sign .more-sign .weibo-loading {
	pointer-events: none;
	cursor: pointer;
	position: relative
}

.sign .more-sign .weibo-loading:after {
	content: "";
	position: absolute;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	background-color: #fff
}

body.reader-night-mode .sign .more-sign .weibo-loading:after {
	background-color: #3f3f3f
}

.sign .more-sign .weibo-loading:before {
	content: "";
	position: absolute;
	top: 50%;
	left: 50%;
	width: 20px;
	height: 20px;
	margin: -10px 0 0 -10px;
	border-radius: 10px;
	border: 2px solid #e05244;
	border-bottom-color: transparent;
	vertical-align: middle;
	-webkit-animation: rolling .8s infinite linear;
	animation: rolling .8s infinite linear;
	z-index: 1
}

@keyframes rolling {
	0% {
		-webkit-transform: rotate(0deg);
		transform: rotate(0deg)
	}

	to {
		-webkit-transform: rotate(1turn);
		transform: rotate(1turn)
	}
}

@-webkit-keyframes rolling {
	0% {
		-webkit-transform: rotate(0deg)
	}

	to {
		-webkit-transform: rotate(1turn)
	}
}

.sign .reset-password-input {
	border-radius: 4px!important
}

.sign .return {
	margin-left: -8px;
	color: #969696
}

.sign .return:hover {
	color: #333
}

.sign .return i {
	margin-right: 5px
}

.sign .icheckbox_square-green {
	display: inline-block;
	*display: inline;
	vertical-align: middle;
	margin: 0;
	padding: 0;
	width: 18px;
	height: 18px;
	background: url(/static/image/green.png) no-repeat;
	border: none;
	cursor: pointer;
	background-position: 0 0
}

.sign .icheckbox_square-green.hover {
	background-position: -20px 0
}

.sign .icheckbox_square-green.checked {
	background-position: -40px 0
}

.sign .icheckbox_square-green.disabled {
	background-position: -60px 0;
	cursor: default
}

.sign .icheckbox_square-green.checked.disabled {
	background-position: -80px 0
}


.geetest_panel_box>* {
	box-sizing: content-box
}

@media (max-width:768px) {
	body {
		min-width: 0
	}

	.sign {
		height: auto;
		min-height: 0;
		background-color: transparent
	}

	.sign .logo {
		display: none
	}

	.sign .main {
		position: absolute;
		left: 50%;
		margin: 0 0 0 -200px;
		box-shadow: none
	}
}
</style>

```

注册路由:

```javascript
import Vue from 'vue'
import Router from 'vue-router'

Vue.use(Router);

import Home from "@/components/Home";
import Login from "@/components/Login"
import Register from "@/components/Register"
import FindPassword from "@/components/FindPassword"
import ResetPassword from "@/components/ResetPassword"


export default new Router({
  mode: "history",
  routes: [
     {
       name:"Home",
       path:"/",
       component:Home,
     },
      {
       name:"Home",
       path:"/home",
       component:Home,
     },
      {
       name:"Login",
       path:"/user/login",
       component:Login,
     },
      {
       name:"Register",
       path:"/user/register",
       component: Register,
     },
      {
       name:"FindPassword",
       path:"/find_password",
       component: FindPassword,
     },
      {
       name:"ResetPassword",
       path:"/reset_password",
       component: ResetPassword,
     },
  ]
})

```

服务端提供验证检测access_token的API接口

视图中接受来自客户端的access_token数据,并进行校验

```python
class ResetPasswordAPIView(APIView):
    def get(self,request):
        """发送找回密码的链接地址"""

        # 检测用户是否存在
        email = request.query_params.get("email")
        try:
            user = User.objects.get(email=email)
        except User.DoesNotExist:
            return Response("当前邮箱对应的用户不存在！", status=status.HTTP_400_BAD_REQUEST)

        # 生成找回密码的链接
        serializer = Serializer(settings.SECRET_KEY, constants.DATA_SIGNATURE_EXPIRE)
        # dumps的返回值是加密书的bytes信息
        access_token = serializer.dumps({"email":email}).decode()

        url = settings.CLIENT_HOST+"/reset_password?access_token="+access_token

        # 使用dango提供的email发送邮件
        send_mail(subject='找回密码',message='',from_email=settings.EMAIL_FROM,recipient_list=['1322349915@qq.com'], html_message='<a href="%s" target="_blank">重置密码</a>' % url)

        return Response("邮件已经发送，请留意您的邮箱")

    def post(self,request):
        # 验证邮箱链接地址中的access_token是否正确并在有效期时间范围内
        access_token = request.data.get("access_token")
        serializer = Serializer(settings.SECRET_KEY, constants.DATA_SIGNATURE_EXPIRE)
        try:
            data = serializer.loads(access_token)
            return Response({"email": data.get("email")})
        except BadData:
            # access_token过期或者错误
            return Response("重置密码的邮件已过期或者邮件地址有误！", status=status.HTTP_400_BAD_REQUEST)
```

客户端发送ajax请求检测access_token是否正确!

```vue
<template>
    <div class="sign">
    <div class="logo"><a href="/"><img src="/static/image/nav-logo.png" alt="Logo"></a></div>
    <div class="main">


<h4 class="reset-title">
  使用邮箱重置密码
</h4>
<div class="js-sign-in-container">
  <form id="new_session" action="" method="post">
      <div class="input-prepend restyle js-normal">
        <input type="text" readonly :value="email" id="session_email_or_mobile_number">
        <i class="iconfont ic-email"></i>
      </div>

      <div class="input-prepend">
        <input placeholder="密码" type="password" v-model="password">
        <i class="iconfont ic-password"></i>
      </div>
      <div class="input-prepend">
        <input placeholder="确认密码" type="password" v-model="password2">
        <i class="iconfont ic-password"></i>
      </div>
      <button class="sign-in-button" id="sign-in-form-submit-btn" type="button" @click.prevent="show_captcha">
        <span id="sign-in-loading"></span>重置密码
      </button>
  </form>
  <!-- 更多登录方式 -->
  <div class="more-sign">
    <h6>社交帐号登录</h6>
    <ul>
  <li id="weibo-link-wrap" class="">
    <a class="weibo" id="weibo-link">
      <i class="iconfont ic-weibo"></i>
    </a>
  </li>
  <li><a id="weixin" class="weixin" target="_blank" href=""><i class="iconfont ic-wechat"></i></a></li>
  <li><a id="qq" class="qq" target="_blank" href=""><i class="iconfont ic-qq_connect"></i></a></li>
</ul>
  </div>
</div>

    </div>
  </div>
</template>

<script>
    import "../../static/js/TCaptcha";
    export default {
        name: "Login",
        data(){
          return {
             email: "",
             password:"",
             password2:"",
          }
        },
        created() {
          this.check_access_token();
        },
        methods:{
          check_access_token(){
            // 检测access_token访问票据是否正确并在有效期范围内.
            this.$axios.post(`${this.$settings.Host}/users/find/password/`,{
               access_token: this.$route.query.access_token,
            }).then(response=>{
                this.email = response.data.email;
            }).catch(error=>{
                let self = this;
                this.$alert("访问页面发生错误，无法修改密码，请确认您的邮件是否超过有效期或链接地址有误！","错误",{
                  callback(){
                    self.$router.go(-1);
                  }
                })
            })
          },
          // 重置密码
          passwordhander(){
            this.$axios.post(this.$settings.Host+"/users/reset/password/",
              {
                "password":this.password,
                "password2":this.password2
              }).then(response=>{
                  this.$confirm('重置密码成功！', '提示', {
                    confirmButtonText: '立即登录',
                    cancelButtonText: '返回上一页',
                    type: 'success'
                  }).then(() => {
                    this.$router.push("/user/login");
                  }).catch(() => {
                    this.$router.go(-1);
                  });

              }).catch(error=>{
                  this.$message.error("重置密码成功！");
              })
          },
          show_captcha(){

            // 判断手机号或者密码是否为空！
            if(this.username.length<1 || this.password.length<1){
              return false; // 阻止代码继续往下执行
            }

            // 验证码
            let self = this;
            // 生成一个验证码对象
            var captcha1 = new TencentCaptcha(this.$settings.TC_captcha.app_id, function(res) {
              console.log(res);
              // res（未通过验证）= {ret: 1, ticket: null}

              // ticket	验证成功的票据，当且仅当ret=0时ticket有值
              // res（验证成功） = {ret: 0, ticket: "String", randstr: "String"}
              if (res.ret === 0) {
                // 随机码
                // api服务端校验验证码的结果
                self.$axios.get(`${self.$settings.Host}/users/captcha/`,{
                  params:{
                    ticket: res.ticket,
                    randstr: res.randstr,
                  }
                }).then(response=>{
                  // 进行登录处理
                  self.passwordhander();
                }).catch(error=>{
                  self.$message.error("验证码校验错误！");
                })
              }
            });

            // 显示验证码
            captcha1.show();
          }
        },
    }
</script>
```

服务端还要提供修改重置密码接口

```python
# Create your views here.
from rest_framework.views import APIView
from django.conf import settings
import json
from urllib.parse import urlencode
from urllib.request import urlopen
from rest_framework.response import Response
from rest_framework import status

class CaptchaAPIView(APIView):
    def get(self,request):
        """验证码的验证结果校验"""
        AppSecretKey = settings.TENCENT_CAPTCHA["App_Secret_Key"]
        appid = settings.TENCENT_CAPTCHA["APPID"]
        Ticket = request.query_params.get("ticket")
        Randstr = request.query_params.get("randstr")
        UserIP = request._request.META.get("REMOTE_ADDR")
        print("用户ID地址：%s" % UserIP)
        params = {
            "aid": appid,
            "AppSecretKey": AppSecretKey,
            "Ticket": Ticket,
            "Randstr": Randstr,
            "UserIP": UserIP
        }
        params = urlencode(params)

        f = urlopen("%s?%s" % (settings.TENCENT_CAPTCHA["GATEWAY"], params))
        content = f.read()
        res = json.loads(content)
        print(res)
        if res:
            error_code = res["response"]
            if error_code == "1":
                return Response("验证通过！")
            else:
                return Response("验证失败！%s" % res["err_msg"], status=status.HTTP_400_BAD_REQUEST)
        else:
            return Response("验证失败！", status=status.HTTP_400_BAD_REQUEST)

from rest_framework.generics import CreateAPIView
from .models import User
from .serializers import UserModelSerializer
class UserCreateAPIView(CreateAPIView):
    queryset = User.objects.all()
    serializer_class = UserModelSerializer

import random
from django_redis import get_redis_connection
from renranapi.settings import constants
from mycelery.sms.tasks import send_sms

class SMSCodeAPIView(APIView):
    """
    短信验证码
    """
    def get(self, request, mobile):
        """
        短信验证码
        """
        redis_conn = get_redis_connection('sms_code')

        # 手机号是否处于发送短信的冷却时间内
        interval = redis_conn.get("sms_time_%s" % mobile)
        if interval is not None:
            return Response("不能频繁发送短信！")

        # 生成短信验证码
        sms_code = "%06d" % random.randint(0, 999999)

        # 保存短信验证码与发送记录
        # 使用redis提供的管道操作可以一次性执行多条redis命令
        pl = redis_conn.pipeline()
        pl.multi()
        pl.setex("sms_%s" % mobile, constants.SMS_CODE_EXPIRE, sms_code)      # 设置短信有效期
        pl.setex("sms_time_%s" % mobile, constants.SMS_CODE_INTERVAL, "_")    # 设置发送短信间隔为60s
        pl.execute()

        # 发送短信验证码
        send_sms.delay(mobile, sms_code)

        return Response({"message": "OK"}, status.HTTP_200_OK)

from itsdangerous import TimedJSONWebSignatureSerializer as Serializer, BadData
from django.core.mail import send_mail

class ResetPasswordAPIView(APIView):
	# //....

    def put(self, request):
        # 重置密码
        # 再次从access_token获取用户信息
        access_token = request.data.get("access_token")
        password = request.data.get("password")
        password2 = request.data.get("password2")

        # 判断密码和确认密码是否一致
        if len(password) < 6 or len(password) > 16:
            return Response("密码长度有误！", status=status.HTTP_400_BAD_REQUEST)

        if password != password2:
            return Response("密码和确认密码不一致！", status=status.HTTP_400_BAD_REQUEST)

        serializer = Serializer(settings.SECRET_KEY, constants.DATA_SIGNATURE_EXPIRE)
        try:
            data = serializer.loads(access_token)
        except BadData:
            # access_token过期或者错误
            return Response("重置密码的邮件已过期或者邮件地址有误！", status=status.HTTP_400_BAD_REQUEST)

        email = data.get('email')
        # 获取用户信息
        try:
            user = User.objects.get(email=email)
        except User.DoesNotExist:
            return Response("重置密码失败！邮箱地址有误！", status=status.HTTP_400_BAD_REQUEST)

        # 修改密码
        user.set_password(password)
        user.save()

        return Response("重置密码成功！")
```

客户端发起请求重置密码

```vue
<template>
    <div class="sign">
    <div class="logo"><a href="/"><img src="/static/image/nav-logo.png" alt="Logo"></a></div>
    <div class="main">


<h4 class="reset-title">
  使用邮箱重置密码
</h4>
<div class="js-sign-in-container">
  <form id="new_session" action="" method="post">
      <div class="input-prepend restyle js-normal">
        <input type="text" readonly :value="email" id="session_email_or_mobile_number">
        <i class="iconfont ic-email"></i>
      </div>

      <div class="input-prepend">
        <input placeholder="密码" type="password" v-model="password">
        <i class="iconfont ic-password"></i>
      </div>
      <div class="input-prepend">
        <input placeholder="确认密码" type="password" v-model="password2">
        <i class="iconfont ic-password"></i>
      </div>
      <button class="sign-in-button" id="sign-in-form-submit-btn" type="button" @click.prevent="show_captcha">
        <span id="sign-in-loading"></span>重置密码
      </button>
  </form>
  <!-- 更多登录方式 -->
  <div class="more-sign">
    <h6>社交帐号登录</h6>
    <ul>
  <li id="weibo-link-wrap" class="">
    <a class="weibo" id="weibo-link">
      <i class="iconfont ic-weibo"></i>
    </a>
  </li>
  <li><a id="weixin" class="weixin" target="_blank" href=""><i class="iconfont ic-wechat"></i></a></li>
  <li><a id="qq" class="qq" target="_blank" href=""><i class="iconfont ic-qq_connect"></i></a></li>
</ul>
  </div>
</div>

    </div>
  </div>
</template>

<script>
    import "../../static/js/TCaptcha";
    export default {
        name: "Login",
        data(){
          return {
             email: "",
             password:"",
             password2:"",
          }
        },
        created() {
          this.check_access_token();
        },
        methods:{
          check_access_token(){
            // 检测access_token访问票据是否正确并在有效期范围内
            this.$axios.post(`${this.$settings.Host}/users/find/password/`,{
               access_token: this.$route.query.access_token,
            }).then(response=>{
                this.email = response.data.email;
            }).catch(error=>{
                let self = this;
                this.$alert("访问页面发生错误，无法修改密码，请确认您的邮件是否超过有效期或链接地址有误！","错误",{
                  callback(){
                    self.$router.go(-1);
                  }
                })
            })
          },
          // 重置密码
          passwordhander(){
            this.$axios.put(this.$settings.Host+"/users/find/password/",
              {
                "access_token": this.$route.query.access_token,
                "password":this.password,
                "password2":this.password2
              }).then(response=>{
                  this.$confirm('重置密码成功！', '提示', {
                    confirmButtonText: '立即登录',
                    cancelButtonText: '返回上一页',
                    type: 'success'
                  }).then(() => {
                    this.$router.push("/user/login");
                  }).catch(() => {
                    this.$router.go(-1);
                  });

              }).catch(error=>{
                  this.$message.error("重置密码成功！");
              })
          },
          show_captcha(){

            // 判断确认密码或者密码是否符合长度并一致！
            if(this.password!=this.password2){
              this.$message.error("密码和确认密码不一致");
              return false;
            }
            if(this.password.length<6 || this.password.length>16){
              this.$message.error("密码长度必须在6-16个字符之间");
              return false;
            }

            // 验证码
            let self = this;
            // 生成一个验证码对象
            var captcha1 = new TencentCaptcha(this.$settings.TC_captcha.app_id, function(res) {
              console.log(res);
              // res（未通过验证）= {ret: 1, ticket: null}

              // ticket	验证成功的票据，当且仅当ret=0时ticket有值
              // res（验证成功） = {ret: 0, ticket: "String", randstr: "String"}
              if (res.ret === 0) {
                // 随机码
                // api服务端校验验证码的结果
                self.$axios.get(`${self.$settings.Host}/users/captcha/`,{
                  params:{
                    ticket: res.ticket,
                    randstr: res.randstr,
                  }
                }).then(response=>{
                  // 进行登录处理
                  self.passwordhander();
                }).catch(error=>{
                  self.$message.error("验证码校验错误！");
                })
              }
            });

            // 显示验证码
            captcha1.show();
          }
        },
    }
</script>
```

#### 使用celery异步发送找回密码的邮件

在mycelery目录下创建异步发送邮件的任务目录email,并创建任务文件tasks.py,代码:

```python
from mycelery.main import app
import logging
from django.conf import settings
log = logging.getLogger("django")
from django.core.mail import send_mail

@app.task(name="send_email")
def send_email(recipient_list, url):
    """异步发送找回密码的邮件"""
    try:
        send_mail(subject='找回密码', message='', from_email=settings.EMAIL_FROM, recipient_list=recipient_list,
                  html_message='<a href="%s" target="_blank">重置密码</a>' % url)
    except:
        log.error("发送邮件失败！")

```

注册任务

mycelery.main.py

```python
# 主程序
import os
from celery import Celery
# 创建celery实例对象
app = Celery("renran")

# 把celery和django进行组合，识别和加载django的配置文件
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'renranapi.settings.dev')
# 对django框架执行初始化
import django
django.setup()

# 通过app对象加载配置
app.config_from_object("mycelery.config")

# 加载任务
# 参数必须必须是一个列表，里面的每一个任务都是任务的路径名称
# app.autodiscover_tasks(["任务1","任务2"])
app.autodiscover_tasks(["mycelery.sms","mycelery.email"])

# 启动Celery的命令
# 切换目录到mycelery的上一级目录下启动
# celery -A mycelery.main worker --loglevel=info
```

重启celery以后, 修改视图users.views.py中的发送邮件代码

```python
from itsdangerous import TimedJSONWebSignatureSerializer as Serializer, BadData
from mycelery.email.tasks import send_email
class ResetPasswordAPIView(APIView):
    def get(self,request):
        """发送找回密码的链接地址"""

        # 检测用户是否存在
        email = request.query_params.get("email")
        try:
            user = User.objects.get(email=email)
        except User.DoesNotExist:
            return Response("当前邮箱对应的用户不存在！", status=status.HTTP_400_BAD_REQUEST)

        # 生成找回密码的链接
        serializer = Serializer(settings.SECRET_KEY, constants.DATA_SIGNATURE_EXPIRE)
        # dumps的返回值是加密书的bytes信息
        access_token = serializer.dumps({"email":email}).decode()

        url = settings.CLIENT_HOST+"/reset_password?access_token="+access_token

        # 使用dango提供的email发送邮件
        send_email.delay([email],url)

        return Response("邮件已经发送，请留意您的邮箱")

```


