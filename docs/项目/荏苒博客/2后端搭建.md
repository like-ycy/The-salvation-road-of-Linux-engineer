# 环境搭建

## 创建虚拟环境

```python
# 如果当前系统中没有虚拟环境，则使用以下命令安装虚拟环境：
# pip3 install virtualenv  -i https://pypi.tuna.tsinghua.edu.cn/simple
# pip3 install virtualenvwrapper -i https://pypi.tuna.tsinghua.edu.cn/simple
# pip3 install virtualenvwrapper-win -i https://pypi.tuna.tsinghua.edu.cn/simple

mkvirtualenv renran
```

如果自己的开发机子中存在多个版本的python，则可以指定python解析器的版本

```python
mkvirtualenv renran -p python3
```



## 相关命令

```python
创建虚拟环境：                mkvirtualenv 虚拟环境名称
创建虚拟环境(指定python版本)： mkvirtualenv 虚拟环境名称 -p python3
查看所有虚拟环境：             workon
使用虚拟环境：                workon 虚拟环境名称
退出虚拟环境：                deactivate
删除虚拟环境（必须先退出虚拟环境内部才能删除当前虚拟环境）:
                           	rmvirtualenv 虚拟环境名称
    
其他相关命令：
查看虚拟环境中安装的包：              pip freeze  或者 pip list
收集当前环境中安装的包及其版本：        pip freeze > requirements.txt
在部署项目的服务器中安装项目使用的模块： pip install -r requirements.txt
```

提示:

- 虚拟环境只会管理环境内部的模块和python解析器,对于源代码是毫无关系

- 创建虚拟环境需要联网
- 创建成功后, 会自动工作在这个虚拟环境上
- 工作在虚拟环境上, 提示符最前面会出现 “(虚拟环境名称)”



## 技术选型

### 外部依赖

1. 注册支付宝的开发者账号

2. 注册阿里云/腾讯云账号,如果可以购买一个服务器【www.aliyun.com】

3. 注册容联云短信接口平台的账号【www.yuntongxun.com】

4. 注册腾讯开发者账户，申请QQ互联开发者实名认证【http://connect.qq.com】

5. 申请163或者QQ邮箱开通smtp/pop3服务【http://mail.163.com】

6. 注册gitee[码云]的账号

7. 如果有条件的,可以申请一个域名进行备案[ICP备案和公安部备案],如果没有的话, 可以注册natapp

   公安部备案平台：<http://www.beian.gov.cn/>

   



#### 依赖包安装

```
pip install django==2.2.0  -i https://pypi.douban.com/simple

pip install djangorestframework  -i https://pypi.douban.com/simple

pip install PymySQL  -i https://pypi.douban.com/simple

pip install Pillow  -i https://pypi.douban.com/simple

pip install django-redis  -i https://pypi.douban.com/simple
```



# 搭建项目

## 创建项目

项目所在路径不要使用中文或者空格或者除了下划线的其它特殊符号

```python
cd ~/Desktop
mkdir renran
cd renran
django-admin startproject renranapi
```



## 打开项目

在pycharm中打开项目

![1593659898433](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1593659898433.png)

![1578105222972](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1578105222972.png)

选择菜单file, 点选settings... 设置虚拟环境

![1553139497155](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1553139497155.png)

点击右边的齿轮，选择Add

![1578104421692](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1578104421692.png)



![1578104445382](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1578104445382.png)

启动django项目中的manage.py

![1578105329159](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1578105329159.png)

因为仅启动manage.py，所以项目不会运行，所以需要配置启动manage.py的参数。

![1578104595762](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1578104595762.png)

点选“Edit Configurations”，在新窗口中的Parammeters中加上以下内容

```bash
runserver 0.0.0.0:8000
```

![1578104637328](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1578104637328.png)

再次运行manage.py

![1578104662964](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1578104662964.png)

效果：

![1557367991756](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1557367991756.png)

提示：

```
在pycharm中如果要使用已经创建好的虚拟环境，则必须设置pycharm中的python解释器，设置为虚拟环境中的python。
```



## 调整目录

```
renran/
  ├── docs/          # 项目相关资料保存目录
      ├ 项目开发日志/项目开发文档.md  
  ├── reran_pc/     # 前端项目目录
  ├── reranapi/      # api服务端项目目录
       ├── logs/          # 项目运行时/开发时日志目录
       ├── manage.py
       ├── reranapi/      # 项目主应用，开发时的代码保存
       │    ├── apps/      # 开发者的代码保存目录，以模块[子应用]为目录保存
       │    ├── libs/      # 第三方类库的保存目录[第三方组件、模块]
       │    ├── settings/
       │         ├── dev.py   # 项目开发时的本地配置[不需要上传到线上或者服务器]
       │         ├── prod.py  # 项目上线时的运行配置
       │    ├── urls.py    # 总路由
       │    ├── utils/     # 多个模块[子应用]的公共函数类库[自己开发的组件]
       └── scripts/       # 保存项目运营时的脚本文件
```

在编辑中开发项目时,必须指定项目目录才能运行,例如,开发后端项目,则必须选择的目录是luffyapi





### 分不同环境进行项目配置

开发者本地的环境、目录、数据库密码和线上的服务器都会不一样,所以我们的配置文件可以针对不同的系统分成多分.

1. 在项目主应用下,创建一个settings的配置文件存储目录
2. 根据线上线下两种情况分别创建2个配置文件 dev.py和prod.py
3. 把原来项目主应用的 settings.py 配置内容复制2份到dev.py和prod.py里面
4. 把原来的settings.py配置文件修改文件名，例如settings_old或者直接删除settings.py

新的配置文件目录settings:

![1578105541412](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1578105541412.png)

接下来,就可以在manage.py中根据不同的开发环境导入对应的配置文件了.

![1557368958823](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1557368958823.png)



## 创建代码版本

cd进入到自己希望存储代码的目录路径，并创建本地仓库.git【pycharm直接打开终端就是项目根目录了。无须cd了】
新创建的本地仓库.git是个空仓库

```python
cd ~/Desktop/renran
git init     # 为当前目录创建一个git仓库
ls -la       # linux下列出当前目录所有目录文件，包括隐藏文件
```

![1585726362762](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1585726362762.png)

### 配置用户名和邮箱

```
git config --global user.name 'moluo'
git config --global user.email '649641514@qq.com'
```



## 在gitee平台创建工程

公司一般都会有自己的代码仓库，一般都是自己搭建，也有使用第三方提供代码管理平台。

常用的代码管理平台：github、gitee(码云)

如果公司自己搭建的代码管理平台，gitlab框架

1） 创建私有项目库

![1578106172369](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1578106172369.png)

![1578106188249](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1578106188249.png)



创建私有/公有空仓库以后的界面:

![1578106470078](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1578106470078.png)



2）克隆项目到本地

注意：
	我们当前项目不需要这个步骤
        这个步骤是 当以后我们进入公司里面，参与人家已经在做的项目时，别人已经有仓库了，但是我们是新人加入项目中的，那么我们不需要在自己本地进行git init，直接git clone 复制别人的仓库代码

```
git clone 仓库地址
注意，如果当前目录下出现git仓库同名目录时，会克隆失败。
```



3）创建并切换分支到dev

```
# git branch dev      # 创建本地分支dev,dev是自定义
# git checkout dev    # 切换本地分支代码
git checkout -b dev   # 这里是上面两句代码的简写
git branch -d dev     # 删除分支
```



git提交

```shell
git add 代码目录   # 添加代码到上传队列
git status        # 查看当前项目的版本状态
git commit -m '添加项目代码'  # 提交代码到本地仓库， -m 表示本次提交的描述
```

推送到远端

```shell
git push origin dev:dev
```

如果推送代码,出现以下提示: git pull ....,则表示当前本地的代码和线上的代码版本不同.

```
1. 把线上的代码执行以下命令,拉取到本地,进行同步
git pull

2. 根据提示,移除多余的冲突的文件,也可以删除.
完成这些步骤以后,再次add,commit,push即可.
```



接下来，我们就把上面创建好的本地项目提交到gitee码云上面

```bash
# .表示当前目录下所有的文件或目录提交到上传队列[上传队列也叫"暂存区"]
# 切换当前工作目录到项目根目录 cd ~/Desktop/renran/
git add .

# 把本地上传队列的代码提交到本地仓库
git commit -m "项目初始化搭建"

# 给本地的git版本控制软件设置项目的远程仓库地址
git remote add origin https://gitee.com/moluo/renran.git

# 提交代码给远程仓库
git push -u origin master
```



```
扩展：
1. 通过 git status 可以查看当前项目的代码版本状态
2. 通过 git reflog 可以查看代码版本日志[简单格式]
3. 通过 git log    可以查看代码版本日志[详细格式]
```

最终就可以成功提交了代码版本到gitee平台。



上面虽然成功移交了代码版本，但是一些不需要的文件也被提交上去了。

所以，我们针对一些不需要的文件，可以选择从代码版本中删除，并且使用`.gitignore`把这些垃圾文件过滤掉。

```bash
git rm 文件  # 删除单个文件
git rm -rf 目录  # 递归删除目录

# 以下操作建议通过ubuntu的终端来完成，不要使用pycharm提供，否则删除.idea还会继续生成。
git rm -rf .idea
git rm db.sqlite3
# 注意，上面的操作只是从项目的源代码中删除，但是git是不知情的，所以我们需要同步。
git add .
git commit -m "删除不必要的文件或目录"
git push -u origin master
```

使用``.gitignore``把一些垃圾文件过滤掉。

```
vim .gitignore

renranapi/.idea
renranapi/.idea/*
renranapi/db.sqlite3
```

开发时我们经常会使用pycharm的提供的git管理工具来完成代码的拉取和推送。

![1557375896356](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1557375896356.png)

## 日志配置

刚搭建的web项目或者没有明确需要调用日志的系统，一般我们直接使用python提供的longging模块来配置日志功能即可。如果类似游戏或者需要对日志进行分析的系统，则一般在服务器中配置ELK日志分析系统的。

对于在django中配置的日志，那么django是没有自己实现日志功能的，而是调用了python解析器提供的日志模块loggings模块。所以，我们在settings/dev.py文件中追加如下配置：

```python
# 日志配置
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': { # 日志的处理格式
        'verbose': {
            'format': '%(levelname)s %(asctime)s %(module)s %(lineno)d %(message)s'
        },
        'simple': {
            'format': '%(levelname)s %(module)s %(lineno)d %(message)s'
        },
    },
    'filters': {
        'require_debug_true': {
            '()': 'django.utils.log.RequireDebugTrue',
        },
    },
    'handlers': {
        'console': {
            'level': 'DEBUG',
            'filters': ['require_debug_true'],
            'class': 'logging.StreamHandler',
            'formatter': 'simple'
        },
        'file': {
            'level': 'INFO',
            'class': 'logging.handlers.RotatingFileHandler',
            # 日志位置,日志文件名,日志保存目录必须手动创建
            'filename': os.path.join(os.path.dirname(BASE_DIR), "logs/renran.log"),
            # 单个日志文件的最大值,这里我们设置300M
            'maxBytes': 300 * 1024 * 1024,
            # 备份日志文件的数量,设置最大日志数量为10
            'backupCount': 10,
            # 日志格式:详细格式
            'formatter': 'verbose'
        },
    },
    # 日志对象
    'loggers': {
        'django': { # 固定，将来django内部也会有异常的处理，只会调用django下标的日志对象
            'handlers': ['console', 'file'],
            'propagate': True, # 是否让日志信息继续冒泡给其他的日志处理系统
        },
    }
}
```





## 异常处理

新建utils/exceptions.py

```python
from rest_framework.views import exception_handler
from django.db import DatabaseError
from rest_framework.response import Response
from rest_framework import status

import logging
logger = logging.getLogger("django")

def custom_exception_handler(exc, context):
    """
    自定义异常处理函数
    :param exc: 异常类对象
    :param context: 抛出异常的上下文
    :return: Response响应对象
    """
    # 调用drf框架原生的异常处理方法
    response = exception_handler(exc, context)
    if response is None:
        view = context["view"]
        """当response的值为None，则有可能出现2种情况: 没有发生异常，或者本次异常没有被drf进行处理"""
        if isinstance(exc, DatabaseError):
            # 数据库异常
            logger.error("数据库发生异常。view=%s，exc=%s" % (view, exc) )
            response = Response({'detail': '服务器内部错误'}, status=status.HTTP_507_INSUFFICIENT_STORAGE)

    return response
```



settings/dev.py配置文件中添加

```python
REST_FRAMEWORK = {
    # 异常处理
    'EXCEPTION_HANDLER': 'renranapi.utils.exceptions.custom_exception_handler',
}
```



## 创建数据库

```mysql
create database renran default charset=utf8mb4;
```

为当前项目创建数据库用户[这个用户只能看到这个数据库]

```mysql
# create user 用户名 identified by '登录密码';       # 创建用户

# grant 权限 on 数据库名.表名 to '用户名'@'登录主机';   # 赋予权限给用户
# * 可以表示任意数据库，也可以表示任意表，也可以表示任意登录主机
# all privileges 表示所有权限，也可以设置 单个权限或多个权限
# grant select,insert,update,delete on ....  # 只赋予增删查改的权限
# grant select on ...   # 只赋予查询权限

# flush privileges;                                # 刷新权限

create user renran_user identified by 'renran';
grant all privileges on renran.* to 'renran_user'@'*';
flush privileges;
```



## 配置数据库连接

打开settings/dev.py文件，并配置

```python
DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.mysql",
        "HOST": "127.0.0.1",
        "PORT": 3306,
        "USER": "renran_user",
        "PASSWORD": "renran",
        "NAME": "renran",
    }
}
```



在项目主模块的 `__init__.py`中导入pymysql

```python
import pymysql

pymysql.install_as_MySQLdb()
```



#### 调整错误

数据库版本检测导致的错误

![1557453985484](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1557453985484.png)

数据库的版本检测代码注释掉。

![1557454099123](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1557454099123.png)



因为python3版本的原因，字符串的编码问题

![1557454044879](2%E5%90%8E%E7%AB%AF%E6%90%AD%E5%BB%BA.assets/1557454044879.png)

```python
把146的代码从下面改动
query = query.decode(errors='replace')
改成：
query = query.encode(errors='replace')
```

