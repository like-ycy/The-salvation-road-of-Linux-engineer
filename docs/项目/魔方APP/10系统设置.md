# 系统设置

## 昵称修改

### 服务端提供更新昵称的api接口

users/api.py，代码：

```python
@get_user_object
def nickname(user: User, name: str) -> Dict[str, Any]:
    """
    更新头像
    :param name 客户端提交的昵称
    """
    # 验证昵称是否正确有效
    if 2 > len(name) > 8:
        return {
            "errno": code.CODE_DATA_FORMAT_ERROR,
            "errmsg": message.data_format_error,
        }

    # 更新用户信息
    user_info: Dict[str, Any] = get_jwt_identity()  # 获取refresh token中的载荷
    update_user(user, {"nickname": name})
    user_info["nickname"] = name

    # 更新token
    access_token, refresh_token = gen_token(user_info)
    return {
        "errno": code.CODE_OK,
        "errmsg": message.ok,
        "access_token": access_token,
        "refresh_token": refresh_token,
    }


```

users/urls.py，代码：

```python
from typing import List
from application import path
from . import api

apipatterns: List = [
    path("mobile", api.check_mobile),
    path("register", api.register),
    path("sms", api.sms),
    path("login", api.login),
    path("info", api.info),
    path("refresh", api.refresh),
    path("verify", api.verify),
    path("logout", api.logout),
    path("avatar", api.avatar),
    path("nickname", api.nickname),
]
```

message.py，代码：

```python
data_format_error: str = "数据格式不正确！"
```

code.py，代码：

```python
CODE_DATA_FORMAT_ERROR: int = 1021 # 数据格式不正确
```



用户点击右边昵称，进入昵称修改页面，html/setting.html，代码：

```html
<!DOCTYPE html>
<html>
<head>
	<title>系统设置</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
    <script src="../script/v-avatar-2.0.3.min.js"></script>
  <script src="../script/main.js"></script>
</head>
<body>
	<div class="app user setting" id="app">
		<div class="bg">
      <img src="../image/form_bg.png">
    </div>
		<img class="back" @click="back" src="../image/user_back.png" alt="">
    <div class="form">
      <div class="item avatar" @click="open_avatar">
        <span class="title">头像</span>
        <span class="goto">&gt;</span>
        <span class="value">
            <v-avatar v-if="user_info.avatar" :src="user_info.avatar" :size="55" :rounded="true"></v-avatar>
            <v-avatar v-else-if="user_info.nickname" :username="user_info.nickname" :size="55" :rounded="true"></v-avatar>
            <v-avatar v-else :username="user_info.id" :size="55" :rounded="true"></v-avatar>
        </span>
      </div>
      <div class="item" @click="open_nickname">
        <span class="title">昵称</span>
        <span class="goto">&gt;</span>
        <span class="value">{{user_info.nickname}}</span>
      </div>
      <div class="item">
        <span class="title">手机号</span>
        <span class="goto">&gt;</span>
        <span class="value" v-if="user_data.mobile">{{game.mobile(user_data.mobile)}}</span>
      </div>
      <div class="item">
        <span class="title">登陆密码</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">交易密码</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">地址管理</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">设备管理</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item logout">
        <img @click="change_account" src="../image/change_account.png" alt="">
        <p @click="logout">退出账号</p>
      </div>
    </div>
	</div>
	<script>
	apiready = function(){
        Vue.prototype.game = new Game("../mp3/bg1.mp3");
		new Vue({
			el:"#app",
			data(){
				return {
                    user_info:{},  // 本地token中载荷的用户基本信息
                    user_data:{},  // 服务端中用户的详情信息
                }
			},
			created(){
                this.listener();
				this.user_info = this.game.user_info();
                this.get_user_data();
			},
			methods:{
                listener(){
                    // 监听token是否更新
                    this.listener_change_token();
                    
                },
                listener_change_token(){
                    // 监听token更新的处理
                    api.addEventListener({
                        name:'change_token',
                    }, (ret)=>{
                        this.user_info = this.game.user_info();
                    })
                },
                back(){
                    this.game.outFrame();
                },
                change_account(){
                    // 切换账号
                    this.game.goWin("login","login.html"); // 打开登陆窗口
                    setTimeout(()=>{
                        this.back(); // 延时当前窗口
                    },500);
                },
                logout(){
                // 退出账号
                    api.actionSheet({
                        title: '您确认要退出当前登录状态吗？',
                        cancelTitle: '取消',  // 取消按钮，buttonIndex=最后一个值
                        destructiveTitle: "确认退出", // 默认按钮，会自动高亮显示buttonIndex=1
                        // buttons: ['再考虑1下','再考虑2下'] // buttonIndex=2,3,...
                    }, (ret, err)=>{
                        if( ret ){
                            if(ret.buttonIndex==1){
                                this.user_logout()
                            }
                        }
                    });
                },
                user_logout(){
                    // 请求服务端删除登陆状态的access_token
                    let token = this.game.token().access_token;
                    this.axios.post("",{
						"jsonrpc": "2.0",
						"id": this.game.uuid(),
						"method": "Users.logout",
						"params": {}
					},{
                        headers:{
                            Authorization: `jwt ${token}`
                        }
                    }).then(response=>{
                        // 退出登陆成功以后，删除本地token，接着关闭当前用户窗口(window)
                        this.game.deldata(["access_token","refresh_token"]);
                        this.game.delfs(["access_token","refresh_token"]);                        
                        this.game.outWin();
                    }).catch(error=>{

                    })
                },
                get_user_data(){
                    // 获取用户的详情信息
                    let token = this.game.token().access_token;
                    this.axios.post("",{
						"jsonrpc": "2.0",
						"id": this.game.uuid(),
						"method": "Users.info",
						"params": {

						}
					},{
                        headers:{
                            Authorization: `jwt ${token}`
                        }
                    }).then(response=>{
                        this.user_data = response.data.result.data;
                    }).catch(error=>{

                    })
                },
                open_avatar(){
                    // 打开头像更新窗口
                    this.game.goFrame("avatar","avatar.html", null, "from_top");
                },
                open_nickname(){
                    // 打开昵称更新窗口
                    this.game.goFrame("nickname","nickname.html", null, "from_top");
                }
			}
		});
	}
	</script>
</body>
</html>
```

昵称修改页面，`html/nickname.html`，代码：

```html
<!DOCTYPE html>
<html>
<head>
	<title>用户中心</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
	<script src="../script/main.js"></script>
</head>
<body>
	<div class="app frame avatar update_password" id="app">
    <div class="box">
      <p class="title">修改昵称</p>
      <img class="close" @click="back" src="../image/close_btn1.png" alt="">
      <div class="content">
            <input class="password" type="text" v-model="nickname" placeholder="用户昵称....">
      </div>
      <img @click="update_nickname_commit" class="btn" src="../image/yes.png" alt="">
    </div>
	</div>
	<script>
	apiready = function(){
    Vue.prototype.game = new Game("../mp3/bg1.mp3");
        new Vue({
			el:"#app",
			data(){
				return {
                  nickname: "", //昵称
				}
			},
			methods:{
                back(){
                    this.game.outFrame();
                },
                update_nickname_commit(){
                    // 提交用户昵称
                    if(this.nickname.length<1){
                        this.game.tips("用户昵称不能为空！");
                        return false;
                    }

                    if(this.nickname.length<2 || this.nickname.length > 8){
                        this.game.tips("昵称在2~8个字符之间！");
                        return false;
                    }

                    let token = this.game.token().access_token;
                    this.axios.post("",{
                        "jsonrpc": "2.0",
                        "id": this.game.uuid(),
                        "method": "Users.nickname",
                        "params": {
                            "name": this.nickname
                        }
                    },{
                        headers:{
                            Authorization: "jwt " + token,
                        }
                    }).then(response=>{
                        if(response.data.result && response.data.result.errno === 0){
                            // 关闭当前页面
                            this.game.tips("修改昵称成功！");
                            // 通知其他页面token更新了
                            this.game.delfs(["access_token","refresh_token"]);
                            this.game.deldata(["access_token","refresh_token"]);
                            this.game.setdata({
                                "access_token": response.data.result.access_token,
                                "refresh_token": response.data.result.refresh_token
                            });
                            // 通知其他窗口或页面，进行用户信息更新操作
                            api.sendEvent({
                                name: 'change_token',
                                extra: {}
                            });
                            // 关闭当前窗口
                            this.back();
                        }else{
                            this.game.tips("修改昵称失败！");
                        }
                    })

                }
            }
		});
	}
	</script>
</body>
</html>
```

main.css，代码：

```css
input::-webkit-input-placeholder { /* WebKit browsers */
  color: white;
}
.update_nickname .nickname,
.update_password .password
{
  margin: 8rem 4.4rem 4rem;
  width: 19.50rem;
  height: 4rem;
  line-height: 4rem;
  background-color: #cc9966;
  outline: none;
  border: 1px solid #330000;
  text-align: center;
  font-size: 1.5rem;
  color: #ffffcc;
}
.update_password .password{
  margin-top: 5.6rem;
  margin-bottom: 0.4rem;
}
.update_password .password2{
  margin-top: 0.4rem;
}
```



## 登陆密码

### 服务端提供修改登陆密码的api接口

users/api.py，代码：

```python
from .services import check_user_password


@get_user_object
def password(user: User, old_password: str, new_password: str, new_password2: str):
    """
    修改用户登录密码
    :param old_password: 原登录密码
    :param new_password: 登录密码
    :param new_password2:  确认新密码
    """
    # 验证密码和确认密码是否一致
    if new_password != new_password2:
        return {
            "errno": code.CODE_PASSWORD_NOT_MATCH,
            "errmsg": message.password_not_match,
        }

    # 验证旧密码是否正确
    ret = check_user_password(user, old_password)
    if not ret:
        return {
            "errno": code.CODE_PASSWORD_ERROR,
            "errmsg": message.password_error,
        }

    # 修改密码
    update_user(user, {"password": new_password})

    # 返回结果
    return {
        "errno": code.CODE_OK,
        "errmsg": message.ok,
    }


```

users/services.py，代码：

```python
def check_user_password(user: User, password: str) -> bool:
    """
    验证密码是否正确！
    """
    return user.check_password(password)

```

users/urls.py，代码：

```python
from typing import List
from application import path
from . import api

apipatterns: List = [
    path("mobile", api.check_mobile),
    path("register", api.register),
    path("sms", api.sms),
    path("login", api.login),
    path("info", api.info),
    path("refresh", api.refresh),
    path("verify", api.verify),
    path("logout", api.logout),
    path("avatar", api.avatar),
    path("nickname", api.nickname),
    path("password", api.password),
]
```

message.py，代码：

```python
password_error: str = "密码不正确！"
```

code.py，代码：

```python
CODE_PASSWORD_NOT_MATCH: int = 1022 # 密码和确认密码不一致
CODE_PASSWORD_ERROR: int = 1023 # 密码错误！
```



### 客户端实现登陆密码修改功能

配置页面中点击登录密码，进入修改页面。`html/setting.html`，代码：

```html
<!DOCTYPE html>
<html>
<head>
	<title>系统设置</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
    <script src="../script/v-avatar-2.0.3.min.js"></script>
  <script src="../script/main.js"></script>
</head>
<body>
	<div class="app user setting" id="app">
		<div class="bg">
      <img src="../image/form_bg.png">
    </div>
		<img class="back" @click="back" src="../image/user_back.png" alt="">
    <div class="form">
      <div class="item avatar" @click="open_avatar">
        <span class="title">头像</span>
        <span class="goto">&gt;</span>
        <span class="value">
            <v-avatar v-if="user_info.avatar" :src="user_info.avatar" :size="55" :rounded="true"></v-avatar>
            <v-avatar v-else-if="user_info.nickname" :username="user_info.nickname" :size="55" :rounded="true"></v-avatar>
            <v-avatar v-else :username="user_info.id" :size="55" :rounded="true"></v-avatar>
        </span>
      </div>
      <div class="item" @click="open_nickname">
        <span class="title">昵称</span>
        <span class="goto">&gt;</span>
        <span class="value">{{user_info.nickname}}</span>
      </div>
      <div class="item">
        <span class="title">手机号</span>
        <span class="goto">&gt;</span>
        <span class="value" v-if="user_data.mobile">{{game.mobile(user_data.mobile)}}</span>
      </div>
      <div class="item" @click="open_password">
        <span class="title">登陆密码</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">交易密码</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">地址管理</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">设备管理</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item logout">
        <img @click="change_account" src="../image/change_account.png" alt="">
        <p @click="logout">退出账号</p>
      </div>
    </div>
	</div>
	<script>
	apiready = function(){
        Vue.prototype.game = new Game("../mp3/bg1.mp3");
		new Vue({
			el:"#app",
			data(){
				return {
                    user_info:{},  // 本地token中载荷的用户基本信息
                    user_data:{},  // 服务端中用户的详情信息
                }
			},
			created(){
                this.listener();
				this.user_info = this.game.user_info();
                this.get_user_data();
			},
			methods:{
                listener(){
                    // 监听token是否更新
                    this.listener_change_token();
                    
                },
                listener_change_token(){
                    // 监听token更新的处理
                    api.addEventListener({
                        name:'change_token',
                    }, (ret)=>{
                        this.user_info = this.game.user_info();
                    })
                },
                back(){
                    this.game.outFrame();
                },
                change_account(){
                    // 切换账号
                    this.game.goWin("login","login.html"); // 打开登陆窗口
                    setTimeout(()=>{
                        this.back(); // 延时当前窗口
                    },500);
                },
                logout(){
                // 退出账号
                    api.actionSheet({
                        title: '您确认要退出当前登录状态吗？',
                        cancelTitle: '取消',  // 取消按钮，buttonIndex=最后一个值
                        destructiveTitle: "确认退出", // 默认按钮，会自动高亮显示buttonIndex=1
                        // buttons: ['再考虑1下','再考虑2下'] // buttonIndex=2,3,...
                    }, (ret, err)=>{
                        if( ret ){
                            if(ret.buttonIndex==1){
                                this.user_logout()
                            }
                        }
                    });
                },
                user_logout(){
                    // 请求服务端删除登陆状态的access_token
                    let token = this.game.token().access_token;
                    this.axios.post("",{
						"jsonrpc": "2.0",
						"id": this.game.uuid(),
						"method": "Users.logout",
						"params": {}
					},{
                        headers:{
                            Authorization: `jwt ${token}`
                        }
                    }).then(response=>{
                        // 退出登陆成功以后，删除本地token，接着关闭当前用户窗口(window)
                        this.game.deldata(["access_token","refresh_token"]);
                        this.game.delfs(["access_token","refresh_token"]);                        
                        this.game.outWin();
                    }).catch(error=>{

                    })
                },
                get_user_data(){
                    // 获取用户的详情信息
                    let token = this.game.token().access_token;
                    this.axios.post("",{
						"jsonrpc": "2.0",
						"id": this.game.uuid(),
						"method": "Users.info",
						"params": {

						}
					},{
                        headers:{
                            Authorization: `jwt ${token}`
                        }
                    }).then(response=>{
                        this.user_data = response.data.result.data;
                    }).catch(error=>{

                    })
                },
                open_avatar(){
                    // 打开头像更新窗口
                    this.game.goFrame("avatar","avatar.html", null, "from_top");
                },
                open_nickname(){
                    // 打开昵称更新窗口
                    this.game.goFrame("nickname","nickname.html", null, "from_top");
                },
                open_password(){
                    // 打开更新登陆密码窗口
                    this.game.goFrame("password","password.html", null, "from_top");
                }
			}
		});
	}
	</script>
</body>
</html>
```



密码修改窗口，`html/password.html`，代码：

```html
<!DOCTYPE html>
<html>
<head>
	<title>用户中心</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
	<script src="../script/main.js"></script>
</head>
<body>
	<div class="app frame avatar update_password" id="app">
    <div class="box">
      <p class="title">修改密码</p>
      <img class="close" @click="back" src="../image/close_btn1.png" alt="">
      <div class="content">
        <input class="password" type="password" v-model="old_password" placeholder="原密码....">
        <input class="password password2" type="password" v-model="password" placeholder="新密码....">
        <input class="password password2" type="password" v-model="password2" placeholder="确认新密码....">
      </div>
      <img @click="update_password_commit" class="btn" src="../image/yes.png" alt="">
    </div>
	</div>
	<script>
	apiready = function(){
    Vue.prototype.game = new Game("../mp3/bg1.mp3");
    new Vue({
			el:"#app",
			data(){
				return {
                    old_password: "", //原密码
                    password:"",
                    password2:"",
				}
			},
			methods:{
                back(){
                    this.game.outFrame();
                },
                update_password_commit(){
                    // 提交用户登陆密码
                    if(this.old_password.length<1 || this.password.length<1){
                        this.game.tips("原密码或新密码不能为空！");
                        return false;
                    }

                    if(this.password.length<6 || this.password.length > 16){
                        this.game.tips("新密码长度在6~16个字符之间！");
                        return false;
                    }

                    if(this.password != this.password2){
                        this.game.tips("新密码或确认新密码不一致！");
                        return false;
                    }

                    let token = this.game.token().access_token;
                    this.axios.post("",{
						"jsonrpc": "2.0",
						"id": this.game.uuid(),
						"method": "Users.password",
						"params": {
                            "old_password": this.old_password,
                            "new_password": this.password,
                            "new_password2": this.password2
						}
					},{
                        headers:{
                            Authorization: "jwt " + token,
                        }
                    }).then((response)=>{
                        if(response.data.result && response.data.result.errno === 0){
                            // 关闭当前页面
                            this.game.tips("修改登陆密码成功！");
                            this.back();
                        }else{
                            this.game.tips("修改登陆密码失败！");
                        }
                    });
                }
			}
		});
	}
	</script>
</body>
</html>
```



## 交易密码

交易密码有别于登陆密码，用于用户交易、提现。

因为刚注册的用户是没有初始化交易密码的。所以我们可以提示用户，如果没有交易密码，则不需要填写。

`html/transaction_password.html`，代码：

```html
<!DOCTYPE html>
<html>
<head>
	<title>用户中心</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
	<script src="../script/main.js"></script>
</head>
<body>
	<div class="app frame avatar update_password" id="app">
    <div class="box">
      <p class="title">修改密码</p>
      <img class="close" @click="back" src="../image/close_btn1.png" alt="">
      <div class="content">
        <input class="password" type="password" v-model="old_password" placeholder="如果没有密码，则留空....">
        <input class="password password2" type="password" v-model="password" placeholder="新密码....">
        <input class="password password2" type="password" v-model="password2" placeholder="确认新密码....">
      </div>
      <img @click="update_password_commit" class="btn" src="../image/yes.png" alt="">
    </div>
	</div>
	<script>
	apiready = function(){
    Vue.prototype.game = new Game("../mp3/bg1.mp3");
    new Vue({
			el:"#app",
			data(){
				return {
                    old_password: "", //原密码
                    password:"",
                    password2:"",
				}
			},
			methods:{
                back(){
                    this.game.outFrame();
                },
                update_password_commit(){
                    // 提交用户交易密码
                    if(this.password.length<1){
                        this.game.tips("新密码不能为空！");
                        return false;
                    }

                    if(this.password.length<6 || this.password.length > 16){
                        this.game.tips("新密码长度在6~16个字符之间！");
                        return false;
                    }

                    if(this.password != this.password2){
                        this.game.tips("新密码或确认新密码不一致！");
                        return false;
                    }

                    let token = this.game.token().access_token;
                    this.axios.post("",{
						"jsonrpc": "2.0",
						"id": this.game.uuid(),
						"method": "Users.transaction_password",
						"params": {
                            "old_password": this.old_password,
                            "new_password": this.password,
                            "new_password2": this.password2
						}
					},{
                        headers:{
                            Authorization: "jwt " + token,
                        }
                    }).then((response)=>{
                        if(response.data.result && response.data.result.errno === 0){
                            // 关闭当前页面
                            this.game.tips("修改交易密码成功！");
                            this.back();
                        }else{
                            this.game.tips("修改交易密码失败！");
                        }
                    });
                }
			}
		});
	}
	</script>
</body>
</html>
```

用户在系统设置页面中，点击交易密码，显示交易密码的修改页面，html/setting.html，代码：

```html
<!DOCTYPE html>
<html>
<head>
	<title>系统设置</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
    <script src="../script/v-avatar-2.0.3.min.js"></script>
  <script src="../script/main.js"></script>
</head>
<body>
	<div class="app user setting" id="app">
		<div class="bg">
      <img src="../image/form_bg.png">
    </div>
		<img class="back" @click="back" src="../image/user_back.png" alt="">
    <div class="form">
      <div class="item avatar" @click="open_avatar">
        <span class="title">头像</span>
        <span class="goto">&gt;</span>
        <span class="value">
            <v-avatar v-if="user_info.avatar" :src="user_info.avatar" :size="55" :rounded="true"></v-avatar>
            <v-avatar v-else-if="user_info.nickname" :username="user_info.nickname" :size="55" :rounded="true"></v-avatar>
            <v-avatar v-else :username="user_info.id" :size="55" :rounded="true"></v-avatar>
        </span>
      </div>
      <div class="item" @click="open_nickname">
        <span class="title">昵称</span>
        <span class="goto">&gt;</span>
        <span class="value">{{user_info.nickname}}</span>
      </div>
      <div class="item">
        <span class="title">手机号</span>
        <span class="goto">&gt;</span>
        <span class="value" v-if="user_data.mobile">{{game.mobile(user_data.mobile)}}</span>
      </div>
      <div class="item" @click="open_password">
        <span class="title">登陆密码</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item" @click="open_transaction_password">
        <span class="title">交易密码</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">地址管理</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">设备管理</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item logout">
        <img @click="change_account" src="../image/change_account.png" alt="">
        <p @click="logout">退出账号</p>
      </div>
    </div>
	</div>
	<script>
	apiready = function(){
        Vue.prototype.game = new Game("../mp3/bg1.mp3");
		new Vue({
			el:"#app",
			data(){
				return {
                    user_info:{},  // 本地token中载荷的用户基本信息
                    user_data:{},  // 服务端中用户的详情信息
                }
			},
			created(){
                this.listener();
				this.user_info = this.game.user_info();
                this.get_user_data();
			},
			methods:{
                listener(){
                    // 监听token是否更新
                    this.listener_change_token();
                    
                },
                listener_change_token(){
                    // 监听token更新的处理
                    api.addEventListener({
                        name:'change_token',
                    }, (ret)=>{
                        this.user_info = this.game.user_info();
                    })
                },
                back(){
                    this.game.outFrame();
                },
                change_account(){
                    // 切换账号
                    this.game.goWin("login","login.html"); // 打开登陆窗口
                    setTimeout(()=>{
                        this.back(); // 延时当前窗口
                    },500);
                },
                logout(){
                // 退出账号
                    api.actionSheet({
                        title: '您确认要退出当前登录状态吗？',
                        cancelTitle: '取消',  // 取消按钮，buttonIndex=最后一个值
                        destructiveTitle: "确认退出", // 默认按钮，会自动高亮显示buttonIndex=1
                        // buttons: ['再考虑1下','再考虑2下'] // buttonIndex=2,3,...
                    }, (ret, err)=>{
                        if( ret ){
                            if(ret.buttonIndex==1){
                                this.user_logout()
                            }
                        }
                    });
                },
                user_logout(){
                    // 请求服务端删除登陆状态的access_token
                    let token = this.game.token().access_token;
                    this.axios.post("",{
						"jsonrpc": "2.0",
						"id": this.game.uuid(),
						"method": "Users.logout",
						"params": {}
					},{
                        headers:{
                            Authorization: `jwt ${token}`
                        }
                    }).then(response=>{
                        // 退出登陆成功以后，删除本地token，接着关闭当前用户窗口(window)
                        this.game.deldata(["access_token","refresh_token"]);
                        this.game.delfs(["access_token","refresh_token"]);                        
                        this.game.outWin();
                    }).catch(error=>{

                    })
                },
                get_user_data(){
                    // 获取用户的详情信息
                    let token = this.game.token().access_token;
                    this.axios.post("",{
						"jsonrpc": "2.0",
						"id": this.game.uuid(),
						"method": "Users.info",
						"params": {

						}
					},{
                        headers:{
                            Authorization: `jwt ${token}`
                        }
                    }).then(response=>{
                        this.user_data = response.data.result.data;
                    }).catch(error=>{

                    })
                },
                open_avatar(){
                    // 打开头像更新窗口
                    this.game.goFrame("avatar","avatar.html", null, "from_top");
                },
                open_nickname(){
                    // 打开昵称更新窗口
                    this.game.goFrame("nickname","nickname.html", null, "from_top");
                },
                open_password(){
                    // 打开更新登陆密码窗口
                    this.game.goFrame("password","password.html", null, "from_top");
                },
                open_transaction_password(){
                    // 打开更新登陆密码窗口
                    this.game.goFrame("transaction_password","transaction_password.html", null, "from_top");
                }
			}
		});
	}
	</script>
</body>
</html>
```

服务端调整用户模型，并实现交易密码的api接口代码，

users/models.py，代码：

```python
from application.utils.models import BaseModel, db
from werkzeug.security import generate_password_hash, check_password_hash


class User(BaseModel):
    """用户基本信息表"""
    __tablename__ = "mf_user"
    name = db.Column(db.String(255), index=True, comment="用户账户")
    nickname = db.Column(db.String(255), comment="用户昵称")
    _password = db.Column(db.String(255), comment="登录密码")
    _transaction_password = db.Column(db.String(255), default="", comment="交易密码")
    age = db.Column(db.SmallInteger, comment="年龄")
    money = db.Column(db.Numeric(10, 2), default=0.0, comment="账户余额")
    credit = db.Column(db.Numeric(10, 2), default=0.0, comment="积分余额")
    ip_address = db.Column(db.String(255), default="", index=True, comment="登录IP")
    intro = db.Column(db.String(500), default="", comment="个性签名")
    avatar = db.Column(db.String(255), default="", comment="头像url地址")
    sex = db.Column(db.SmallInteger, default=0, comment="性别")  # 0表示未设置,保密, 1表示男,2表示女
    email = db.Column(db.String(32), index=True, default="", nullable=False, comment="邮箱地址")
    mobile = db.Column(db.String(32), index=True, nullable=False, comment="手机号码")
    unique_id = db.Column(db.String(255), index=True, default="", comment="客户端唯一标记符")
    province = db.Column(db.String(255), default="", comment="省份")
    city = db.Column(db.String(255), default="", comment="城市")
    area = db.Column(db.String(255), default="", comment="地区")
    info = db.relationship("UserProfile", uselist=False, backref="user", primaryjoin="User.id==UserProfile.user_id", foreign_keys="UserProfile.user_id")

    # 存取器
    @property
    def password(self):  # user.password
        return self._password

    @password.setter
    def password(self, rawpwd: str):  # user.password = '123456'
        """密码加密"""
        self._password = generate_password_hash(rawpwd)

    def check_password(self, rawpwd: str):
        """验证密码"""
        return check_password_hash(self.password, rawpwd)

    @property
    def transaction_password(self): # user.transaction_password
        return self._transaction_password

    @transaction_password.setter # # user.transaction_password = '123456'
    def transaction_password(self, rawpwd):
        """密码加密"""
        self._transaction_password = generate_password_hash(rawpwd)

    def check_transaction_password(self, rawpwd):
        """验证交易密码"""
        return check_password_hash(self.transaction_password, rawpwd)


class UserProfile(BaseModel):
    """用户详情信息表"""
    __tablename__ = "mf_user_profile"
    user_id = db.Column(db.Integer, index=True, comment="用户ID")
    education = db.Column(db.Integer, comment="学历教育")
    middle_school = db.Column(db.String(255), default="", comment="初中/中专")
    high_school = db.Column(db.String(255), default="", comment="高中/高职")
    college_school = db.Column(db.String(255), default="", comment="大学/大专")
    profession_cate = db.Column(db.String(255), default="", comment="职业类型")
    profession_info = db.Column(db.String(255), default="", comment="职业名称")
    position = db.Column(db.SmallInteger, default=0, comment="职位/职称")
    emotion_status = db.Column(db.SmallInteger, default=0, comment="情感状态")
    birthday = db.Column(db.DateTime, default="", comment="生日")
    hometown_province = db.Column(db.String(255), default="", comment="家乡省份")
    hometown_city = db.Column(db.String(255), default="", comment="家乡城市")
    hometown_area = db.Column(db.String(255), default="", comment="家乡地区")
    hometown_address = db.Column(db.String(255), default="", comment="家乡地址")
    living_province = db.Column(db.String(255), default="", comment="现居住省份")
    living_city = db.Column(db.String(255), default="", comment="现居住城市")
    living_area = db.Column(db.String(255), default="", comment="现居住地区")
    living_address = db.Column(db.String(255), default="", comment="现居住地址")


"""
 外界开发中，不过是SQLAlachemy或者django的ORM，大部分的公司都会放弃使用外键约束来关联查询数据库表。
 因为外键约束，在数据库操作过程中，需要消耗额外的维护成本来管理这个外键关系。因此在大数据的查询中，一般都会设置成逻辑外键[虚拟外键]。数据库本身维护的外键一般我们称之为 "物理外键".
"""
```

在数据库中，基于alter语句新增数据表的字段：

```sql
alter table mf_user add _transaction_password  varchar(255) default "" after _password;
```

users/api.py，代码：

```python

@get_user_object
def transaction_password(user: User, old_password: str, new_password: str, new_password2: str):
    """
    修改用户登录密码
    :param old_password: 原登录密码
    :param new_password: 登录密码
    :param new_password2:  确认新密码
    """
    # 验证新密码和确认密码是否一致
    if new_password != new_password2:
        return {
            "errno": code.CODE_PASSWORD_NOT_MATCH,
            "errmsg": message.password_not_match,
        }

    # 验证旧密码是否正确
    ret = check_user_transaction_password(user, old_password)
    if not ret:
        return {
            "errno": code.CODE_PASSWORD_ERROR,
            "errmsg": message.password_error,
        }

    # 修改密码
    update_user(user, {"transaction_password": new_password})

    # 返回结果
    return {
        "errno": code.CODE_OK,
        "errmsg": message.ok,
    }

```

users/services.py，代码：

```python
def check_user_transaction_password(user: User, password: str) -> bool:
    """
    验证交易密码是否正确！
    """
    # 因为新用户默认时没有交易密码的，所以默认交易为空字符，因此当用户的交易密码为空字符时，则默认验证通过
    if user.transaction_password == "":
        return True

    return user.check_transaction_password(password)

```

users/urls.py，代码：

```python
from typing import List
from application import path
from . import api

apipatterns: List = [
    path("mobile", api.check_mobile),
    path("register", api.register),
    path("sms", api.sms),
    path("login", api.login),
    path("info", api.info),
    path("refresh", api.refresh),
    path("verify", api.verify),
    path("logout", api.logout),
    path("avatar", api.avatar),
    path("nickname", api.nickname),
    path("password", api.password),
    path("transaction_password", api.transaction_password),
]
```

提交版本

```bash
git add .
git commit -m "fix: update user's password"
git push
```
