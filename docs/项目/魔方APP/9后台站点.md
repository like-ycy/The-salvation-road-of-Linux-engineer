## flask-Admin构建和配置后台运营站点管理用户信息

### Flask-Admin

这是类似django-admin的运营站点，但是没有django-admin的那么多功能。

文档：https://flask-admin.readthedocs.io/en/latest/

#### 安装

```bash
pip install flask-admin
```

##### 模块初始化

`application/__init__.py`，代码：

```python
# 项目初始化[主程文件]
import os
from flask import Flask
from flask_script import Manager
from flask_sqlalchemy import SQLAlchemy
from flask_redis import FlaskRedis
from flask_session import Session
from flask_migrate import Migrate,MigrateCommand
from flask_jsonrpc import JSONRPC
from faker import Faker
from flask_jwt_extended import JWTManager
from flask_admin import Admin

from application.utils.config import load_config
from application.utils.session import init_session
from application.utils.logger import Log
from application.utils.commands import load_command
from application.utils import init_blueprint
from application.utils.language.message_text import Message as message
from application.utils.language.status_number import Status as status
# 创建数据库链接对象
db = SQLAlchemy()

# redis链接对象
redis = FlaskRedis()

# Session存储对象
session_store = Session()

# 数据迁移实例对象
migrate = Migrate()

# 日志对象
log = Log()

# 初始化jsonrpc模块
jsonrpc = JSONRPC(service_url='/api')

faker = Faker(locale="zh_CN")

# jwt认证模块实例化
jwt = JWTManager()

# flask-admin模块初始化
admin = Admin()

def init_app(config_path):

    app = Flask(__name__)

    # 项目根目录
    app.BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
    # import sys
    # sys.path.append(os.path.join(app.BASE_DIR, "application/utils/language"))
    # 加载配置
    app.config.from_object(load_config(config_path))

    # 初始化终端脚本工具
    manager = Manager()
    manager.app = app

    # 数据库
    db.init_app(app)
    redis.init_app(app)

    # session存储初始化
    init_session(app)
    session_store.init_app(app)

    # 数据迁移初始化
    migrate.init_app(app,db)
    # 添加数据迁移的命令到终端脚本工具中
    manager.add_command('db', MigrateCommand)

    # 日志初始化
    app.log = log.init_app(app)

    # 注册自定义命令
    load_command(manager)

    # 初始化json-rpc
    app.jsonrpc = jsonrpc
    jsonrpc.init_app(app)

    # jwt初始化
    jwt.init_app(app)

    # 注册蓝图
    init_blueprint(app)

    # admin站点
    admin.name = app.config['FLASK_ADMIN_NAME']
    admin.template_mode = app.config['TEMPLATE_MODE']
    admin.init_app(app)

    return manager
```

`settings/__init__`，代码：

```python
    # 运营站点配置信息
    FLASK_ADMIN_SWATCH = 'cerulean'
    FLASK_ADMIN_NAME = "魔方App"
    TEMPLATE_MODE = "bootstrap3"
```

直接访问：http://127.0.0.1:5000/admin，效果如下：

![image-20210926095014788](9%E5%90%8E%E5%8F%B0%E7%AB%99%E7%82%B9.assets/image-20210926095014788.png)

可以发现上面什么都没有,就一个Home首页导航.

测试代码，我们可以在users的任意一个文件中，编写一段**官方提供的基于模型生成后台视图功能的代码**，这里我们先写在`users/__init__.py`里面。

```python
from application import admin,db
from .models import User
from flask_admin.contrib.sqla import ModelView
admin.add_view(ModelView(User, db.session))
```

访问admin后台，效果如下：

![image-20210926095235916](9%E5%90%8E%E5%8F%B0%E7%AB%99%E7%82%B9.assets/image-20210926095235916.png)



#### 模块配置

因为后台站点的相关代码肯定很多，页面也多，所以我们把每一个蓝图下关于admin站点相关配置的代码编写在每一个蓝图下的`admin.py` 中,并且在蓝图初始化中进行自动加载.

`application/utils/blueprint.py`，代码：

```python
from types import ModuleType
from typing import List, Callable, Dict, Union
from flask import Flask, Blueprint
from importlib import import_module  # 可以根据字符串路径完成导报操作
from flask_jsonrpc import JSONRPC


def register_blueprint(app: Flask, jsonrpc: JSONRPC):
    """自动注册蓝图的工具函数"""
    # 从配置文件中读取需要注册到项目中的蓝图路径信息
    blueprint_path_list: List = app.config.get("INSTALL_BLUEPRINT", [])

    # 从配置文件中读取总路由模块
    app_urls_path: str = app.config.get("URL_PATH", "application.urls")
    # 总路由模块
    app_urls_module: ModuleType = import_module(app_urls_path)

    # 总路由列表
    if not hasattr(app_urls_module, "urlpatterns"):
        app.logger.error("总路由文件URL_PATH，没有路由列表！")
        raise Exception("总路由文件URL_PATH，没有路由列表！")

    app_urlpatterns: List = app_urls_module.urlpatterns

    # 遍历蓝图路径列表，对每一个蓝图进行初始化
    for blueprint_path in blueprint_path_list:
        # 获取蓝图路径中最后一段的包名作为蓝图的名称
        blueprint_name: str = blueprint_path.split(".")[-1]
        # 创建蓝图对象
        blueprint: Blueprint = Blueprint(blueprint_name, blueprint_path)

        # 蓝图路由的前缀
        url_prefix: str = ""

        # 蓝图下注册普通视图的子路由列表
        urlpatterns: List = []

        # 蓝图下注册api视图的子路由列表
        apipatterns: List = []

        # 获取蓝图的父级目录，目的是为了拼接总路由中所有蓝图下的urls子路由文件的路径
        blueprint_father_path: str = ".".join(blueprint_path.split(".")[:-1])

        # 循环总路由列表
        for item in app_urlpatterns:
            # 判断当前蓝图是否有注册到总路由中提供对外访问，如果没有把蓝图注册到总路由中，则无法被外界访问。
            if blueprint_name in item["blueprint_url_subffix"]:
                # 导入当前蓝图下的子路由模块
                urls_module: ModuleType = import_module(f"{blueprint_father_path}.{item['blueprint_url_subffix']}")
                if hasattr(urls_module, "urlpatterns"):
                    # 获取子路由文件中的路由列表
                    urlpatterns = urls_module.urlpatterns
                # 获取urls模块下api列表apiurlpatterns
                if hasattr(urls_module, "apipatterns"):
                    apipatterns = urls_module.apipatterns

                # 提取蓝图路由的前缀
                url_prefix = item["url_prefix"]
                # 从总路由中查到当前蓝图对象的前缀就不要继续往下遍历了
                # 把urlpatterns的每一个路由信息添加注册到蓝图对象里面
                for url in urlpatterns:
                    blueprint.add_url_rule(**url)
                break

        # 把urlpatterns的每一个路由信息添加注册到蓝图对象里面
        for url in urlpatterns:
            blueprint.add_url_rule(**url)

        # 把apipatterns的每一个路由信息添加注册到JSONRPC对象里面
        for api in apipatterns:
            name = api.pop("rule")
            if len(url_prefix) > 0:
                api["name"] = f"{url_prefix[1:].title()}.{name}"
            else:
                api["name"] = name
            jsonrpc.register_view_function(**api)

        try:
            # 让蓝图自动发现模型模块
            import_module(f"{blueprint_path}.models")
        except ModuleNotFoundError:
            pass

        try:
            # 让蓝图自动发现admin配置模块
            import_module(f"{blueprint_path}.admin")
        except ModuleNotFoundError:
            pass

        # 把蓝图对象注册到app实例对象
        # url_prefix 是蓝图下所有子路由的地址前缀
        app.register_blueprint(blueprint, url_prefix=url_prefix)


def path(rule: str, name: Union[Callable, str], **kwargs) -> Dict:
    """
    绑定url地址和视图的映射关系
    :param rule: 视图路由或者蓝图路由前缀
    :param name: 视图函数名称或者蓝图名称，
           当name是一个蓝图的名称时，
           格式：蓝图包名.路由模块名
           例如：蓝图目录是home, 路由模块名是urls，则参数：home.urls
    :return: Dict
    """
    if isinstance(name, Callable):
        return {"rule": rule, "view_func": name, **kwargs}
    elif isinstance(name, str):
        return {"url_prefix": rule, "blueprint_url_subffix": name, **kwargs }
    else:
        return {}


class APIView(object):
    """视图基类"""
    @classmethod
    def as_view(cls, func):
        if hasattr(cls, func):
            obj = cls()
            return getattr(obj, func)
```

把上面编写在`users/__init__.py`中的admin站点配置代码，转义到`users/admin.py`中，并重新启动项目。

```python
from application import admin, db
from .models import User
from flask_admin.contrib.sqla import ModelView
admin.add_view(ModelView(User, db.session))
```

改造原来的blue创建蓝图命令，`application.utils.commands`，代码：

```python
import click, os
from typing import Optional
from flask import Flask

class Command(object):
    """命令管理类"""
    def __init__(self, app: Optional[Flask] = None):
        if app is not None:
            self.init_app(app)

    def init_app(self, app: Flask):
        self.app: Flask = app
        self.setup()

    def setup(self):
        """初始化终端命令"""
        self.blueprint()  # 自动创建蓝图目录和文件

    def blueprint(self):
        """蓝图生成命令"""
        @self.app.cli.command("blue")  # 指定终端命令的调用名称
        @click.option("--name", default="home", help="蓝图目录名称", type=str)
        def create_blueprint(name: str):
            # 生成蓝图名称对象的目录
            os.mkdir(name)
            open("%s/__init__.py" % name, "w")
            open("%s/ws.py" % name, "w")  # websocket的视图文件
            open("%s/admin.py" % name, "w")  # admin运营站点配置文件
            open("%s/api.py" % name, "w")  # api接口的视图文件
            open("%s/views.py" % name, "w")  # 普通视图文件
            open("%s/models.py" % name, "w")
            open("%s/documents.py" % name, "w")
            open("%s/urls.py" % name, "w")  # 视图路由
            open("%s/test.py" % name, "w")
            open("%s/tasks.py" % name, "w")
            open("%s/serializers.py" % name, "w")  # 序列化器文件

            print("蓝图[%s]创建完成...." % name)
```

提交版本

```bash
git add .
git commit -m "基于flask-admin搭建admin运营站点"
git push
```



#### 快速使用

##### 修改默认首页

在项目入口程序`applicaiton/__init__.py`中，对admin站点的默认首页重写内容主体模板，代码：

```python
# 先解析器内置，后框架官方，然后第三方模块，接着是自己封装的模块。
import os

from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_redis import FlaskRedis
from flask_session import Session
from flask_jsonrpc import JSONRPC
from flask_marshmallow import Marshmallow
from celery import Celery
from flask_jwt_extended import JWTManager
from flask_cors import CORS
from flask_admin import Admin, AdminIndexView

from application.utils.config import init_config
from application.utils.logger import Log
from application.utils.commands import Command
from application.utils.blueprint import register_blueprint, path, include
from application.utils import message, status
# SQLAlchemy初始化
db = SQLAlchemy()

# redis初始化
redis_cache = FlaskRedis(config_prefix="REDIS")
redis_check = FlaskRedis(config_prefix="CHECK")
redis_session = FlaskRedis(config_prefix="SESSION")

# session存储配置初始化
session_store = Session()

# 自定义日志初始化
logger = Log()

# 自定义终端命令初始化
command = Command()

# jsonrpc初始化
jsonrpc = JSONRPC()

# 序列化转换器的初始化
ma = Marshmallow()

# celery初始化
celery = Celery()


# jwt认证模块实例化
jwt = JWTManager()

# 跨域资源共享
cors = CORS(supports_credentials=False)

# flask-admin模块初始化
admin = Admin()

def init_app(config_path):
    """用于创建app实例对象并完成初始化过程的工厂函数"""
    app = Flask(__name__)
    # 当前项目根目录
    app.BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

    # 加载配置
    init_config(app, config_path)
    # print(app.config)

    # SQLAlchemy加载配置
    db.init_app(app)
    ma.init_app(app)

    # redis加载配置
    redis_cache.init_app(app)
    redis_check.init_app(app)
    redis_session.init_app(app)

    # session保存数据到redis时启用的链接对象
    app.config["SESSION_REDIS"] = redis_session
    # session存储配置类加载配置
    session_store.init_app(app)

    # 日志加载配置
    log = logger.init_app(app)
    app.log = log

    # 自定义终端命令初始化
    command.init_app(app)

    # jsonrpc注册到项目中
    # 开启rpc接口的web调试界面：/api/browse
    jsonrpc.browse_url = app.config.get("API_BROWSE_URL", "/api/browse")
    jsonrpc.enable_web_browsable_api = app.config.get("DEBUG", False)
    jsonrpc.init_app(app)

    # 自动注册蓝图
    register_blueprint(app, jsonrpc)

    # 加载celery配置
    celery.main = app.name
    celery.app = app
    # 更新配置
    celery.conf.update(app.config)
    # 自动注册任务
    celery.autodiscover_tasks(app.config.get("INSTALL_BLUEPRINT"))

    # jwt初始化
    jwt.init_app(app)

    # 跨域资源共享
    cors.init_app(app)

    # admin站点
    admin.name = app.config['FLASK_ADMIN_NAME']
    admin.template_mode = app.config['TEMPLATE_MODE']
    admin._set_admin_index_view(index_view=AdminIndexView(
        name=app.config["ADMIN_HOME_NAME"],
        template=app.config["ADMIN_HOME_TEMPLATE"],
    ))
    admin.init_app(app)
    
    # db创建数据表
    with app.app_context():
        db.create_all()

    return app
```

`setttings.__init__`，代码：

```python
ADMIN_HOME_NAME = "首页"  # 后台默认首页的导航名称
ADMIN_HOME_TEMPLATE = "admin/index.html" # 后台默认首页的模板路径
```

在application下新增模板目录templates,并新增模板文件目录admin,并在admin目录下创建运营站点的首页模板文件index.html，代码:

```python
{% extends 'admin/master.html' %}
{% block body %}

    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="#">Home</a></li>
      </ol>
    </nav>

    <table class="table">
      <thead class="thead-dark">
        <tr>
          <th scope="col">#</th>
          <th scope="col">First</th>
          <th scope="col">Last</th>
          <th scope="col">Handle</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th scope="row">1</th>
          <td>Mark</td>
          <td>Otto</td>
          <td>@mdo</td>
        </tr>
        <tr>
          <th scope="row">2</th>
          <td>Jacob</td>
          <td>Thornton</td>
          <td>@fat</td>
        </tr>
        <tr>
          <th scope="row">3</th>
          <td>Larry</td>
          <td>the Bird</td>
          <td>@twitter</td>
        </tr>
      </tbody>
    </table>

    <table class="table">
      <thead class="thead-light">
        <tr>
          <th scope="col">#</th>
          <th scope="col">First</th>
          <th scope="col">Last</th>
          <th scope="col">Handle</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th scope="row">1</th>
          <td>Mark</td>
          <td>Otto</td>
          <td>@mdo</td>
        </tr>
        <tr>
          <th scope="row">2</th>
          <td>Jacob</td>
          <td>Thornton</td>
          <td>@fat</td>
        </tr>
        <tr>
          <th scope="row">3</th>
          <td>Larry</td>
          <td>the Bird</td>
          <td>@twitter</td>
        </tr>
      </tbody>
    </table>
{% endblock %}
```

直接访问admin站点后台查看效果。要修改页面效果，可以到bootstrap4.0的官方查找对应的html代码，直接复制黏贴即可。

bs4地址：https://v4.bootcss.com/docs/getting-started/introduction/



##### 新增自定义导航

给admin站点新增一个用户导航，在`application/templates/admin/`下新增users模板目录,并创建index.html模板文件，

templates/admin/users/index.html，代码：

```html
{% extends 'admin/master.html' %}
{% block body %}
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item" aria-current="page">首页</li>
        <li class="breadcrumb-item active" aria-current="page">用户管理</li>
      </ol>
    </nav>
    <table class="table">
      <thead class="thead-dark">
        <tr>
          <th scope="col">id</th>
          <th scope="col">手机号码</th>
          <th scope="col">用户名</th>
          <th scope="col">余额</th>
        </tr>
      </thead>
      <tbody>
      {% for data in data_list %}
        <tr>
          <th scope="row">{{ data.id }}</th>
          <td>{{ data.mobile }}</td>
          <td>{{ data.name }}</td>
          <td>{{ data.money }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
{% endblock %}
```

在`application/apps/users/admin.py`admin站点配置文件，把上面模板加载到admin导航菜单中，代码：

```python
# 注册User模型，自动生成站点管理功能
from application import admin, db
from .models import User
from flask_admin.contrib.sqla import ModelView
admin.add_view(ModelView(User, db.session))

from application.utils.admin import AdminBaseView, expose
from .models import User

class UserAdmin(AdminBaseView):
    """自定义一个导航页面"""
    @expose("/")
    def index(self):
        title = "admin站点用户相关的内容"
        data_list = User.query.all()
        return self.ret("admin/users/index.html", locals())

admin.add_view(UserAdmin(name='用户',url="users"))
```

`application.utils.admin`，创建一个视图基类，专门收集视图中的所有变量，代码：

```python
from flask_admin import BaseView,expose

class AdminBaseView(BaseView):
    def ret(self, template, data):
        data.pop("self")
        return self.render(template=template,**data)
```

重新运行项目,效果如下：

![image-20211111170728854](9%E5%90%8E%E5%8F%B0%E7%AB%99%E7%82%B9.assets/image-20211111170728854.png)



##### 注册模型生成功能页面

`application/apps/users/admin.py`，代码：

```python
from application import admin, db
from .models import User
from flask_admin.contrib.sqla import ModelView
from application.utils.admin import AdminBaseView, expose


class UserAdmin(AdminBaseView):
    """自定义一个导航页面"""
    @expose("/")
    def index(self):
        title = "admin站点用户相关的内容"
        data_list = User.query.all()
        return self.ret("admin/users/index.html", locals())

admin.add_view(UserAdmin(name='自定义用户导航页面',url="users"))


class UserModelView(ModelView):
    """模型管理器"""
    # 列表页显示字段列表
    column_list = ["id", "name", "sex", "nickname", "mobile", "email"]
    # 字段别名
    column_labels = {
        "id": 'ID',
        "name": '用户名',
        "mobile": '手机号',
        "nickname": "昵称",
        "money": "余额",
        "age": "年龄",
        "credit": "积分",
        "email": "邮箱",
        "orders": "排序",
        "sex": "性别",
        "created_time": "添加时间",
        "updated_time": "更新时间",
    }
    # 列表页显示排除字段列表，与column_list互斥
    # column_exclude_list = ["is_delete", "_password", "age", "ip_address"]

    # 列表页可以直接编辑的字段列表
    column_editable_list = ["nickname", "sex"]
    # 是否允许查看详情
    can_view_details = True
    # 列表页显示直接可以搜索数据的字典
    column_searchable_list = ['nickname', 'name', 'email']
    # 过滤器
    column_filters = ['sex']
    # 单页显示数据量【显示分页】
    page_size = 2



# 根据模型生成模型管理数据的界面，还可以增加配置信息的
# admin.add_view(UserModelView(User, db.session, name="用户管理"))

admin.add_view(UserModelView(User, db.session, name="用户信息", url="user", category="用户管理"))


# 还可以增加外部导航连接
# 添加子导航还有2种方式：
# 把超链接作为子导航加载到顶级导航中
from flask_admin.menu import MenuLink
# 把超链接作为顶级导航显示
# admin.add_link(MenuLink(name='老男孩', url='http://www.oldboyedu.com'))
# 把超链接作为指定顶级导航下的子导航显示
admin.add_link(MenuLink(name='老男孩', url='http://www.oldboyedu.com', category='用户管理'))
```



##### 国际化与本地化

`flask-babelex`是Flask 的翻译扩展工具，在项目安装配置，可以实现中文显示。方便我们管理admin后台站点。

安装模块

```bash
pip install flask-babelex -i https://pypi.douban.com/simple
```

模块初始化`application/__init__.py`，代码：

```python
# 先解析器内置，后框架官方，然后第三方模块，接着是自己封装的模块。
import os

from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_redis import FlaskRedis
from flask_session import Session
from flask_jsonrpc import JSONRPC
from flask_marshmallow import Marshmallow
from celery import Celery
from flask_jwt_extended import JWTManager
from flask_cors import CORS
from flask_admin import Admin, AdminIndexView
from flask_babelex import Babel

from application.utils.config import init_config
from application.utils.logger import Log
from application.utils.commands import Command
from application.utils.blueprint import register_blueprint, path, include
from application.utils import message, status
# SQLAlchemy初始化
db = SQLAlchemy()

# redis初始化
redis_cache = FlaskRedis(config_prefix="REDIS")
redis_check = FlaskRedis(config_prefix="CHECK")
redis_session = FlaskRedis(config_prefix="SESSION")

# session存储配置初始化
session_store = Session()

# 自定义日志初始化
logger = Log()

# 自定义终端命令初始化
command = Command()

# jsonrpc初始化
jsonrpc = JSONRPC()

# 序列化转换器的初始化
ma = Marshmallow()

# celery初始化
celery = Celery()


# jwt认证模块实例化
jwt = JWTManager()

# 跨域资源共享
cors = CORS(supports_credentials=False)

# flask-admin模块初始化
admin = Admin()

# 国际化/本地化配置初始化
babel = Babel()

def init_app(config_path):
    """用于创建app实例对象并完成初始化过程的工厂函数"""
    app = Flask(__name__)
    # 当前项目根目录
    app.BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

    # 加载配置
    init_config(app, config_path)
    # print(app.config)

    # SQLAlchemy加载配置
    db.init_app(app)
    ma.init_app(app)

    # redis加载配置
    redis_cache.init_app(app)
    redis_check.init_app(app)
    redis_session.init_app(app)

    # session保存数据到redis时启用的链接对象
    app.config["SESSION_REDIS"] = redis_session
    # session存储配置类加载配置
    session_store.init_app(app)

    # 日志加载配置
    log = logger.init_app(app)
    app.log = log

    # 自定义终端命令初始化
    command.init_app(app)

    # jsonrpc注册到项目中
    # 开启rpc接口的web调试界面：/api/browse
    jsonrpc.browse_url = app.config.get("API_BROWSE_URL", "/api/browse")
    jsonrpc.enable_web_browsable_api = app.config.get("DEBUG", False)
    jsonrpc.init_app(app)

    # 自动注册蓝图
    register_blueprint(app, jsonrpc)

    # 加载celery配置
    celery.main = app.name
    celery.app = app
    # 更新配置
    celery.conf.update(app.config)
    # 自动注册任务
    celery.autodiscover_tasks(app.config.get("INSTALL_BLUEPRINT"))

    # jwt初始化
    jwt.init_app(app)

    # 跨域资源共享
    cors.init_app(app)

    # admin站点
    admin.name = app.config['FLASK_ADMIN_NAME']
    admin.template_mode = app.config['TEMPLATE_MODE']
    admin._set_admin_index_view(index_view=AdminIndexView(
        name=app.config["ADMIN_HOME_NAME"],
        template=app.config["ADMIN_HOME_TEMPLATE"],
    ))
    admin.init_app(app)


    # 国际化/本地化
    babel.init_app(app)

    # db创建数据表
    with app.app_context():
        db.create_all()

    return app
```

语言配置，`application/settings/__init__.py`，代码：

```python
# 国际化与本地化
LANGUAGE = "zh_CN"
TIMEZONE = "Asia/Shanghai"

# 针对babel模块的语言和设置
BABEL_DEFAULT_LOCALE = LANGUAGE
BABEL_DEFAULT_TIMEZONE = TIMEZONE
```



#### 站点文件的管理

在application目录下准备static静态文件存储目录，并添加几个测试文件或图片在里面。

在项目入口程序`application.__init__`中，给Admin站点新增项目文件管理功能，代码：

```python
# 项目初始化主程序

from pathlib import Path

from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_redis import FlaskRedis
from flask_pymongo import PyMongo
from flask_jsonrpc import JSONRPC
from celery import Celery
from flask_jwt_extended import JWTManager
from flask_admin import Admin, AdminIndexView
from flask_admin.contrib.fileadmin import FileAdmin
from flask_babelex import Babel

from application.utils.config import Config
from application.utils.logger import Log
from application.utils.commands import Command
from application.utils.blueprint import register_blueprint, path, APIView
from application.utils import code, message

"""加载组件[单例模式]"""

# 初始化配置加载类
config: Config = Config()

# SQLAlchemy初始化
db: SQLAlchemy = SQLAlchemy()

# redis初始化
redis_cache: FlaskRedis = FlaskRedis(config_prefix="REDIS")
redis_check: FlaskRedis = FlaskRedis(config_prefix="CHECK")


# mongo初始化
mongo: PyMongo = PyMongo()


# 日志配置类初始化
logger: Log = Log()

# 终端命令管理类实例化
command: Command = Command()


# 实例化JSONRPC
jsonrpc = JSONRPC()

# celery初始化
celery = Celery()


# jwt认证模块实例化
jwt = JWTManager()

# flask-admin模块初始化
admin = Admin()

# 国际化/本地化配置初始化
babel = Babel()


def init_app(config_path: str) -> Flask:
    """用于创建app实例对象并完成初始化过程的工厂函数"""
    # 实例化flask应用对象
    app: Flask = Flask(__name__)
    # 项目跟目录路径
    app.BASE_DIR = Path(__file__).resolve().parent.parent
    # 加载配置
    config.init_app(app, config_path)

    # 加载mysql数据库配置
    db.init_app(app)

    # redis加载配置
    redis_cache.init_app(app)
    redis_check.init_app(app)

    # pymongo加载配置
    mongo.init_app(app)

    # 日志加载配置
    logger.init_app(app)

    # 终端命令管理类加载配置
    command.init_app(app)

    # jsonrpc注册到项目中，必须写在蓝图注册代码的上方
    # 开启rpc接口的web调试界面：/api/browse
    jsonrpc.browse_url = app.config.get("API_BROWSE_URL", "/api/browse")
    jsonrpc.enable_web_browsable_api = app.config.get("DEBUG", False)
    jsonrpc.init_app(app)

    # jwt初始化，必须写在蓝图注册代码的上方
    jwt.init_app(app)

    # 注册蓝图
    register_blueprint(app, jsonrpc)

    # admin站点
    admin.name = app.config['FLASK_ADMIN_NAME']
    admin.template_mode = app.config['TEMPLATE_MODE']
    admin._set_admin_index_view(index_view=AdminIndexView(
        name=app.config["ADMIN_HOME_NAME"],
        template=app.config["ADMIN_HOME_TEMPLATE"],
    ))

    # 项目静态文件、上传文件的管理视图
    static_path = str( app.BASE_DIR / "application/static")
    print(static_path)
    # 注意: flask_admin不仅可以管理当前系统的指定目录，还可以通过配置管理阿里云OSS这样的远程服务端的静态文件，默认支持AWS的静态存储节点调用
    admin.add_view(FileAdmin(static_path, '/static/', name='静态文件', category="资源管理"))
    admin.init_app(app)

    # 国际化/本地化
    babel.init_app(app)

    # 加载celery配置
    celery.main = app.name
    celery.app = app
    # 更新配置
    celery.conf.update(app.config)
    # 自动注册任务
    celery.autodiscover_tasks(app.config.get("INSTALL_BLUEPRINT"))

    # db创建数据表
    with app.app_context():
        db.create_all()

    return app

```

`settings/__init__.py`，代码：

```python
"""公共配置"""
SECRET_KEY = "66c11147-270e-41e8-9c4b-34e103dab748"
```



BUG修复

![image-20220120110037044](9%E5%90%8E%E5%8F%B0%E7%AB%99%E7%82%B9.assets/image-20220120110037044.png)



#### Admin站点管理redis

`application/__init__.py`，代码：

```python
# 项目初始化主程序

from pathlib import Path

from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_redis import FlaskRedis
from flask_pymongo import PyMongo
from flask_jsonrpc import JSONRPC
from celery import Celery
from flask_jwt_extended import JWTManager
from flask_admin import Admin, AdminIndexView
from flask_admin.contrib.fileadmin import FileAdmin
from flask_admin.contrib import rediscli
from flask_babelex import Babel
from redis import Redis

from application.utils.config import Config
from application.utils.logger import Log
from application.utils.commands import Command
from application.utils.blueprint import register_blueprint, path, APIView
from application.utils import code, message

"""加载组件[单例模式]"""

# 初始化配置加载类
config: Config = Config()

# SQLAlchemy初始化
db: SQLAlchemy = SQLAlchemy()

# redis初始化
redis_cache: FlaskRedis = FlaskRedis(config_prefix="REDIS")
redis_check: FlaskRedis = FlaskRedis(config_prefix="CHECK")


# mongo初始化
mongo: PyMongo = PyMongo()


# 日志配置类初始化
logger: Log = Log()

# 终端命令管理类实例化
command: Command = Command()


# 实例化JSONRPC
jsonrpc = JSONRPC()

# celery初始化
celery = Celery()


# jwt认证模块实例化
jwt = JWTManager()

# flask-admin模块初始化
admin = Admin()

# 国际化/本地化配置初始化
babel = Babel()


def init_app(config_path: str) -> Flask:
    """用于创建app实例对象并完成初始化过程的工厂函数"""
    # 实例化flask应用对象
    app: Flask = Flask(__name__)
    # 项目跟目录路径
    app.BASE_DIR = Path(__file__).resolve().parent.parent
    # 加载配置
    config.init_app(app, config_path)

    # 加载mysql数据库配置
    db.init_app(app)

    # redis加载配置
    redis_cache.init_app(app)
    redis_check.init_app(app)

    # pymongo加载配置
    mongo.init_app(app)

    # 日志加载配置
    logger.init_app(app)

    # 终端命令管理类加载配置
    command.init_app(app)

    # jsonrpc注册到项目中，必须写在蓝图注册代码的上方
    # 开启rpc接口的web调试界面：/api/browse
    jsonrpc.browse_url = app.config.get("API_BROWSE_URL", "/api/browse")
    jsonrpc.enable_web_browsable_api = app.config.get("DEBUG", False)
    jsonrpc.init_app(app)

    # jwt初始化，必须写在蓝图注册代码的上方
    jwt.init_app(app)

    # 注册蓝图
    register_blueprint(app, jsonrpc)

    # admin站点
    admin.name = app.config['FLASK_ADMIN_NAME']
    admin.template_mode = app.config['TEMPLATE_MODE']
    admin._set_admin_index_view(index_view=AdminIndexView(
        name=app.config["ADMIN_HOME_NAME"],
        template=app.config["ADMIN_HOME_TEMPLATE"],
    ))

    # 项目静态文件、上传文件的管理视图
    static_path = str( app.BASE_DIR / "application/static")
    print(static_path)
    # 注意: flask_admin不仅可以管理当前系统的指定目录，还可以通过配置管理阿里云OSS这样的远程服务端的静态文件，默认支持AWS的静态存储节点调用
    admin.add_view(FileAdmin(static_path, '/static/', name='静态文件', category="资源管理"))

    # 集成redis终端到Admin站点中
    admin.add_view(rediscli.RedisCli(Redis.from_url(app.config.get("REDIS_URL")), name='redis_db_0', endpoint="redis_db_0", category="Redis", url="redis/0"))
    admin.add_view(rediscli.RedisCli(Redis.from_url(app.config.get("CHECK_URL")), name='redis_db_1', endpoint="redis_db_1", category="Redis", url="redis/1"))
    admin.add_view(rediscli.RedisCli(Redis.from_url(app.config.get("CELERY_RESULT_BACKEND")), name='redis_db_14', endpoint="redis_db_14", category="Redis", url="redis/14"))
    admin.add_view(rediscli.RedisCli(Redis.from_url(app.config.get("BROKER_URL")), name='redis_db_15', endpoint="redis_db_15", category="Redis", url="redis/15"))

    admin.init_app(app)

    # 国际化/本地化
    babel.init_app(app)

    # 加载celery配置
    celery.main = app.name
    celery.app = app
    # 更新配置
    celery.conf.update(app.config)
    # 自动注册任务
    celery.autodiscover_tasks(app.config.get("INSTALL_BLUEPRINT"))

    # db创建数据表
    with app.app_context():
        db.create_all()

    return app

```

效果：

![image-20210926120158177](9%E5%90%8E%E5%8F%B0%E7%AB%99%E7%82%B9.assets/image-20210926120158177.png)



## 