# 个人中心

## 客户端显示个人中心页面

`html/user.html`，代码：

```html
<!DOCTYPE html>
<html>
<head>
	<title>用户中心</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
  <script src="../script/main.js"></script>
</head>
<body>
	<div class="app user" id="app">
		<div class="bg">
      <img src="../image/bg0.jpg">
    </div>
		<img class="back" @click="back" src="../image/user_back.png" alt="">
		<img class="setting" src="../image/setting.png" alt="">
		<div class="header">
			<div class="info">
				<div class="avatar">
					<img class="avatar_bf" src="../image/avatar_bf.png" alt="">
					<img class="user_avatar" src="../image/avatar.png" alt="">
					<img class="avatar_border" src="../image/avatar_border.png" alt="">
				</div>
				<p class="user_name">清蒸小帅锅</p>
			</div>
			<div class="wallet">
				<div class="balance">
					<p class="title"><img src="../image/money.png" alt="">钱包</p>
					<p class="num">99,999.00</p>
				</div>
				<div class="balance">
					<p class="title"><img src="../image/integral.png" alt="">果子</p>
					<p class="num">99,999.00</p>
				</div>
			</div>
			<div class="invite">
				<img class="invite_btn" src="../image/invite.png" alt="">
			</div>
		</div>
		<div class="menu">
				<div class="item">
					<span class="title">我的主页</span>
					<span class="value">查看</span>
				</div>
				<div class="item">
					<span class="title">任务列表</span>
					<span class="value">75%</span>
				</div>
				<div class="item">
					<span class="title">收益明细</span>
					<span class="value">查看</span>
				</div>
				<div class="item">
					<span class="title">实名认证</span>
					<span class="value">未认证</span>
				</div>
				<div class="item">
					<span class="title">问题反馈</span>
					<span class="value">去反馈</span>
				</div>
			</ul>
		</div>
	</div>
	<script>
	apiready = function(){
        Vue.prototype.game = new Game("../mp3/bg1.mp3");
		new Vue({
			el:"#app",
			data(){
				return {
                    
				}
			},
			methods:{
                back(){
                    // 返回首页
                    this.game.outWin();
                },
			}
		});
	}
	</script>
</body>
</html>
```

css/main.css，代码：

```css
.user .header{
	position: absolute;
	top: 1.22rem;
	left: 0;
	right: 0;
	margin: auto;
	width: 32rem;
	height: 19.28rem;
	background: url("../image/ucenter.png") no-repeat 0 0;
	background-size: 100%;
  }
  .user .back{
	position: absolute;
	width: 3.83rem;
	height: 3.89rem;
	z-index: 1;
	top: 2.72rem;
	left: 3rem;
  }
  .user .setting{
	position: absolute;
	z-index: 1;
	top: 4.2rem;
	right: 3.8rem;
	width: 3.06rem;
	height: 3.06rem;
  }
  .user .info{
	position: absolute;
	z-index: 1;
	top: 6.94rem;
	left: 3.89rem;
	width: 6.39rem;
	height: 9.17rem;
  }
  .user .info .avatar{
	width: 6.39rem;
	height: 6.39rem;
	position: relative;
  }
  .user .info .avatar_bf{
	position: absolute;
	z-index: 1;
	margin: auto;
	width: 4.56rem;
	height: 4.56rem;
	top: 0;
	bottom: 0;
	left: 0;
	right: 0;
  }
  .user .info .user_avatar{
	position: absolute;
	z-index: 1;
	width: 4.56rem;
	height: 4.56rem;
	margin: auto;
	top: 0;
	bottom: 0;
	left: 0;
	right: 0;
  }
  .user .info .avatar_border{
	position: absolute;
	z-index: 1;
	margin: auto;
	top: 0;
	bottom: 0;
	left: 0;
	right: 0;
	width: 6.2rem;
	height: 6.2rem;
  }
  .user .info .user_name{
	text-align: center;
  }
  .user .wallet{
	position: absolute;
	top: 5.56rem;
	right: 1.94rem;
	width: 16rem;
	height: 10rem;
  }
  .user .wallet .balance{
	margin-top: 1.4rem;
	float: left;
	margin-right: 1rem;
  }
  .user .wallet .title{
	color: #300;
	font-size: 1.2rem;
	width: 6.4rem;
	text-align: center;
  }
  .user .wallet .title img{
	width: 1.4rem;
	margin-right: 0.2rem;
	vertical-align: sub;
	height: 1.4rem;
  }
  .user .wallet .num{
	background: url("../image/btn3.png") no-repeat 0 0;
	background-size: 100%;
	width: 6.4rem;
	font-size: 0.8rem;
	color: #fff;
	height: 2rem;
	line-height: 1.8rem;
	text-indent: 1rem;
  }
  .user .invite{
	position: absolute;
	top: 11.6rem;
	right: 6.4rem;
  }
  .user .invite .invite_btn{
	width: 9.39rem;
	height: 3.67rem;
  }
  .user .menu{
	position: absolute;
	top: 22rem;
	padding-top: 4.6rem;
	right: 0;
	left: 0;
	margin: auto;
	width: 28.44rem;
	height: 33.89rem;
	background: url("../image/bg10.png") no-repeat 0 0;
	background-size: 100%;
  }
  .user .menu .item{
	margin-left: 2.6rem;
	margin-bottom: 0.5rem;
	width: 23.06rem;
	height: 4.22rem;
	line-height: 4.22rem;
	overflow: hidden;
	background: url("../image/title.png") no-repeat 0 0;
	background-size: 100%;
	text-indent: 2rem;
	color: #fff;
	font-size: 1.33rem;
  }
  .user .menu .item .title{
	float: left;
  }
  .user .menu .item .value{
	float: right;
	padding-right: 2rem;
  }
```



## 基于Faker生成仿真测试数据

文档：https://faker.readthedocs.io/en/master/

安装：

```bash
pip install Faker
```

初始化，`application/__init__.py`， 因此接下来需要自定义终端命令，所以设置db对象和faker对象作为app应用对象的子对象存在，方便引入使用，代码：

```python
# 项目初始化主程序

from pathlib import Path

from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_redis import FlaskRedis
from flask_pymongo import PyMongo
from flask_jsonrpc import JSONRPC
from celery import Celery
from flask_jwt_extended import JWTManager
from flask_admin import Admin, AdminIndexView
from flask_admin.contrib.fileadmin import FileAdmin
from flask_admin.contrib import rediscli
from flask_babelex import Babel
from redis import Redis
from faker import Faker

from application.utils.config import Config
from application.utils.logger import Log
from application.utils.commands import Command
from application.utils.blueprint import register_blueprint, path, APIView
from application.utils import code, message

"""加载组件[单例模式]"""

# 初始化配置加载类
config: Config = Config()

# SQLAlchemy初始化
db: SQLAlchemy = SQLAlchemy()

# redis初始化
redis_cache: FlaskRedis = FlaskRedis(config_prefix="REDIS")
redis_check: FlaskRedis = FlaskRedis(config_prefix="CHECK")


# mongo初始化
mongo: PyMongo = PyMongo()


# 日志配置类初始化
logger: Log = Log()

# 终端命令管理类实例化
command: Command = Command()


# 实例化JSONRPC
jsonrpc = JSONRPC()

# celery初始化
celery = Celery()


# jwt认证模块实例化
jwt = JWTManager()

# flask-admin模块初始化
admin = Admin()

# 国际化/本地化配置初始化
babel = Babel()


def init_app(config_path: str) -> Flask:
    """用于创建app实例对象并完成初始化过程的工厂函数"""
    # 实例化flask应用对象
    app: Flask = Flask(__name__)
    # 项目跟目录路径
    app.BASE_DIR = Path(__file__).resolve().parent.parent
    # 加载配置
    config.init_app(app, config_path)

    # 加载mysql数据库配置
    db.init_app(app)

    # redis加载配置
    redis_cache.init_app(app)
    redis_check.init_app(app)

    # pymongo加载配置
    mongo.init_app(app)

    # 日志加载配置
    logger.init_app(app)

    # 终端命令管理类加载配置
    command.init_app(app)

    # jsonrpc注册到项目中，必须写在蓝图注册代码的上方
    # 开启rpc接口的web调试界面：/api/browse
    jsonrpc.browse_url = app.config.get("API_BROWSE_URL", "/api/browse")
    jsonrpc.enable_web_browsable_api = app.config.get("DEBUG", False)
    jsonrpc.init_app(app)

    # jwt初始化，必须写在蓝图注册代码的上方
    jwt.init_app(app)

    # 注册蓝图
    register_blueprint(app, jsonrpc)

    # admin站点
    admin.name = app.config['FLASK_ADMIN_NAME']
    admin.template_mode = app.config['TEMPLATE_MODE']
    admin._set_admin_index_view(index_view=AdminIndexView(
        name=app.config["ADMIN_HOME_NAME"],
        template=app.config["ADMIN_HOME_TEMPLATE"],
    ))

    # 项目静态文件、上传文件的管理视图
    static_path = str( app.BASE_DIR / "application/static")
    print(static_path)
    # 注意: flask_admin不仅可以管理当前系统的指定目录，还可以通过配置管理阿里云OSS这样的远程服务端的静态文件，默认支持AWS的静态存储节点调用
    admin.add_view(FileAdmin(static_path, '/static/', name='静态文件', category="资源管理"))

    # 集成redis终端到Admin站点中
    admin.add_view(rediscli.RedisCli(Redis.from_url(app.config.get("REDIS_URL")), name='redis_db_0', endpoint="redis_db_0", category="Redis", url="redis/0"))
    admin.add_view(rediscli.RedisCli(Redis.from_url(app.config.get("CHECK_URL")), name='redis_db_1', endpoint="redis_db_1", category="Redis", url="redis/1"))
    admin.add_view(rediscli.RedisCli(Redis.from_url(app.config.get("CELERY_RESULT_BACKEND")), name='redis_db_14', endpoint="redis_db_14", category="Redis", url="redis/14"))
    admin.add_view(rediscli.RedisCli(Redis.from_url(app.config.get("BROKER_URL")), name='redis_db_15', endpoint="redis_db_15", category="Redis", url="redis/15"))

    admin.init_app(app)

    # 国际化/本地化
    babel.init_app(app)

    # 数据种子生成器[faker]
    app.faker = Faker(app.config.get("LANGUAGE"))

    # 加载celery配置
    celery.main = app.name
    celery.app = app
    # 更新配置
    celery.conf.update(app.config)
    # 自动注册任务
    celery.autodiscover_tasks(app.config.get("INSTALL_BLUEPRINT"))

    # db创建数据表
    with app.app_context():
        db.create_all()

    return app
```

Faker模块的基本使用，代码：

```python
# ./command.sh shell

# 随机IP地址
from faker.providers import internet

app.faker.add_provider(internet)

# IPV4的私网IP
app.faker.ipv4_private()

# 产生随机手机号
app.faker.phone_number()
# 产生随机姓名
app.faker.name()
# 产生随机地址
app.faker.address()
# 随机产生国家名
app.faker.country()
# 随机产生国家代码
app.faker.country_code()
# 随机产生城市名
app.faker.city_name()
# 随机产生城市
app.faker.city()
# 随机产生省份
app.faker.province()
# 产生随机email
app.faker.email()
# 产生随机IPV4地址
app.faker.ipv4()
# 产生长度在最大值与最小值之间的随机字符串
faker.pystr(min_chars=0, max_chars=8)

# 随机产生车牌号
app.faker.license_plate()

# 随机产生颜色
app.faker.rgb_color()  # rgb
app.faker.safe_hex_color()  # 16进制（web安全色）
app.faker.color_name()  # 颜色名字
app.faker.hex_color() # 16进制

# 随机产生公司名
app.faker.company()

# 随机产生工作岗位
app.faker.job()
# 随机生成密码
app.faker.password(length=32, special_chars=True, digits=True, upper_case=True, lower_case=True)
# 随机生成uuid
app.faker.uuid4()
# 随机生成sha1
app.faker.sha1(raw_output=False)
# 随机生成md5
app.faker.md5(raw_output=False)

# 随机生成女性名字
app.faker.name_female()
# 男性名字
app.faker.name_male()
# 随机生成名字
app.faker.name()

# 生成基本信息
app.faker.profile(fields=None, sex=None)
app.faker.simple_profile(sex=None)

# 随机生成浏览器的访问代理信息user_agent
app.faker.user_agent()

# 随机产生时间 月份
app.faker.month_name()
# 'May'
app.faker.date_time_this_century(before_now=True, after_now=False, tzinfo=None)
# 207-09-18 12:21:32
app.faker.time_object(end_datetime=None)
# 16:51:21
app.faker.date_time_between(start_date="-10y", end_date="now", tzinfo=None)
# 2015-11-15 21:07:38
app.faker.future_date(end_date="+30d", tzinfo=None)
# 2020-04-25
app.faker.date_time(tzinfo=None, end_datetime=None)
# 2002-09-01 18:27:45
app.faker.date(pattern="%Y-%m-%d", end_datetime=None)
# '1998-08-02'
app.faker.date_time_this_month(before_now=True, after_now=False, tzinfo=None)
# 2020-04-03 16:03:21
app.faker.date_time_this_decade(before_now=True, after_now=False, tzinfo=None)
# 2020-01-09 01:15:08
app.faker.month()
# '11'
app.faker.day_of_week()
# 'Sunday'
app.faker.date_object(end_datetime=None)
# 2017-06-26
app.faker.date_this_decade(before_today=True, after_today=False)
# 2020-03-30
app.faker.date_this_century(before_today=True, after_today=False)
# datetime.date(2000, 6, 1)
app.faker.date_this_month(before_today=True, after_today=False)
# datetime.date(2018, 6, 13)
app.faker.past_datetime(start_date="-30d", tzinfo=None)
# datetime.datetime(2018, 6, 25, 7, 41, 34)
app.faker.date_this_year(before_today=True, after_today=False)
# datetime.date(2018, 2, 24)
app.faker.date_time_between_dates(datetime_start=None, datetime_end=None, tzinfo=None)
# datetime.datetime(2018, 6, 26, 14, 40, 5)
app.faker.date_time_ad(tzinfo=None, end_datetime=None)
# datetime.datetime(673, 1, 28, 18, 17, 55)
app.faker.date_between_dates(date_start=None, date_end=None)
# datetime.date(2018, 6, 26)
app.faker.future_datetime(end_date="+30d", tzinfo=None)
# datetime.datetime(2018, 7, 4, 10, 53, 6)
app.faker.past_date(start_date="-30d", tzinfo=None)
# datetime.date(2018, 5, 30)
app.faker.time(pattern="%H:%M:%S", end_datetime=None)
# '01:32:14'
app.faker.day_of_month()
# '19'
app.faker.unix_time(end_datetime=None, start_datetime=None)

app.faker.date_time_this_year(before_now=True, after_now=False, tzinfo=None)
# datetime.datetime(2018, 5, 24, 11, 25, 25)
app.faker.date_between(start_date="-30y", end_date="today")
# datetime.date(2003, 1, 11)
app.faker.year()
# '1993'
```



自定义终端命令，生成指定数量的测试用户，`application.utils.commands`，代码：

```python
import click, os
from typing import Optional
from flask import Flask

class Command(object):
    """命令管理类"""
    def __init__(self, app: Optional[Flask] = None):
        if app is not None:
            self.init_app(app)

    def init_app(self, app: Flask):
        self.app: Flask = app
        self.setup()

    def setup(self):
        """初始化终端命令"""
        self.blueprint()  # 自动创建蓝图目录和文件
        self.faker()  # 自动创建蓝图目录和文件

    def blueprint(self):
        """蓝图生成命令"""
        @self.app.cli.command("blue")  # 指定终端命令的调用名称
        @click.option("--name", default="home", help="蓝图目录名称", type=str)
        def create_blueprint(name: str):
            # 生成蓝图名称对象的目录
            os.mkdir(name)
            open("%s/__init__.py" % name, "w")
            open("%s/ws.py" % name, "w")  # websocket的视图文件
            open("%s/admin.py" % name, "w")  # admin运营站点配置文件
            open("%s/api.py" % name, "w")  # api接口的视图文件
            open("%s/views.py" % name, "w")  # 普通视图文件
            open("%s/models.py" % name, "w")
            open("%s/documents.py" % name, "w")
            open("%s/urls.py" % name, "w")  # 视图路由
            open("%s/test.py" % name, "w")
            open("%s/tasks.py" % name, "w")
            open("%s/serializers.py" % name, "w")  # 序列化器文件

            print("蓝图[%s]创建完成...." % name)

    def faker(self):
        # 自定义终端命令: 创建测试用户
        @self.app.cli.command("user")  # 指定终端命令的调用名称
        @click.option("--num", default="", help="用户数量")
        @click.option("--password", default="", help="登录密码")
        def faker_user(num, password):
            import random
            from faker.providers import internet
            from application import db
            from application.apps.users.models import User, UserProfile
            faker = self.app.faker
            faker.add_provider(internet)
            try:
                num = int(num)
            except:
                num = 1
            if len(password) < 1:
                password = "123456"

            user_list = []
            for _ in range(0, num):
                sex = bool(random.randint(0, 2))
                if sex == 0:
                    # 性别保密的用户
                    nickname = faker.name()
                elif sex == 1:
                    # 性别为男的用户
                    nickname = faker.name_male()
                else:
                    # 性别为女的用户
                    nickname = faker.name_female()
                # 6~20位长度的账号
                name = faker.pystr(min_chars=6, max_chars=16)

                # 生成指定范围的时间对象
                age = random.randint(13, 50)
                birthday = faker.date_time_between(start_date="-%sy" % age, end_date="-12y", tzinfo=None)
                hometown_province = faker.province()
                hometown_city = faker.city()
                hometown_area = faker.district()
                living_province = faker.province()
                living_city = faker.city()
                living_area = faker.district()

                user = User(
                    nickname=nickname,
                    sex=sex,
                    name=name,
                    password=password,
                    money=random.randint(100, 99999),
                    credit=random.randint(100, 99999),
                    ip_address=faker.ipv4_public(),
                    email=faker.ascii_free_email(),
                    mobile=faker.phone_number(),
                    unique_id=faker.uuid4(),
                    province=faker.province(),
                    city=faker.city(),
                    area=faker.district(),
                    info=UserProfile(
                        birthday=birthday,
                        hometown_province=hometown_province,
                        hometown_city=hometown_city,
                        hometown_area=hometown_area,
                        hometown_address=hometown_province + hometown_city + hometown_area + faker.street_address(),
                        living_province=living_province,
                        living_city=living_city,
                        living_area=living_area,
                        living_address=living_province + living_city + living_area + faker.street_address()
                    )
                )

                user_list.append(user)

            db.session.add_all(user_list)
            db.session.commit()

            print(f"成功创建了{num}个用户，登录密码：{password}")
```

在项目根目录下创建一个command.sh脚本文件，把之前所有的sh命令全部整合到一个文件中，代码：

```bash
#!/usr/bin/env bash
export FLASK_APP="/home/moluo/Desktop/mofangapi/manage.py"
# 生产模式/运营模式
# export FLASK_ENV=product
# 开发模式
export FLASK_ENV=development

if [ $1 ]; then
  if [ $1 == "run" ]; then
    flask run --host=0.0.0.0 --port=5000

  elif [ $1 == "blue" ]; then
    cd application/apps
    flask $1 --name=$2

  elif [ $1 == "celery" ]; then
    celery -A manage.celery worker -l info

  elif [ $1 == "beat" ]; then
    celery -A manage.celery beat -l info

  # 生成测试用户
  elif [ $1 == 'user' ]; then
    flask $1 --num=$2 --password=$3

  else
    flask $1
  fi
fi
```

终端下执行命令，生成测试数据

```python
./command.sh user            # 创建 1个测试用户，默认密码为123456
./command.sh user 10         # 创建10个测试用户，默认密码为123456
./command.sh user 10 123123  # 创建10个测试用户，默认密码为123123
```

提交版本

```bash
git add .
git commit -m "fix:faker create user data"
git push
```



## 检查用户登录状态

main.js中实现goto方法，并在方法内部获取access_token判断登陆状态，而且可以根据refresh_token获取access_token的功能

```
1. 页面跳转 this.game.goto(this,'user','user.html');
2. 在goto方法中，进行了判断是否需要使用登录状态
   2.1 当需要登录状态时，使用check_token判断并获取access_token
   2.2 如果没有access_token，提示继续操作还是取消
       判断是否允许通过refresh_token来获取新的access_token
   2.3 refresh_token 如果没有，则跳转到登陆页面，
   2.4 refresh_token 如果存在，则通过ajax直接发送请求获取新的access_token并进行页面跳转
       新token无法生成，则跳转到登陆页面
```

html/index.html，进行页面跳转如果需要判断用户登录状态则采用goto方法，代码：

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <title>首页</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
	<script src="../script/main.js"></script>
</head>
<body>
  <div class="app" id="app">
    <img class="music" :class="music_play?'music2':''" @click="music_play=!music_play" src="../image/player.png">
    <div class="bg">
      <img src="../image/bg0.jpg">
    </div>
    <ul>
      <li><img class="module1" src="../image/image1.png"></li> <!-- 果园 -->
      <li><img class="module2" @click="open_user" src="../image/image2.png"></li> <!-- 会员 -->
      <li><img class="module3" src="../image/image3.png"></li> <!-- 娱乐 -->
      <li><img class="module4" @click="open_login" src="../image/image4.png"></li> <!-- 签到 -->
    </ul>
  </div>
  <script>
	apiready = function(){
		Vue.prototype.game = new Game("../mp3/bg1.mp3");  // vue3.0里面需要修改这句代码
		new Vue({
			el:"#app",
			data(){
				return {
                    music_play: true,  // 默认播放背景音乐
                }
			},
            watch:{
                music_play(){
                    if(this.music_play){
                        this.game.play_music("../mp3/bg1.mp3");
                    }else{
                        this.game.stop_music();
                    }
                }
            },
            methods:{
                open_login(){
                    this.game.goWin("login","./login.html");
                },
                open_user(){
                    this.game.goto(this, "user","./user.html");
                }
            }
		})
	}
	</script>
</body>
</html>
```

main.js，代码：

```typescript
class Game{
	// 主程序
	constructor(bg_music){
		// 构造函数，类似于python的 __init__()
		this.init();
    	this.play_music(bg_music);
		this.quit();
	}
	init(){
		// 初始化
		this.print("系统初始化");
    	this.rem();
		this.init_config();
		this.init_axios();
	}
	init_config(){
		// 初始化配置
		this.config = {
			"server_api": "http://192.168.19.251:5000/api", // api服务端的网关地址
			"app_id": "2071340228",  // 防水墙验证码的应用ID
		}
	}
	init_axios(){
		// 初始化axios http请求工具包
        if(window.axios && window.Vue){
			this.print("初始化axios");
			axios.defaults.baseURL = this.config.server_api    // 服务端api接口网关地址
			axios.defaults.withCredentials = false; // 跨域请求资源的情况下,忽略cookie的发送
			Vue.prototype.axios = axios;            // 给vue对象增加一个全局的属性，this.axios
		}
	}
	quit(){
		// 监听设备中的keyback按钮是否被按了
		api.addEventListener({
			name: 'keyback'
		}, (ret, err) => {
			// 弹出一个确认框
			var windows = api.windows()
			if(windows.length>1){
				// 如果当前APP打开了多个窗口，则直接关闭窗口
				this.outWin();
			}else{
				// 如果当前APP只打开了一个窗口，则弹窗确认用户是否退出当前APP
				api.confirm({
					title: '系统提示',
					msg: '您确认退出魔方APP吗？',
					buttons: ['退出', '取消']
				}, (ret, err) => {
					var index = ret.buttonIndex;
					if(index === 1) {
						this.outWin();
					}
				});
			}
		});
	}
	print(data,show=false){
		// 打印数据
		if(show){
			// 以弹窗的方式打印数据
			api.alert({"msg": JSON.stringify(data)});
		}else{
			// 以终端的方式打印数据
			console.log(JSON.stringify(data));
		}
	}
	rem(){
		// 页面自适配方法
		if(window.innerWidth<1200){
			this.UIWidth = document.documentElement.clientWidth;
			this.UIHeight = document.documentElement.clientHeight;
			document.documentElement.style.fontSize = (0.01*this.UIWidth*3)+"px";
			document.querySelector("#app").style.height=this.UIHeight+"px"
		}
		window.onresize = ()=>{
			if(window.innerWidth<1200){
				this.UIWidth = document.documentElement.clientWidth;
				this.UIHeight = document.documentElement.clientHeight;
				document.documentElement.style.fontSize = (0.01*this.UIWidth*3)+"px";
			}
		}
	}
	stop_music(){
		this.print("停止音乐")
		try {
			document.body.removeChild(this.audio);
		} catch (error) {
			this.print(error)
		}
	}
	play_music(src){
		this.print("播放音乐")
		try {
			this.audio = document.createElement("audio");
			this.source = document.createElement("source");
			this.source.type = "audio/mp3";
			this.audio.autoplay = "autoplay";
			this.source.src=src;
			this.audio.appendChild(this.source);
			document.body.appendChild(this.audio);
			var t = setInterval(()=>{
				if(this.audio.readyState > 0){
					if(this.audio.ended){
						clearInterval(t);
						document.body.removeChild(this.audio);
					}
				}
			},100);
		} catch (error) {
			this.print(error);
		}
	}

	goWin(name, url, pageParam){
		// 打开窗口
		api.openWin({
		    name: name,            // 自定义窗口名称
		    bounces: false,        // 窗口是否上下拉动
		    reload: true,          // 如果页面已经在之前被打开了,是否要重新加载当前窗口中的页面
		    url: url,              // 窗口创建时展示的html页面的本地路径[相对于当前代码所在文件的路径]
		    animation:{            // 打开新建窗口时的过渡动画效果
		    	type: "push",                //动画类型（详见动画类型常量）
		    	subType: "from_right",       //动画子类型（详见动画子类型常量）
		    	duration:300                 //动画过渡时间，默认300毫秒
		    },
		    pageParam: pageParam   // 传递给下一个窗口使用的参数.将来可以在新窗口中通过 api.pageParam.name 获取
		});
	}
	outWin(name){
		// 关闭窗口
		api.closeWin({
			name: name
		});
	}

	goFrame(name, url, pageParam){
		// 打开帧页面
		api.openFrame({
				name: name,
				url: url,
				rect: {
						x: 0,
						y: 0,
						w: 'auto',
						h: 'auto'
				},
				useWKWebView: true,
				historyGestureEnabled: true,
				bounces: false,
				animation:{
							type:"push",
							subType: "from_right",
							duration:300
				},
				pageParam: pageParam
		});
	}

	outFrame(name){
		// 关闭帧页面
		api.closeFrame({
		    name: name,
		});
	}

	uuid(){
		// UUID
		return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c)=>{
			var r = Math.random()*16|0,v=c=='x'?r:r&0x3|0x8;
			return v.toString(16);
		})
	}
	
	tips(msg, location='middle'){
		// 消息提示
		api.toast({
			msg: msg,
			duration: 3000,
			location: location
		});
	}

	setfs(data){
		// 保存一个或多个键值对数据到本地文件系统中
		for(let key in data){
			api.setPrefs({ // 储存
				 key: key,
				 value: data[key]
			});
		}
	}

	getfs(key){ // keys="access_token"    keys = ["access_token","refresh_token"]
		// 根据key值来获取本地文件系统中存储的数据
		let keys = key;
		if(!(key instanceof Array)){ // 如果不是数组，改造成数组，统一操作
			keys = [key];
		}

		let data = {}
		for(let item of keys){
			data[item] = api.getPrefs({
				key: item,
				sync: true,
			});
		}

		if(key instanceof Array){
			return data;
		}

		return data[key];
	}

	delfs(key){
		// 根据key值来删除本地文本系统中存储的数据
		let keys = key;
		if(!(key instanceof Array)){ // 如果不是数组，改造成数组，统一操作
			keys = [key];
		}

		for(let item of keys){
			api.removePrefs({
				key: item,
			});
		}

	}

	setdata(data){
		// 保存数据到内存中
		for(let key in data){
			api.setGlobalData({ // 储存
				key: key,
				value: data[key]
			});
		}
	}

	getdata(key){
		// 根据key值来获取内存中存储的数据
		let keys = key;
		if(!(key instanceof Array)){ // 如果不是数组，改造成数组，统一操作
			keys = [key];
		}

		let data = {}
		for(let item of keys){
			data[item] = api.getGlobalData({
				key: item
			});
		}

		if(key instanceof Array){
			return data;
		}

		return data[key];
	}

	deldata(key){
		// 根据key值来删除内存中存储的数据
		let keys = key;
		if(!(key instanceof Array)){ // 如果不是数组，改造成数组，统一操作
			keys = [key];
		}

		for(let item of keys){
			api.setGlobalData({
				key: item,
				value: "",
			});
		}
	}

	token(){
		// 获取token
		let token = {}
		let data = this.getdata("access_token");
		let fs   = this.getfs("access_token");
		if(data){
			token["access_token"] = data
			token["remember"] = false
		}else if (fs){
			token["access_token"] = fs
			token["remember"] = true
		}else{
			token["access_token"] = ""
			token["remember"] = false
		}
		return token;
	}

	payload(){
		let token = this.token().access_token
		// 获取载荷数据
		let arr = token.split(".")
		if(!arr[0]){
			return {}
		}
		let payload = JSON.parse( window.atob(arr[1]) )
		// 判断token是否已经过期了
		let current_time = parseInt((new Date()-0)) / 1000;
		if( current_time > payload.exp){
			this.delfs("access_token");
			this.deldata("access_token");
			return {}
		}
		return payload
	}
	user_info(){
		// 获取载荷中的用户信息
		return this.payload().sub
	}

	check_token(vm){
		// 使用本地token到服务端验证token，检查用户登陆状态
		let token = this.token().access_token;
		return vm.axios.post("", {
			"jsonrpc": "2.0",
			"id": this.uuid(),
			"method": "Users.verify",
			"params": {}
		},{
			headers:{
				Authorization: `jwt ${token}`
			}
		});
	}

	refresh_access_token(vm){
		// 使用本地refresh_token到服务端生成新的access_token
		let refresh_token  = this.getdata("refresh_token") || this.getfs("refresh_token");
		return vm.axios.post("",{
			"jsonrpc": "2.0",
			"id": this.uuid(),
			"method": "Users.refresh",
			"params": {}
		},{
			headers:{
				Authorization: `jwt ${refresh_token}`
			}
		});
	}

	goto(vm, name, url){
		// 鉴权以后，打开新窗口
		let remember = this.token().remember;
		this.check_token(vm).then(response=>{
			if(response.data.result.errno === 0){
				this.delfs(["access_token"]);
				this.deldata(["access_token"]);
				if(remember){
					this.setfs({
						'access_token': response.data.result.access_token,
					});
				}else{
					this.setdata({
						'access_token': response.data.result.access_token,
					});
				}
				this.goWin(name,url);
			}else if(response.data.result.errno === 1012){
				// access_token已经过期了。
				api.confirm({
					title: '登陆已超时！',
					msg: '是否请求服务端提取新的访问令牌继续登录操作？',
					buttons: ['继续', '取消']
				}, (ret, err)=>{
					if(ret.buttonIndex === 1){
						// 如果用户点击"继续"，则使用refresh_token到服务端生成新access_token
						this.refresh_access_token(vm).then(response=>{
							if(response.data.result.errno === 0){
								this.delfs(["access_token"]);
								this.deldata(["access_token"]);
								if(remember){
									this.setfs({
										'access_token': response.data.result.access_token,
									});
								}else{
									this.setdata({
										'access_token': response.data.result.access_token,
									});
								}
							}else{
								// 无法使用refresh_token生成access_token
								this.goWin("login", "login.html");
							}
						})
					}
				})
			}else{
				this.goWin("login", "login.html");
			}
		})
	}
}

```

服务端提供返回access_token的视图方法和路由

`users/api.py`，代码：

```python
@jwt_required(refresh=True)  # 验证 jwt的 refresh token
def refresh() -> Dict[str, Any]:
    """依靠refresh token 换取 assess token"""
    user_info: Dict[str, Any] = get_jwt_identity() # 获取refresh token中的载荷
    user: User = get_user_by_id(user_info["id"])
    if user is None:
        return {
            "errno": code.CODE_USER_NOT_EXISTS,
            "errmsg": message.user_not_exists
        }

    access_token,  _ = gen_token(payload=user_info)

    return {
        "errno": code.CODE_OK,
        "errmsg": message.ok,
        "access_token": access_token
    }


@jwt_required()   # 验证 jwt的 assess token
def verify() -> Any:
    """验证access_token并生成新的access_token"""
    payload: Dict[str, Any] = get_jwt_identity()  # 获取refresh token中的载荷
    access_token, _ = gen_token(payload=payload)
    return {
        "errno": code.CODE_OK,
        "errmsg": message.ok,
        "access_token": access_token
    }
```

`users.urls`，代码：

```python
from typing import List
from application import path
from . import api

apipatterns: List = [
    path("mobile", api.check_mobile),
    path("register", api.register),
    path("sms", api.sms),
    path("login", api.login),
    path("info", api.info),
    path("refresh", api.refresh),
    path("verify", api.verify),
]
```



## 显示当前用户信息

### 基于Vue-avatar组件显示用户头像

vue-avatar文档：https://eliep.github.io/vue-avatar/

user.html，代码：

```html
<!DOCTYPE html>
<html>
<head>
	<title>用户中心</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
	<script src="../script/v-avatar-2.0.3.min.js"></script>
  	<script src="../script/main.js"></script>
</head>
<body>
	<div class="app user" id="app">
		<div class="bg">
      <img src="../image/bg0.jpg">
    </div>
		<img class="back" @click="back" src="../image/user_back.png" alt="">
		<img class="setting" src="../image/setting.png" alt="">
		<div class="header">
			<div class="info">
				<div class="avatar">
					<img class="avatar_bf" src="../image/avatar_bf.png" alt="">
					<div class="user_avatar">
						<v-avatar v-if="user_info.avatar" :src="user_info.avatar" :size="55" :rounded="true"></v-avatar>
						<v-avatar v-else-if="user_info.nickname" :username="user_info.nickname" :size="55" :rounded="true"></v-avatar>
						<v-avatar v-else :username="user_info.id" :size="55" :rounded="true"></v-avatar>
					</div>
					<img class="avatar_border" src="../image/avatar_border.png" alt="">
				</div>
				<p class="user_name">{{user_info.nickname}}</p>
			</div>
			<div class="wallet">
				<div class="balance">
					<p class="title"><img src="../image/money.png" alt="">钱包</p>
					<p class="num">{{game.money(user_info.money)}}</p>
				</div>
				<div class="balance">
					<p class="title"><img src="../image/integral.png" alt="">果子</p>
					<p class="num">{{game.money(user_info.credit)}}</p>
				</div>
			</div>
			<div class="invite">
				<img class="invite_btn" src="../image/invite.png" alt="">
			</div>
		</div>
		<div class="menu">
				<div class="item">
					<span class="title">我的主页</span>
					<span class="value">查看</span>
				</div>
				<div class="item">
					<span class="title">任务列表</span>
					<span class="value">75%</span>
				</div>
				<div class="item">
					<span class="title">收益明细</span>
					<span class="value">查看</span>
				</div>
				<div class="item">
					<span class="title">实名认证</span>
					<span class="value">未认证</span>
				</div>
				<div class="item">
					<span class="title">问题反馈</span>
					<span class="value">去反馈</span>
				</div>
			</ul>
		</div>
	</div>
	<script>
	apiready = function(){
        Vue.prototype.game = new Game("../mp3/bg1.mp3");
		new Vue({
			el:"#app",
			data(){
				return {
					user_info: {}, // 当前登陆用户信息
				}
			},
			created(){
				this.user_info = this.game.user_info();
				this.game.print(this.user_info);
			},
			methods:{
                back(){
                    // 返回首页
                    this.game.outWin();
                },
			}
		});
	}
	</script>
</body>
</html>
```

main.js，代码：

```javascript
	money(num){
		// 货币格式化
		let data_int = parseInt(num).toLocaleString();
		let data_float = parseFloat(num).toFixed(2).split(".")[1];
		return `${data_int}.${data_float}`
	}
```



## 退出登录

APP项目中对于用户的退出登录，一般都在系统设置中进行。

在用户中心页面html/user.html中，打开html/setting.html配置窗口，代码：

```html
<!DOCTYPE html>
<html>
<head>
	<title>用户中心</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
	<script src="../script/v-avatar-2.0.3.min.js"></script>
  	<script src="../script/main.js"></script>
</head>
<body>
	<div class="app user" id="app">
		<div class="bg">
      <img src="../image/bg0.jpg">
    </div>
		<img class="back" @click="back" src="../image/user_back.png" alt="">
		<img class="setting" @click="open_setting" src="../image/setting.png" alt="">
		<div class="header">
			<div class="info">
				<div class="avatar">
					<img class="avatar_bf" src="../image/avatar_bf.png" alt="">
					<div class="user_avatar">
						<v-avatar v-if="user_info.avatar" :src="user_info.avatar" :size="55" :rounded="true"></v-avatar>
						<v-avatar v-else-if="user_info.nickname" :username="user_info.nickname" :size="55" :rounded="true"></v-avatar>
						<v-avatar v-else :username="user_info.id" :size="55" :rounded="true"></v-avatar>
					</div>
					<img class="avatar_border" src="../image/avatar_border.png" alt="">
				</div>
				<p class="user_name">{{user_info.nickname}}</p>
			</div>
			<div class="wallet">
				<div class="balance">
					<p class="title"><img src="../image/money.png" alt="">钱包</p>
					<p class="num">{{game.money(user_info.money)}}</p>
				</div>
				<div class="balance">
					<p class="title"><img src="../image/integral.png" alt="">果子</p>
					<p class="num">{{game.money(user_info.credit)}}</p>
				</div>
			</div>
			<div class="invite">
				<img class="invite_btn" src="../image/invite.png" alt="">
			</div>
		</div>
		<div class="menu">
				<div class="item">
					<span class="title">我的主页</span>
					<span class="value">查看</span>
				</div>
				<div class="item">
					<span class="title">任务列表</span>
					<span class="value">75%</span>
				</div>
				<div class="item">
					<span class="title">收益明细</span>
					<span class="value">查看</span>
				</div>
				<div class="item">
					<span class="title">实名认证</span>
					<span class="value">未认证</span>
				</div>
				<div class="item">
					<span class="title">问题反馈</span>
					<span class="value">去反馈</span>
				</div>
			</ul>
		</div>
	</div>
	<script>
	apiready = function(){
        Vue.prototype.game = new Game("../mp3/bg1.mp3");
		new Vue({
			el:"#app",
			data(){
				return {
					user_info: {}, // 当前登陆用户信息
				}
			},
			created(){
				this.user_info = this.game.user_info();
				this.game.print(this.user_info);
			},
			methods:{
                back(){
                    // 返回首页
                    this.game.outWin();
                },
				open_setting(){
					this.game.goFrame('settings','setting.html');
				}
			}
		});
	}
	</script>
</body>
</html>
```

 客户端新增系统设置页面`html/setting.html`，代码：

```html
<!DOCTYPE html>
<html>
<head>
	<title>系统设置</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
  <script src="../script/main.js"></script>
</head>
<body>
	<div class="app user setting" id="app">
		<div class="bg">
      <img src="../image/form_bg.png">
    </div>
		<img class="back" @click="back" src="../image/user_back.png" alt="">
    <div class="form">
      <div class="item avatar">
        <span class="title">头像</span>
        <span class="goto">&gt;</span>
        <span class="value">
          <img src="../image/avatar.png" alt="">
        </span>
      </div>
      <div class="item">
        <span class="title">昵称</span>
        <span class="goto">&gt;</span>
        <span class="value">清蒸小帅锅</span>
      </div>
      <div class="item">
        <span class="title">手机号</span>
        <span class="goto">&gt;</span>
        <span class="value">139****5901</span>
      </div>
      <div class="item">
        <span class="title">登陆密码</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">交易密码</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">地址管理</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">设备管理</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item logout">
        <img @click="change_account" src="../image/change_account.png" alt="">
        <p @click="logout">退出账号</p>
      </div>
    </div>
	</div>
	<script>
	apiready = function(){
        Vue.prototype.game = new Game("../mp3/bg1.mp3");
		new Vue({
			el:"#app",
			data(){
				return {

                }
			},
			methods:{
                back(){
                    setInterval(()=>{
                        this.game.outFrame();
                    },500);
                },
                change_account(){
                    // 切换账号
                    this.game.goWin("login","login.html"); // 打开登陆窗口
                    this.back(); // 退出当前窗口
                },
                logout(){
                // 退出账号
                    api.actionSheet({
                        title: '您确认要退出当前登录吗？',
                        cancelTitle: '取消',  // 取消按钮，buttonIndex=最后一个值
                        destructiveTitle: "退出登录", // 默认按钮，会自动高亮显示buttonIndex=1
                        buttons: ['再考虑1下','再考虑2下'] // buttonIndex=2
                    }, (ret, err)=>{
                        if( ret ){
                            if(ret.buttonIndex==1){
                                this.game.deldata(["access_token","refresh_token"]);
                                this.game.delfs(["access_token","refresh_token"]);
                                this.game.outWin();
                            }
                        }
                    });
                }
			}
		});
	}
	</script>
</body>
</html>
```

`static/css/main.css`，样式代码：

```css
.setting .bg img{
  animation: normal;
}
.setting .back{
  top: 4rem;
}
.setting .form {
  top: 9rem;
}
.setting .form .item{
  height: 3.9rem;
  line-height: 3.9rem;
  font-size: 1.25rem;
  text-indent: 0.6rem;
  border-bottom: 1px solid rgba(204,153,102,0.2);
}
.setting .form .avatar{
  height: 6.11rem;
  line-height: 6.11rem;
}
.setting .form .avatar img{
  width: 4.56rem;
  height: 4.56rem;
  vertical-align: middle;
}
.setting .form .item .value,
.setting .form .item .goto{
  float: right;
}
.setting .form .logout{
  margin-top: 3rem;
  text-align: center;
  height: 4rem;
  line-height: 2rem;
}
.setting .form .logout img{
  width: 11rem;
}
```



### 系统设置页面中显示用户个人信息

setting.html，代码：

```html
<!DOCTYPE html>
<html>
<head>
	<title>系统设置</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
    <script src="../script/v-avatar-2.0.3.min.js"></script>
  <script src="../script/main.js"></script>
</head>
<body>
	<div class="app user setting" id="app">
		<div class="bg">
      <img src="../image/form_bg.png">
    </div>
		<img class="back" @click="back" src="../image/user_back.png" alt="">
    <div class="form">
      <div class="item avatar">
        <span class="title">头像</span>
        <span class="goto">&gt;</span>
        <span class="value">
            <v-avatar v-if="user_info.avatar" :src="user_info.avatar" :size="55" :rounded="true"></v-avatar>
            <v-avatar v-else-if="user_info.nickname" :username="user_info.nickname" :size="55" :rounded="true"></v-avatar>
            <v-avatar v-else :username="user_info.id" :size="55" :rounded="true"></v-avatar>
        </span>
      </div>
      <div class="item">
        <span class="title">昵称</span>
        <span class="goto">&gt;</span>
        <span class="value">{{user_info.nickname}}</span>
      </div>
      <div class="item">
        <span class="title">手机号</span>
        <span class="goto">&gt;</span>
        <span class="value" v-if="user_data.mobile">{{game.mobile(user_data.mobile)}}</span>
      </div>
      <div class="item">
        <span class="title">登陆密码</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">交易密码</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">地址管理</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">设备管理</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item logout">
        <img @click="change_account" src="../image/change_account.png" alt="">
        <p @click="logout">退出账号</p>
      </div>
    </div>
	</div>
	<script>
	apiready = function(){
        Vue.prototype.game = new Game("../mp3/bg1.mp3");
		new Vue({
			el:"#app",
			data(){
				return {
                    user_info:{},  // 本地token中载荷的用户基本信息
                    user_data:{},  // 服务端中用户的详情信息
                }
			},
			created(){
				this.user_info = this.game.user_info();
                this.get_user_data();
			},
			methods:{
                back(){
                    this.game.outFrame();
                },
                change_account(){
                    // 切换账号
                    this.game.goWin("login","login.html"); // 打开登陆窗口
                    setTimeout(()=>{
                        this.back(); // 延时当前窗口
                    },500);
                },
                logout(){
                // 退出账号
                    api.actionSheet({
                        title: '您确认要退出当前登录状态吗？',
                        cancelTitle: '取消',  // 取消按钮，buttonIndex=最后一个值
                        destructiveTitle: "确认退出", // 默认按钮，会自动高亮显示buttonIndex=1
                        // buttons: ['再考虑1下','再考虑2下'] // buttonIndex=2,3,...
                    }, (ret, err)=>{
                        if( ret ){
                            if(ret.buttonIndex==1){
                                this.game.deldata(["access_token","refresh_token"]);
                                this.game.delfs(["access_token","refresh_token"]);
                                this.game.outWin();
                            }
                        }
                    });
                },
                get_user_data(){
                    // 获取用户的详情信息
                    let token = this.game.token().access_token;
                    this.axios.post("",{
						"jsonrpc": "2.0",
						"id": this.game.uuid(),
						"method": "Users.info",
						"params": {

						}
					},{
                        headers:{
                            Authorization: `jwt ${token}`
                        }
                    }).then(response=>{
                        this.user_data = response.data.result.data;
                    }).catch(error=>{

                    })
                }
			}
		});
	}
	</script>
</body>
</html>
```

main.js，代码：

```javascript
	mobile(data){
		// 手机号格式化
		if(data.length<1){
			return data;
		}
		return data.replace(/(\d{3})\d{4}(\d{4})/, "$1****$2");
	}
```

### 退出登陆功能实现

服务端提供退出登陆状态的API接口

users/api.py

```python
@jwt_required()
def logout() -> Any:
    """退出登录状态"""
    payload: Dict[str, Any] = get_jwt_identity()  # 获取refresh token中的载荷
    # 删除redis中的access_token
    del_token(payload["id"])

    return {
        "errno": code.CODE_OK,
        "errmsg": message.ok,
    }

```

users/services.py

```python
def del_token(id: int):
    """删除access_token"""
    cache.delete(f"access_token_{id}")

```

users/urls.py

```python
from typing import List
from application import path
from . import api

apipatterns: List = [
    path("mobile", api.check_mobile),
    path("register", api.register),
    path("sms", api.sms),
    path("login", api.login),
    path("info", api.info),
    path("refresh", api.refresh),
    path("verify", api.verify),
    path("logout", api.logout),
]
```

### 客户端请求服务端删除access_token

html/settting.html

```html
<!DOCTYPE html>
<html>
<head>
	<title>系统设置</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
    <script src="../script/v-avatar-2.0.3.min.js"></script>
  <script src="../script/main.js"></script>
</head>
<body>
	<div class="app user setting" id="app">
		<div class="bg">
      <img src="../image/form_bg.png">
    </div>
		<img class="back" @click="back" src="../image/user_back.png" alt="">
    <div class="form">
      <div class="item avatar">
        <span class="title">头像</span>
        <span class="goto">&gt;</span>
        <span class="value">
            <v-avatar v-if="user_info.avatar" :src="user_info.avatar" :size="55" :rounded="true"></v-avatar>
            <v-avatar v-else-if="user_info.nickname" :username="user_info.nickname" :size="55" :rounded="true"></v-avatar>
            <v-avatar v-else :username="user_info.id" :size="55" :rounded="true"></v-avatar>
        </span>
      </div>
      <div class="item">
        <span class="title">昵称</span>
        <span class="goto">&gt;</span>
        <span class="value">{{user_info.nickname}}</span>
      </div>
      <div class="item">
        <span class="title">手机号</span>
        <span class="goto">&gt;</span>
        <span class="value" v-if="user_data.mobile">{{game.mobile(user_data.mobile)}}</span>
      </div>
      <div class="item">
        <span class="title">登陆密码</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">交易密码</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">地址管理</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">设备管理</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item logout">
        <img @click="change_account" src="../image/change_account.png" alt="">
        <p @click="logout">退出账号</p>
      </div>
    </div>
	</div>
	<script>
	apiready = function(){
        Vue.prototype.game = new Game("../mp3/bg1.mp3");
		new Vue({
			el:"#app",
			data(){
				return {
                    user_info:{},  // 本地token中载荷的用户基本信息
                    user_data:{},  // 服务端中用户的详情信息
                }
			},
			created(){
				this.user_info = this.game.user_info();
                this.get_user_data();
			},
			methods:{
                back(){
                    this.game.outFrame();
                },
                change_account(){
                    // 切换账号
                    this.game.goWin("login","login.html"); // 打开登陆窗口
                    setTimeout(()=>{
                        this.back(); // 延时当前窗口
                    },500);
                },
                logout(){
                // 退出账号
                    api.actionSheet({
                        title: '您确认要退出当前登录状态吗？',
                        cancelTitle: '取消',  // 取消按钮，buttonIndex=最后一个值
                        destructiveTitle: "确认退出", // 默认按钮，会自动高亮显示buttonIndex=1
                        // buttons: ['再考虑1下','再考虑2下'] // buttonIndex=2,3,...
                    }, (ret, err)=>{
                        if( ret ){
                            if(ret.buttonIndex==1){
                                this.user_logout()
                            }
                        }
                    });
                },
                user_logout(){
                    // 请求服务端删除登陆状态的access_token
                    let token = this.game.token().access_token;
                    this.axios.post("",{
						"jsonrpc": "2.0",
						"id": this.game.uuid(),
						"method": "Users.logout",
						"params": {}
					},{
                        headers:{
                            Authorization: `jwt ${token}`
                        }
                    }).then(response=>{
                        // 退出登陆成功以后，删除本地token，接着关闭当前用户窗口(window)
                        this.game.deldata(["access_token","refresh_token"]);
                        this.game.delfs(["access_token","refresh_token"]);                        
                        this.game.outWin();
                    }).catch(error=>{

                    })
                },
                get_user_data(){
                    // 获取用户的详情信息
                    let token = this.game.token().access_token;
                    this.axios.post("",{
						"jsonrpc": "2.0",
						"id": this.game.uuid(),
						"method": "Users.info",
						"params": {

						}
					},{
                        headers:{
                            Authorization: `jwt ${token}`
                        }
                    }).then(response=>{
                        this.user_data = response.data.result.data;
                    }).catch(error=>{

                    })
                }
			}
		});
	}
	</script>
</body>
</html>
```



## 更新头像

点击头像进入更新头像页面，setting.html，代码：

```html
<!DOCTYPE html>
<html>
<head>
	<title>系统设置</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
    <script src="../script/v-avatar-2.0.3.min.js"></script>
  <script src="../script/main.js"></script>
</head>
<body>
	<div class="app user setting" id="app">
		<div class="bg">
      <img src="../image/form_bg.png">
    </div>
		<img class="back" @click="back" src="../image/user_back.png" alt="">
    <div class="form">
      <div class="item avatar" @click="open_avatar">
        <span class="title">头像</span>
        <span class="goto">&gt;</span>
        <span class="value">
            <v-avatar v-if="user_info.avatar" :src="user_info.avatar" :size="55" :rounded="true"></v-avatar>
            <v-avatar v-else-if="user_info.nickname" :username="user_info.nickname" :size="55" :rounded="true"></v-avatar>
            <v-avatar v-else :username="user_info.id" :size="55" :rounded="true"></v-avatar>
        </span>
      </div>
      <div class="item">
        <span class="title">昵称</span>
        <span class="goto">&gt;</span>
        <span class="value">{{user_info.nickname}}</span>
      </div>
      <div class="item">
        <span class="title">手机号</span>
        <span class="goto">&gt;</span>
        <span class="value" v-if="user_data.mobile">{{game.mobile(user_data.mobile)}}</span>
      </div>
      <div class="item">
        <span class="title">登陆密码</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">交易密码</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">地址管理</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">设备管理</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item logout">
        <img @click="change_account" src="../image/change_account.png" alt="">
        <p @click="logout">退出账号</p>
      </div>
    </div>
	</div>
	<script>
	apiready = function(){
        Vue.prototype.game = new Game("../mp3/bg1.mp3");
		new Vue({
			el:"#app",
			data(){
				return {
                    user_info:{},  // 本地token中载荷的用户基本信息
                    user_data:{},  // 服务端中用户的详情信息
                }
			},
			created(){
				this.user_info = this.game.user_info();
                this.get_user_data();
			},
			methods:{
                back(){
                    this.game.outFrame();
                },
                change_account(){
                    // 切换账号
                    this.game.goWin("login","login.html"); // 打开登陆窗口
                    setTimeout(()=>{
                        this.back(); // 延时当前窗口
                    },500);
                },
                logout(){
                // 退出账号
                    api.actionSheet({
                        title: '您确认要退出当前登录状态吗？',
                        cancelTitle: '取消',  // 取消按钮，buttonIndex=最后一个值
                        destructiveTitle: "确认退出", // 默认按钮，会自动高亮显示buttonIndex=1
                        // buttons: ['再考虑1下','再考虑2下'] // buttonIndex=2,3,...
                    }, (ret, err)=>{
                        if( ret ){
                            if(ret.buttonIndex==1){
                                this.user_logout()
                            }
                        }
                    });
                },
                user_logout(){
                    // 请求服务端删除登陆状态的access_token
                    let token = this.game.token().access_token;
                    this.axios.post("",{
						"jsonrpc": "2.0",
						"id": this.game.uuid(),
						"method": "Users.logout",
						"params": {}
					},{
                        headers:{
                            Authorization: `jwt ${token}`
                        }
                    }).then(response=>{
                        // 退出登陆成功以后，删除本地token，接着关闭当前用户窗口(window)
                        this.game.deldata(["access_token","refresh_token"]);
                        this.game.delfs(["access_token","refresh_token"]);                        
                        this.game.outWin();
                    }).catch(error=>{

                    })
                },
                get_user_data(){
                    // 获取用户的详情信息
                    let token = this.game.token().access_token;
                    this.axios.post("",{
						"jsonrpc": "2.0",
						"id": this.game.uuid(),
						"method": "Users.info",
						"params": {

						}
					},{
                        headers:{
                            Authorization: `jwt ${token}`
                        }
                    }).then(response=>{
                        this.user_data = response.data.result.data;
                    }).catch(error=>{

                    })
                },
                open_avatar(){
                    // 打开头像更新窗口
                    this.game.goFrame("avatar","avatar.html", null, "from_top");
                }
			}
		});
	}
	</script>
</body>
</html>
```

main.js，修改openFrame方法的参数，代码：

```javascript
	goFrame(name, url, pageParam, redirection="from_right"){
		// 打开帧页面
		api.openFrame({
				name: name,
				url: url,
				rect: {
						x: 0,
						y: 0,
						w: 'auto',
						h: 'auto'
				},
				useWKWebView: true,
				historyGestureEnabled: true,
				bounces: false,
				animation:{
							type:"push",
							subType: redirection,
							duration:300
				},
				pageParam: pageParam
		});
	}
```



avatar.html，显示更新头像的页面，代码：

```html
<!DOCTYPE html>
<html>
<head>
	<title>更新头像</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
	<script src="../script/main.js"></script>
</head>
<body>
	<div class="app frame avatar" id="app">
    <div class="box">
      <p class="title">上传头像</p>
      <img class="close" @click="back" src="../image/close_btn1.png" alt="">
      <div class="content">
        <p class="header">！注意事项</p>
        <p class="text">禁止使用有诱导性的内容，二维码，联系方式等违规违法违约的图片，一经发现，永久封号，
          并保留追究法律责任的权利。</p>
      </div>
      <img @click="update_avatar_confirm" class="btn" src="../image/yes.png" alt="">
    </div>
	</div>
	<script>
	apiready = function(){
        Vue.prototype.game = new Game("../mp3/bg1.mp3");
		new Vue({
			el:"#app",
			data(){
				return {
				}
			},
			methods:{
                update_avatar_confirm(){
                // 确认上传头像

                },
                upload_avatar(ret){
                // 头像上传处理

                },
                back(){
                    this.game.outFrame();
                }
			}
		});
	}
	</script>
</body>
</html>
```



main.css，页面样式，代码：

```css
.avatar.frame{
  background-color: rgba(0,0,0,0.6);
}
.avatar{
  overflow: hidden;
}
.avatar .box{
  width: 28.89rem;
  height: 34.44rem;
  background: url("../image/board_bg1.png") no-repeat 0 0;
  background-size: 100%;
  position: absolute;
  top: 11rem;
  margin: 0 auto;
  left: 0;
  right: 0;
}

.avatar .box .title{
  color: #fff;
  font-size: 2rem;
  text-align: center;
  margin-top: 2.8rem;
}
.avatar .box .close{
  width: 5.22rem;
  height: 5.78rem;
  position: absolute;
  right: 0;
  top: 8rem;
}
.avatar .box .header{
  margin-top: 3.6rem;
  font-size: 1.8rem;
  text-align: center;
  color: #ff3333;
  font-weight: bold;
}
.avatar .box .text{
  width: 16.67rem;
  margin: 1.4rem auto 0;
  font-size: 1.22rem;
  color: #ffffcc;
}
.avatar .box .btn{
  display: block;
  width: 12.22rem;
  height: 4.55rem;
  margin: 1.4rem auto 0;
}
```



头像上传来源选择，`avatar.html`，代码：

```html
<!DOCTYPE html>
<html>
<head>
	<title>更新头像</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
	<script src="../script/main.js"></script>
</head>
<body>
	<div class="app frame avatar" id="app">
    <div class="box">
      <p class="title">上传头像</p>
      <img class="close" @click="back" src="../image/close_btn1.png" alt="">
      <div class="content">
        <p class="header">！注意事项</p>
        <p class="text">禁止使用有诱导性的内容，二维码，联系方式等违规违法违约的图片，一经发现，永久封号，
          并保留追究法律责任的权利。</p>
      </div>
      <img @click="update_avatar_confirm" class="btn" src="../image/yes.png" alt="">
    </div>
	</div>
	<script>
	apiready = function(){
        Vue.prototype.game = new Game("../mp3/bg1.mp3");
		new Vue({
			el:"#app",
			data(){
				return {
				}
			},
			methods:{
                update_avatar_confirm(){
                    // 确认上传头像的来源
                    api.actionSheet({
                        title: '请选择上传头像的来源',
                        cancelTitle: '取消',
                        buttons: ['相册','相机','图库'],
                    }, (ret, err)=>{
                        if( ret.buttonIndex == 1 ){
                            // 相册
                            this.game.print( ret, 1 );
                        }else if(ret.buttonIndex == 2){
                            // 相机
                            this.game.print( ret,1 );
                        }else if(ret.buttonIndex == 3){
                            // 图库
                            this.game.print( ret,1 );
                        }
                    });
                },
                upload_avatar(ret){
                // 头像上传处理

                },
                back(){
                    this.game.outFrame();
                }
			}
		});
	}
	</script>
</body>
</html>
```

接下来,调用`apicloud`提供的本地接口从相册、相机或图库中提取图片.

avatar.html，代码：

```html
<!DOCTYPE html>
<html>
<head>
	<title>更新头像</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
	<script src="../script/main.js"></script>
</head>
<body>
	<div class="app frame avatar" id="app">
    <div class="box">
      <p class="title">上传头像</p>
      <img class="close" @click="back" src="../image/close_btn1.png" alt="">
      <div class="content">
        <p class="header">！注意事项</p>
        <p class="text">禁止使用有诱导性的内容，二维码，联系方式等违规违法违约的图片，一经发现，永久封号，
          并保留追究法律责任的权利。</p>
      </div>
      <img @click="update_avatar_confirm" class="btn" src="../image/yes.png" alt="">
    </div>
	</div>
	<script>
	apiready = function(){
        Vue.prototype.game = new Game("../mp3/bg1.mp3");
		new Vue({
			el:"#app",
			data(){
				return {
				}
			},
			methods:{
                update_avatar_confirm(){
                    // 确认上传头像的来源
                    api.actionSheet({
                        title: '请选择上传头像的来源',
                        cancelTitle: '取消',
                        buttons: ["本地图库",'相册','相机'],
                    }, (ret, err)=>{
                        // 本地获取相册/相机的图片
                        var sourceType = ["library", "album","camera"];
                        if(ret.buttonIndex > sourceType.length){
                            // 如果用户选择了取消,则关闭当前修改头像的页面
                            this.game.outFrame();
                        }else{
                            // 获取头像
                            api.getPicture({
                                sourceType: sourceType[ret.buttonIndex-1],
                                mediaValue: 'pic',
                                destinationType: 'base64',
                                allowEdit: true,
                                preview: true,
                                quality: 100,
                                targetWidth: 100,
                                targetHeight: 100,
                                saveToPhotoAlbum: true,
                            }, (ret, err)=>{
                                this.game.print( ret );
                                // 头像上传处理
                                this.upload_avatar(ret);
                            });

                        }
                    });
                },
                upload_avatar(ret){
                // 头像上传处理

                },
                back(){
                    this.game.outFrame();
                }
			}
		});
	}
	</script>
</body>
</html>
```

服务端提供头像更新接口，注意，为了保证图片不被其他第三方恶意爬取，所以我们设置需要验证token才提供给客户端，`users/api.py`，代码：

```python
import random

from typing import Dict, Union, Any
from flask_jwt_extended import get_jwt_identity, jwt_required

from application import message, code, redis_check as redis
from .serializers import MobileSchema, ValidationError, UserSchema, UserLoginSchema
from .models import User
from .tasks import send_sms
from .services import gen_token, get_user_by_id, del_token, save_avatar


# 中间代码省略

@jwt_required() # 验证jwt
def avatar(img: str) -> Dict[str, Any]:
    """
    更新头像
    :param img 客户端上传的头像信息(base64内容)
    """
    # 1. 接受客户端上传的头像信息
    ext = img[img.find("/") + 1:img.find(";")]  # 资源格式，文件后缀

    # 判断格式是否符合要求
    if ext not in ["png", "svg", "jpeg", "jpg"]:
        return {
            "errno": code.CODE_IMAGE_FORMAT_ERROR,
            "errmsg": message.image_format_error,
        }

    # 保存头像
    url = save_avatar(img, ext)

    return {
        "errno": code.CODE_OK,
        "errmsg": message.ok,
        "url": url,
    }

```

users/services.py，代码：

```python
import base64, uuid
from typing import Dict, List, Any, Tuple

from flask import current_app, request
from flask_jwt_extended import create_access_token, create_refresh_token

from application import redis_cache as cache
from .models import User


# 中间代码省略

def save_avatar(img: str, ext: str) -> str:
    """
    保存头像
    :param img 客户端上传的头像内容(base64内容)
    :param ext 头像文件类型后缀
    """
    b64_avatar = img[img.find(",") + 1:]  # 获取头像图片base64内容
    b64_image = base64.b64decode(b64_avatar)  # 把base64转换成bytes类型数据
    filename = uuid.uuid4()  # 基于UUID生成随机文件名，防止图片名字重复
    # 暂时先保存到本地[本地目录要手动创建]
    static_path = current_app.BASE_DIR / current_app.config["AVATAR_DIR"]

    # 图片信息写入到指定文件名中
    print("%s/%s.%s" % (static_path, filename, ext))
    with open("%s/%s.%s" % (static_path, filename, ext), "wb") as f:
        f.write(b64_image)

    return f"{request.host_url}{current_app.config['AVATAR_URL']}/{filename}.{ext}"

```

settings/dev.py，代码:

```python
"""静态文件存储目录"""
# 头像存储路径
AVATAR_DIR = "application/static/avatar"
AVATAR_URL = "static/avatar"
```

`users.urls`，代码：

```python
from typing import List
from application import path
from . import api

apipatterns: List = [
    path("mobile", api.check_mobile),
    path("register", api.register),
    path("sms", api.sms),
    path("login", api.login),
    path("info", api.info),
    path("refresh", api.refresh),
    path("verify", api.verify),
    path("logout", api.logout),
    path("avatar", api.avatar),
]
```

message.py，代码：

```python
image_format_error: str = "错误的图片格式！"
```

code.py，代码：

```python
CODE_IMAGE_FORMAT_ERROR: int = 1020 # 错误的图片格式
```



### 客户端基于axios上传图片base64数据

`html/avatar.html`，代码：

```html
<!DOCTYPE html>
<html>
<head>
	<title>更新头像</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
	<script src="../script/main.js"></script>
</head>
<body>
	<div class="app frame avatar" id="app">
    <div class="box">
      <p class="title">上传头像</p>
      <img class="close" @click="back" src="../image/close_btn1.png" alt="">
      <div class="content">
        <p class="header">！注意事项</p>
        <p class="text">禁止使用有诱导性的内容，二维码，联系方式等违规违法违约的图片，一经发现，永久封号，
          并保留追究法律责任的权利。</p>
      </div>
      <img @click="update_avatar_confirm" class="btn" src="../image/yes.png" alt="">
    </div>
	</div>
	<script>
	apiready = function(){
        Vue.prototype.game = new Game("../mp3/bg1.mp3");
		new Vue({
			el:"#app",
			data(){
				return {
				}
			},
			methods:{
                update_avatar_confirm(){
                    // 确认上传头像的来源
                    api.actionSheet({
                        title: '请选择上传头像的来源',
                        cancelTitle: '取消',
                        buttons: ['相册','相机','图库'],
                    }, (ret, err)=>{
                        var sourceType = ["album","camera", "library"];
                        if(ret.buttonIndex > sourceType.length){
                            // 如果用户选择了取消,则关闭当前修改头像的页面
                            this.game.outFrame();
                        }else{
                            // 获取头像
                            api.getPicture({
                                sourceType: sourceType[ret.buttonIndex-1],
                                mediaValue: 'pic',  // 媒体类型是图片
                                destinationType: 'base64',  // 数据类型是图片内容经过base64算法处理以后的内容
                                allowEdit: true,   // 允许选择图片后进行编辑
                                preview: true,     // 选择图片后进行预览，IOS
                                quality: 100,      // 图片质量，只针对jpg格式图片（0-100整数）
                                targetWidth: 100,  // 压缩后的图片宽度，图片会按比例适配此宽度
                                targetHeight: 100, // 压缩后的图片高度，图片会按比例适配此高度
                                saveToPhotoAlbum: true, // 拍照或录制视频后是否保存到系统相册目录。
                            }, (ret, err)=>{
                                // 头像上传处理
                                this.upload_avatar(ret);
                            });

                        }
                    });
                },
                upload_avatar(ret){
                    // 头像上传处理
                    let token = this.game.token().access_token;
                    this.axios.post("",{
						"jsonrpc": "2.0",
						"id": this.game.uuid(),
						"method": "Users.avatar",
						"params": {
                            "img": ret.base64Data,
                        }
					},{
                        headers:{
                            Authorization: `jwt ${token}`
                        }
                    }).then(response=>{
                        // 上传处理完成头像以后
                        this.game.print(response.data.result)
                    }).catch(error=>{

                    })
                },
                back(){
                    this.game.outFrame();
                }
			}
		});
	}
	</script>
</body>
</html>
```

保存头像时还要更新数据库中用户信息

users/api.py，代码：

```python
@jwt_required()  # 验证jwt
def avatar(img: str) -> Dict[str, Any]:
    """
    更新头像
    :param img 客户端上传的头像信息(base64内容)
    """
    # 1. 接受客户端上传的头像信息
    ext = img[img.find("/") + 1:img.find(";")]  # 资源格式，文件后缀

    # 判断格式是否符合要求
    if ext not in ["png", "svg", "jpeg", "jpg"]:
        return {
            "errno": code.CODE_IMAGE_FORMAT_ERROR,
            "errmsg": message.image_format_error,
        }

    # 保存头像
    url = save_avatar(img, ext)

    # 更新用户信息
    user_info: Dict[str, Any] = get_jwt_identity()  # 获取refresh token中的载荷
    user = get_user_by_id(user_info["id"])
    update_user(user, {"avatar": url})
    user_info["avatar"] = url
    
    # 更新token
    access_token, refresh_token = gen_token(user_info)
    return {
        "errno": code.CODE_OK,
        "errmsg": message.ok,
        "access_token": access_token,
        "refresh_token": refresh_token,
    }

```

users/services.py，代码：

```python
def update_user(user: User, data: Dict):
    """
    更新用户模型数据
    :param user 用户模型对象
    :param data 要更新的字段键值对
    """
    for key, value in data.items():
        setattr(user, key, value)
    db.session.commit()

```

提交版本

```bash
git add .
git commit -m "fix: update avatar"
git push
```



### 基于APICloud提供的全局事件通知完成本地数据的其他窗口/页面更新

文档：https://docs.apicloud.com/Client-API/api#72

当前功能,我们需要根据文档了解关于`sendEvent`和`addEventListener`的使用.

```javascript
// a页面可以通过sendEvent发起一个自定义事件
api.sendEvent({
    name: 'myEvent',     // 事件名称，有内置事件，也有自定义事件，自定义事件的名称，开发者自定义的。
    extra: {
        key1: 'value1',  // 事件传参
        key2: 'value2'
    }
});

// b页面可以通过addEventListener进行监听是否有对应名称的事件触发了,一旦监听到，则自动执行回调函数：
api.addEventListener({
    name: 'myEvent'       // 监听指定名称的事件
}, (ret, err)=>{   // ret接收指定名称的事件参数
    alert(JSON.stringify(ret.value));
});

// c页面也可以通过addEventListener进行监听是否有对应名称的自定义事件进行发送了,一旦监听到，则自动执行回调函数：
api.addEventListener({
    name: 'myEvent'
}, (ret, err)=>{
    alert(JSON.stringify(ret.value));
});

// b.c 页面都将收到 myEvent 事件
```

关闭avatar.html页面,展示底下的setting.html,并更新头像.

客户端发起通知，avatar.html代码:

```html
<!DOCTYPE html>
<html>
<head>
	<title>更新头像</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
	<script src="../script/main.js"></script>
</head>
<body>
	<div class="app frame avatar" id="app">
    <div class="box">
      <p class="title">上传头像</p>
      <img class="close" @click="back" src="../image/close_btn1.png" alt="">
      <div class="content">
        <p class="header">！注意事项</p>
        <p class="text">禁止使用有诱导性的内容，二维码，联系方式等违规违法违约的图片，一经发现，永久封号，
          并保留追究法律责任的权利。</p>
      </div>
      <img @click="update_avatar_confirm" class="btn" src="../image/yes.png" alt="">
    </div>
	</div>
	<script>
	apiready = function(){
        Vue.prototype.game = new Game("../mp3/bg1.mp3");
		new Vue({
			el:"#app",
			data(){
				return {
				}
			},
			methods:{
                update_avatar_confirm(){
                    // 确认上传头像的来源
                    api.actionSheet({
                        title: '请选择上传头像的来源',
                        cancelTitle: '取消',
                        buttons: ['相册','相机','图库'],
                    }, (ret, err)=>{
                        var sourceType = ["album","camera", "library"];
                        if(ret.buttonIndex > sourceType.length){
                            // 如果用户选择了取消,则关闭当前修改头像的页面
                            this.game.outFrame();
                        }else{
                            // 获取头像
                            api.getPicture({
                                sourceType: sourceType[ret.buttonIndex-1],
                                mediaValue: 'pic',  // 媒体类型是图片
                                destinationType: 'base64',  // 数据类型是图片内容经过base64算法处理以后的内容
                                allowEdit: true,   // 允许选择图片后进行编辑
                                preview: true,     // 选择图片后进行预览，IOS
                                quality: 100,      // 图片质量，只针对jpg格式图片（0-100整数）
                                targetWidth: 100,  // 压缩后的图片宽度，图片会按比例适配此宽度
                                targetHeight: 100, // 压缩后的图片高度，图片会按比例适配此高度
                                saveToPhotoAlbum: true, // 拍照或录制视频后是否保存到系统相册目录。
                            }, (ret, err)=>{
                                // 头像上传处理
                                this.upload_avatar(ret);
                            });

                        }
                    });
                },
                upload_avatar(ret){
                    // 头像上传处理
                    let token = this.game.token().access_token;
                    this.axios.post("",{
						"jsonrpc": "2.0",
						"id": this.game.uuid(),
						"method": "Users.avatar",
						"params": {
                            "img": ret.base64Data,
                        }
					},{
                        headers:{
                            Authorization: `jwt ${token}`
                        }
                    }).then(response=>{
                        // 上传处理完成头像以后，删除本次登录时保存在本地的token数据（旧数据）
                        this.game.delfs(["access_token","refresh_token"]);
						this.game.deldata(["access_token","refresh_token"]);
                        // 修改了个人信息以后，就默认不记住登陆状态了
                        this.game.setdata({
                            'access_token': response.data.result.access_token,
                            'refresh_token': response.data.result.refresh_token
                        });

                        // 基于APICloud提供全局事件，通知其他窗口或页面，进行用户信息更新操作
                        api.sendEvent({
                            name: 'change_token',
                            extra: {}
                        });

                        // 上传头像处理完成以后关闭页面
                        this.back();

                    }).catch(error=>{

                    })
                },
                back(){
                    this.game.outFrame();
                }
			}
		});
	}
	</script>
</body>
</html>
```

用户信息页面user.hml和安全设置页面setting.html，对change_token进行监听并接收全局通知

setting.html, 代码：

```html
<!DOCTYPE html>
<html>
<head>
	<title>系统设置</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
    <script src="../script/v-avatar-2.0.3.min.js"></script>
  <script src="../script/main.js"></script>
</head>
<body>
	<div class="app user setting" id="app">
		<div class="bg">
      <img src="../image/form_bg.png">
    </div>
		<img class="back" @click="back" src="../image/user_back.png" alt="">
    <div class="form">
      <div class="item avatar" @click="open_avatar">
        <span class="title">头像</span>
        <span class="goto">&gt;</span>
        <span class="value">
            <v-avatar v-if="user_info.avatar" :src="user_info.avatar" :size="55" :rounded="true"></v-avatar>
            <v-avatar v-else-if="user_info.nickname" :username="user_info.nickname" :size="55" :rounded="true"></v-avatar>
            <v-avatar v-else :username="user_info.id" :size="55" :rounded="true"></v-avatar>
        </span>
      </div>
      <div class="item">
        <span class="title">昵称</span>
        <span class="goto">&gt;</span>
        <span class="value">{{user_info.nickname}}</span>
      </div>
      <div class="item">
        <span class="title">手机号</span>
        <span class="goto">&gt;</span>
        <span class="value" v-if="user_data.mobile">{{game.mobile(user_data.mobile)}}</span>
      </div>
      <div class="item">
        <span class="title">登陆密码</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">交易密码</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">地址管理</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item">
        <span class="title">设备管理</span>
        <span class="value"></span>
        <span class="goto">&gt;</span>
      </div>
      <div class="item logout">
        <img @click="change_account" src="../image/change_account.png" alt="">
        <p @click="logout">退出账号</p>
      </div>
    </div>
	</div>
	<script>
	apiready = function(){
        Vue.prototype.game = new Game("../mp3/bg1.mp3");
		new Vue({
			el:"#app",
			data(){
				return {
                    user_info:{},  // 本地token中载荷的用户基本信息
                    user_data:{},  // 服务端中用户的详情信息
                }
			},
			created(){
                this.listener();
				this.user_info = this.game.user_info();
                this.get_user_data();
			},
			methods:{
                listener(){
                    // 监听token是否更新
                    this.listener_change_token();
                    
                },
                listener_change_token(){
                    // 监听token更新的处理
                    api.addEventListener({
                        name:'change_token',
                    }, (ret)=>{
                        this.user_info = this.game.user_info();
                    })
                },
                back(){
                    this.game.outFrame();
                },
                change_account(){
                    // 切换账号
                    this.game.goWin("login","login.html"); // 打开登陆窗口
                    setTimeout(()=>{
                        this.back(); // 延时当前窗口
                    },500);
                },
                logout(){
                // 退出账号
                    api.actionSheet({
                        title: '您确认要退出当前登录状态吗？',
                        cancelTitle: '取消',  // 取消按钮，buttonIndex=最后一个值
                        destructiveTitle: "确认退出", // 默认按钮，会自动高亮显示buttonIndex=1
                        // buttons: ['再考虑1下','再考虑2下'] // buttonIndex=2,3,...
                    }, (ret, err)=>{
                        if( ret ){
                            if(ret.buttonIndex==1){
                                this.user_logout()
                            }
                        }
                    });
                },
                user_logout(){
                    // 请求服务端删除登陆状态的access_token
                    let token = this.game.token().access_token;
                    this.axios.post("",{
						"jsonrpc": "2.0",
						"id": this.game.uuid(),
						"method": "Users.logout",
						"params": {}
					},{
                        headers:{
                            Authorization: `jwt ${token}`
                        }
                    }).then(response=>{
                        // 退出登陆成功以后，删除本地token，接着关闭当前用户窗口(window)
                        this.game.deldata(["access_token","refresh_token"]);
                        this.game.delfs(["access_token","refresh_token"]);                        
                        this.game.outWin();
                    }).catch(error=>{

                    })
                },
                get_user_data(){
                    // 获取用户的详情信息
                    let token = this.game.token().access_token;
                    this.axios.post("",{
						"jsonrpc": "2.0",
						"id": this.game.uuid(),
						"method": "Users.info",
						"params": {

						}
					},{
                        headers:{
                            Authorization: `jwt ${token}`
                        }
                    }).then(response=>{
                        this.user_data = response.data.result.data;
                    }).catch(error=>{

                    })
                },
                open_avatar(){
                    // 打开头像更新窗口
                    this.game.goFrame("avatar","avatar.html", null, "from_top");
                }
			}
		});
	}
	</script>
</body>
</html>
```

在user.html页面中，监听接收全局通知事件.

```html
<!DOCTYPE html>
<html>
<head>
	<title>用户中心</title>
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta charset="utf-8">
	<link rel="stylesheet" href="../css/main.css">
	<script src="../script/vue.js"></script>
	<script src="../script/axios.js"></script>
	<script src="../script/v-avatar-2.0.3.min.js"></script>
  	<script src="../script/main.js"></script>
</head>
<body>
	<div class="app user" id="app">
		<div class="bg">
      <img src="../image/bg0.jpg">
    </div>
		<img class="back" @click="back" src="../image/user_back.png" alt="">
		<img class="setting" @click="open_setting" src="../image/setting.png" alt="">
		<div class="header">
			<div class="info">
				<div class="avatar">
					<img class="avatar_bf" src="../image/avatar_bf.png" alt="">
					<div class="user_avatar">
						<v-avatar v-if="user_info.avatar" :src="user_info.avatar" :size="55" :rounded="true"></v-avatar>
						<v-avatar v-else-if="user_info.nickname" :username="user_info.nickname" :size="55" :rounded="true"></v-avatar>
						<v-avatar v-else :username="user_info.id" :size="55" :rounded="true"></v-avatar>
					</div>
					<img class="avatar_border" src="../image/avatar_border.png" alt="">
				</div>
				<p class="user_name">{{user_info.nickname}}</p>
			</div>
			<div class="wallet">
				<div class="balance">
					<p class="title"><img src="../image/money.png" alt="">钱包</p>
					<p class="num">{{game.money(user_info.money)}}</p>
				</div>
				<div class="balance">
					<p class="title"><img src="../image/integral.png" alt="">果子</p>
					<p class="num">{{game.money(user_info.credit)}}</p>
				</div>
			</div>
			<div class="invite">
				<img class="invite_btn" src="../image/invite.png" alt="">
			</div>
		</div>
		<div class="menu">
				<div class="item">
					<span class="title">我的主页</span>
					<span class="value">查看</span>
				</div>
				<div class="item">
					<span class="title">任务列表</span>
					<span class="value">75%</span>
				</div>
				<div class="item">
					<span class="title">收益明细</span>
					<span class="value">查看</span>
				</div>
				<div class="item">
					<span class="title">实名认证</span>
					<span class="value">未认证</span>
				</div>
				<div class="item">
					<span class="title">问题反馈</span>
					<span class="value">去反馈</span>
				</div>
			</ul>
		</div>
	</div>
	<script>
	apiready = function(){
        Vue.prototype.game = new Game("../mp3/bg1.mp3");
		new Vue({
			el:"#app",
			data(){
				return {
					user_info: {}, // 当前登陆用户信息
				}
			},
			created(){
				this.listener();
				this.user_info = this.game.user_info();
				this.game.print(this.user_info);
			},
			methods:{
				listener(){
                    // 监听token是否更新
                    this.listener_change_token();
                    
                },
				listener_change_token(){
                    // 监听token更新的处理
                    api.addEventListener({
                        name:'change_token',
                    }, (ret)=>{
                        this.user_info = this.game.user_info();
                    })
                },
                back(){
                    // 返回首页
                    this.game.outWin();
                },
				open_setting(){
					this.game.goFrame('settings','setting.html');
				}
			}
		});
	}
	</script>
</body>
</html>
```



### 服务端存储静态文件到阿里OSS云存储

地址：https://oss.console.aliyun.com/bucket

创建存储空间(一个项目对应一个存储空间)

![image-20211112172730403](8%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83.assets/image-20211112172730403-16445613499041.png)

![image-20211112172752263](8%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83.assets/image-20211112172752263-16445613499042.png)

![image-20211112172817949](8%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83.assets/image-20211112172817949-16445613499053.png)

接下来，我们基于oss提供的地址访问上传的静态资源。

![image-20211112173032545](8%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83.assets/image-20211112173032545-16445613499054.png)

点击详情

![image-20211112173100025](8%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83.assets/image-20211112173100025-16445613499055.png)

直接访问：http://mofangproject.oss-cn-beijing.aliyuncs.com/pic.png

![image-20211112173125634](8%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83.assets/image-20211112173125634-16445613499056.png)

接下来我们就需要在api服务端基于oss提供的sdk来操作和上传静态资源。

#### 安装

文档：https://help.aliyun.com/document_detail/85288.html

```
pip install oss2 -i https://pypi.douban.com/simple
```

接下來要調用oss2提供的接口操作方法，需要基于阿里云的访问ID和秘钥。

```
Bucket name：      mofangproject
AccessKey ID：     xxxxxxxxxx
AccessKey Secret： xxxxxxxxxxxxx
基于上面创建的Bucket存储空间
	Endpoint地域节点：oss-cn-beijing.aliyuncs.com
	Bucket 域名：mofangproject.oss-cn-beijing.aliyuncs.com
```

基本使用

可以把下面的操作写到文件中运行，oss2Demo.py，代码：

```python
import oss2,uuid,base64

if __name__ == '__main__':
    endpoint = "oss-cn-beijing.aliyuncs.com"
    AccessKeyID = "xxxxxxxxxxxx"
    AccessKeySecret = "xxxxxxxxxxxxxxxxx"
    bucket_name = "mofangproject"

    auth = oss2.Auth(AccessKeyID, AccessKeySecret)

    bucket = oss2.Bucket(auth, endpoint, bucket_name)

    base64_avatar = "base64格式图片信息"
    b64_image = base64.b64decode(base64_avatar)  # 把base64转换成bytes类型数据
    filename = uuid.uuid4().__str__()
    full_filename = f"demo/{filename}.png"
    bucket.put_object(full_filename, b64_image) # png仅仅时举例，实际开发中肯定时根据内容来设置真实的文件扩展名

    object_stream = bucket.get_object(full_filename)
    content = object_stream.read()
    with open(f"{filename}.png", "wb+") as f:
        f.write(content)
```



### 服务端调整头像更新接口

#### 封装oss操作的工具类

`utils.alioss`，代码：

```python
import oss2

class OSS(object):
    """
    阿里云对象存储工具类
    """
    def __init__(self, app=None):
        if app is not None:
            self.init_app(app)

    def init_app(self,app):
        """初始化"""
        self.app = app
        return self.setup()

    def setup(self):
        """安装"""
        self.endpoint = self.app.config.get("OSS_ENDPOINT")
        self.bucket_name = self.app.config.get("OSS_BUCKET_NAME")
        self.bucket_url = self.app.config.get("OSS_BUCKET_URL")
        self.access_key_id = self.app.config.get("ALI_ACCESS_KEY_ID")
        self.access_key_secret = self.app.config.get("ALI_ACCESS_KEY_SECRET")
        self.auth = oss2.Auth(self.access_key_id, self.access_key_secret)
        self.bucket = oss2.Bucket(self.auth, self.endpoint, self.bucket_name)
        return self.bucket

    def upload(self,name,data):
        """文件上传"""
        return self.bucket.put_object(name,data)

    def download(self, remote_name, local_name):
        """
        文件下载
        :param remote_name 要下载的文件路径
        :param local_name 本次保存下载文件的路径
        """
        object_stream = self.bucket.get_object(remote_name)
        content = object_stream.read()
        with open(f"{local_name}", "wb+") as f:
            f.write(content)

```

在settings/dev.py中配置阿里云对象存储的配置信息，代码：

```python
"""阿里云"""
ALI_ACCESS_KEY_ID = "xxxxxxxx"  # 访问key
ALI_ACCESS_KEY_SECRET = "xxxxxxxx"  # 访问秘钥

# OSS对象存储
OSS_ENDPOINT = "oss-cn-beijing.aliyuncs.com"  # 存储节点
OSS_BUCKET_NAME = "mofangproject" # 存储空间
OSS_BUCKET_URL = "https://mofangproject.oss-cn-beijing.aliyuncs.com"
```



在`application.__init__`，代码：

```python
# 项目初始化主程序

from pathlib import Path

from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_redis import FlaskRedis
from flask_pymongo import PyMongo
from flask_jsonrpc import JSONRPC
from celery import Celery
from flask_jwt_extended import JWTManager
from flask_admin import Admin, AdminIndexView
from flask_admin.contrib.fileadmin import FileAdmin
from flask_admin.contrib import rediscli
from flask_babelex import Babel
from redis import Redis
from faker import Faker

from application.utils.config import Config
from application.utils.logger import Log
from application.utils.commands import Command
from application.utils.blueprint import register_blueprint, path, APIView
from application.utils import code, message
from application.utils.alioss import OSS

"""加载组件[单例模式]"""

# 初始化配置加载类
config: Config = Config()

# SQLAlchemy初始化
db: SQLAlchemy = SQLAlchemy()

# redis初始化
redis_cache: FlaskRedis = FlaskRedis(config_prefix="REDIS")
redis_check: FlaskRedis = FlaskRedis(config_prefix="CHECK")


# mongo初始化
mongo: PyMongo = PyMongo()


# 日志配置类初始化
logger: Log = Log()

# 终端命令管理类实例化
command: Command = Command()


# 实例化JSONRPC
jsonrpc = JSONRPC()

# celery初始化
celery = Celery()


# jwt认证模块实例化
jwt = JWTManager()

# flask-admin模块初始化
admin = Admin()

# 国际化/本地化配置初始化
babel = Babel()

# 阿里云OSS对象存储
oss = OSS()


def init_app(config_path: str) -> Flask:
    """用于创建app实例对象并完成初始化过程的工厂函数"""
    # 实例化flask应用对象
    app: Flask = Flask(__name__)
    # 项目跟目录路径
    app.BASE_DIR = Path(__file__).resolve().parent.parent
    # 加载配置
    config.init_app(app, config_path)

    # 加载mysql数据库配置
    db.init_app(app)

    # redis加载配置
    redis_cache.init_app(app)
    redis_check.init_app(app)

    # pymongo加载配置
    mongo.init_app(app)

    # 日志加载配置
    logger.init_app(app)

    # 终端命令管理类加载配置
    command.init_app(app)

    # jsonrpc注册到项目中，必须写在蓝图注册代码的上方
    # 开启rpc接口的web调试界面：/api/browse
    jsonrpc.browse_url = app.config.get("API_BROWSE_URL", "/api/browse")
    jsonrpc.enable_web_browsable_api = app.config.get("DEBUG", False)
    jsonrpc.init_app(app)

    # jwt初始化，必须写在蓝图注册代码的上方
    jwt.init_app(app)

    # 注册蓝图
    register_blueprint(app, jsonrpc)

    # admin站点
    admin.name = app.config['FLASK_ADMIN_NAME']
    admin.template_mode = app.config['TEMPLATE_MODE']
    admin._set_admin_index_view(index_view=AdminIndexView(
        name=app.config["ADMIN_HOME_NAME"],
        template=app.config["ADMIN_HOME_TEMPLATE"],
    ))

    # 项目静态文件、上传文件的管理视图
    static_path = str( app.BASE_DIR / "application/static")
    print(static_path)
    # 注意: flask_admin不仅可以管理当前系统的指定目录，还可以通过配置管理阿里云OSS这样的远程服务端的静态文件，默认支持AWS的静态存储节点调用
    admin.add_view(FileAdmin(static_path, '/static/', name='静态文件', category="资源管理"))

    # 集成redis终端到Admin站点中
    admin.add_view(rediscli.RedisCli(Redis.from_url(app.config.get("REDIS_URL")), name='redis_db_0', endpoint="redis_db_0", category="Redis", url="redis/0"))
    admin.add_view(rediscli.RedisCli(Redis.from_url(app.config.get("CHECK_URL")), name='redis_db_1', endpoint="redis_db_1", category="Redis", url="redis/1"))
    admin.add_view(rediscli.RedisCli(Redis.from_url(app.config.get("CELERY_RESULT_BACKEND")), name='redis_db_14', endpoint="redis_db_14", category="Redis", url="redis/14"))
    admin.add_view(rediscli.RedisCli(Redis.from_url(app.config.get("BROKER_URL")), name='redis_db_15', endpoint="redis_db_15", category="Redis", url="redis/15"))

    admin.init_app(app)

    # 国际化/本地化
    babel.init_app(app)

    # 数据种子生成器[faker]
    app.faker = Faker(app.config.get("LANGUAGE"))

    # 加载celery配置
    celery.main = app.name
    celery.app = app
    # 更新配置
    celery.conf.update(app.config)
    # 自动注册任务
    celery.autodiscover_tasks(app.config.get("INSTALL_BLUEPRINT"))

    # 阿里云对象存储安装注册
    oss.init_app(app)

    # db创建数据表
    with app.app_context():
        db.create_all()

    return app

```



#### 服务端更新头像的存储代码进行调整

users/services.py，代码：

```python
from application import db, redis_cache as cache, oss

class UploadFileError(Exception):
    """
    上传文件失败
    """
    pass

def save_avatar(img: str, ext: str) -> str:
    """
    保存头像
    :param img 客户端上传的头像内容(base64内容)
    :param ext 头像文件类型后缀
    """
    b64_avatar = img[img.find(",") + 1:]  # 获取头像图片base64内容
    b64_image = base64.b64decode(b64_avatar)  # 把base64转换成bytes类型数据
    filename = uuid.uuid4()  # 基于UUID生成随机文件名，防止图片名字重复

    # # 暂时先保存到本地[本地目录要手动创建]
    # static_path = current_app.BASE_DIR / current_app.config["AVATAR_DIR"]

    # # 图片信息写入到指定文件名中
    # print("%s/%s.%s" % (static_path, filename, ext))
    # with open("%s/%s.%s" % (static_path, filename, ext), "wb") as f:
    #     f.write(b64_image)
    #
    # url = f"{request.host_url}{current_app.config['AVATAR_URL']}/{filename}.{ext}"

    # 图片信息上传到阿里云OSS对象存储
    file = f"{current_app.config['AVATAR_URL']}/{filename}.{ext}"
    ret = oss.upload(file, b64_image)
    if ret.status != 200:
        raise UploadFileError()

    url = f"{oss.bucket_url}/{file}"
    
    return url

```

提交代码版本

```python
git add .
git commit -m "fix: update avatar to oss"
git push
```



## 基于装饰器实现用户身份信息的提取

在现有的接口代码中，因为个人中心必须用户登录以后才能进行操作，所以每次都需要验证jwt，从jwt中获取用户信息或用户模型，并确认用户在数据库中存在。也因此接口代码中会存在了大部分类似的验证代码，在此我们对这些认证相关和获取用户模型的代码进行简单的封装处理。

utils/decorators.py，代码：

```python
from typing import Callable, Any, Union, Dict
from flask_jwt_extended import get_jwt_identity, jwt_required
from application import code, message


def get_user_object(func: Callable) -> Callable:
    """用户鉴权，并获取用户模型对象"""
    @jwt_required()  # 验证jwt
    def wrapper(*args, **kwargs) -> Union[Callable, Dict[str, Any]]:
        from application.apps.users.models import User
        payload = get_jwt_identity()
        user_id = int(payload["id"])
        user = User.query.filter(User.id == user_id).first()
        if user is None:
            return {
                "errno": code.CODE_USER_NOT_EXISTS,
                "errmsg": message.user_not_exists
            }
        return func(user, *args, **kwargs)

    return wrapper
```

为了方便调用，我们直接在`application.__init__`，导入装饰器，代码：

```python
from application.utils.decorators import get_user_object
```

在users/api.py中，凡是验证access_token，全部改成get_user_object进行装饰，并给api视图函数新增user模型对象参数。

users/api.py，代码：

```python
import random

from typing import Dict, Union, Any
from flask_jwt_extended import get_jwt_identity, jwt_required

from application import message, code, redis_check as redis, get_user_object
from .serializers import MobileSchema, ValidationError, UserSchema, UserLoginSchema
from .models import User
from .tasks import send_sms
from .services import gen_token, get_user_by_id, del_token, save_avatar, update_user


def check_mobile(mobile: str) -> Dict[str, Union[str, int]]:
    """
    验证手机号码是否已经注册
    :param mobile: 手机号码
    :return:
    """
    # 调用构造器反序列化验证
    ms: MobileSchema = MobileSchema()
    try:
        ms.load({"mobile": mobile})
        result: Dict[str, Union[str, int]] = {"errno": code.CODE_OK, "errmsg": message.ok}
    except ValidationError as e:
        result: Dict[str, Union[str, int]] = {"errno": code.CODE_VALIDATE_ERROR, "errmsg": e.messages["mobile"][0]}

    return result


def register(mobile: str, password: str, password2: str, sms_code: str) -> Dict[str, Any]:
    """
    用户信息注册
    :param mobile: 手机号
    :param password: 登录密码
    :param password2: 确认密码
    :param sms_code: 短信验证码
    :return:
    """
    try:
        ms: MobileSchema = MobileSchema()
        ms.load({"mobile": mobile})

        us: UserSchema = UserSchema()
        user: User = us.load({
            "mobile": mobile,
            "password": password,
            "password2": password2,
            "sms_code": sms_code
        })
        result: Dict[str, Union[str, Any]] = {"errno": code.CODE_OK, "errmsg": us.dump(user)}
    except ValidationError as e:
        result: Dict[str, Union[str, Any]] = {"errno": code.CODE_VALIDATE_ERROR, "errmsg": e.messages}
    return result


def sms(mobile: str) -> Dict[str, Any]:
    """
    发送短信验证码
    :param mobile: 手机号
    :return:
    """
    # 验证手机
    ret: Dict[str, Any] = check_mobile(mobile=mobile)
    if ret["errno"] != 0:
        return ret

    # 短信发送冷却时间
    ret: int = redis.ttl("int_%s" % mobile)
    if ret > 0:
        return {
            "errno": code.CODE_INTERVAL_TIME,
            "errmsg": message.sms_interval_time,
            "data": {
                "time": ret,
            }
        }

    # 生成验证码
    sms_code: str = "%04d" % random.randint(0, 9999)


    # 异步发送短信
    send_sms.delay(mobile=mobile, sms_code=sms_code)

    return {"errno": code.CODE_OK, "errmsg": message.ok}


def login(account: str, password: str, ticket: str, randstr: str) -> Dict[str, Any]:
    """
    用户jwt登录
    :param account: 账户名[可以是手机号、邮箱、用户名]
    :param password: 登录密码
    :return
    """
    # 1. 验证数据
    try:
        us: UserLoginSchema = UserLoginSchema()
        # 反序列化
        user: User = us.load({
            "account": account,
            "password": password,
            "ticket": ticket,
            "randstr": randstr
        })

        # 序列化
        payload: Dict[str, Any] = us.dump(user)

        # 2. 生成jwt assess token 和 refresh token
        access_token, refresh_token = gen_token(payload=payload)

        # 3. 返回2个token给客户端
        result: Dict[str, Any] = {
            "errno": code.CODE_OK,
            "errmsg": message.ok,
            "access_token": access_token,
            "refresh_token": refresh_token
        }

    except ValidationError as e:
        result: Dict[str, Any] = {"errno": code.CODE_VALIDATE_ERROR, "errmsg": e.messages}

    return result


@get_user_object   # 验证 jwt的 assess token
def info(user: User) -> Any:
    """获取用户身份信息"""
    user_info: Dict[str, Any] = get_jwt_identity()
    user_info["mobile"] = user.mobile
    return {
        "errno": code.CODE_OK,
        "errmsg": message.ok,
        "data": user_info,
    }


@jwt_required(refresh=True)  # 验证 jwt的 refresh token
def refresh() -> Dict[str, Any]:
    """依靠refresh token 换取 assess token"""
    user_info: Dict[str, Any] = get_jwt_identity() # 获取refresh token中的载荷
    user: User = get_user_by_id(user_info["id"])
    if user is None:
        return {
            "errno": code.CODE_USER_NOT_EXISTS,
            "errmsg": message.user_not_exists
        }

    access_token,  _ = gen_token(payload=user_info)

    return {
        "errno": code.CODE_OK,
        "errmsg": message.ok,
        "access_token": access_token
    }


@get_user_object  # 验证 jwt的 assess token
def verify(user: User) -> Any:
    """验证access_token并生成新的access_token"""
    payload: Dict[str, Any] = get_jwt_identity()  # 获取refresh token中的载荷
    access_token, _ = gen_token(payload=payload)
    return {
        "errno": code.CODE_OK,
        "errmsg": message.ok,
        "access_token": access_token
    }


@jwt_required()
def logout() -> Any:
    """退出登录状态"""
    payload: Dict[str, Any] = get_jwt_identity()  # 获取refresh token中的载荷
    # 删除redis中的access_token
    del_token(payload["id"])

    return {
        "errno": code.CODE_OK,
        "errmsg": message.ok,
    }


@get_user_object
def avatar(user: User, img: str) -> Dict[str, Any]:
    """
    更新头像
    :param img 客户端上传的头像信息(base64内容)
    """
    # 1. 接受客户端上传的头像信息
    ext = img[img.find("/") + 1:img.find(";")]  # 资源格式，文件后缀

    # 判断格式是否符合要求
    if ext not in ["png", "svg", "jpeg", "jpg"]:
        return {
            "errno": code.CODE_IMAGE_FORMAT_ERROR,
            "errmsg": message.image_format_error,
        }

    # 保存头像
    url = save_avatar(img, ext)

    # 更新用户信息
    user_info: Dict[str, Any] = get_jwt_identity()  # 获取refresh token中的载荷
    update_user(user, {"avatar": url})
    user_info["avatar"] = url

    # 更新token
    access_token, refresh_token = gen_token(user_info)
    return {
        "errno": code.CODE_OK,
        "errmsg": message.ok,
        "access_token": access_token,
        "refresh_token": refresh_token,
    }
```

