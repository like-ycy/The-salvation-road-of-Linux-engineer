# 购物车实现

## 准备工作

### 新建代码分支

```bash
git checkout master
git merge feature/course
git branch -d feature/course
git add .
git commit -m "合并课程内容分支到master"
git push origin master
git push origin --delete feature/course
git tag v0.0.4 -m "课程信息管理功能完成"
git push origin v0.0.4

git checkout -b feature/cart
```

### 创建子应用 cart

```
cd fuguangapi/apps
python ../../manage.py startapp cart
```

### 注册子应用cart

```python
INSTALLED_APPS = [
    'simpleui',
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',

    'rest_framework',
    'corsheaders',  # cors跨域子应用
    'ckeditor',     # 富文本插件核心应用
    'ckeditor_uploader',  # 用于支持富文本插件上传文件使用的
    'stdimage',     # 生成缩略图
    'haystack',

    'home',
    'users',
    'courses',
    'cart',
]

```

子路由注册到总路由

cart/urls.py，代码：

```python
from django.urls import path
from . import views
urlpatterns = [

]
```

fuguangapi/urls.py，总路由，代码：

```python
from django.contrib import admin
from django.urls import path, include, re_path

from django.conf import settings
from django.views.static import serve  # 静态文件代理访问模块

urlpatterns = [
    path('admin/', admin.site.urls),
    re_path(r'uploads/(?P<path>.*)', serve, {"document_root": settings.MEDIA_ROOT}),
    path('ckeditor/', include('ckeditor_uploader.urls')),
    path('', include("home.urls")),
    path("users/", include("users.urls")),
    path("courses/", include("courses.urls")),
    path("cart/", include("cart.urls")),
]

```

因为购物车中的商品(课程)信息会经常被用户操作，所以为了减轻mysql服务器的压力,可以选择把购物车信息通过redis来存储.

### 配置信息

```python
# redis configration
# https://django-redis-chs.readthedocs.io/zh_CN/latest/#
# 设置redis缓存
CACHES = {
    # 默认缓存
    "default": {
        "BACKEND": "django_redis.cache.RedisCache",
        # 项目上线时,需要调整这里的路径
        "LOCATION": "redis://:123456@127.0.0.1:6379/0",
        "OPTIONS": {
            "CLIENT_CLASS": "django_redis.client.DefaultClient",
        }
    },
    # 提供给admin站点的session存储
    "session": {
        "BACKEND": "django_redis.cache.RedisCache",
        "LOCATION": "redis://:123456@127.0.0.1:6379/1",
        "OPTIONS": {
            "CLIENT_CLASS": "django_redis.client.DefaultClient",
        }
    },
    # 提供存储短信验证码
    "sms_code":{
        "BACKEND": "django_redis.cache.RedisCache",
        "LOCATION": "redis://:123456@127.0.0.1:6379/2",
        "OPTIONS": {
            "CLIENT_CLASS": "django_redis.client.DefaultClient",
        }
    },
    # 提供存储搜索热门关键字
    "hot_word": {
        "BACKEND": "django_redis.cache.RedisCache",
        "LOCATION": "redis://:123456@127.0.0.1:6379/3",
        "OPTIONS": {
            "CLIENT_CLASS": "django_redis.client.DefaultClient",
        }
    },
    # 提供存储购物车课程商品
    "cart": {
        "BACKEND": "django_redis.cache.RedisCache",
        "LOCATION": "redis://:123456@127.0.0.1:6379/4",
        "OPTIONS": {
            "CLIENT_CLASS": "django_redis.client.DefaultClient",
        }
    },
}

```



接下来购物车中要实现记录用户添加到购物车中的商品信息，存储数据应有以下内容:

```python
购物车中的商品数据的格式：
    商品数量[因为目前的商品是课程，属于虚拟商品，所以没有数量的，如果以后做到真实商品，则必须有数量]
    商品id
    用户id
    商品勾选状态----> 在用户勾选了商品以后，该商品才会在结算阶段中出现。没勾选则会保留在购物车中，等下次购买。

五种数据类型
    hash哈希字典
        用户ID:{
            商品ID1: 商品数量,
            商品ID2: 商品数量,
        }
        用户ID：{商品ID1,商品ID2,....}
    list列表
        键: [值1,值2,....]
    set集合
        键: {值1,值2,....}

经过比较可以发现没有一种数据类型完整有效的存储购物车数据，勉强可以保存的只有hash，但是hash默认情况下只会保存3种数据而已，当如果再需要保存1种，则可能需要花费更多的操作完成这个存储过程，所以我们完全使用redis的2种数据结构或多种数据结构来分别保存购物车数据

可以发现，上面5种数据类型中，哈希hash可以存储的数据量是最多的。因为购物车中的商品不需要顺序，反而需要在勾选的时候进行唯一的处理，所以选用set
当然，现在我们实现的在线教育商城只需要保存的字段只有：用户ID，商品ID，勾选状态即可。所以我们采用hash一种数据结构即可。

当前在线教育商城的购物车数据结构：
hash：
    键[用户ID]:{
        域[商品ID]:勾选状态,
        域[商品ID]:勾选状态,
        域[商品ID]:勾选状态,
        域[商品ID]:勾选状态,
    }

如果将来保存有数量的商品：
hash：
    键[用户ID]:{
        域[商品ID]:商品数量,
        域[商品ID]:商品数量,
        域[商品ID]:商品数量,
        域[商品ID]:商品数量,
    }
set:
    键[用户ID]:{商品ID1,商品ID2....}
```



可以结合我们之前在项目第一天的需求，进行分析：

```bash
POST   添加商品到购物车
GET    列表购物车所有商品
PATCH  对购物车中的商品切换勾选状态
PUT    对购物车中的所有商品批量切换勾选状态
DELETE 从购物车删除商品


CreateAPIView
ModelViewSet  ---> 5个基本接口
ViewSet       --->
```





## 添加课程商品到购物车

cart/views.py视图，代码：

```python
from django_redis import get_redis_connection
from rest_framework import status
from rest_framework.viewsets import ViewSet
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

# Create your views here.
from courses.models import Course


class CartViewSet(ViewSet):
    """购物车"""
    # 保证用户必须是登录状态才能调用当前视图
    permission_classes = [IsAuthenticated]

    def add_cart(self, request):
        """添加商品到购物车"""
        # 接收客户端的信息[用户ID，商品ID，勾选状态]
        user_id = request.user.id
        course_id = request.data.get("course_id")
        selected = 1

        # 验证数据
        try:
            Course.objects.get(is_delete=False, is_show=True,pk=course_id)
        except Course.DoesNotExist:
            return Response({"errmsg": "当前课程不存在！"}, status=status.HTTP_400_BAD_REQUEST)

        # 获取redis连接
        redis = get_redis_connection("cart")

        # todo 因为我们当前实现是属于虚拟商品的购买，是没有数量的。所以，针对同一个课程，或者曾经购买过的课程，不让用户再次添加到购物车
        ret = redis.hexists(f"cart_{user_id}", course_id)
        cart_total = redis.hlen(f"cart_{user_id}")
        if ret:
            return Response({
                "errmsg": "当前商品课程已经被添加到购物车，请不要重复添加！",
                "cart_total": cart_total,
            })

        # 保存商品信息到购物车
        # hset <user_id> <course_id> <selected>
        redis.hset(f"cart_{user_id}", course_id, selected)
        """
        cart_1: {
           course_id: True,
           course_id: True,
           course_id: True,
        }

        cart_2: {
           ....
        }
        """

        # 返回操作结果，购物车中的商品总数
        # hlen <user_id>
        cart_total = redis.hlen(f"cart_{user_id}")

        # 5. 返回结果给客户端
        return Response({
            "errmsg": "成功添加商品课程到购物车！",
            "cart_total": cart_total
        }, status=status.HTTP_201_CREATED)


```

redis的异常处理，utils/exceptions.py，代码：

```python
import logging

from rest_framework.views import exception_handler as drf_exception_handler
from rest_framework.response import Response
from rest_framework import status
from django.db import DatabaseError
from redis.exceptions import RedisError

logger = logging.getLogger("django")


def exception_handler(exc, context):
    """
    自定义异常处理
    :param exc: 本次出现异常的异常实例对象
    :param context: 抛出异常的上下文
    :return: Response响应对象
    """
    # 调用drf框架原生的异常处理方法
    response = drf_exception_handler(exc, context)

    if response is None:
        view = context['view']

        if isinstance(exc, DatabaseError):
            # 数据库异常
            logger.error('[%s] %s' % (view, exc))
            response = Response({'errmsg': '服务器内部错误'}, status=status.HTTP_507_INSUFFICIENT_STORAGE)

        elif isinstance(exc, RedisError):
            logger.error('redis操作异常！[%s] %s' % (view, exc))
            response = Response({'errmsg': '服务器内部错误'}, status=status.HTTP_507_INSUFFICIENT_STORAGE)

    return response

```

urls.py，代码：

```python
from django.urls import path
from . import views

urlpatterns = [
    path("", views.CartViewSet.as_view({
        "post": "add_cart"
    }))
]
```



### 客户端用户添加商品到购物车

`api/cart.js`，代码：

```javascript
import http from "../utils/http";
import {reactive} from "vue";

const cart = reactive({
    add_course_to_cart(course_id, token ){
        // 添加课程到购物车
        return http.post("/cart/", {
            course_id, // course_id: course_id,
        }, {
            headers: {
                // 因为当前课程端添加课程商品到购物车必须登录，所以接口操作时必须发送jwt
                Authorization: "jwt " + token,   // 注意：jwt字符串与token之间务必有空格！否则无法认证
            }
        })
    }
});

export default cart;
```

`views/Course.vue`，代码：

```vue
                    <p class="two clearfix">
                        <span class="price l red bold" v-if="course_info.discount.price>=0">￥{{parseFloat(course_info.discount.price).toFixed(2)}}</span>
                        <span class="price l red bold" v-else>￥{{parseFloat(course_info.price).toFixed(2)}}</span>
                        <span class="origin-price l delete-line" v-if="course_info.discount.price>=0">￥{{parseFloat(course_info.price).toFixed(2)}}</span>
                        <span class="add-shop-cart r" @click.prevent.stop="add_cart(course_info)"><img class="icon imv2-shopping-cart" src="../assets/cart2.svg">加购物车</span>
                    </p>
```

```html
<script setup>
import {watch} from "vue";
import Header from "../components/Header.vue"
import Footer from "../components/Footer.vue"
import course from "../api/course";
import {fill0} from "../utils/func";
import cart from "../api/cart";
import {ElMessage} from "element-plus";
import {useStore} from "vuex";
const store = useStore()

course.get_course_direction().then(response=>{
  // 获取学习方向
  course.direction_list = response.data;
})


const get_category = ()=>{
  // 获取课程分类

  // 重置当前选中的课程分类
  course.current_category=0;

  course.get_course_category().then(response=>{
    course.category_list = response.data;
  })
}

get_category();

const get_hot_word = ()=>{
  // 搜索热门关键字列表
  course.get_hot_word().then(response=>{
    course.hot_word_list = response.data
  })
}

const get_course_list = ()=>{
  // 获取课程列表
  let ret  = null // 预设一个用于保存服务端返回的数据
  if(course.text) {
    ret = course.search_course()
  }else{
    ret = course.get_course_list()
  }
  ret.then(response=>{
    course.course_list = response.data.results;
    // 总数据量
    course.count = response.data.count;
    course.has_perv = !!response.data.previous; // !!2个非表示把数据转换成布尔值
    course.has_next = !!response.data.next;

    // 优惠活动的倒计时
    course.start_timer();
  })

  // 获取热手词列表
  get_hot_word();
}

get_course_list();

get_hot_word();

// 添加课程到购物车
const add_cart = (course_info)=>{
  let token = sessionStorage.token || localStorage.token;
  cart.add_course_to_cart(course_info.id, token).then(response=>{
    ElMessage.success(response?.data?.errmsg)
  }).catch(error=>{
    if(error?.response?.status === 401){
      store.commit("logout");
      ElMessage.error("您尚未登录或已登录超时，请登录后继续操作！");
    }else{
      ElMessage.error(`添加商品到购物车失败:` + error?.response?.data?.errmsg);
    }
  })
}

watch(
    // 监听切换不同的学习方向
    ()=> course.current_direction,
    ()=>{
        // 重置搜索文本框
        course.text = "";
        // 重置页码
        course.page = 1;
        // 重置排序条件
        course.ordering = "-id";

        get_category();
        get_course_list();
    }
)

watch(
    // 监听切换不同的课程分类
    ()=> course.current_category,
    ()=>{
        // 重置搜索文本框
        course.text = "";
        // 重置页码
        course.page = 1;
        // 重置排序条件
        course.ordering = "-id";
        get_course_list();
    }
)

watch(
    // 监听课程切换不同的排序条件
    ()=>course.ordering,
    ()=>{
        // 重置页码
        course.page = 1;
        get_course_list();
    }
)

// 监听页码
watch(
    ()=>course.page,
    ()=>{
        // 重新获取课程信息
        get_course_list();
    }
)

</script>
```

`views/Info.vue`，代码：

```vue
            <div class="buy">
              <div class="buy-btn">
                <button class="buy-now">立即购买</button>
                <button class="free">免费试学</button>
              </div>
              <el-popconfirm title="您确认添加当前课程加入购物车吗？" @confirm="add_cart" confirmButtonText="买买买！" cancelButtonText="误操作！">
                <template #reference>
                  <div class="add-cart"><img src="../assets/cart-yellow.svg" alt="">加入购物车</div>
                </template>
              </el-popconfirm>
<!--              <div class="add-cart"><img src="../assets/cart-yellow.svg" alt="">加入购物车</div>-->
            </div>
```

```vue
<script setup>
import {reactive,ref,watch} from "vue"
import {useRoute} from "vue-router"
import Header from "../components/Header.vue"
import Footer from "../components/Footer.vue"
import router from "../router"
import {ElMessage} from "element-plus"
import course from "../api/course"
import {fill0} from "../utils/func";
import cart from "../api/cart";
import {useStore} from "vuex";

let route = useRoute()
const store = useStore()

const state = reactive({
  tabIndex: 2,
})

// 获取地址栏上面的课程IDcourse_id
course.course_id = route.params.id;
if(course.course_id > 0){
  // 获取课程详情信息
  course.get_course_info().then(response=>{
    course.info = response.data;
    // 针对优惠课程如果有优惠时间，则进行倒计时处理
    clearInterval(course.timer);
    course.timer = setInterval(()=>{
      if(course.info.discount.expire && course.info.discount.expire>0){
        course.info.discount.expire--
      }
    },1000);
  }).catch(error=>{
    ElMessage.error({
      message: "无效的课程ID！",
      duration: 1000,
      onClose(){
        router.go(-1);
      }
    })
  })
}else{
  ElMessage.error({
    message: "无效的课程ID！",
    duration: 2000,
    onClose(){
      router.go(-1);  // 返回上一页
    }
  })
}


// 添加课程到购物车
// 详情页中添加商品到购物车，不用传递参数，直接使用course来获取课程信息
const add_cart = ()=>{
  let token = sessionStorage.token || localStorage.token;
  cart.add_course_to_cart(course.course_id, token).then(response=>{
    ElMessage.success(response?.data?.errmsg)
  }).catch(error=>{
    if(error?.response?.status === 401){
      store.commit("logout");
      ElMessage.error("您尚未登录或已登录超时，请登录后继续操作！");
    }else{
      ElMessage.error(`添加商品到购物车失败:${error?.response?.data?.errmsg}`);
    }
  })
}


// 播放器开始播放视频的回调函数
let onPlay = (event)=>{
    console.log("播放")
    console.log(event);
    console.log(event.target.currentTime); // 当前播放的视频时间进度，可以用于跟踪播放视频的视频
    console.log(event.target.duration); // 当前视频的总时长，可以用于跟踪播放视频的视频
}

// 播放器暂停播放视频的回调函数
let onPause = (event)=>{
    console.log("暂停")
    console.log(event.target.currentTime); // 当前播放的视频时间进度，可以用于跟踪播放视频的视频
    console.log(event.target.duration); // 当前视频的总时长，可以用于跟踪播放视频的视频
}

</script>
```

代码提交版本

```bash
git add .
git commit -m "添加商品课程到购物车"
git push --set-upstream origin feature/cart
```



## 显示购物车的商品数量

components/Header.vue，代码：

```vue
          <div class="login-bar logined-bar" v-if="store.getters.getUserInfo">
            <div class="shop-cart ">
              <img src="../assets/cart.svg" alt="" />
              <el-badge type="danger" :value="store.state.cart_total" class="item">
              <span><router-link to="/cart">购物车</router-link></span>
              </el-badge>
            </div>
```

store/index.js，代码：

```javascript
import {createStore} from "vuex"
import createPersistedState from "vuex-persistedstate"

// 实例化一个vuex存储库
export default createStore({
    // 调用永久存储vuex数据的插件，localstorage里会多一个名叫vuex的Key，里面就是vuex的数据
    plugins: [createPersisted`State()],
    state(){  // 相当于组件中的data，用于保存全局状态数据
        return {
            user: {},  // 登录用户信息
            cart_total: 0, // 购物车中的商品数量
        }
    },
    getters: {
        getUserInfo(state){
            let now = parseInt( (new Date() - 0) / 1000 );
            if(state.user.exp === undefined) {
                // 没登录
                state.user = {}
                localStorage.token = null;
                sessionStorage.token = null;
                return null
            }

            if(parseInt(state.user.exp) < now) {
                // 过期处理
                state.user = {}
                localStorage.token = null;
                sessionStorage.token = null;
                return null
            }
            return state.user;
        }
    },
    mutations: { // 相当于组件中的methods，用于操作state全局数据
        login(state, payload){
            state.user = payload; // state.user 就是上面声明的user
        },
        logout(state){ // 退出登录
            state.user = {}
            localStorage.token = null;
            sessionStorage.token = null;
        },
        set_cart_total(state, total) {
            // 设置商品数量的总数
            state.cart_total = total
        },
    }
})
```

views/Course.vue，代码：

```vue
<script setup>
import {watch} from "vue";
import Header from "../components/Header.vue"
import Footer from "../components/Footer.vue"
import course from "../api/course";
import {fill0} from "../utils/func";
import cart from "../api/cart";
import {ElMessage} from "element-plus";
import {useStore} from "vuex";
const store = useStore()

course.get_course_direction().then(response=>{
  // 获取学习方向
  course.direction_list = response.data;
})


const get_category = ()=>{
  // 获取课程分类

  // 重置当前选中的课程分类
  course.current_category=0;

  course.get_course_category().then(response=>{
    course.category_list = response.data;
  })
}

get_category();

const get_hot_word = ()=>{
  // 搜索热门关键字列表
  course.get_hot_word().then(response=>{
    course.hot_word_list = response.data
  })
}

const get_course_list = ()=>{
  // 获取课程列表
  let ret  = null // 预设一个用于保存服务端返回的数据
  if(course.text) {
    ret = course.search_course()
  }else{
    ret = course.get_course_list()
  }
  ret.then(response=>{
    course.course_list = response.data.results;
    // 总数据量
    course.count = response.data.count;
    course.has_perv = !!response.data.previous; // !!2个非表示把数据转换成布尔值
    course.has_next = !!response.data.next;

    // 优惠活动的倒计时
    course.start_timer();
  })

  // 获取热手词列表
  get_hot_word();
}

get_course_list();

get_hot_word();

// 添加课程到购物车
const add_cart = (course_info)=>{
  let token = sessionStorage.token || localStorage.token;
  cart.add_course_to_cart(course_info.id, token).then(response=>{
    ElMessage.success(response?.data?.errmsg);
    store.commit("set_cart_total", response.data.cart_total)
  }).catch(error=>{
    if(error?.response?.status === 401){
      store.commit("logout");
      ElMessage.error("您尚未登录或已登录超时，请登录后继续操作！");
    }else{
      ElMessage.error(`添加商品到购物车失败:${error?.response?.data?.errmsg}`);
    }
  })
}

watch(
    // 监听切换不同的学习方向
    ()=> course.current_direction,
    ()=>{
        // 重置搜索文本框
        course.text = "";
        // 重置页码
        course.page = 1;
        // 重置排序条件
        course.ordering = "-id";

        get_category();
        get_course_list();
    }
)

watch(
    // 监听切换不同的课程分类
    ()=> course.current_category,
    ()=>{
        // 重置搜索文本框
        course.text = "";
        // 重置页码
        course.page = 1;
        // 重置排序条件
        course.ordering = "-id";
        get_course_list();
    }
)

watch(
    // 监听课程切换不同的排序条件
    ()=>course.ordering,
    ()=>{
        // 重置页码
        course.page = 1;
        get_course_list();
    }
)

// 监听页码
watch(
    ()=>course.page,
    ()=>{
        // 重新获取课程信息
        get_course_list();
    }
)

</script>
```

views/Info.vue，代码：

```vue
<script setup>
import {reactive,ref,watch} from "vue"
import {useRoute} from "vue-router"
import Header from "../components/Header.vue"
import Footer from "../components/Footer.vue"
import router from "../router"
import {ElMessage} from "element-plus"
import course from "../api/course"
import {fill0} from "../utils/func";
import cart from "../api/cart";
import {useStore} from "vuex";

let route = useRoute()
const store = useStore()

const state = reactive({
  tabIndex: 2,
})

// 获取地址栏上面的课程IDcourse_id
course.course_id = route.params.id;
if(course.course_id > 0){
  // 获取课程详情信息
  course.get_course_info().then(response=>{
    course.info = response.data;
    // 针对优惠课程如果有优惠时间，则进行倒计时处理
    clearInterval(course.timer);
    course.timer = setInterval(()=>{
      if(course.info.discount.expire && course.info.discount.expire>0){
        course.info.discount.expire--
      }
    },1000);
  }).catch(error=>{
    ElMessage.error({
      message: "无效的课程ID！",
      duration: 1000,
      onClose(){
        router.go(-1);
      }
    })
  })
}else{
  ElMessage.error({
    message: "无效的课程ID！",
    duration: 2000,
    onClose(){
      router.go(-1);  // 返回上一页
    }
  })
}


// 添加课程到购物车
// 详情页中添加商品到购物车，不用传递参数，直接使用course来获取课程信息
const add_cart = ()=>{
  let token = sessionStorage.token || localStorage.token;
  cart.add_course_to_cart(course.course_id, token).then(response=>{
    ElMessage.success(response?.data?.errmsg);
    store.commit("set_cart_total", response.data.cart_total)
  }).catch(error=>{
    if(error?.response?.status === 401){
      store.commit("logout");
      ElMessage.error("您尚未登录或已登录超时，请登录后继续操作！");
    }else{
      ElMessage.error(`添加商品到购物车失败:`+${error?.response?.data?.errmsg});
    }
  })
}


// 播放器开始播放视频的回调函数
let onPlay = (event)=>{
    console.log("播放")
    console.log(event);
    console.log(event.target.currentTime); // 当前播放的视频时间进度，可以用于跟踪播放视频的视频
    console.log(event.target.duration); // 当前视频的总时长，可以用于跟踪播放视频的视频
}

// 播放器暂停播放视频的回调函数
let onPause = (event)=>{
    console.log("暂停")
    console.log(event.target.currentTime); // 当前播放的视频时间进度，可以用于跟踪播放视频的视频
    console.log(event.target.duration); // 当前视频的总时长，可以用于跟踪播放视频的视频
}

</script>
```



### 设置jwt登录返回购物车商品数量

文档：https://jpadilla.github.io/django-rest-framework-jwt/#jwt_response_payload_handler

`utils/authenticate.py`，自定义返回响应内容，代码：

```python

from django_redis import get_redis_connection


def jwt_response_payload_handler(token, user, request):
    """
    增加返回购物车的商品数量
    token: jwt token
    user: 用户模型对象
    request: 客户端的请求对象
    """
    redis = get_redis_connection("cart")
    cart_total = redis.hlen(f"cart_{user.id}")

    return {
        "cart_total": cart_total,
        "token": token
    }

```

配置文件，settings/dev.py，代码：

```python
import datetime
# jwt认证相关配置项
JWT_AUTH = {
    # 设置jwt的有效期
    # 如果内部站点，例如：运维开发系统，OA，往往配置的access_token有效期基本就是15分钟，30分钟，1~2个小时
    # 'JWT_EXPIRATION_DELTA': datetime.timedelta(weeks=1),  # 一周有效，
    'JWT_EXPIRATION_DELTA': datetime.timedelta(minutes=30),  # 一周有效，
    # 自定义载荷
    'JWT_PAYLOAD_HANDLER': 'fuguangapi.utils.authenticate.jwt_payload_handler',
    # 自定义响应数据
    'JWT_RESPONSE_PAYLOAD_HANDLER': 'fuguangapi.utils.authenticate.jwt_response_payload_handler'
}

```

客户端登录成功以后，显示当前用户的购物车中商品数量。

刚注册的用户是不会在redis有商品购物车的数量。

components/Login.vue，代码：

```vue
<script setup>
import user from "../api/user";
import { ElMessage } from 'element-plus'
import {useStore} from "vuex";
import "../utils/TCaptcha";
import settings from "../settings";
const store = useStore()
const emit = defineEmits(["login_success",])

// 显示登录验证码
const show_captcha = ()=>{
  var captcha1 = new TencentCaptcha(settings.captcha_app_id, (res)=>{
      // 接收验证结果的回调函数
      /* res（验证成功） = {ret: 0, ticket: "String", randstr: "String"}
         res（客户端出现异常错误 仍返回可用票据） = {ret: 0, ticket: "String", randstr: "String", errorCode: Number, errorMessage: "String"}
         res（用户主动关闭验证码）= {ret: 2}
      */
      loginhandler(res);
  });
  captcha1.show(); // 显示验证码
}


// 登录处理
const loginhandler = (res)=>{
  if(user.account.length<1 || user.password.length<1){
    // 错误提示
    console.log("错了哦，用户名或密码不能为空！");
    ElMessage.error('错了哦，用户名或密码不能为空！');
    return false;  // 在函数/方法中，可以阻止代码继续往下执行
  }

  // 发送请求
  user.login({
    username: user.account,
    password: user.password,
    ticket: res.ticket,
    randstr: res.randstr,
  }).then(response=>{
    // 保存token，并根据用户的选择，是否记住密码
    localStorage.removeItem("token");
    sessionStorage.removeItem("token");

    if(user.remember){ // 判断是否记住登录状态
      // 记住登录
      localStorage.token = response.data.token
    }else{
      // 不记住登录，关闭浏览器以后就删除状态
      sessionStorage.token = response.data.token;
    }
    // 保存token，并根据用户的选择，是否记住密码
    // 成功提示
    ElMessage.success("登录成功！");
    console.log("登录成功！");
    // 关闭登录弹窗，对父级页面发送一个登录成功的信息
    user.account = ""
    user.password = ""
    user.mobile = ""
    user.code = ""
    user.remember = false
    // 全局通知，保存user用户信息到vuex
    let payload = response.data.token.split(".")[1]  // 载荷
    payload = JSON.parse(atob(payload)) // 提取用户信息
    store.commit("login", payload);
    store.commit("set_cart_total", response.data.cart_total);
    emit("login_success")  // 通知父组件登录成功了
  }).catch(error=>{
    console.log(error);
  })
}

</script>
```



## 购物车商品列表展示

### 客户端页面展示

`router/index.js`，代码：

```javascript
// 路由列表
const routes = [
    {
      meta:{
        title: "浮光在线教育-首页",
        keepAlive: true
      },
      path:'/',         // uri访问地址
      component: ()=> import("../views/Home.vue")
    },{
      meta:{
        title: "登录",
        keepAlive: true
      },
      path: '/login',
      name: "Login",            // 路由名称
      component: ()=> import("../views/Login.vue"),         // uri绑定的组件页面
    },{
      meta:{
        title: "注册",
        keepAlive: true
      },
      path: '/register',
      name: "Register",            // 路由名称
      component: ()=> import("../views/Register.vue"),         // uri绑定的组件页面
    },{
      meta:{
        title: "项目课",
        keepAlive: true
      },
      path: '/project',
      name: "Course",            // 路由名称
      component: ()=> import("../views/Course.vue"),         // uri绑定的组件页面
    },{
      meta:{
        title: "项目课",
        keepAlive: true
      },
      path: '/project/:id',
      name: "Info",
      component: ()=> import("../views/Info.vue"),
    },{
      meta:{
        title: "购物车",
        keepAlive: true
      },
      path: '/cart',
      name: "Cart",
      component: ()=> import("../views/Cart.vue"),
    }
]
```

`views/Cart.vue`，代码：

```vue
<template>
  <div class="cart">
    <Header/>
    <div class="cart-main">
      <div class="cart-header">
        <div class="cart-header-warp">
          <div class="cart-title left">
            <h1 class="left">我的购物车</h1>
            <div class="left">
              共<span>5</span>门，已选择<span>5</span>门
            </div>
          </div>
          <div class="right">
            <div class="">
              <span class="left"><router-link class="myorder-history" to="/myorder">我的订单列表</router-link></span>
            </div>
          </div>
        </div>
      </div>
      <div class="cart-body" id="cartBody">
        <div class="cart-body-title">
          <div class="item-1 l"><el-checkbox v-model="state.checked">全选</el-checkbox></div>
          <div class="item-2 l"><span class="course">课程</span></div>
          <div class="item-3 l"><span>金额</span></div>
          <div class="item-4 l"><span>操作</span></div>
        </div>
        <div class="cart-body-table">
          <div class="item">
              <div class="item-1">
                  <el-checkbox v-model="state.checked"></el-checkbox>
              </div>
              <div class="item-2">
                  <a href="" class="img-box l">
                    <img src="/src/assets/course-7.png">
                  </a>
                  <dl class="l has-package">
                    <dt>【实战课 移动端UI设置入门与实战</dt>
                    <p class="package-item">优惠价</p>
                  </dl>
              </div>

              <div class="item-3">
                  <div class="price">
                      <span class="discount-price"><em>￥</em><span>588.00</span></span><br>
                      <span class="original-price"><em>￥</em><span>1988.00</span></span>
                  </div>
              </div>
              <div class="item-4">
                <span class="close">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024"><path fill="currentColor" d="M764.288 214.592 512 466.88 259.712 214.592a31.936 31.936 0 0 0-45.12 45.12L466.752 512 214.528 764.224a31.936 31.936 0 1 0 45.12 45.184L512 557.184l252.288 252.288a31.936 31.936 0 0 0 45.12-45.12L557.12 512.064l252.288-252.352a31.936 31.936 0 1 0-45.12-45.184z"></path></svg>
                </span>
              </div>
          </div>
          <div class="item">
              <div class="item-1"><el-checkbox v-model="state.checked"></el-checkbox></div>
              <div class="item-2">
                  <a href="" class="img-box l"><img src="/src/assets/course-1.png"></a>
                  <dl class="l has-package">
                      <dt>【实战课】算法与数据结构</dt>
                      <p class="package-item">限时优惠</p>
                  </dl>
              </div>
              <div class="item-3">
                <div class="price"><em>￥</em><span>299.00</span></div></div>
              <div class="item-4">
                <span class="close">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024"><path fill="currentColor" d="M764.288 214.592 512 466.88 259.712 214.592a31.936 31.936 0 0 0-45.12 45.12L466.752 512 214.528 764.224a31.936 31.936 0 1 0 45.12 45.184L512 557.184l252.288 252.288a31.936 31.936 0 0 0 45.12-45.12L557.12 512.064l252.288-252.352a31.936 31.936 0 1 0-45.12-45.184z"></path></svg>
                </span>
              </div>
          </div>
          <div class="cart-body-bot fixed">
            <div class=" cart-body-bot-box">
              <div class="right">
                <div class="add-coupon-box">
                  <div class="li-left">
                    <div class="li-2">
                      <span class="topdiv w70">总计金额：</span>
                      <span class="price price-red w100">
                        <em>￥</em>
                        <span>1751.00</span>
                      </span>
                    </div>
                  </div>
                  <div class="li-3"><span class="btn">去结算</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <Footer/>
  </div>
</template>

<script setup>
import {reactive} from "vue"
import Header from "../components/Header.vue"
import Footer from "../components/Footer.vue"
import {} from "../api/cart"
import { ElMessage } from 'element-plus'
let state = reactive({
  checked: false,
})

</script>

<style scoped>
.cart-header {
	height: 160px;
	background-color: #e3e6e9;
	background: url("/src/assets/cart-header-bg.jpeg") repeat-x;
	background-size: 38%;
}

.cart-header .cart-header-warp {
	width: 1500px;
	height: 120px;
	line-height: 120px;
	margin-left: auto;
	margin-right: auto;
	font-size: 14px
}

.cart-header .cart-header-warp .myorder-history {
	font-weight: 200
}

.cart-header .left {
	float: left
}

.cart-header .right {
	float: right
}

.cart-header .cart-title {
	color: #4d555d;
	font-weight: 200;
	font-size: 14px
}

.cart-header .cart-title h1 {
	font-size: 32px;
	line-height: 115px;
	margin-right: 25px;
	color: #07111b;
	font-weight: 200
}

.cart-header .cart-title span {
	margin: 0 4px
}

.cart-header .cart-title .js-number-box-cart {
	line-height: 115px
}

.cart-header .num {
	display: none;
	padding: 4px 5px;
	background-color: #f01414;
	color: #fff;
	border-radius: 50%;
	text-align: center;
	font-size: 12px;
	line-height: 10px;
	margin-top: 51px;
	margin-left: 5px
}

.l {
    float: left;
}

.cart-body {
	width: 1500px;
	padding: 0 36px 32px;
	background-color: #fff;
	margin-top: -40px;
	margin-left: auto;
	margin-right: auto;
	box-shadow: 0 8px 16px 0 rgba(7,17,27,.1);
	border-radius: 8px;
	box-sizing: border-box
}

.cart-body .left {
	float: left!important
}

.cart-body .right {
	float: right!important
}

.cart-body .cart-body-title {
	min-height: 88px;
	line-height: 88px;
	border-bottom: 1px solid #b7bbbf;
	box-sizing: border-box
}

.cart-body .priceprice i {
	float: left
}

body {
	background: #f8fafc
}

.cart-body .cart-body-title span {
	font-size: 14px
}

.cart-body .cart-body-title .item-1>span,
.cart-body .cart-body-title .item-2>span,
.cart-body .cart-body-title .item-3>span,
.cart-body .cart-body-title .item-4>span {
	display: inline-block;
	font-size: 14px;
	line-height: 24px;
	color: #4d555d;
}
.cart-body .cart-body-title .item-1>span {
	color: #93999f
}

.cart-body .cart-body-title .item-2>span {
	margin-left: 40px
}
.cart-body .cart-body-title .item-2 .course{
  line-height: 88px;
}
.cart-body .cart-body-title .item-4>span {
	margin-right: 32px;

}

.cart-body .cart-body-table .title .title-content span {
	margin-right: 9px;
	position: relative
}

.cart-body .cart-body-table .title .title-content span::after {
	content: "/";
	position: absolute;
	right: -9px
}

.cart-body .cart-body-table .title .title-content span:last-child::after {
	content: ''
}

.cart-body .item {
	height: 88px;
	padding: 24px 0;
	border-bottom: 1px solid #d9dde1
}

.cart-body .item>div {
	float: left
}

.cart-body .item .item-1 {
	padding-top: 34px;
	position: relative;
	z-index: 1
}

.cart-body .item:last-child>.item-1::after {
	display: none
}

.cart-body .item.disabled .price,.cart-body .item.disabled dt {
	color: #93999f!important
}

.cart-body .item-1 {
	width: 120px
}

.cart-body .item-1 i {
	margin-left: 12px;
	margin-right: 8px;
	font-size: 24px
}

.cart-body .item-2 {
	width: 820px;
  position:relative;
}
.cart-body .item-2>span{
  line-height: 88px;
}
.cart-body .item-2 dl {
	width: 464px;
	margin-left: 24px;
	padding-top: 12px
}

.cart-body .item-2 dl a {
	display: block;
}

.cart-body .item-2 dl.has-package {
	padding-top: 4px;
}

.cart-body .item-2 dl.has-package .package-item {
	display: inline-block;
	padding: 0 12px;
	margin-top: 4px;
	font-size: 12px;
	color: rgba(240,20,20,.6);
	line-height: 24px;
	background: rgba(240,20,20,.08);
	border-radius: 12px;
	cursor: pointer
}

.cart-body .item-2 dl.has-package .package-item:hover {
	color: #fff;
	background: rgba(240,20,20,.2)
}

.cart-body .item-2 dt {
	font-size: 16px;
	color: #07111b;
	line-height: 24px;
	margin-bottom: 4px
}

.cart-body .item-2 .img-box {
	display: block;
  margin-left: 42px;
}
.cart-body .item-2 .img-box img{
  height: 94px;
}
.cart-body .item-2 dd {
	font-size: 12px;
	color: #93999f;
	line-height: 24px;
	font-weight: 200
}

.cart-body .item-2 dd a {
	display: inline-block;
	margin-left: 12px;
	color: rgba(240,20,20,.4)
}

.cart-body .item-2 dd a:hover {
	color: #f01414
}

.cart-body .item-3 {
	width: 280px;
	margin-left: 48px;
  position: relative;
}

.cart-body .item-3 .price {
	display: inline-block;
	color: #1c1f21;
	height: 46px;
	width: 96px;
  padding-top: 24px;
  padding-bottom: 24px;
  font-size: 18px;
}
.cart-body .item-3 .price .original-price
{
  color: #aaa;
  text-decoration: line-through;
}
.cart-body .item-4 {
	margin-left: 74px;
}

.cart-body .item-4 .close {
	font-size: 36px;
	height: 36px;
  width: 36px;
  display: inline-block;
	color: #b7bbbf;
	line-height: 90px;
	cursor: pointer
}
.cart-body .item-4 .close:hover{
  color: #ff0000;
}
.cart-body .cart-body-bot.fixed {
	position: fixed;
	bottom: 0;
	left: 0;
	width: 100%;
	background-color: #fff;
	z-index: 300;
	box-shadow: 10px -2px 12px rgba(7,17,27,.2)
}

.cart-body .cart-body-bot.fixed .cart-body-bot-box {
	padding-bottom: 70px;
	width: 1500px;
  height: 20px;
  padding-top: 40px;
}

.cart-body .cart-body-bot.fixed .cart-body-bot-box .li-3 {
	margin-right: 36px
}

.cart-body .cart-body-bot .cart-body-bot-box {
	margin-left: auto;
	margin-right: auto;
	display: block;
	padding-top: 24px
}

.cart-body .cart-body-bot .cart-body-bot-box .add-coupon-box {
	display: flex;
	flex-direction: row;
	align-items: center
}

.cart-body .cart-body-bot li {
	float: left
}

.cart-body .cart-body-bot .li-left {
	text-align: right
}

cart-body .cart-body-bot .li-3 {
	font-size: 12px;
	color: #07111b;
	line-height: 24px
}

.cart-body .cart-body-bot .li-1 em,.cart-body .cart-body-bot .li-3 em {
	font-style: normal;
	color: red
}

.cart-body .cart-body-bot .li-2 {
	font-size: 0
}

.cart-body .cart-body-bot .li-2 .topdiv {
	font-size: 14px;
	color: #07111b;
	line-height: 28px
}

.cart-body .cart-body-bot .li-2 .price {
	font-size: 16px;
	color: #f01414;
	line-height: 24px;
	font-weight: 700
}

.cart-body .cart-body-bot .li-3 .btn {
	margin-left: 38px;
	float: right;
	padding: 13px 32px;
	color: #fff;
	font-size: 16px;
	color: #fff;
	cursor: pointer;
	font-weight: 200;
	background: #f01414;
	border-radius: 4px
}

.cart-body .cart-body-bot .w70 {
	display: inline-block;
	width: 120px;
	text-align: right
}

.cart-body .cart-body-bot .w100 {
	display: inline-block;
	width: 100px;
	text-align: right
}
</style>
```

src/App.vue，代码：

```vue
<style>
.cart .el-checkbox .el-checkbox__inner{
  width: 30px;
  height: 30px;
  border: 1px solid #aaa;
}
.cart .el-checkbox .el-checkbox__inner::after{
  height: 17px;
  left: 8px;
  width: 10px;
  border: 3px solid #FFF;
  border-left: 0;
  border-top: 0;
}
</style>
```



### 服务端提供购物车商品课程列表api接口

`cart/views.py`，当前商品课程列表与前面的添加商品课程到购物车中，使用的url地址一致。代码：

```python
from django_redis import get_redis_connection
from rest_framework import status
from rest_framework.viewsets import ViewSet
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from courses.models import Course


class CartViewSet(ViewSet):
    """购物车"""
    # 保证用户必须是登录状态才能调用当前视图
    permission_classes = [IsAuthenticated]

    def add_cart(self, request):
        """添加商品到购物车"""
        # 接收客户端的信息[用户ID，商品ID，勾选状态]
        user_id = request.user.id
        course_id = request.data.get("course_id")
        selected = 1

        # 验证数据
        try:
            Course.objects.get(is_delete=False, is_show=True,pk=course_id)
        except Course.DoesNotExist:
            return Response({"errmsg": "当前课程不存在！"}, status=status.HTTP_400_BAD_REQUEST)

        # 获取redis连接
        redis = get_redis_connection("cart")

        # todo 因为我们当前实现是属于虚拟商品的购买，是没有数量的。所以，针对同一个课程，或者曾经购买过的课程，不让用户再次添加到购物车
        ret = redis.hexists(f"cart_{user_id}", course_id)
        cart_total = redis.hlen(f"cart_{user_id}")
        if ret:
            return Response({
                "errmsg": "当前商品课程已经被添加到购物车，请不要重复添加！",
                "cart_total": cart_total,
            })

        # 保存商品信息到购物车
        # hset <user_id> <course_id> <selected>
        redis.hset(f"cart_{user_id}", course_id, selected)
        """
        cart_1: {
           course_id: True,
           course_id: True,
           course_id: True,
        }

        cart_2: {
           ....
        }
        """

        # 返回操作结果，购物车中的商品总数
        # hlen <user_id>
        cart_total = redis.hlen(f"cart_{user_id}")

        # 5. 返回结果给客户端
        return Response({
            "errmsg": "成功添加商品课程到购物车！",
            "cart_total": cart_total
        }, status=status.HTTP_201_CREATED)

    def list(self, request):
        """购物车商品列表页"""
        # 查询购物车中的商品课程ID列表
        user_id = request.user.id
        redis = get_redis_connection("cart")
        cart_hash = redis.hgetall(f"cart_{user_id}")
        """
        cart_hash = {
            # b'商品课程ID': b'勾选状态',
            b'2': b'1',
            b'4': b'1',
            b'5': b'1'
        }
        """
        if len(cart_hash) < 1:
            return Response({"errmsg": "购物车没有任何商品。"}, status=status.HTTP_204_NO_CONTENT)

        # 把redis中的购物车信息转换成普通字典
        cart_dict = {int(course_id.decode()): bool(int(selected.decode())) for course_id, selected in cart_hash.items()}
        """
        cart_dict = {
           # 商品课程ID: 勾选状态,
            2: True,
            4: True,
            5: True
        }
        """
        # 从mysql中提取购物车商品对应的商品其他信息
        course_list = Course.objects.filter(pk__in=cart_dict.keys(), is_delete=False, is_show=True).all()

        # 把course_list进行遍历，提取课程中的信息组成列表
        data = []
        for course in course_list:
            data.append({
                "id": course.id,
                "name": course.name,
                "course_cover": course.course_cover.url,
                "price": float(course.price),
                "discount": course.discount,
                "course_type": course.get_course_type_display(),
                "selected": cart_dict[course.id],
            })

        # 返回客户端
        return Response({"errmsg": "ok！", "cart": data})

```

课程模型中调整了课程类型的提示文本。`courses.models`，代码：

```python
class Course(BaseModel):
    course_type = (
        (0, '实战课程'),
        (1, '会员专享'),
        (2, '学位课程'),
    )
```

cart/urls.py，代码：

```python
from django.urls import path
from . import views

urlpatterns = [
    path("", views.CartViewSet.as_view({
        "post": "add_cart",
        "get": "list",
    }))
]
```



### 客户端展示购物车课程信息

`api/cart.js`，代码：

```javascript
import http from "../utils/http";
import {reactive} from "vue";

const cart = reactive({
    course_list: [], // 购物车中的商品列表
    total_price: 0,  // 购物车中的商品总价格
    selected_course_total: 0, // 购物车中被勾选商品的数量
    checked: false,  // 购物车中是否全选商品了
    add_course_to_cart(course_id, token ){
        // 添加课程到购物车
        return http.post("/cart/", {
            course_id, // course_id: course_id,
        }, {
            headers: {
                // 因为当前课程端添加课程商品到购物车必须登录，所以接口操作时必须发送jwt
                Authorization: "jwt " + token,   // 注意：jwt字符串与token之间务必有空格！否则无法认证
            }
        })
    },
    get_course_from_cart(token){
        return http.get("/cart/", {
            headers:{
                Authorization: "jwt " + token,
            }
        })
    }
});

export default cart;
```



`views/Cart.vue`，代码：

```vue
<template>
  <div class="cart">
    <Header/>
    <div class="cart-main">
      <div class="cart-header">
        <div class="cart-header-warp">
          <div class="cart-title left">
            <h1 class="left">我的购物车</h1>
            <div class="left">
              共<span>{{cart.course_list.length}}</span>门，已选择<span>{{cart.selected_course_total}}</span>门
            </div>
          </div>
          <div class="right">
            <div class="">
              <span class="left"><router-link class="myorder-history" to="/myorder">我的订单列表</router-link></span>
            </div>
          </div>
        </div>
      </div>
      <div class="cart-body" id="cartBody">
        <div class="cart-body-title">
          <div class="item-1 l">
              <el-checkbox v-model="cart.checked">全选</el-checkbox></div>
          <div class="item-2 l">
              <span class="course">课程</span></div>
          <div class="item-3 l">
              <span>金额</span></div>
          <div class="item-4 l">
              <span>操作</span></div>
        </div>
        <div class="cart-body-table">
          <div class="item" v-for="(course_info, key) in cart.course_list">
              <div class="item-1">
                  <!-- 商品勾选状态-->
                  <el-checkbox v-model="course_info.selected"></el-checkbox>
              </div>
              <div class="item-2">
                  <router-link :to="`/project/${course_info.id}`" class="img-box l">
                    <img :src="course_info.course_cover">
                  </router-link>
                  <dl class="l has-package">
                    <dt>【{{course_info.course_type}}】 {{course_info.name}}</dt>
                    <p class="package-item" v-if="course_info.discount.type">{{ course_info.discount.type }}</p>
                  </dl>
              </div>

              <div class="item-3">
                  <div class="price" v-if="course_info.discount.price>=0">
                      <span class="discount-price"><em>￥</em><span>{{course_info.discount.price.toFixed(2)}}</span></span><br>
                      <span class="original-price"><em>￥</em><span>{{course_info.price.toFixed(2)}}</span></span>
                  </div>
                  <div class="price" v-else>
                      <div class="discount-price"><em>￥</em><span>{{course_info.price.toFixed(2)}}</span></div>
                  </div>
              </div>
              <div class="item-4">
                <span class="close">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024"><path fill="currentColor" d="M764.288 214.592 512 466.88 259.712 214.592a31.936 31.936 0 0 0-45.12 45.12L466.752 512 214.528 764.224a31.936 31.936 0 1 0 45.12 45.184L512 557.184l252.288 252.288a31.936 31.936 0 0 0 45.12-45.12L557.12 512.064l252.288-252.352a31.936 31.936 0 1 0-45.12-45.184z"></path></svg>
                </span>
              </div>
          </div>
          <div class="cart-body-bot fixed">
            <div class=" cart-body-bot-box">
              <div class="right">
                <div class="add-coupon-box">
                  <div class="li-left">
                    <div class="li-2">
                      <span class="topdiv w70">总计金额：</span>
                      <span class="price price-red w100">
                        <em>￥</em>
                        <span>{{cart.total_price.toFixed(2)}}</span>
                      </span>
                    </div>
                  </div>
                  <div class="li-3"><span class="btn">去结算</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <Footer/>
  </div>
</template>
```

```vue
<script setup>
import {reactive} from "vue"
import Header from "../components/Header.vue"
import Footer from "../components/Footer.vue"
import cart from "../api/cart"
import { ElMessage } from 'element-plus'
let state = reactive({
  checked: false,
})

const get_cart = ()=>{
  // 获取购物车中的商品列表
  let token = sessionStorage.token || localStorage.token;
  cart.get_course_from_cart(token).then(response=>{
    cart.course_list = response.data.cart;
    get_cart_total();
  })
}

get_cart()


// 计算获取购物车中勾选商品课程的总价格
const get_cart_total = ()=>{
  let sum = 0;
  let select_sum = 0;
  cart.course_list.forEach((course, key)=>{
    if(course.selected){
      // 当前被勾选
      select_sum+=1;
      // 判断当前商品是否有优惠价格
      if(course.discount.price>=0){
        sum+=course.discount.price;
      }else{
        sum+=course.price;
      }
    }
    cart.total_price = sum; // 购物车中的商品总价格
    cart.selected_course_total = select_sum; // 购物车中被勾选商品的数量
    cart.checked = select_sum === cart.course_list.length;  // 购物车中是否全选商品了
  })
}

</script>
```



## 购物车商品的勾选状态切换

商品课程的勾选状态发生改变时，同步到服务端中的购物车。

```python
from django_redis import get_redis_connection
from rest_framework import status
from rest_framework.viewsets import ViewSet
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from courses.models import Course


class CartViewSet(ViewSet):
    """购物车"""
    # 保证用户必须是登录状态才能调用当前视图
    permission_classes = [IsAuthenticated]

    # //...中间代码省略

    def change_select(self, request):
        """切换单个商品的勾选状态"""
        # 谁的购物车？user_id
        # 获取购物车的课程ID与勾选状态
        user_id = request.user.id
        course_id = int(request.data.get("course_id", 0))
        selected = int(bool(request.data.get("selected", True)))
        redis = get_redis_connection("cart")

        try:
            Course.objects.get(pk=course_id, is_show=True, is_delete=False)
        except Course.DoesNotExist:
            redis.hdel(f"cart_{user_id}", course_id)
            return Response({"errmsg": "当前商品不存在或已经被下架！！"})

        redis.hset(f"cart_{user_id}", course_id, selected)

        return Response({"errmsg": "ok"})
```



### 服务端实现购物车的全选和反选

`courses.views`，代码：

```python
from django_redis import get_redis_connection
from rest_framework import status
from rest_framework.viewsets import ViewSet
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from courses.models import Course


class CartViewSet(ViewSet):
    """购物车"""
    # 保证用户必须是登录状态才能调用当前视图
    permission_classes = [IsAuthenticated]

    # // ... 中间代码省略

    def together_select(self, request):
        """全选/全不选"""
        user_id = request.user.id
        selected = int(bool(request.data.get("selected", True)))
        redis = get_redis_connection("cart")
        # 获取购物车中所有商品课程信息
        cart_hash = redis.hgetall(f"cart_{user_id}")
        """
        cart_hash = {
            # b'商品课程ID': b'勾选状态',
            b'2': b'1',
            b'4': b'1',
            b'5': b'1'
        }
        """
        if len(cart_hash) < 1:
            return Response({"errmsg": "购物车没有任何商品。"}, status=status.HTTP_204_NO_CONTENT)

        # 把redis中的购物车课程ID信息转换成普通列表
        cart_list = [int(course_id.decode()) for course_id in cart_hash]

        # 批量修改购物车中素有商品课程的勾选状态
        pipe = redis.pipeline()
        pipe.multi()
        for course_id in cart_list:
            pipe.hset(f"cart_{user_id}", course_id, selected)
        pipe.execute()

        return Response({"errmsg": "ok"})

```

路由，cart/urls.py，代码：

```python
from django.urls import path
from . import views

urlpatterns = [
    path("", views.CartViewSet.as_view({
        "post": "add_cart",
        "get": "list",
        "patch": "change_select", # 切换单个课程的勾选状态
        "put": "together_select", # 切换购物车中所有商品的勾选状态[全选/全不选]
    }))
]
```



### 客户端实现购物车的全选和反选

`api/cart.js`，代码：

```javascript
import http from "../utils/http";
import {reactive} from "vue";

const cart = reactive({
    // ... 中间代码省略

    select_course(course_id, selected, token){
        // 切换指定商品课程的勾选状态
        return http.patch("/cart/", {
            course_id,
            selected,
        },{
            headers:{
                Authorization: "jwt " + token,
            }
        })
    },
    select_all_course(selected, token){
        // 切换购物车对应商品课程的全选状态
        return http.put("/cart/", {
            selected,
        },{
            headers:{
                Authorization: "jwt " + token,
            }
        })
    }
});

export default cart;
```



`views/Cart.vue`

```vue
<div class="item-1">
                  <!-- 商品勾选状态-->
                  <el-checkbox v-model="course_info.selected" @change="change_select_course(course_info)"></el-checkbox>
              </div>
```

```vue
<script setup>
import { watch } from "vue";
import Header from "../components/Header.vue";
import Footer from "../components/Footer.vue";
import cart from "../api/cart";
import { useStore } from "vuex";
import { ElMessage } from "element-plus";

const store = useStore();

const get_cart = ()=>{
  // 获取购物车中的商品列表
  let token = sessionStorage.token || localStorage.token;
  cart.get_course_from_cart(token).then(response=>{
    cart.course_list = response.data.cart;
    get_cart_total();

    // 监听所有课程的勾选状态是否发生
    watch(
    [...cart.course_list],  // watch多个数据必须是数组结构，但是cart.course_list是由我们通过vue.reactive装饰成响应式对象了，所以需要转换
    ()=>{
      get_cart_total();
    },
  )
  })
}

get_cart()


// 计算获取购物车中勾选商品课程的总价格
const get_cart_total = ()=>{
  let sum = 0;
  let select_sum = 0;
  cart.course_list.forEach((course, key)=>{
    if(course.selected){
      // 当前被勾选
      select_sum+=1;
      // 判断当前商品是否有优惠价格
      if(course.discount.price>=0){
        sum+=course.discount.price;
      }else{
        sum+=course.price;
      }
    }
    cart.total_price = sum; // 购物车中的商品总价格
    cart.selected_course_total = select_sum; // 购物车中被勾选商品的数量
    cart.checked = select_sum === cart.course_list.length;  // 购物车中是否全选商品了
  })
}


const change_select_course = (course)=>{
  // 切换指定课程的勾选状态
  let token = sessionStorage.token || localStorage.token;
  cart.select_course(course.id, course.selected, token).catch(error=>{
    ElMessage.error(error?.response?.data?.errmsg);
  })
}

// 监听全选按钮的状态切换
watch(
    ()=>cart.checked,
    ()=>{
        let token = sessionStorage.token || localStorage.token;
        // 如果勾选了全选，则所有课程的勾选状态都为true
        if(cart.checked){
            // 让客户端的所有课程状态先改版
            cart.course_list.forEach((course, key)=>{
                course.selected = true
            })

            // 如果是因为购物车中所有课程的勾选状态都为true的情况下，是不需要发送全选的ajax请求
            if(!(cart.selected_course_total === cart.course_list.length)){
                cart.select_all_course(true, token);
            }
        }

        // 如果在所有课程的勾选状态都为true的情况下，把全选去掉，则所有课程的勾选状态也变成false
        if((cart.checked === false) && (cart.selected_course_total === cart.course_list.length)){
            cart.course_list.forEach((course, key)=>{
                course.selected = false
            })
            cart.select_all_course(false,token);
        }
    }
)

</script>
```



## 删除购物车中的商品

### 服务端提供购物车中删除商品课程的api接口

cart/views.py，代码：

```python
from django_redis import get_redis_connection
from rest_framework import status
from rest_framework.viewsets import ViewSet
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

# Create your views here.
from courses.models import Course


class CartViewSet(ViewSet):
    """购物车"""
    # 保证用户必须是登录状态才能调用当前视图
    permission_classes = [IsAuthenticated]

    # //.. 中间代码省略

    def delete_course(self, request):
        """从购物车中删除课程"""
        user_id = request.user.id
        course_id = int(request.query_params.get("course_id", 0))
        redis = get_redis_connection("cart")
        redis.hdel(f"cart_{user_id}", course_id)
        return Response(status=status.HTTP_204_NO_CONTENT)

```

路由，cart/urls.py，代码：

```python
from django.urls import path
from . import views

urlpatterns = [
    path("", views.CartViewSet.as_view({
        "post": "add_cart",
        "get": "list",
        "patch": "change_select",
        "put": "together_select",
        "delete": "delete_course",
    }))
]
```



### 客户端实现删除课程的功能

`api/cart.js`，代码：

```javascript
import http from "../utils/http";
import {reactive} from "vue";

const cart = reactive({
    // ... 中间代码省略

    delete_course(course_id, token){
        // 从购物车中删除商品课程
        return http.delete("/cart/", {
            params:{
                course_id,
            },
            headers:{
                Authorization: "jwt " + token,
            }
        })
    }
});

export default cart;
```

`views/Cart.vue`，代码：

```vue
<div class="item-4">
              <el-popconfirm title="您确认要从购物车删除当前课程吗？" @confirm="del_cart(key)" confirmButtonText="删除！" cancelButtonText="误操作！">
                <template #reference>
                    <span class="close">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024"><path fill="currentColor" d="M764.288 214.592 512 466.88 259.712 214.592a31.936 31.936 0 0 0-45.12 45.12L466.752 512 214.528 764.224a31.936 31.936 0 1 0 45.12 45.184L512 557.184l252.288 252.288a31.936 31.936 0 0 0 45.12-45.12L557.12 512.064l252.288-252.352a31.936 31.936 0 1 0-45.12-45.184z"></path></svg>
                    </span>
                </template>
              </el-popconfirm>
              </div>
```

```vue
<script setup>
import {watch} from "vue"
import Header from "../components/Header.vue"
import Footer from "../components/Footer.vue"
import cart from "../api/cart"
import {useStore} from "vuex";
import { ElMessage } from 'element-plus'


const store = useStore()

const get_cart = ()=>{
  // 获取购物车中的商品列表
  let token = sessionStorage.token || localStorage.token;
  cart.get_course_from_cart(token).then(response=>{
    cart.course_list = response.data.cart;
    get_cart_total();

    // 监听所有课程的勾选状态是否发生
    watch(
    [...cart.course_list],  // watch多个数据必须是数组结构，但是cart.course_list是由我们通过vue.reactive装饰成响应式对象了，所以需要转换
    ()=>{
      get_cart_total();
    },
  )
  })
}

get_cart()


// 计算获取购物车中勾选商品课程的总价格
const get_cart_total = ()=>{
  let sum = 0;
  let select_sum = 0;
  cart.course_list.forEach((course, key)=>{
    if(course.selected){
      // 当前被勾选
      select_sum+=1;
      // 判断当前商品是否有优惠价格
      if(course.discount.price>=0){
        sum+=course.discount.price;
      }else{
        sum+=course.price;
      }
    }
    cart.total_price = sum; // 购物车中的商品总价格
    cart.selected_course_total = select_sum; // 购物车中被勾选商品的数量
    cart.checked = select_sum === cart.course_list.length;  // 购物车中是否全选商品了
  })
}


const change_select_course = (course)=>{
  // 切换指定课程的勾选状态
  let token = sessionStorage.token || localStorage.token;
  cart.select_course(course.id, course.selected, token).catch(error=>{
    ElMessage.error(error?.response?.data?.errmsg);
  })
}

// 监听全选按钮的状态切换
watch(
    ()=>cart.checked,
    ()=>{
        let token = sessionStorage.token || localStorage.token;
        // 如果勾选了全选，则所有课程的勾选状态都为true
        if(cart.checked){
            // 让客户端的所有课程状态先改版
            cart.course_list.forEach((course, key)=>{
                course.selected = true
            })

            // 如果是因为购物车中所有课程的勾选状态都为true的情况下，是不需要发送全选的ajax请求
            if(!(cart.selected_course_total === cart.course_list.length)){
                cart.select_all_course(true, token);
            }
        }

        // 如果在所有课程的勾选状态都为true的情况下，把全选去掉，则所有课程的勾选状态也变成false
        if((cart.checked === false) && (cart.selected_course_total === cart.course_list.length)){
            cart.course_list.forEach((course, key)=>{
                course.selected = false
            })
            cart.select_all_course(false,token);
        }
    }
)

const del_cart = (key)=>{
    // 从购物车中删除商品课程
    let token = sessionStorage.token || localStorage.token;
    let course = cart.course_list[key];
    cart.delete_course(course.id, token).then(response=>{
        // 当课程的勾选状态为True时，删除课程以后，把已勾选状态的课程总数-1
        cart.course_list.splice(key, 1);
        store.commit("set_cart_total", cart.course_list.length);
        // 重新计算购物车中的商品课程的总价格
        get_cart_total();
    })
}

</script>
```

