## 数据库

与Django框架相比，Tornado没有自带ORM，对于数据库需要自己去适配。我们使用MySQL数据库。

在Tornado3.0版本以前提供tornado.database模块用来操作MySQL数据库，而从3.0版本开始，此模块就被独立出来，作为torndb包单独提供。torndb只是对MySQLdb的简单封装，不支持Python 3。所以如果在当前版本中使用torndb进行数据库操作，需要修改源代码，所以在此，我们使用pymysql。

>   项目中如果要使用ORM，可以使用SQLAlchemy，但开发中，很少有人这么使用.
>
>   同时，tornado强大的地方在于其异步非阻塞，所以我们后面关于数据库操作，不管是mysql, mongodb还是redis基本都是异步读写操作。

### MySQL

```
pip install pymysql
```

mysql.py，代码:

```python
import pymysql
class MySQL(object):
    def __init__(self, host, user, pwd, name):
        self.host = host
        self.user = user
        self.pwd = pwd
        self.name = name
        self.data = None
        self.last_sql = None

    def connect(self):
        self.db = pymysql.Connect(host=self.host, user=self.user, passwd=self.pwd, db=self.name)
        self.cursor = self.db.cursor()

    def close(self):
        self.cursor.close()
        self.db.close()

    def get_one(self, sql):
        try:
            self.connect()
            self.cursor.execute(sql)
            res = self.cursor.fetchone()
            self.data = res
            self.last_sql = sql
            self.close()
        except:
            print("fail to select")

        return self
    def get_all(self, sql):
        try:
            self.connect()
            self.cursor.execute(sql)
            res = self.cursor.fetchall()
            self.last_sql = sql
            self.data = res
            self.close()
        except:
            print("fail to select")
        return self

    def get_all_obj(self, sql):
        resList = []
        fieldList = []
        arr = sql.lower().split(" ")
        while "" in arr:
            arr.remove("")
        tableName = arr[arr.index("from")+1]
        fieldSql = "select COLUMN_NAME from information_schema.COLUMNS where table_name='%s' and table_schema='%s'" % (
            tableName, self.name
        )
        fields = self.get_all(fieldSql).data
        for item in fields:
            fieldList.append(item[0])
        
        res = self.get_all(sql).data
        for item in res:
            obj = {}
            count = 0
            for x in item:
                obj[fieldList[count]] = x
                count += 1
            resList.append(obj)
        self.data = resList
        return self

    def insert(self, sql):
        return self.execute(sql)

    def update(self, sql):
        return self.execute(sql)

    def delete(self, sql):
        return self.execute(sql)

    def execute(self, sql):
        count = 0
        try:
            self.connect()
            count = self.cursor.execute(sql)
            self.db.commit()
            self.data = self.db.rowcount()
            self.last_sql = sql
            self.close()
        except:
            print("fail execute sql")
            self.db.rollback()
        return count
```



server.py，代码：

```python
from tornado import ioloop
from tornado import web
from mysql import MySQL


mysql = {
    "host": "127.0.0.1",
    "user": "root",
    "pwd": "123",
    "db": "students"
}

db = MySQL(mysql["host"], mysql["user"], mysql["pwd"], mysql["db"])

settings = {
    'debug': True,
}

class Request(web.RequestHandler):
    def initialize(self,db):
        self.db = db

    def write(self, chunk: web.Union[str, bytes, dict, list]) -> None:
        if self._finished:
            raise RuntimeError("Cannot write() after finish()")
        if not isinstance(chunk, (bytes, web.unicode_type, dict, list)):
            message = "write() only accepts bytes, unicode, and dict objects"
            # if isinstance(chunk, list):
            #     message += (
            #         ". Lists not accepted for security reasons; see "
            #         + "http://www.tornadoweb.org/en/stable/web.html#tornado.web.RequestHandler.write"  # noqa: E501
            #     )
            raise TypeError(message)
        if isinstance(chunk, (dict,list)):
            chunk = web.escape.json_encode(chunk)
            self.set_header("Content-Type", "application/json; charset=UTF-8")
        chunk = web.utf8(chunk)
        self._write_buffer.append(chunk)

class Home(Request):
    def get1(self):
        """查询一条数据"""
        data = self.db.get_one("select * from tb_student").data
        print(data)
        self.write("hello,get")

    def get2(self):
        """查询多条数据[返回元祖]"""
        data = self.db.get_all("select * from tb_student").data
        print(data)
        self.write("hello,get")

    def get3(self):
        """查询多条数据[返回元祖]"""
        data = self.db.get_all("select * from tb_student").data
        print(data)
        """查询多条数据[返回列表]"""
        data = self.db.get_all_json("select * from tb_student").data
        print(data)
        self.write("hello,get")

    def get(self):
        """添加/删除/修改"""
        # """添加一条"""
        # name = "xiaobai"
        # avatar = "2.png"
        # age = 16
        # sex = True
        # money = 100
        # sql = "INSERT INTO tb_student (name,avatar,age,sex,money) VALUES ('%s','%s',%s,%s,%s)" % (name,avatar,age,sex,money)
        # data = self.db.insert(sql).data
        # print(data)

        """添加多条"""
        # student_list = [
        #     {"name":"xiaohui1","avatar":"1.png","age":16,"sex":True,"money":1000},
        #     {"name":"xiaohui2","avatar":"2.png","age":16,"sex":False,"money":1000},
        #     {"name":"xiaohui3","avatar":"3.png","age":16,"sex":True,"money":1000},
        #     {"name":"xiaohui4","avatar":"4.png","age":16,"sex":False,"money":1000},
        # ]
        # table = "tb_student"
        #
        # fields = ",".join( student_list[0].keys() )
        # sql = "INSERT INTO %s (%s) VALUES " % (table,fields)
        #
        # for student in student_list:
        #     sql += "('%s','%s',%s,%s,%s)," % (student["name"],student["avatar"],student["age"],student["sex"],student["money"])
        # sql = sql[:-1]
        # data = self.db.insert(sql).data
        # print(data)

        """更新"""
        # name = "小辉"
        # sql = "UPDATE tb_student set name='%s' WHERE id = 3" % (name)
        # data = self.db.update(sql).data
        # print(data)

        """删除"""
        # sql = "DELETE FROM tb_student WHERE id = 16"
        # data = self.db.delete(sql).data
        # print(data)

        self.write("hello,get")

# 设置路由列表
urls = [
    (r"/", Home,{"db":db}),
]

if __name__ == "__main__":
    # 创建应用实例对象
    app = web.Application(urls, **settings)
    # 设置监听的端口和地址
    app.listen(8888)
    # ioloop，全局的tornado事件循环，是服务器的引擎核心，start表示创建IO事件循环
    ioloop.IOLoop.current().start()
```

